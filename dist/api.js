!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AceApi=t():e.AceApi=t()}(global,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=18)}([function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("@babel/runtime/helpers/interopRequireDefault")},function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(4),i=n(6),o={_id:"config",client:{},assets:{},schemas:[],taxonomies:[],users:[],roles:(new(n(12))).roles(),provider:{},module:{}};e.exports=class{constructor(e){this.config=e}get(){var e,t=this;return r.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return e=o,n.prev=1,n.next=4,r.default.awrap(a.connect(t.config).get("config"));case 4:e=n.sent,e=s.merge({},o,e),n.next=10;break;case 8:n.prev=8,n.t0=n.catch(1);case 10:return e.slug=t.config.slug,n.abrupt("return",e);case 12:case"end":return n.stop()}}),null,null,[[1,8]],Promise)}set(e){var t=this;return r.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return e._id="config",delete e.roles,n.next=4,r.default.awrap(i.createOrUpdate(t.config,e));case 4:return e=n.sent,e=s.merge({},o,e),n.abrupt("return",e);case 7:case"end":return n.stop()}}),null,null,null,Promise)}}},function(e,t,n){"use strict";const r=n(11);class s{constructor(e,t){return this.config=e,s.connect(e,t)}static connect(e,t){return new r({url:e.db.url,maxAttempt:5,plugins:["promises",{retry:{retryDelayMultiplier:2,retryInitialDelayMsecs:500}}]}).db.use(t||e.db.name)}}e.exports=s},function(e,t){e.exports=require("bluebird")},function(e,t,n){"use strict";const r=n(0),s=n(5),a=n(4);e.exports=class{constructor(e){this.config=e,this.assistUrl=e.assist.url,this.slug=e.slug}static createOrUpdate(e,t){return new s((n,r)=>{a.connect(e).insert(t).then(e=>{t._id=e.id,t._rev=e.rev,n(t)},s=>{409===s.statusCode?a.connect(e).get(t._id).then(s=>{t._rev=s._rev,a.connect(e).insert(t).then(e=>{t._rev=e.rev,n(t)},r)},r):r(s)})})}static chunkUpdate(e,t,n=1e3){return new s((i,o)=>{const c=r.chunk(t,n),u=[];c.forEach(t=>{u.push(new s((n,r)=>{a.connect(e).bulk({docs:t}).then(n,r)}))}),s.all(u).then(i,o)})}static groupEntities(e,t=1/0){const n=[];let r={entities:[]};return e.forEach(e=>{(!e.groupBefore||r.entities.length>=t)&&(r={entities:[]}),r.entities.push(e),(!e.groupAfter||r.entities.length>=t)&&(r.ratio=0,r.entities.forEach(e=>{r.ratio+=(e.thumbnail||e).ratio}),r.entities.forEach(e=>{e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n}static now(){return JSON.stringify(new Date).replace(/"/g,"")}static replace(e,t,n){return e.map(e=>e[n]===t[n]?t:e)}thumbnailSrc(e,t,n,s){if(!e)return"";let a;"string"==typeof t&&(a=t.split(/,|;/),t={},a.forEach(e=>{e=e.split(/_|:/),t[e[0]]=e[1]}));const i=!!e.crops&&e.crops[n];i?(t.x=i[0],t.y=i[1],t.x2=i[2],t.y2=i[3]):s&&(t.g=s),a=[],r.forEach(t,(e,t)=>{a.push([t,e].join(":"))});const o=a.join(";");if(/(image)/.test(e.thumbnailType))return"svg"===e.ext?[this.assistUrl,this.slug,e.name+e.ext].join("/"):[this.assistUrl,this.slug,"transform",o,e.name+e.ext].join("/");if(/(video)/.test(e.thumbnailType))return[this.assistUrl,this.slug,"transform",o,e.name,"thumb.jpg"].join("/");if(/(oembed|proxy)/.test(e.thumbnailType)){const t=e.thumbnailUrl.replace(/https?:\/\//,"");return[this.assistUrl,this.slug,"proxy","transform",o,t].join("/")}return""}}},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(8),i=n(20),o=n(3);e.exports=class{constructor(e){this.config=e}deleteFiles(e){var t,n,c,u,l=this;return r.default.async((function(d){for(;;)switch(d.prev=d.next){case 0:return t=new o(l.config),d.next=3,r.default.awrap(t.get());case 3:if(n=d.sent,c=s.get(n,"assets.slug",l.config.slug),0!==e.length){d.next=7;break}return d.abrupt("return",[]);case 7:return d.next=9,r.default.awrap(a.post(`${l.config.assist.url}/${c}/file/delete`,{fileNames:e},{auth:{username:l.config.assist.username,password:i.generate(l.config.assist.password)}}));case 9:return u=d.sent.data,d.abrupt("return",u);case 11:case"end":return d.stop()}}),null,null,null,Promise)}}},function(e,t){e.exports=require("@cloudant/cloudant")},function(e,t,n){"use strict";const r=n(0),s=[{name:"Admin",slug:"admin",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!0,settings:!0,userSettings:!0,tools:!0}},{name:"Editor",slug:"editor",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!1,settings:!1,userSettings:!0,tools:!1}},{name:"Guest",slug:"guest",permissions:{entityGrid:!0,entityCreate:!1,entityRead:!0,entityUpdate:!1,entityDelete:!1,taxonomyCreate:!1,taxonomyRead:!0,taxonomyUpdate:!1,taxonomyDelete:!1,fileCreate:!1,fileRead:!0,fileUpdate:!1,fileDelete:!1,config:!1,schema:!1,user:!1,settings:!1,userSettings:!1,tools:!1}}];e.exports=class{roles(){return s.map(e=>Object.freeze(e))}role(e){return r.find(this.roles(),{slug:e})}}},function(e,t,n){"use strict";const r=n(26);e.exports=class{constructor(e){this.config=e}signToken(e,t={}){return r.sign(e,this.config.auth.tokenSecret,t)}verifyToken(e){return r.verify(e,this.config.auth.tokenSecret)}}},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(5),i=n(45),{diff:o}=n(46),c=n(3),u=n(4),l=n(6),d=n(15),p=n(10);class f{constructor(e){this.config=e,this.flattenValues=f.flattenValues}static flattenValues(e){return e.map(e=>e.fields&&s.size(e.fields)?(e.fields=s.mapValues(e.fields,e=>(/entity/.test(e.type)&&s.isArray(e.value)&&(e.value=f.flattenValues(e.value)),e.value)),e):e)}static _filterEntityFields(e,t="guest"){const n=s.isArray(e);return e=(n?e:[e]).map(e=>(s.size(e.fields)&&(e.fields=s.mapValues(e.fields,e=>(s.isArray(e.value)&&(e.value=e.value.filter(e=>!!e&&(!e.type||"entity"!==e.type||"guest"!==t||(void 0===e.published||e.published)))),e))),e)),n?e:e[0]}static _appendChildren(e,t){return e.map(e=>s.size(e.fields)?(e.fields=s.mapValues(e.fields,e=>(s.isArray(e.value)&&(e.value=e.value.filter(e=>!!e&&("entity"!==e.type||void 0!==t[e.id])),e.value=e.value.map(e=>("entity"===e.type&&(e=s.merge(e,t[e.id])),e=s.omitBy(e,(e,t)=>t.startsWith("_"))))),e)),e):e)}static _appendParents(e,t=null,n="guest"){let r={};return e.forEach(e=>{e.doc&&"entity"===e.value.type&&(r[e.id]={...e.doc,parents:[]})}),t&&(e.forEach(e=>{e.doc&&"parent"===e.value.type&&r[e.key].parents.push(f._filterEntityFields(e.doc,n))}),r=s.mapValues(r,e=>(e.parents=s.uniqBy(e.parents,e=>e._id),e))),e=(e=e.map(e=>(e.doc=r[e.id],e))).filter(e=>"entity"===e.value.type)}static _fileNames(e){const t=[];return e.forEach(e=>{s.forEach(e.fields,e=>{e.value&&e.value.file&&t.push(e.value.file.name)})}),s.uniq(t)}fieldValues(e,t){var n,s=this;return r.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,r.default.awrap(u.connect(s.config).viewWithList("entity","byField","search",{startkey:[e],endkey:[e,{}],group:!0,searchTerm:t}));case 2:return n=a.sent,a.abrupt("return",n);case 4:case"end":return a.stop()}}),null,null,null,Promise)}static _query(e,t,n=!1){if(t=t.replace(/(\s\s|\t|\r|\n)/g,""),n){const e=t.trim().split(/\[|\]/),n=`fields.${e[0]}.value[${e[1]||"*"}]`,r=/\]:/.test(t)?":"+t.split(/\]:/).slice(-1)[0].trim():"";t=`${n}${r}`}return i(t,{data:e,locals:{slice:(e,t,n)=>s.slice(e,t,n),sample:(e,t=1)=>s.sampleSize(e,t),group:(e,t=1/0)=>{const n=[];let r=[];return e.forEach(e=>{(!e.groupBefore||r.length>=t)&&(r=[]),r.push(e),(!e.groupAfter||r.length>=t)&&(r.ratio=0,r.forEach(e=>{r.ratio+=(e.thumbnail||e).ratio}),r.forEach(e=>{e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n},pick:(e,...t)=>s.map(e,e=>{const n={id:e.id||void 0};return(t=t.filter(e=>e)).forEach(t=>{const r=t.match(/([^\s]+)/g),a=r[0],i=r[r.length-1];s.set(n,i,s.get(e,a))}),n})},allowRegexp:!0})}static _queriesFromString(e){const t=(e=e.replace(/(\s\s|\t|\r|\n)/gm,"")).match(/\(([^)]+)\)/g);let n=(e=e.replace(/\(.*?\)/g,"()")).split(/,(?![^([]*[\])])/g);return n=n.map(e=>{const n=e.match(/\(\)/g);return n&&s.times(n.length,()=>{e=e.replace("()",t.splice(0,1))}),e.trim()}),n}_entitiesById(e=[],t={}){var n,a,i=this;return r.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=s.merge({parents:!1,role:"guest"},t),n={include_docs:!0},e.length&&(n.keys=e),o.next=5,r.default.awrap(u.connect(i.config).view("entity",t.parents?"byIdExtended":"byId",n));case 5:return(a=o.sent).rows=a.rows.map(e=>(e.doc=f._filterEntityFields(e.doc,t.role),e)),a.rows=f._appendParents(a.rows,t.parents,t.role),o.abrupt("return",a);case 9:case"end":return o.stop()}}),null,null,null,Promise)}static _childDepthLimit(e){let t=0;return s.isNumber(e)&&(t=e-1),s.isArray(e)&&(t=e.length-1),t}_getDocMap(e,t={},n={}){var a,i,o,c=this;return r.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(n._childDepth=n._childDepth||0,n.parents||n.children){u.next=3;break}return u.abrupt("return",t);case 3:if(a=[],i=[],e.forEach(e=>{const t=!!e.doc;let r=t?e.doc:e;r=f._filterEntityFields(r,n.role),n.children&&r.fields&&s.size(r.fields)&&(s.isArray(n.children)?f._queriesFromString(n.children[n._childDepth]).forEach(e=>{i=i.concat(s.flatten(f._query(r,e,!0).value).map(e=>e&&e.id))}):s.forEach(r.fields,e=>{s.isArray(e.value)&&(e.value=e.value.filter(e=>e),e.value.forEach(e=>{e.id&&i.push(e.id)}))})),a.push(t?e.id:r._id||r.id)}),!((a=(a=s.uniq(a)).filter(e=>!t[e])).length>0)){u.next=14;break}return u.next=12,r.default.awrap(c._entitiesById(a,n));case 12:u.sent.rows.map(e=>e.doc).forEach(e=>{t[e._id]=e});case 14:if(i=(i=s.uniq(i)).filter(e=>!t[e]),o=[],!(i.length>0)){u.next=22;break}return u.next=20,r.default.awrap(c._entitiesById(i,{...n,parents:!1}));case 20:(o=u.sent.rows.map(e=>e.doc)).forEach(e=>{t[e._id]=e});case 22:if(n.children&&n._childDepth!==f._childDepthLimit(n.children)){u.next=24;break}return u.abrupt("return",t);case 24:return u.next=26,r.default.awrap(c._getDocMap(o,t,{...n,parents:!1,_childDepth:n._childDepth+1}));case 26:return u.abrupt("return",u.sent);case 27:case"end":return u.stop()}}),null,null,null,Promise)}static _mergeDocs(e,t,n={children:!1,parents:!1}){return n._childDepth=n._childDepth||0,n.children&&n._childDepth-1===f._childDepthLimit(n.children)?e:e=e.map(e=>{const r=!!e.doc;let a=r?e.doc:e;if(t[e.id||e._id]&&(a=s.merge({},a,t[e.id||e._id])),n.children&&a.fields&&s.size(a.fields)){let e;s.isArray(n.children)&&(e={},f._queriesFromString(n.children[n._childDepth]).forEach(t=>{const n=t.split(/\[|\]/)[0];e[n]=t})),a.fields=s.mapValues(a.fields,(r,a)=>(s.isArray(r.value)&&(r.value=r.value.filter(e=>e),(!e||e&&e[a])&&(e&&e[a]&&(r.value=r.value.filter(e=>e.id&&t[e.id])),r.value=r.value.map(e=>(e&&e.id&&t[e.id]&&(e=s.merge(e,t[e.id]||{}),e=s.omitBy(e,(e,t)=>t.startsWith("_"))),e)),r.value=f._mergeDocs(r.value,t,{...n,_childDepth:n._childDepth+1}))),r)),a.fields=s.mapValues(a.fields,(t,n)=>(s.isArray(t.value)&&e&&e[n]&&(t.value=s.flatten(f._query(a,e[n],!0).value)),t))}return s.isArray(n.parents)&&a.parents&&(a.parents=s.flatten(f._query(a.parents,n.parents[0]).value)),r?e.doc=a:e=a,e})}_extendRowsOrDocs(e,t={}){var n,a=this;return r.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=s.merge({select:!1,children:!1,parents:!1,role:"guest"},t),i.next=3,r.default.awrap(a._getDocMap(e,{},t));case 3:return n=i.sent,e=f._mergeDocs(e,n,t),t.select&&(e=s.flatten(f._query(e,t.select).value)),n=null,i.abrupt("return",e);case 8:case"end":return i.stop()}}),null,null,null,Promise)}_removeChildren(e){return new a((t,n)=>{0!==e.length?(e=e.map(e=>e._id),u.connect(this.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(r=>{const a=s.uniqBy(r.rows,e=>e.doc._id).map(t=>(t.doc.fields=s.mapValues(t.doc.fields,t=>(s.isArray(t.value)&&(t.value=s.filter(t.value,t=>!("entity"===t.type&&-1!==e.indexOf(t.id)))),t)),t.doc));0!==a.length?l.chunkUpdate(this.config,a,1e3).then(t,n):t([])},n)):t([])})}_updateChildren(e){return new a((t,n)=>{if(0===e.length)return void t([]);const r={};e=e.map(e=>(r[e._id]=e,e._id)),u.connect(this.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(e=>{const a=e.rows.map(e=>{const t=e.doc;return s.forEach(t.fields,(e,n)=>{s.isArray(e.value)&&(t.fields[n].value=e.value.filter(e=>e).map(e=>("entity"===e.type&&r[e.id]&&(e.slug=r[e.id].slug,e.title=r[e.id].title,e.schema=r[e.id].schema,e.published=r[e.id].published,r[e.id].thumbnail?e.thumbnail=r[e.id].thumbnail:e.thumbnail=null),e)))}),t});l.chunkUpdate(this.config,a,1e3).then(t,n)},n)})}entityList(e=[],t={}){var n,a,i=this;return r.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=s.merge({select:!1,children:!1,parents:!1,role:"guest"},t),o.next=3,r.default.awrap(i._entitiesById(e,t));case 3:return n=o.sent,o.next=6,r.default.awrap(i._extendRowsOrDocs(n.rows,t));case 6:return a=o.sent,o.abrupt("return",a);case 8:case"end":return o.stop()}}),null,null,null,Promise)}_entitySearch(e,t={}){return new a((n,r)=>{e.limit=Math.min(e.limit||200,200),t.children&&(e.include_docs=!0),e.include_fields||(e.include_fields=[]),e.sort||delete e.sort,e.bookmark||delete e.bookmark,e.index||delete e.index,e.group_field||delete e.group_field,u.connect(this.config).search("entity",e.index||"all",e).then(e=>{if(e.groups){const s=[];return e.groups=e.groups.map(e=>(s.push(new a((n,r)=>{(t.children||t.parents)&&0!==e.total_rows?this._extendRowsOrDocs(e.hits,t).then(t=>{e.hits=t,n()},r):n()})),e)),void a.all(s).then(()=>{n(e)},r)}this._extendRowsOrDocs(e.rows,t).then(t=>{e.rows=t,n(e)},r)},r)})}entitySearch(e,t={}){return t=s.merge({children:!1,parents:!1,role:"guest"},t),new a((n,r)=>{const a=e.limit||25;if(a<=200)return void this._entitySearch(e,t).then(n,r);let i=[],o=[];(function c(u){const l=s.clone(e);u&&(l.bookmark=u),this._entitySearch(l,t).then(e=>{e.rows&&(i=i.concat(e.rows)),e.groups&&(o=o.concat(e.groups)),i.length<e.total_rows&&i.length<a?c.call(this,e.bookmark):(e.rows=i,e.groups=o,n(e))},r)}).call(this)})}entityFind(e,t={}){var n,a,i,o,l=this;return r.default.async((function(p){for(;;)switch(p.prev=p.next){case 0:return t=s.merge({children:!1,parents:!1,role:"guest"},t),p.prev=1,p.next=4,r.default.awrap(u.connect(l.config).find(e));case 4:n=p.sent,p.next=20;break;case 7:if(p.prev=7,p.t0=p.catch(1),"no_usable_index"!==p.t0.error){p.next=20;break}return a=new c(l.config),p.next=13,r.default.awrap(a.get());case 13:return i=p.sent,o=new d(l.config),p.next=17,r.default.awrap(o.updateEntityIndex(i.schemas));case 17:return p.next=19,r.default.awrap(u.connect(l.config).find(e));case 19:n=p.sent;case 20:if(!1!==t.children){p.next=22;break}return p.abrupt("return",n);case 22:if(!e.fields||-1!==e.fields.indexOf("_id")){p.next=24;break}throw Error("_id field required for `children`");case 24:return p.next=26,r.default.awrap(l._extendRowsOrDocs(n.docs,t));case 26:return n.docs=p.sent,p.abrupt("return",n);case 28:case"end":return p.stop()}}),null,null,[[1,7]],Promise)}entityRevisions(e){return new a((t,n)=>{u.connect(this.config).get(e,{revs_info:!0}).then(r=>{const a=[];r._revs_info.forEach(e=>{"available"===e.status&&a.push(e.rev)}),u.connect(this.config).get(e,{open_revs:JSON.stringify(a)}).then(e=>{const r=[],a=[];e.forEach(e=>{e.ok&&(r.push(e.ok),s.forEach(e.ok.fields,e=>{/entity/.test(e.type)&&s.forEach(e.value,e=>{e.id&&a.push(e.id)})}))}),u.connect(this.config).fetch({keys:s.uniq(a),include_docs:!0}).then(e=>{const n={};e.rows.forEach(e=>{try{n[e.doc._id]=e.doc}catch(e){console.error("Error: child no longer exists")}}),t(f._appendChildren(r,n))},n)},n)},n)})}entityCreate(e){return new a((t,n)=>{e.type="entity",u.connect(this.config).insert(e).then(n=>{e._id=n.id,e._rev=n.rev,t(e)},n)})}entityRead(e){return new a((t,n)=>{u.connect(this.config).get(e).then(t,n)})}entityUpdate(e,t){var n,a,i,c,d,p,f=this;return r.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return e=s.isArray(e)?e:[e],n={},a=e.map(e=>{let t;return s.isObject(e)&&(t=e._id,n[t]=e),s.isString(e)&&(t=e),t}),h.next=5,r.default.awrap(u.connect(f.config).fetch({keys:a,include_docs:!0}));case 5:if(i=h.sent,c=[],d=[],e=i.rows.map(e=>{const r=e.doc,i=n[r._id];let u=r;return i&&(delete i._rev,o(r,i).forEach(e=>{if(/published|slug|title|thumbnail/.test(e.path[0])&&-1===c.indexOf(i)&&-1!==a.indexOf(i._id)&&c.push(i),"fields"===e.path[0]&&"value"===e.path[2]){const t=r.fields[e.path[1]];/attachment|image|audio|video/.test(t.type)&&t.value&&d.push(t.value.file.name)}}),u=s.mergeWith({},r,i,(e,t)=>{if(s.isArray(e)&&s.isArray(t))return t})),t&&(u.trashed=!1),u}),d.length,!c.length){h.next=13;break}return h.next=13,r.default.awrap(f._updateChildren(c));case 13:return h.next=15,r.default.awrap(l.chunkUpdate(f.config,e,1e3));case 15:return p=h.sent,h.abrupt("return",p);case 17:case"end":return h.stop()}}),null,null,null,Promise)}entityDelete(e,t=!1){var n,a,i,o,c,d=this;return r.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:if("trashed"!==e){h.next=7;break}return t=!0,h.next=4,r.default.awrap(u.connect(d.config).view("entity","trashed",{include_docs:!0}));case 4:n=h.sent.rows,h.next=10;break;case 7:return h.next=9,r.default.awrap(u.connect(d.config).fetch({keys:s.isArray(e)?e:[e],include_docs:!0}));case 9:n=h.sent.rows;case 10:return n=(n=n.filter(e=>!e.value||!e.value.deleted)).map(e=>e.doc),h.next=14,r.default.awrap(d._removeChildren(n));case 14:if(!t){h.next=24;break}if(!(i=f._fileNames(n)).length){h.next=21;break}return o=new p(d.config),h.next=20,r.default.awrap(o.deleteFiles(i));case 20:a=h.sent;case 21:n=n.map(e=>({_id:e._id,_rev:e._rev,_deleted:!0})),h.next=25;break;case 24:n=n.map(e=>(e.trashed=!0,e));case 25:return h.next=27,r.default.awrap(l.chunkUpdate(d.config,n,1e3));case 27:return c=h.sent,h.abrupt("return",{entities:c,files:a});case 29:case"end":return h.stop()}}),null,null,null,Promise)}}e.exports=f},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(3),i=n(4),o=n(16);e.exports=class{constructor(e){return this.config=e,this}create(e){var t,n,s=this;return r.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=new a(s.config),i.next=3,r.default.awrap(t.get());case 3:return(n=i.sent).schemas.push(e),i.next=7,r.default.awrap(s.updateEntityIndex(n.schemas));case 7:return i.abrupt("return",t.set(n));case 8:case"end":return i.stop()}}),null,null,null,Promise)}read(e){var t,n,i,o=this;return r.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(o.config),c.next=3,r.default.awrap(t.get());case 3:if(n=c.sent,i=s.find(n.schemas,{slug:e})){c.next=7;break}throw Error("Schema not found: "+e);case 7:return c.abrupt("return",i);case 8:case"end":return c.stop()}}),null,null,null,Promise)}update(e){var t,n,i,o=this;return r.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(o.config),c.next=3,r.default.awrap(t.get());case 3:if(n=c.sent,-1!==(i=s.findIndex(n.schemas,{slug:e.slug}))){c.next=7;break}throw Error("Schema not found: "+e.slug);case 7:return n.schemas.splice(i,1,e),c.next=10,r.default.awrap(o.updateEntityIndex(n.schemas));case 10:return c.abrupt("return",t.set(n));case 11:case"end":return c.stop()}}),null,null,null,Promise)}delete(e){var t,n,i=this;return r.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=new a(i.config),o.next=3,r.default.awrap(t.get());case 3:return n=o.sent,e=s.isArray(e)?e:[e],n.schemas=n.schemas.filter(t=>-1===e.indexOf(t.slug)),n.schemas=n.schemas.map(t=>t.fields?(t.fields=t.fields.map(t=>t.settings?(t.settings.schemas&&(t.settings.schemas=t.settings.schemas.filter(t=>-1===e.indexOf(t))),t):t),t):t),o.next=9,r.default.awrap(i.updateEntityIndex(n.schemas));case 9:return o.abrupt("return",t.set(n));case 10:case"end":return o.stop()}}),null,null,null,Promise)}updateAll(e){var t,n,s=this;return r.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=new a(s.config),i.next=3,r.default.awrap(t.get());case 3:return(n=i.sent).schemas=e,i.abrupt("return",t.set(n));case 6:case"end":return i.stop()}}),null,null,null,Promise)}updateEntityIndex(e){var t,n,a,c=this;return r.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=[],e.forEach(e=>{t=t.concat(e.fields)}),t=s.uniqBy(t,"slug"),n={name:"entity",type:"text",ddoc:"entityIndex",index:{default_field:{enabled:!0,analyzer:"standard"},selector:{$and:[{type:"entity"}]},fields:[{name:"published",type:"boolean"},{name:"trashed",type:"boolean"},{name:"title",type:"string"},{name:"slug",type:"string"},{name:"schema",type:"string"},{name:"modifiedAt",type:"string"},{name:"publishedAt",type:"string"}]}},t.forEach(e=>{const t=o.field(e.type);/number|string|boolean/.test(t.dataType)&&n.index.fields.push({name:`fields.${e.slug}.value`,type:t.dataType}),/array/.test(t.dataType)&&n.index.fields.push({name:`fields.${e.slug}.value.[].slug`,type:"string"}),/taxonomy/.test(e.type)&&n.index.fields.push({name:`fields.${e.slug}.value.terms.[].slug`,type:"string"})}),u.next=7,r.default.awrap(i.connect(c.config).index(n));case 7:return a=u.sent,u.abrupt("return",a);case 9:case"end":return u.stop()}}),null,null,null,Promise)}}},function(e,t,n){"use strict";const r=n(0),s=[{type:"attachment",name:"Attachment",dataType:"object"},{type:"audio",name:"Audio",dataType:"object"},{type:"checkbox",name:"Checkbox",dataType:"boolean"},{type:"color",name:"Color",dataType:"string"},{type:"date",name:"Date",dataType:"number"},{type:"embedly",name:"Embedly",dataType:"object"},{type:"entity",name:"Entity",dataType:"array"},{type:"entityGrid",name:"Entity Grid",dataType:"array"},{type:"entityTile",name:"Entity Tile",dataType:"array"},{type:"image",name:"Image",dataType:"object"},{type:"keyValue",name:"Key Value",dataType:"object",toText(e){if(r.isArray(e))return e.map(e=>`${e.key}: ${e.value}`).join(", ")}},{type:"number",name:"Number",dataType:"number"},{type:"richText",name:"Rich Text",dataType:"object"},{type:"select",name:"Select",dataType:"array"},{type:"taxonomy",name:"Taxonomy",dataType:"object"},{type:"text",name:"Text",dataType:"string"},{type:"textArea",name:"Text Area",dataType:"string"},{type:"user",name:"User",dataType:"array"},{type:"video",name:"Video",dataType:"object"},{type:"vimeo",name:"Vimeo",dataType:"object"}];class a{static fields(){return s.map(e=>Object.freeze(e))}static field(e){return r.find(a.fields(),{type:e})}}e.exports=a},function(e,t){e.exports=require("request-promise")},function(e,t,n){"use strict";function r(){}r.defaultConfig=n(19),r.Assist=(...e)=>new(n(10))(...e),r.Auth=(...e)=>new(n(21))(...e),r.ClientConfig=(...e)=>new(n(3))(...e),r.Db=(...e)=>new(n(4))(...e),r.Email=(...e)=>new(n(28))(...e),r.Embedly=(...e)=>new(n(43))(...e),r.Entity=(...e)=>new(n(14))(...e),r.Fields=(...e)=>new(n(16))(...e),r.Helpers=(...e)=>new(n(6))(...e),r.Instagram=(...e)=>new(n(47))(...e),r.Jwt=(...e)=>new(n(13))(...e),r.Pdf=(...e)=>new(n(48))(...e),r.Roles=(...e)=>new(n(12))(...e),r.Schema=(...e)=>new(n(15))(...e),r.Settings=(...e)=>new(n(52))(...e),r.Shopify=(...e)=>new(n(53))(...e),r.Taxonomy=(...e)=>new(n(57))(...e),r.Tools=(...e)=>new(n(58))(...e),r.User=(...e)=>new(n(59))(...e),e.exports=r},function(e,t,n){"use strict";(function(t){const r=n(7),s={environment:process.env.ENVIRONMENT||"development",debug:process.env.DEBUG||!1,slug:process.env.SLUG,baseUrl:process.env.BASE_URL||"",db:{url:process.env.DB_URL,host:process.env.DB_HOST,name:process.env.DB_NAME,requestPlugin:process.env.DB_REQUEST_PLUGIN,meterType:process.env.DB_METER_TYPE},auth:{superUserId:process.env.AUTH_SUPER_USER_ID,tokenSecret:process.env.AUTH_TOKEN_SECRET||"change_this_secret"},auth0:{domain:process.env.AUTH0_DOMAIN,audience:process.env.AUTH0_AUDIENCE},dev:{userId:process.env.DEV_USER_ID||"dev",role:process.env.DEV_ROLE||"super"},cms:{title:process.env.CMS_TITLE,url:process.env.CMS_URL},assist:{url:process.env.ASSIST_URL,username:process.env.ASSIST_USERNAME,password:process.env.ASSIST_PASSWORD},mailgun:{apiKey:process.env.MAILGUN_API_KEY,domain:process.env.MAILGUN_DOMAIN},embedly:{apiKey:process.env.EMBEDLY_API_KEY},pdf:{templatesPath:r.resolve(t,"pdf")},email:{templatesPath:r.resolve(t,"email")},provider:{google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},instagram:{clientId:process.env.INSTAGRAM_CLIENT_ID,clientSecret:process.env.INSTAGRAM_CLIENT_SECRET},spotify:{clientId:process.env.SPOTIFY_CLIENT_ID,clientSecret:process.env.SPOTIFY_CLIENT_SECRET},twitter:{consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,accessTokenKey:process.env.TWITTER_ACCESS_TOKEN_KEY,accessTokenSecret:process.env.TWITTER_ACCESS_TOKEN_SECRET},vimeo:{clientId:process.env.VIMEO_CLIENT_ID,clientSecret:process.env.VIMEO_CLIENT_SECRET}}};e.exports=s}).call(this,"/")},function(e,t){e.exports=require("password-hash")},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(22),i=n(8),o=n(23),c=n(24),u=n(25).AuthenticationClient,l=n(3),d=n(4),p=n(13),f=n(27),h={google:"https://www.googleapis.com/oauth2/v4/token",instagram:"https://api.instagram.com/oauth/access_token",vimeo:"https://api.vimeo.com/oauth/access_token",spotify:"https://accounts.spotify.com/api/token"};e.exports=class{constructor(e){this.config=e,this.jwtCheck=o({secret:c.expressJwtSecret({cache:!0,rateLimit:!0,jwksRequestsPerMinute:5,jwksUri:"https://"+this.config.auth0.domain+"/.well-known/jwks.json"}),audience:this.config.auth0.audience,issuer:"https://"+this.config.auth0.domain+"/",algorithms:["RS256"]})}authUser(e,t){var n,a,i,o,c,l,h,m,g=this;return r.default.async((function(y){for(;;)switch(y.prev=y.next){case 0:return n=new u({domain:g.config.auth0.domain}),y.next=3,r.default.awrap(n.getProfile(t));case 3:if(a=y.sent,i=a.email,!(s.get(g.config,"auth.superUserId","").split(",").map(e=>e.trim()).indexOf(i)>-1)){y.next=10;break}o={active:!0,role:"super"},y.next=20;break;case 10:return y.prev=10,y.next=13,r.default.awrap(d.connect(g.config,e).get("config"));case 13:c=y.sent,o=s.find(c.users,e=>e.email.toLowerCase()===i.toLowerCase()),y.next=20;break;case 17:throw y.prev=17,y.t0=y.catch(10),new f(404,"Database not found: "+e);case 20:if(o){y.next=22;break}throw new f(401,"User not found: "+i);case 22:if(o.active){y.next=24;break}throw new f(401,"User not active: "+i);case 24:return l={slug:e,userId:i,active:o.active,role:o.role},h=new p(g.config),m=h.signToken(l,{}),y.abrupt("return",{...l,apiToken:m});case 28:case"end":return y.stop()}}),null,null,[[10,17]],Promise)}authProvider(e,t={},n=null,o=!1){var c,u,d,p,f,m,g,y=this;return r.default.async((function(x){for(;;)switch(x.prev=x.next){case 0:return c=new l(y.config),x.next=3,r.default.awrap(c.get());case 3:return u=x.sent,d=s.merge({},y.config.provider[e],t||{}),(p=n?s.get(u,["userSettings",n,"provider",e]):s.get(u,["provider",e]))||(p={}),f={grant_type:o?"refresh_token":"authorization_code",code:t&&t.code?t.code:void 0,client_id:d.clientId,client_secret:d.clientSecret,redirect_uri:d.redirectUri,refresh_token:o?p.refresh_token:void 0},m=h[e],x.prev=9,x.next=12,r.default.awrap(i.post(m,a.stringify(f)));case 12:g=x.sent.data,x.next=18;break;case 15:throw x.prev=15,x.t0=x.catch(9),Error(JSON.stringify(x.t0.response.data));case 18:if((p=s.merge({},p,g)).begins=Math.floor((new Date).getTime()/1e3),"google"!==e){x.next=30;break}return x.prev=21,x.next=24,r.default.awrap(i.get("https://www.googleapis.com/plus/v1/people/me?access_token="+p.access_token));case 24:p.user=x.sent.data,x.next=30;break;case 27:x.prev=27,x.t1=x.catch(21),console.error(x.t1);case 30:if("spotify"!==e){x.next=40;break}return x.prev=31,x.next=34,r.default.awrap(i.get("https://api.spotify.com/v1/me?access_token="+p.access_token));case 34:p.user=x.sent.data,x.next=40;break;case 37:x.prev=37,x.t2=x.catch(31),console.error(x.t2);case 40:return n?s.set(u,["userSettings",n,"provider",e],p):s.set(u,["provider",e],p),x.abrupt("return",c.set(u));case 42:case"end":return x.stop()}}),null,null,[[9,15],[21,27],[31,37]],Promise)}}},function(e,t){e.exports=require("querystring")},function(e,t){e.exports=require("express-jwt")},function(e,t){e.exports=require("jwks-rsa")},function(e,t){e.exports=require("auth0")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";e.exports=class{constructor(e,t){const n=Error(t);return n.code=e,n}}},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(7),a=n(5),i=a.promisifyAll(n(9)),o=n(0),c=n(29),u=a.promisifyAll(n(30)),l=n(31),d=n(32).Inky,p=n(33),f=n(34).registerComponent,h=n(35).registerDependencies,{McSection:m,McImage:g}=n(36),y=n(37),x=n(38),v=n(39),w=a.promisifyAll(n(40)),b=n(41),_=n(42),E=n(3),k=n(6);e.exports=class{constructor(e){this.config=e,this.inky=new d,f(m),f(g),h({"mc-section":["mj-column","mj-group","mj-raw"],"mj-column":["mc-image"],"mj-hero":["mc-image"]})}getTemplate(e,t={},n={}){var a,c,u,l,d,f,h,m,g,T,S,A=this;return r.default.async((function(P){for(;;)switch(P.prev=P.next){case 0:return a=o.merge({},{inlineStyles:!0,inky:!1,mjml:!1,skipValidation:!1},n),c=s.join(A.config.email.templatesPath,e),P.prev=2,P.next=5,r.default.awrap(i.statAsync(c));case 5:P.next=10;break;case 7:P.prev=7,P.t0=P.catch(2),c=s.resolve("../email",e);case 10:return P.next=12,r.default.awrap(i.readdirAsync(c));case 12:if(u=P.sent,l="html",o.find(u,e=>/^html\.mjml/.test(e))&&(l="html.mjml",a.mjml=!0),d="html",o.find(u,e=>/\.pug$/.test(e))&&(d="pug"),f="",!o.find(u,e=>/^style\.scss$/.test(e))){P.next=22;break}return P.next=21,r.default.awrap(w.renderAsync({file:s.join(c,"style.scss"),sourceMapContents:!a.inlineStyles,sourceMapEmbed:!a.inlineStyles}));case 21:f=P.sent.css.toString().replace(/"/g,"'");case 22:return h=new E(A.config),P.next=25,r.default.awrap(h.get());case 25:if(m=P.sent,g=new k(A.config),t=o.merge({},t,{config:o.merge({},o.pick(A.config,["cms"]),o.pick(m,["slug","client","assets"])),helpers:g,style:f,moment:x,countries:v,templateSlug:e}),"html"===d&&(T=i.readFileAsync(`${c}/${l}.${d}`)),"pug"===d&&(T=b.renderFile(`${c}/${l}.${d}`,t)),!a.mjml){P.next=35;break}if(!(S=p(T,{level:a.skipValidation?"skip":"soft"})).errors||!S.errors.length){P.next=34;break}throw Error(o.uniq(S.errors.map(e=>e.formattedMessage)).join("\n"));case 34:T=S.html;case 35:return a.inky&&(T=A.inky.releaseTheKraken(T)),a.inlineStyles&&(T=_(T,{preserveMediaQueries:!0,preserveFontFaces:!0,removeStyleTags:!1,removeLinkTags:!1,preserveImportant:!0,webResources:{links:!1,scripts:!1,images:!1}})),P.abrupt("return",{html:T,text:y.fromString(T)});case 38:case"end":return P.stop()}}),null,null,[[2,7]],Promise)}sendEmail(e,t,n={},r={}){return new a((s,a)=>{const i=c.createTransport(l({auth:{api_key:this.config.mailgun.apiKey,domain:this.config.mailgun.domain}}));this.getTemplate(t,o.merge({},e,n),r).then(t=>{e.html=t.html,e.text=t.text,i.sendMail(e,(t,n)=>{t?a(t):s({metadata:n,email:e})})},a)})}subscribe(e,t,n){return new a((r,s)=>{new E(this.config).get().then(i=>{if("createsend"===t){if(i.provider.createsend){const t=new u({apiKey:i.provider.createsend.clientApiKey});return void a.promisifyAll(t.subscribers).addSubscriberAsync(n,{EmailAddress:e.email,Name:e.name,Resubscribe:!0,RestartSubscriptionBasedAutoresponders:!0}).then(e=>{r("Email.subscribe(): "+e.emailAddress)}).catch(e=>{s(e.Message)})}s(Error("Subscriber list not configured"))}},s)})}}},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("createsend-node")},function(e,t){e.exports=require("nodemailer-mailgun-transport")},function(e,t){e.exports=require("inky")},function(e,t){e.exports=require("mjml")},function(e,t){e.exports=require("mjml-core")},function(e,t){e.exports=require("mjml-validator")},function(e,t){e.exports=require("mjml-mailchimp")},function(e,t){e.exports=require("html-to-text")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("i18n-iso-countries")},function(e,t){e.exports=require("node-sass")},function(e,t){e.exports=require("pug")},function(e,t){e.exports=require("juice")},function(e,t,n){"use strict";const r=n(0),s=n(5),a=n(44);e.exports=class{constructor(e){this.config=e}oembed(e){return new s((t,n)=>{const s=new a({key:this.config.embedly.apiKey}),i={urls:r.isArray(e)?e:[e],format:"json"};s.oembed(i,(e,r)=>{e?n(e):t(r)})})}}},function(e,t){e.exports=require("embedly")},function(e,t){e.exports=require("json-query")},function(e,t){e.exports=require("deep-diff")},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(17);e.exports=class{constructor(e){this.options=s.merge({},{client_id:null,access_token:null,version:"v1",host:"https://api.instagram.com"},e||{})}_request(e,t,n){var i,o,c=this;return r.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return(i={method:e,url:[c.options.host,c.options.version,t].join("/"),qs:{access_token:n.access_token||c.options.access_token,client_id:n.client_id||c.options.client_id}}).qs=s.extend({},i.qs,n),u.next=4,r.default.awrap(a(i));case 4:return o=u.sent,u.abrupt("return",JSON.parse(o));case 6:case"end":return u.stop()}}),null,null,null,Promise)}get(e,t){return this._request("GET",e,t)}}},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(9),a=n(7),i=n(0),o=n(49),c=n(17),u=n(50),l=n(14),d=n(3);e.exports=class{constructor(e){this.config=e}getTemplates(){var e,t=this;return r.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return e={},s.next=3,r.default.awrap(u(t.config.pdf.templatesPath));case 3:return s.sent.forEach(r=>{if(!/\.js$/.test(r))return;const s=r.replace(t.config.pdf.templatesPath+"/","").replace(".js","");e[s]=n(51)(r)}),s.abrupt("return",e);case 6:case"end":return s.stop()}}),null,null,null,Promise)}getPayload(e,t,n){var i,c,u,d,p=this;return r.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return i=o(s.readFileSync(a.join(p.config.pdf.templatesPath,e+".js"),"utf-8"),e+".js",{},!0),c=new l(p.config),f.next=4,r.default.awrap(c.entityList([t],{children:2,role:n}));case 4:if(0!==(u=f.sent.map(e=>e.doc)).length){f.next=7;break}throw Error("Entity not found");case 7:return d=i(l.flattenValues(u)[0]),f.abrupt("return",d);case 9:case"end":return f.stop()}}),null,null,null,Promise)}getPdf(e){var t,n,s,a,o,u=this;return r.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return t=new d(u.config),l.next=3,r.default.awrap(t.get());case 3:return n=l.sent,s=i.get(n,"assets.slug",u.config.slug),a=`${u.config.assist.url}/${s}/pdf/download`,e="object"==typeof e?JSON.stringify(e).replace(/'/gi,"â€™"):e,l.next=9,r.default.awrap(c({method:"POST",uri:a,encoding:null,form:{payload:e}}));case 9:return o=l.sent,l.abrupt("return",o);case 11:case"end":return l.stop()}}),null,null,null,Promise)}}},function(e,t){e.exports=require("eval")},function(e,t){e.exports=require("recursive-readdir")},function(e,t){function n(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=51},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(3);e.exports=class{constructor(e){return this.config=e,this}update(e){var t,n,i=this;return r.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=new a(i.config),o.next=3,r.default.awrap(t.get());case 3:return(n=o.sent).client=s.merge({},n.client,e),o.abrupt("return",t.set(n));case 6:case"end":return o.stop()}}),null,null,null,Promise)}}},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(8),a=n(54),i=n(55),o=n(56),c=n(3);e.exports=class{constructor(e){this.config=e}getCatalog({shopLink:e,productLinkTemplate:t}){var n,u,l,d,p,f,h=this;return r.default.async((function(m){for(;;)switch(m.prev=m.next){case 0:return n=new c(h.config),m.next=3,r.default.awrap(n.get());case 3:return u=m.sent,m.next=6,r.default.awrap(s({url:`https://${u.provider.shopify.domain}.myshopify.com/api/graphql`,method:"post",headers:{"X-Shopify-Storefront-Access-Token":u.provider.shopify.storefrontAccessToken},data:{query:"\n          query {\n            shop {\n              name\n              primaryDomain {\n                url\n              }\n              description\n              products(first: 250) {\n                edges {\n                  node {\n                    id\n                    handle\n                    title\n                    description\n                    onlineStoreUrl\n                    images(first: 1) {\n                      edges {\n                        node {\n                          originalSrc\n                          transformedSrc\n                        }\n                      }\n                    }\n                    productType\n                    vendor\n                    availableForSale\n                    priceRange {\n                      minVariantPrice {\n                        amount\n                        currencyCode\n                      }\n                      maxVariantPrice {\n                        amount\n                        currencyCode\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        "}}));case 6:return l=m.sent.data.data,d=i.compile(t),p=l.shop.products.edges.map(e=>({"g:id":e.node.handle,"g:title":a.encode(e.node.title),"g:description":a.encode(e.node.description),"g:link":d({handle:e.node.handle}),"g:image_link":e.node.images.edges[0].node.originalSrc,"g:brand":e.node.vendor,"g:condition":"new","g:availability":e.node.availableForSale?"in stock":"out of stock","g:price":`${e.node.priceRange.minVariantPrice.amount} ${e.node.priceRange.minVariantPrice.currencyCode}`})),f=[{name:"title",text:l.shop.name},{name:"link",text:e},{name:"description",text:l.shop.description}],p.forEach(e=>{f.push({name:"item",children:e})}),m.abrupt("return",`<?xml version="1.0"?>\n    <rss xmlns:g="http://base.google.com/ns/1.0" version="2.0">\n      ${o({channel:f})}\n    </rss>`);case 12:case"end":return m.stop()}}),null,null,null,Promise)}}},function(e,t){e.exports=require("he")},function(e,t){e.exports=require("handlebars")},function(e,t){e.exports=require("jsontoxml")},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(4),i=n(3);e.exports=class{constructor(e){this.config=e}create(e){var t,n,s=this;return r.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=new i(s.config),a.next=3,r.default.awrap(t.get());case 3:return(n=a.sent).taxonomies.push(e),a.abrupt("return",t.set(n));case 6:case"end":return a.stop()}}),null,null,null,Promise)}read(e){var t,n,a,o=this;return r.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new i(o.config),c.next=3,r.default.awrap(t.get());case 3:if(n=c.sent,a=s.find(n.taxonomies,{slug:e})){c.next=7;break}throw Error("Taxonomy not found: "+e);case 7:return c.abrupt("return",a);case 8:case"end":return c.stop()}}),null,null,null,Promise)}update(e){var t,n,a,o=this;return r.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new i(o.config),c.next=3,r.default.awrap(t.get());case 3:if(n=c.sent,-1!==(a=s.findIndex(n.taxonomies,{slug:e.slug}))){c.next=7;break}throw Error("Taxonomy not found: "+e.slug);case 7:return n.taxonomies.splice(a,1,e),c.abrupt("return",t.set(n));case 9:case"end":return c.stop()}}),null,null,null,Promise)}delete(e){var t,n,a=this;return r.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=new i(a.config),o.next=3,r.default.awrap(t.get());case 3:return n=o.sent,e=s.isArray(e)?e:[e],n.taxonomies=n.taxonomies.filter(t=>-1===e.indexOf(t.slug)),o.abrupt("return",t.set(n));case 7:case"end":return o.stop()}}),null,null,null,Promise)}entitiesByTerm(e){var t,n,i,o,c=this;return r.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=a.connect(c.config),u.next=3,r.default.awrap(t.view("entity","byTaxonomyTerm",{keys:[e.id],group:!0}));case 3:if(n=u.sent.rows.map(e=>e.value)[0]){u.next=6;break}return u.abrupt("return",[]);case 6:return i=[],s.forEach(n,e=>{i=i.concat(e)}),i=s.uniq(i),u.next=11,r.default.awrap(t.fetch({keys:i,include_docs:!0}));case 11:return o=u.sent.rows.filter(e=>e.doc).map(e=>e.doc),u.abrupt("return",o);case 13:case"end":return u.stop()}}),null,null,null,Promise)}createTerm(e,t){var n,s=this;return r.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,r.default.awrap(s.read(e));case 2:return(n=a.sent).terms.push(t),a.abrupt("return",s.update(n));case 5:case"end":return a.stop()}}),null,null,null,Promise)}updateTerm(e){var t,n=this;return r.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,r.default.awrap(n.entitiesByTerm(e));case 2:return t=(t=i.sent).map(t=>(t.fields=s.mapValues(t.fields,t=>("taxonomy"===t.type&&t.value&&(t.value.terms||(t.value.terms=[]),t.value.terms=t.value.terms.map(t=>(t.id===e.id&&(t.title=e.title,t.slug=e.slug),t.parents||(t.parents=[]),t.parents=t.parents.map(t=>(t.id===e.id&&(t.title=e.title,t.slug=e.slug),t)),t))),t)),t)),i.abrupt("return",a.connect(n.config).bulk({docs:t}));case 5:case"end":return i.stop()}}),null,null,null,Promise)}deleteTerm(e){var t,n=this;return r.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,r.default.awrap(n.entitiesByTerm(e));case 2:return t=(t=i.sent).map(t=>(t.fields=s.mapValues(t.fields,t=>("taxonomy"===t.type&&t.value&&(t.value.terms||(t.value.terms=[]),t.value.terms=t.value.terms.filter(t=>t.id!==e.id&&!(t.parents||[]).filter(t=>t.id===e.id).length)),t)),t)),i.abrupt("return",a.connect(n.config).bulk({docs:t}));case 5:case"end":return i.stop()}}),null,null,null,Promise)}}},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(5).promisifyAll(n(9)),a=n(11),i=n(4);e.exports=class{constructor(e){this.config=e}getDb(){var e,t=this;return r.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,r.default.awrap(i.connect(t.config).fetch({include_docs:!0}));case 2:return e=n.sent,n.abrupt("return",e);case 4:case"end":return n.stop()}}),null,null,null,Promise)}getChanges(){var e,t=this;return r.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,r.default.awrap(i.connect(t.config).changes({limit:50,include_docs:!0,filter:"entity/changes"}));case 2:return e=n.sent,n.abrupt("return",e);case 4:case"end":return n.stop()}}),null,null,null,Promise)}importDb(e){var t,n,o,c,u,l=this;return r.default.async((function(d){for(;;)switch(d.prev=d.next){case 0:return t=l.config.db.name,d.next=3,r.default.awrap(s.readFileAsync(e.path));case 3:return n=d.sent,o=JSON.parse(n).rows.map(e=>{const{doc:t}=e;return delete t._rev,t}),d.next=7,r.default.awrap(s.unlinkAsync(e.path));case 7:return c=new a({url:l.config.db.url,plugins:["promises","retry"]}).db,d.prev=8,d.next=11,r.default.awrap(c.destroy(t));case 11:d.next=15;break;case 13:d.prev=13,d.t0=d.catch(8);case 15:return d.next=17,r.default.awrap(c.create(t));case 17:return d.next=19,r.default.awrap(i.connect(l.config,t).bulk({docs:o}));case 19:return u=d.sent,d.abrupt("return",u);case 21:case"end":return d.stop()}}),null,null,[[8,13]],Promise)}}},function(e,t,n){"use strict";var r=n(1)(n(2));const s=n(0),a=n(3);e.exports=class{constructor(e){return this.config=e,this}create(e){var t,n,s=this;return r.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=new a(s.config),i.next=3,r.default.awrap(t.get());case 3:return n=i.sent,e.id=e.id.toLowerCase(),e.email=e.email.toLowerCase(),n.users.push(e),i.abrupt("return",t.set(n));case 8:case"end":return i.stop()}}),null,null,null,Promise)}read(e){var t,n,i,o=this;return r.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(o.config),c.next=3,r.default.awrap(t.get());case 3:if(n=c.sent,i=s.find(n.users,{id:e})){c.next=7;break}throw Error("User not found: "+e);case 7:return c.abrupt("return",i);case 8:case"end":return c.stop()}}),null,null,null,Promise)}update(e){var t,n,i,o=this;return r.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(o.config),c.next=3,r.default.awrap(t.get());case 3:if(n=c.sent,-1!==(i=s.findIndex(n.users,{id:e.id}))){c.next=7;break}throw Error("User not found: "+e.id);case 7:return e.email=e.email.toLowerCase(),n.users.splice(i,1,e),c.abrupt("return",t.set(n));case 10:case"end":return c.stop()}}),null,null,null,Promise)}delete(e){var t,n,i=this;return r.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=new a(i.config),o.next=3,r.default.awrap(t.get());case 3:return n=o.sent,e=s.isArray(e)?e:[e],n.users=n.users.filter(t=>-1===e.indexOf(t.id)),o.abrupt("return",t.set(n));case 7:case"end":return o.stop()}}),null,null,null,Promise)}}}])}));
//# sourceMappingURL=api.js.map