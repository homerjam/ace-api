{"version":3,"sources":["webpack://AceApi/webpack/universalModuleDefinition","webpack://AceApi/webpack/bootstrap","webpack://AceApi/external \"babel-runtime/helpers/createClass\"","webpack://AceApi/external \"babel-runtime/helpers/classCallCheck\"","webpack://AceApi/external \"lodash\"","webpack://AceApi/./lib/client-config.js","webpack://AceApi/external \"babel-runtime/helpers/asyncToGenerator\"","webpack://AceApi/external \"babel-runtime/regenerator\"","webpack://AceApi/./lib/db.js","webpack://AceApi/external \"bluebird\"","webpack://AceApi/./lib/helpers.js","webpack://AceApi/external \"babel-runtime/core-js/json/stringify\"","webpack://AceApi/external \"path\"","webpack://AceApi/./lib sync","webpack://AceApi/external \"request-promise\"","webpack://AceApi/./lib/fields.js","webpack://AceApi/./lib/schema.js","webpack://AceApi/./lib/entity.js","webpack://AceApi/external \"fs\"","webpack://AceApi/./lib/email.js","webpack://AceApi/external \"babel-runtime/core-js/object/freeze\"","webpack://AceApi/./lib/roles.js","webpack://AceApi/external \"@cloudant/cloudant\"","webpack://AceApi/external \"axios\"","webpack://AceApi/./lib/assist.js","webpack://AceApi/./lib/user.js","webpack://AceApi/./lib/tools.js","webpack://AceApi/./lib/taxonomy.js","webpack://AceApi/external \"hashids\"","webpack://AceApi/external \"stripe\"","webpack://AceApi/./lib/stripe.js","webpack://AceApi/external \"shippo\"","webpack://AceApi/./lib/shippo.js","webpack://AceApi/./lib/settings.js","webpack://AceApi/external \"recursive-readdir\"","webpack://AceApi/external \"babel-runtime/helpers/typeof\"","webpack://AceApi/./lib/pdf.js","webpack://AceApi/external \"jsonwebtoken\"","webpack://AceApi/./lib/jwt.js","webpack://AceApi/./lib/instagram.js","webpack://AceApi/external \"deep-diff\"","webpack://AceApi/external \"json-query\"","webpack://AceApi/external \"embedly\"","webpack://AceApi/./lib/embedly.js","webpack://AceApi/external \"node-sass\"","webpack://AceApi/external \"i18n-iso-countries\"","webpack://AceApi/external \"moment\"","webpack://AceApi/external \"html-to-text\"","webpack://AceApi/external \"mjml-mailchimp\"","webpack://AceApi/external \"mjml-validator\"","webpack://AceApi/external \"mjml-core\"","webpack://AceApi/external \"mjml\"","webpack://AceApi/external \"inky\"","webpack://AceApi/external \"email-templates\"","webpack://AceApi/external \"nodemailer-mailgun-transport\"","webpack://AceApi/external \"createsend-node\"","webpack://AceApi/external \"nodemailer\"","webpack://AceApi/./lib/ecommerce.js","webpack://AceApi/external \"querystring\"","webpack://AceApi/./lib/auth.js","webpack://AceApi/external \"password-hash\"","webpack://AceApi/./config.default.js","webpack://AceApi/./index.js"],"names":["root","factory","exports","module","define","amd","global","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","configurable","enumerable","get","r","value","n","__esModule","object","property","prototype","hasOwnProperty","p","w","s","require","_","Db","Helpers","DEFAULT_CLIENT_CONFIG","_id","client","schemas","taxonomies","users","roles","ClientConfig","config","_classCallCheck3","default","this","clientConfig","connect","merge","slug","createOrUpdate","Cloudant","dbName","url","db","maxAttempt","plugins","retry","retryDelayMultiplier","retryInitialDelayMsecs","use","Promise","assistUrl","assist","thumbnail","settings","cropSlug","cropDefault","settingsArray","split","forEach","setting","crop","crops","x","y","x2","y2","g","key","push","join","settingsString","test","thumbnailType","ext","thumbnailUrl","replace","doc","resolve","reject","insert","then","response","id","_rev","rev","error","statusCode","docs","chunkSize","arguments","length","undefined","promises","chunk","bulk","all","entities","groupSize","Infinity","grouped","group","entity","groupBefore","groupAfter","ratio","groupRatio","_stringify2","Date","array","replacementObject","map","webpackEmptyContext","req","e","Error","code","keys","fields","type","dataType","Fields","field","_freeze2","find","Schema","schema","cc","updateEntityIndex","set","schemaSlug","index","findIndex","splice","schemaSlugs","isArray","filter","indexOf","concat","uniqBy","ddoc","default_field","enabled","analyzer","selector","$and","fieldRef","result","jsonQuery","diff","Assist","Entity","flattenValues","fieldSlug","searchTerm","viewWithList","startkey","endkey","ids","parents","role","query","include_docs","view","_appendParents","children","docMap","childDepth","rowOrDoc","isRow","size","flatten","_query","obj","uniq","_entitiesById","row","_docs","rows","_childDepthLimit","_getDocMap","_mergeDocs","_this","updatedEntities","mapValues","remove","chunkUpdate","_this2","entityMap","title","published","total_rows","_extendDocs","_this3","limit","Math","min","sort","isString","include_fields","bookmark","group_field","search","groups","hits","_this4","_entitySearch","__entitySearch","_this5","clone","_context6","t0","entityId","_this6","revs_info","revisionIds","_revs_info","revision","status","open_revs","revisions","childrenIds","ok","fetch","childrenMap","console","_appendChildren","_this7","_this8","restore","_this9","entityIds","entityOrEntityId","isObject","oldEntity","newEntity","path","mergeWith","a","b","trashed","_updateChildren","forever","filesResult","deleted","_removeChildren","fileNames","_fileNames","deleteFiles","_deleted","entitiesResult","files","omitBy","startsWith","filterEntityFields","file","forceId","queryParts","trim","modifier","slice","data","locals","input","start","end","sample","sampleSize","pick","_len","paths","Array","_key","copy","allowRegexp","merging","isNumber","queries","queryField","fs","nodemailer","Createsend","promisifyAll","nodemailerMailgunTransport","EmailTemplate","Inky","mjml2html","registerComponent","registerDependencies","McSection","McImage","htmlToText","moment","countries","sass","Email","inky","mc-section","mj-column","mj-hero","templateSlug","templateData","templateOptions","options","inlineStyles","mjml","skipValidation","templatePath","email","templatesPath","existsSync","templateFiles","readdirSync","htmlPath","fileName","extension","style","renderSync","sourceMapContents","sourceMapEmbed","css","toString","emailTemplate","views","juice","juiceResources","preserveMediaQueries","preserveFontFaces","removeStyleTags","removeLinkTags","preserveImportant","webResources","links","scripts","images","transport","jsonTransport","helpers","render","html","convertMjmlResult","level","errors","releaseTheKraken","text","fromString","emailOptions","nodemailerMailgun","createTransport","auth","api_key","mailgun","apiKey","domain","getTemplate","sendMail","metadata","details","provider","listId","createsend","cs","clientApiKey","subscribers","addSubscriberAsync","EmailAddress","Name","Resubscribe","RestartSubscriptionBasedAutoresponders","emailAddress","catch","Message","permissions","entityGrid","entityCreate","entityRead","entityUpdate","entityDelete","taxonomyCreate","taxonomyRead","taxonomyUpdate","taxonomyDelete","fileCreate","fileRead","fileUpdate","fileDelete","user","userSettings","tools","ecommerce","Roles","axios","passwordHash","assetsSlug","post","username","password","generate","User","userId","Tools","changes","dbBackupFile","readFileAsync","fileConents","JSON","parse","unlinkAsync","cloudant","destroy","create","Taxonomy","taxonomy","taxonomySlug","term","entityGroups","read","terms","update","entitiesByTerm","_term","parent","Stripe","Hashids","StripeClass","stripe","hashids","_context","clientStripeAccountId","stripe_user_id","t1","assets","token","order","getSettings","subscribe","customerDetails","log","findOrCreateCustomer","customer","createOrder","updateOrCreateStripeCustomer","stripeCustomer","updateCustomer","createCharge","updatedOrder","sendReceipt","orderReceipt","messages","sendNotification","orderNotification","updateOrder","finalOrder","accounts","retrieve","amount","refunds","refund_application_fee","charge","stripe_account","refund","charges","amountRefunded","amount_refunded","body","now","newCustomer","createdAt","modifiedAt","phone","billingAddress","shippingAddress","orders","source","description","customer_id","customers","param","items","item","price","quantity","newOrder","orderId","encode","getTime","shippingMethod","Number","subtotal","tax","rate","includedInPrice","total","show","discount","currency","iso","toLowerCase","capture","order_id","statement_descriptor","kebabCase","storeName","toUpperCase","application_fee","ceil","paymentGateway","livemode","_this10","from","emailSenderName","emailSenderAddress","to","subject","assetSlug","sendEmail","_this11","shippo","Shippo","address","parcel","addressFrom","object_purpose","zip","fromZip","country","fromCountry","addressTo","distance_unit","mass_unit","shipment","address_from","address_to","ratesReady","attempts","object_status","object_id","val","rates","Settings","request","readdir","Pdf","templates","pdf","templateId","template","entityList","payload","assistPdfUrl","_typeof3","method","uri","encoding","form","jwt","Jwt","sign","tokenSecret","verify","client_id","access_token","version","host","endpoint","requestOptions","qs","extend","_request","EmbedlyApi","Embedly","urls","embedly","opts","format","oembed","Ecommerce","dateStart","dateEnd","message","querystring","providerTokenUri","google","instagram","vimeo","spotify","Auth","superUserId","superUser","active","params","refresh","providerConfig","providerClientConfig","grant_type","clientId","client_secret","clientSecret","redirect_uri","redirectUri","refresh_token","providerAuth","stringify","_context2","begins","floor","t2","environment","process","env","ENVIRONMENT","debug","DEBUG","SLUG","baseUrl","BASE_URL","DB_URL","DB_HOST","DB_NAME","requestPlugin","DB_REQUEST_PLUGIN","meterType","DB_METER_TYPE","AUTH_SUPER_USER_ID","AUTH_TOKEN_SECRET","dev","DEV_USER_ID","DEV_ROLE","cms","CMS_TITLE","CMS_URL","ASSIST_URL","ASSIST_USERNAME","ASSIST_PASSWORD","__dirname","INSTAGRAM_CLIENT_ID","INSTAGRAM_CLIENT_SECRET","twitter","consumerKey","TWITTER_CONSUMER_KEY","consumerSecret","TWITTER_CONSUMER_SECRET","accessTokenKey","TWITTER_ACCESS_TOKEN_KEY","accessTokenSecret","TWITTER_ACCESS_TOKEN_SECRET","GOOGLE_CLIENT_ID","GOOGLE_CLIENT_SECRET","MAILGUN_API_KEY","MAILGUN_DOMAIN","EMBEDLY_API_KEY","aws","iamAccessKeyId","AWS_IAM_ACCESS_KEY_ID","iamAccessKeySecret","AWS_IAM_ACCESS_KEY_SECRET","s3","bucket","AWS_S3_BUCKET","SHIPPO_TOKEN","SHIPPO_FROM_ZIP","SHIPPO_FROM_COUNTRY","SPOTIFY_CLIENT_ID","SPOTIFY_CLIENT_SECRET","STRIPE_CLIENT_ID","STRIPE_CLIENT_SECRET","STRIPE_API_KEY","VIMEO_CLIENT_ID","VIMEO_CLIENT_SECRET","zencoder","ZENCODER_API_KEY","ZENCODER_S3_BUCKET","credentials","ZENCODER_S3_CREDENTIALS","Api","defaultConfig","args","Function","bind","apply","_len2","_key2","_len3","_key3","_len4","_key4","_len5","_key5","_len6","_key6","_len7","_key7","_len8","_key8","_len9","_key9","_len10","_key10","Instagram","_len11","_key11","_len12","_key12","_len13","_key13","_len14","_key14","_len15","_key15","_len16","_key16","_len17","_key17","_len18","_key18","_len19","_key19","_len20","_key20","_len21","_key21"],"mappings":"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","file":"api.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"AceApi\"] = factory();\n\telse\n\t\troot[\"AceApi\"] = factory();\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading wasm modules\n \tvar installedWasmModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// object with all compiled WebAssembly.Modules\n \t__webpack_require__.w = {};\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 60);\n","module.exports = require(\"babel-runtime/helpers/createClass\");","module.exports = require(\"babel-runtime/helpers/classCallCheck\");","module.exports = require(\"lodash\");","const _ = require('lodash');\nconst Db = require('./db');\nconst Helpers = require('./helpers');\nconst Roles = require('./roles');\n\nconst roles = new Roles();\n\nconst DEFAULT_CLIENT_CONFIG = {\n  _id: 'config',\n  client: {},\n  schemas: [],\n  taxonomies: [],\n  users: [],\n  roles: roles.roles(),\n};\n\nclass ClientConfig {\n  constructor(config) {\n    this.config = config;\n  }\n\n  async get() {\n    let clientConfig = DEFAULT_CLIENT_CONFIG;\n\n    try {\n      clientConfig = await Db.connect(this.config).get('config');\n\n      clientConfig = _.merge({}, DEFAULT_CLIENT_CONFIG, clientConfig);\n    } catch (error) {\n      //\n    }\n\n    clientConfig.slug = this.config.slug;\n\n    return clientConfig;\n  }\n\n  async set(clientConfig) {\n    clientConfig._id = 'config';\n\n    delete clientConfig.roles;\n\n    clientConfig = await Helpers.createOrUpdate(this.config, clientConfig);\n\n    clientConfig = _.merge({}, DEFAULT_CLIENT_CONFIG, clientConfig);\n\n    return clientConfig;\n  }\n}\n\n\nmodule.exports = ClientConfig;\n","module.exports = require(\"babel-runtime/helpers/asyncToGenerator\");","module.exports = require(\"babel-runtime/regenerator\");","const Cloudant = require('@cloudant/cloudant');\n\nclass Db {\n  constructor (config, dbName) {\n    this.config = config;\n\n    return Db.connect(config, dbName);\n  }\n\n  static connect (config, dbName) {\n    const cloudant = new Cloudant({\n      url: config.db.url,\n      maxAttempt: 5,\n      plugins: [\n        'promises',\n        {\n          retry: {\n            retryDelayMultiplier: 2,\n            retryInitialDelayMsecs: 500,\n          },\n        },\n      ],\n    });\n\n    return cloudant.db.use(dbName || config.db.name);\n  }\n}\n\nmodule.exports = Db;\n","module.exports = require(\"bluebird\");","const _ = require('lodash');\nconst Promise = require('bluebird');\nconst Db = require('./db');\n\nclass Helpers {\n  constructor(config) {\n    this.config = config;\n    this.assistUrl = config.assist.url;\n    this.slug = config.slug;\n  }\n\n  static createOrUpdate (config, doc) {\n    return new Promise((resolve, reject) => {\n      Db.connect(config).insert(doc)\n        .then((response) => {\n          doc._id = response.id;\n          doc._rev = response.rev;\n          resolve(doc);\n        }, (error) => {\n          if (error.statusCode !== 409) {\n            reject(error);\n            return;\n          }\n\n          Db.connect(config).get(doc._id)\n            .then((response) => {\n              doc._rev = response._rev;\n\n              Db.connect(config).insert(doc)\n                .then((response) => {\n                  doc._rev = response.rev;\n                  resolve(doc);\n                }, reject);\n            }, reject);\n        });\n    });\n  }\n\n  static chunkUpdate (config, docs, chunkSize = 1000) {\n    return new Promise((resolve, reject) => {\n      const chunks = _.chunk(docs, chunkSize);\n      const promises = [];\n\n      chunks.forEach((chunk) => {\n        promises.push(new Promise((resolve, reject) => {\n          Db.connect(config).bulk({\n            docs: chunk,\n          }).then(resolve, reject);\n        }));\n      });\n\n      Promise.all(promises).then(resolve, reject);\n    });\n  }\n\n  static groupEntities (entities, groupSize = Infinity) {\n    const grouped = [];\n\n    let group = {\n      entities: [],\n    };\n\n    entities.forEach((entity) => {\n      if (!entity.groupBefore || group.entities.length >= groupSize) {\n        group = {\n          entities: [],\n        };\n      }\n\n      group.entities.push(entity);\n\n      if (!entity.groupAfter || group.entities.length >= groupSize) {\n        group.ratio = 0;\n\n        group.entities.forEach((entity) => {\n          group.ratio += (entity.thumbnail || entity).ratio;\n        });\n\n        group.entities.forEach((entity) => {\n          entity.groupRatio = (entity.thumbnail || entity).ratio / group.ratio;\n        });\n\n        grouped.push(group);\n      }\n    });\n\n    return grouped;\n  }\n\n  static now () {\n    return JSON.stringify(new Date()).replace(/\"/g, '');\n  }\n\n  static replace (array, replacementObject, key) {\n    return array.map((object) => {\n      if (object[key] === replacementObject[key]) {\n        return replacementObject;\n      }\n      return object;\n    });\n  }\n\n  thumbnailSrc (thumbnail, settings, cropSlug, cropDefault) {\n    if (!thumbnail) {\n      return '';\n    }\n\n    let settingsArray;\n\n    if (typeof settings === 'string') {\n      settingsArray = settings.split(/,|;/);\n\n      settings = {};\n\n      settingsArray.forEach((setting) => {\n        setting = setting.split(/_|:/);\n\n        settings[setting[0]] = setting[1];\n      });\n    }\n\n    const crop = thumbnail.crops ? thumbnail.crops[cropSlug] : false;\n\n    if (crop) {\n      settings.x = crop[0];\n      settings.y = crop[1];\n      settings.x2 = crop[2];\n      settings.y2 = crop[3];\n    } else if (cropDefault) {\n      settings.g = cropDefault;\n    }\n\n    settingsArray = [];\n\n    _.forEach(settings, (value, key) => {\n      settingsArray.push([key, value].join(':'));\n    });\n\n    const settingsString = settingsArray.join(';');\n\n    if (/(image)/.test(thumbnail.thumbnailType)) {\n      if (thumbnail.ext === 'svg') {\n        return [this.assistUrl, this.slug, thumbnail.name + thumbnail.ext].join('/');\n      }\n\n      return [this.assistUrl, this.slug, 'transform', settingsString, thumbnail.name + thumbnail.ext].join('/');\n    }\n\n    if (/(video)/.test(thumbnail.thumbnailType)) {\n      return [this.assistUrl, this.slug, 'transform', settingsString, thumbnail.name, 'thumb.jpg'].join('/');\n    }\n\n    if (/(oembed|proxy)/.test(thumbnail.thumbnailType)) {\n      const thumbnailUrl = thumbnail.thumbnailUrl.replace(/https?:\\/\\//, '');\n\n      return [this.assistUrl, this.slug, 'proxy', 'transform', settingsString, thumbnailUrl].join('/');\n    }\n\n    return '';\n  }\n\n}\n\nmodule.exports = Helpers;\n","module.exports = require(\"babel-runtime/core-js/json/stringify\");","module.exports = require(\"path\");","function webpackEmptyContext(req) {\n\tvar e = new Error('Cannot find module \"' + req + '\".');\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 11;","module.exports = require(\"request-promise\");","const _ = require('lodash');\n\nconst fields = [\n  {\n    type: 'attachment',\n    name: 'Attachment',\n    dataType: null,\n  },\n  {\n    type: 'audio',\n    name: 'Audio',\n    dataType: null,\n  },\n  {\n    type: 'checkbox',\n    name: 'Checkbox',\n    dataType: 'boolean',\n  },\n  {\n    type: 'color',\n    name: 'Color',\n    dataType: 'string',\n  },\n  {\n    type: 'date',\n    name: 'Date',\n    dataType: 'string',\n  },\n  {\n    type: 'embedly',\n    name: 'Embedly',\n    dataType: null,\n  },\n  {\n    type: 'entity',\n    name: 'Entity',\n    dataType: 'array',\n  },\n  {\n    type: 'entityGrid',\n    name: 'Entity Grid',\n    dataType: 'array',\n  },\n  {\n    type: 'entityTile',\n    name: 'Entity Tile',\n    dataType: 'array',\n  },\n  {\n    type: 'image',\n    name: 'Image',\n    dataType: null,\n  },\n  {\n    type: 'keyValue',\n    name: 'Key Value',\n    dataType: null,\n  },\n  {\n    type: 'number',\n    name: 'Number',\n    dataType: 'number',\n  },\n  {\n    type: 'richText',\n    name: 'Rich Text',\n    dataType: null,\n  },\n  {\n    type: 'select',\n    name: 'Select',\n    dataType: 'array',\n  },\n  {\n    type: 'taxonomy',\n    name: 'Taxonomy',\n    dataType: null,\n  },\n  {\n    type: 'text',\n    name: 'Text',\n    dataType: 'string',\n  },\n  {\n    type: 'textArea',\n    name: 'Text Area',\n    dataType: 'string',\n  },\n  {\n    type: 'user',\n    name: 'User',\n    dataType: 'array',\n  },\n  {\n    type: 'video',\n    name: 'Video',\n    dataType: null,\n  },\n  {\n    type: 'vimeo',\n    name: 'Vimeo',\n    dataType: null,\n  },\n];\n\nclass Fields {\n  static fields() {\n    return fields.map(field => Object.freeze(field));\n  }\n  static field(type) {\n    return _.find(Fields.fields(), { type });\n  }\n}\n\nmodule.exports = Fields;\n","const _ = require('lodash');\nconst ClientConfig = require('./client-config');\nconst Db = require('./db');\nconst Fields = require('./fields');\n\nclass Schema {\n  constructor(config) {\n    this.config = config;\n\n    return this;\n  }\n\n  async create(schema) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    clientConfig.schemas.push(schema);\n\n    await this.updateEntityIndex(clientConfig.schemas);\n\n    return cc.set(clientConfig);\n  }\n\n  async read(schemaSlug) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    const schema = _.find(clientConfig.schemas, { slug: schemaSlug });\n\n    if (!schema) {\n      throw Error(`Schema not found: ${schemaSlug}`);\n    }\n\n    return schema;\n  }\n\n  async update(schema) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    const index = _.findIndex(clientConfig.schemas, { slug: schema.slug });\n\n    if (index === -1) {\n      throw Error(`Schema not found: ${schema.slug}`);\n    }\n\n    clientConfig.schemas.splice(index, 1, schema);\n\n    await this.updateEntityIndex(clientConfig.schemas);\n\n    return cc.set(clientConfig);\n  }\n\n  async delete(schemaSlugs) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    schemaSlugs = _.isArray(schemaSlugs) ? schemaSlugs : [schemaSlugs];\n\n    clientConfig.schemas = clientConfig.schemas.filter(schema => schemaSlugs.indexOf(schema.slug) === -1);\n\n    clientConfig.schemas = clientConfig.schemas.map((schema) => {\n      if (!schema.fields) {\n        return schema;\n      }\n      schema.fields = schema.fields.map((field) => {\n        if (!field.settings) {\n          return field;\n        }\n        if (field.settings.schemas) {\n          field.settings.schemas = field.settings.schemas.filter(schema => schemaSlugs.indexOf(schema) === -1);\n        }\n        return field;\n      });\n      return schema;\n    });\n\n    await this.updateEntityIndex(clientConfig.schemas);\n\n    return cc.set(clientConfig);\n  }\n\n  async updateAll(schemas) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    clientConfig.schemas = schemas;\n\n    // await this.updateEntityIndex(clientConfig.schemas);\n\n    return cc.set(clientConfig);\n  }\n\n  async updateEntityIndex(schemas) {\n    let fields = [];\n\n    schemas.forEach((schema) => {\n      fields = fields.concat(schema.fields);\n    });\n\n    fields = _.uniqBy(fields, 'slug');\n\n    const index = {\n      name: 'entity',\n      type: 'text',\n      ddoc: 'entityIndex',\n      index: {\n        default_field: {\n          enabled: true,\n          analyzer: 'standard',\n        },\n        selector: {\n          $and: [\n            {\n              type: 'entity',\n            },\n          ],\n        },\n        fields: [\n          {\n            name: 'published',\n            type: 'boolean',\n          },\n          {\n            name: 'trashed',\n            type: 'boolean',\n          },\n          {\n            name: 'title',\n            type: 'string',\n          },\n          {\n            name: 'slug',\n            type: 'string',\n          },\n          {\n            name: 'schema',\n            type: 'string',\n          },\n          {\n            name: 'modifiedAt',\n            type: 'string',\n          },\n          {\n            name: 'publishedAt',\n            type: 'string',\n          },\n        ],\n      },\n    };\n\n    fields.forEach((field) => {\n      const fieldRef = Fields.field(field.type);\n\n      if (/number|string|boolean/.test(fieldRef.dataType)) {\n        index.index.fields.push({\n          name: `fields.${field.slug}.value`,\n          type: fieldRef.dataType,\n        });\n      }\n\n      if (/array/.test(fieldRef.dataType)) {\n        index.index.fields.push({\n          name: `fields.${field.slug}.value.[].slug`,\n          type: 'string',\n        });\n      }\n\n      if (/taxonomy/.test(field.type)) {\n        index.index.fields.push({\n          name: `fields.${field.slug}.value.terms.[].slug`,\n          type: 'string',\n        });\n      }\n    });\n\n    const result = await Db.connect(this.config).index(index);\n\n    return result;\n  }\n\n}\n\nmodule.exports = Schema;\n","const _ = require('lodash');\nconst Promise = require('bluebird');\nconst jsonQuery = require('json-query');\nconst diff = require('deep-diff').diff;\nconst ClientConfig = require('./client-config');\nconst Db = require('./db');\nconst Helpers = require('./helpers');\nconst Schema = require('./schema');\nconst Assist = require('./assist');\n\nconst CHUNK_UPDATE_SIZE = 1000;\n\nclass Entity {\n  constructor (config) {\n    this.config = config;\n\n    // Expose helpers\n    this.flattenValues = Entity.flattenValues;\n  }\n\n  static flattenValues (docs) {\n    return docs.map((doc) => {\n      if (!doc.fields || !_.size(doc.fields)) {\n        return doc;\n      }\n\n      doc.fields = _.mapValues(doc.fields, (field) => {\n        if (/entity/.test(field.type) && _.isArray(field.value)) { // entity / entityTile / entityGrid\n          field.value = Entity.flattenValues(field.value);\n        }\n        return field.value;\n      });\n\n      return doc;\n    });\n  }\n\n  static filterEntityFields (docs, role = 'guest') {\n    const isArray = _.isArray(docs);\n\n    docs = (isArray ? docs : [docs]).map((doc) => {\n      if (_.size(doc.fields)) {\n        doc.fields = _.mapValues(doc.fields, (field) => {\n          if (_.isArray(field.value)) {\n            field.value = field.value.filter((obj) => {\n              if (!obj) {\n                return false;\n              }\n              if (obj.type && obj.type === 'entity' && role === 'guest') {\n                return obj.published !== undefined ? obj.published : true;\n              }\n              return true;\n            });\n          }\n          return field;\n        });\n      }\n      return doc;\n    });\n\n    return isArray ? docs : docs[0];\n  }\n\n  static _appendChildren (docs, childrenMap) {\n    return docs.map((doc) => {\n      if (!_.size(doc.fields)) {\n        return doc;\n      }\n\n      doc.fields = _.mapValues(doc.fields, (field) => {\n        if (_.isArray(field.value)) {\n          field.value = field.value.filter((obj) => {\n            if (!obj) {\n              return false;\n            }\n            if (obj.type === 'entity') {\n              return childrenMap[obj.id] !== undefined;\n            }\n            return true;\n          });\n\n          field.value = field.value.map((obj) => {\n            if (obj.type === 'entity') {\n              obj = _.merge(obj, childrenMap[obj.id]);\n            }\n            obj = _.omitBy(obj, (value, key) => key.startsWith('_'));\n            return obj;\n          });\n        }\n\n        return field;\n      });\n\n      return doc;\n    });\n  }\n\n  static _appendParents (result, parents = null, role = 'guest') {\n    let entityMap = {};\n\n    result.rows.forEach((row) => {\n      if (!row.doc) {\n        return;\n      }\n\n      if (row.value.type === 'entity') {\n        if (parents) {\n          row.doc.parents = [];\n        }\n        entityMap[row.id] = row.doc;\n      }\n    });\n\n    if (parents) {\n      result.rows.forEach((row) => {\n        if (row.doc && row.value.type === 'parent') {\n          entityMap[row.key].parents.push(Entity.filterEntityFields(row.doc, role));\n        }\n      });\n\n      entityMap = _.mapValues(entityMap, (entity) => {\n        entity.parents = _.uniqBy(entity.parents, entity => entity._id);\n        return entity;\n      });\n    }\n\n    entityMap = null;\n\n    return result;\n  }\n\n  static _fileNames (entities) {\n    const fileNames = [];\n\n    entities.forEach((entity) => {\n      _.forEach(entity.fields, (field) => {\n        if (field.value && field.value.file) {\n          fileNames.push(field.value.file.name);\n        }\n      });\n    });\n\n    return _.uniq(fileNames);\n  }\n\n  async fieldValues (fieldSlug, searchTerm) {\n    const result = await Db.connect(this.config).viewWithList('entity', 'byField', 'search', {\n      startkey: [fieldSlug],\n      endkey: [fieldSlug, {}],\n      group: true,\n      searchTerm,\n    });\n    return result;\n  }\n\n  static _query(doc, query, forceId = false) {\n    const queryParts = query.trim().split(/\\[|\\]/);\n    const selector = `fields.${queryParts[0]}.value[${queryParts[1] || '*'}]`;\n    const modifier = /\\]:/.test(query) ? `:${query.split(/\\]:/).slice(-1)[0].trim()}` : '';\n\n    const result = jsonQuery(`${selector}${modifier}`, {\n      data: doc,\n      locals: {\n        slice: (input, start, end) => _.slice(input, start, end),\n        sample: (input, size = 1) => _.sampleSize(input, size),\n        group: (entities, groupSize = Infinity) => {\n          const grouped = [];\n\n          let group = [];\n\n          entities.forEach((entity) => {\n            if (!entity.groupBefore || group.length >= groupSize) {\n              group = [];\n            }\n\n            group.push(entity);\n\n            if (!entity.groupAfter || group.length >= groupSize) {\n              group.ratio = 0;\n\n              group.forEach((entity) => {\n                group.ratio += (entity.thumbnail || entity).ratio;\n              });\n\n              group.forEach((entity) => {\n                entity.groupRatio = (entity.thumbnail || entity).ratio / group.ratio;\n              });\n\n              grouped.push(group);\n            }\n          });\n\n          return grouped;\n        },\n        pick: (input, ...paths) => _.map(input, (obj) => {\n          const copy = {};\n          if (forceId && obj.id) {\n            copy.id = obj.id;\n          }\n          paths.forEach((path) => {\n            _.set(copy, path, _.get(obj, path));\n          });\n          return copy;\n        }),\n      },\n      allowRegexp: true,\n    });\n\n    return result;\n  }\n\n  async _entitiesById (ids = [], parents = null, role = 'guest') {\n    const query = {\n      include_docs: true,\n    };\n\n    if (ids.length) {\n      query.keys = ids;\n    }\n\n    let result = await Db.connect(this.config)\n      .view('entity', parents ? 'byIdExtended' : 'byId', query);\n\n    result = Entity._appendParents(result, parents, role);\n\n    return result;\n  }\n\n  static _childDepthLimit (children, merging = false) {\n    if (_.isNumber(children)) {\n      return children;\n    }\n    if (_.isArray(children)) {\n      if (merging) {\n        return children.length + 1;\n      }\n      return children.length;\n    }\n    return 1;\n  }\n\n  async _getDocMap (docs, children, parents, role, docMap = {}, childDepth = 0) {\n    if (!parents && !children) {\n      return docMap;\n    }\n\n    let ids = [];\n\n    docs.forEach((rowOrDoc) => {\n      const isRow = !!rowOrDoc.doc;\n\n      const doc = isRow ? rowOrDoc.doc : rowOrDoc;\n\n      if (children && doc.fields && _.size(doc.fields)) {\n        if (_.isArray(children)) {\n          const queries = children[childDepth].split(/,(?![^([]*[\\])])/g);\n\n          queries.forEach((query) => {\n            ids = ids.concat(_.flatten(Entity._query(doc, query, true).value).map(obj => obj && obj.id));\n          });\n\n        } else {\n          _.forEach(doc.fields, (field) => {\n            if (_.isArray(field.value)) {\n              field.value = field.value.filter(obj => obj);\n\n              field.value.forEach((obj) => {\n                if (obj.id) {\n                  ids.push(obj.id);\n                }\n              });\n            }\n          });\n        }\n      }\n\n      const id = isRow ? rowOrDoc.id : doc._id || doc.id;\n      if (!docMap[id]) {\n        ids.push(id);\n      }\n    });\n\n    ids = _.uniq(ids);\n\n    ids = ids.filter(id => !docMap[id]);\n\n    if (ids.length === 0) {\n      return docMap;\n    }\n\n    let _docs = (await this._entitiesById(ids, parents, role)).rows.map(row => row.doc);\n\n    _docs.forEach((doc) => {\n      docMap[doc._id] = doc;\n    });\n\n    childDepth += 1;\n\n    if (!children || (childDepth >= Entity._childDepthLimit(children))) {\n      return docMap;\n    }\n\n    docMap = await this._getDocMap(_docs, children, parents, role, docMap, childDepth);\n\n    _docs = null;\n\n    return docMap;\n  }\n\n  static _mergeDocs(docs, docMap, children, childDepth = 0) {\n    if (children && (childDepth + 1 >= Entity._childDepthLimit(children, true))) {\n      return docs;\n    }\n\n    docs = docs.map((rowOrDoc) => {\n      const isRow = !!rowOrDoc.doc;\n\n      let doc = isRow ? rowOrDoc.doc : rowOrDoc;\n\n      if (!doc.fields && docMap[rowOrDoc.id || rowOrDoc._id]) {\n        doc = docMap[rowOrDoc.id || rowOrDoc._id];\n      }\n\n      if (children && doc.fields && _.size(doc.fields)) {\n\n        let queries;\n\n        if (_.isArray(children)) {\n          queries = {};\n          children[childDepth].split(/,(?![^([]*[\\])])/g).forEach((query) => {\n            query = query.trim();\n            const queryField = query.split(/\\[|\\]/)[0];\n            queries[queryField] = query;\n          });\n        }\n\n        doc.fields = _.mapValues(doc.fields, (field, fieldSlug) => {\n          if (_.isArray(field.value)) {\n            field.value = field.value.filter(obj => obj);\n\n            if (!queries || (queries && queries[fieldSlug])) {\n              if (queries && queries[fieldSlug]) {\n                field.value = field.value.filter(obj => obj.id && docMap[obj.id]);\n              }\n\n              field.value = field.value.map((obj) => {\n                if (obj && obj.id && docMap[obj.id]) {\n                  obj = _.merge(obj, docMap[obj.id] || {});\n                  obj = _.omitBy(obj, (value, key) => key.startsWith('_'));\n                }\n                return obj;\n              });\n\n              field.value = Entity._mergeDocs(field.value, docMap, children, childDepth + 1);\n            }\n          }\n          return field;\n        });\n\n        doc.fields = _.mapValues(doc.fields, (field, fieldSlug) => {\n          if (_.isArray(field.value)) {\n            if (queries && queries[fieldSlug]) {\n              field.value = _.flatten(Entity._query(doc, queries[fieldSlug]).value);\n            }\n          }\n          return field;\n        });\n\n      }\n\n      if (isRow) {\n        rowOrDoc.doc = doc;\n      } else {\n        rowOrDoc = doc;\n      }\n\n      return rowOrDoc;\n    });\n\n    return docs;\n  }\n\n  async _extendDocs (docs, children, parents, role) {\n    let docMap = await this._getDocMap(docs, children, parents, role);\n\n    docs = Entity._mergeDocs(docs, docMap, children);\n\n    docMap = null;\n\n    return docs;\n  }\n\n  _removeChildren (entities) {\n    return new Promise((resolve, reject) => {\n      if (entities.length === 0) {\n        resolve([]);\n        return;\n      }\n\n      entities = entities.map(entity => entity._id);\n\n      Db.connect(this.config).view('entity', 'byChildren', {\n        keys: entities,\n        include_docs: true,\n      })\n        .then((response) => {\n          const updatedEntities = _.uniqBy(response.rows, row => row.doc._id).map((row) => {\n            row.doc.fields = _.mapValues(row.doc.fields, (field) => {\n              if (_.isArray(field.value)) {\n                field.value = _.remove(field.value, obj => obj.type === 'entity' && entities.indexOf(obj.id) !== -1);\n              }\n              return field;\n            });\n\n            return row.doc;\n          });\n\n          if (updatedEntities.length === 0) {\n            resolve([]);\n            return;\n          }\n\n          Helpers.chunkUpdate(this.config, updatedEntities, CHUNK_UPDATE_SIZE)\n            .then(resolve, reject);\n        }, reject);\n    });\n  }\n\n  _updateChildren (entities) {\n    return new Promise((resolve, reject) => {\n      if (entities.length === 0) {\n        resolve([]);\n        return;\n      }\n\n      const entityMap = {};\n\n      entities = entities.map((entity) => {\n        entityMap[entity._id] = entity;\n\n        return entity._id;\n      });\n\n      Db.connect(this.config).view('entity', 'byChildren', {\n        keys: entities,\n        include_docs: true,\n      })\n        .then((response) => {\n          const entities = response.rows.map((row) => {\n            const entity = row.doc;\n\n            _.forEach(entity.fields, (field, fieldSlug) => {\n              if (_.isArray(field.value)) {\n                entity.fields[fieldSlug].value = field.value.map((obj) => {\n                  if (obj.type === 'entity' && entityMap[obj.id]) {\n                    obj.slug = entityMap[obj.id].slug;\n                    obj.title = entityMap[obj.id].title;\n                    obj.schema = entityMap[obj.id].schema;\n                    obj.published = entityMap[obj.id].published;\n\n                    if (entityMap[obj.id].thumbnail) {\n                      obj.thumbnail = entityMap[obj.id].thumbnail;\n                    } else {\n                      obj.thumbnail = null;\n                    }\n                  }\n\n                  return obj;\n                });\n              }\n            });\n\n            return entity;\n          });\n\n          Helpers.chunkUpdate(this.config, entities, CHUNK_UPDATE_SIZE)\n            .then(resolve, reject);\n        }, reject);\n    });\n  }\n\n  async entityList (ids = [], children = null, parents = null, role = 'guest') {\n    const result = await this._entitiesById(ids, parents, role);\n\n    if ((!children && !parents) || result.total_rows === 0) {\n      return result.rows;\n    }\n\n    const rows = await this._extendDocs(result.rows, children, parents, role);\n\n    return rows;\n  }\n\n  _entitySearch (query, children = null, parents = null, role = 'guest') {\n    return new Promise((resolve, reject) => {\n      query.limit = Math.min(query.limit || 200, 200);\n      query.sort = _.isString(query.sort) ? `\"${query.sort}\"` : query.sort;\n\n      if (children) {\n        query.include_docs = true;\n      }\n\n      if (!query.include_fields) {\n        query.include_fields = [];\n      }\n\n      if (_.isArray(query.include_fields)) {\n        query.include_fields = JSON.stringify(query.include_fields);\n      }\n\n      if (!query.sort) {\n        delete query.sort;\n      }\n      if (!query.bookmark) {\n        delete query.bookmark;\n      }\n      if (!query.index) {\n        delete query.index;\n      }\n      if (!query.group_field) {\n        delete query.group_field;\n      }\n\n      Db.connect(this.config).search('entity', query.index || 'all', query)\n        .then((result) => {\n\n          if (result.groups) {\n            const promises = [];\n\n            result.groups = result.groups.map((group) => {\n              promises.push(new Promise((resolve, reject) => {\n                if ((!children && !parents) || group.total_rows === 0) {\n                  resolve();\n                  return;\n                }\n\n                this._extendDocs(group.hits, children, parents, role)\n                  .then((docs) => {\n                    group.hits = docs;\n\n                    resolve();\n                  }, reject);\n              }));\n              return group;\n            });\n\n            Promise.all(promises)\n              .then(() => {\n                resolve(result);\n              }, reject);\n\n            return;\n          }\n\n          if ((!children && !parents) || result.total_rows === 0) {\n            resolve(result);\n            return;\n          }\n\n          this._extendDocs(result.rows, children, parents, role)\n            .then((docs) => {\n              result.rows = docs;\n\n              resolve(result);\n            }, reject);\n        }, reject);\n    });\n  }\n\n  entitySearch (query, children = null, parents = null, role = 'guest') {\n    return new Promise((resolve, reject) => {\n      const limit = query.limit || 25;\n\n      if (limit <= 200) {\n        this._entitySearch(query, children, parents, role)\n          .then(resolve, reject);\n        return;\n      }\n\n      let rows = [];\n      let groups = [];\n\n      function __entitySearch (bookmark) {\n        const _query = _.clone(query);\n\n        if (bookmark) {\n          _query.bookmark = bookmark;\n        }\n\n        this._entitySearch(_query, children, parents, role)\n          .then((result) => {\n            if (result.rows) {\n              rows = rows.concat(result.rows);\n            }\n            if (result.groups) {\n              groups = groups.concat(result.groups);\n            }\n\n            if (rows.length < result.total_rows && rows.length < limit) {\n              __entitySearch.call(this, result.bookmark);\n              return;\n            }\n\n            result.rows = rows;\n            result.groups = groups;\n\n            resolve(result);\n          }, reject);\n      }\n\n      __entitySearch.call(this);\n    });\n  }\n\n  async entityFind (query, children = null, parents = null, role = 'guest') {\n    let result;\n\n    try {\n      result = await Db.connect(this.config).find(query);\n    } catch (error) {\n      if (error.error === 'no_usable_index') {\n        const cc = new ClientConfig(this.config);\n        const clientConfig = await cc.get();\n\n        const schema = new Schema(this.config);\n        await schema.updateEntityIndex(clientConfig.schemas);\n\n        result = await Db.connect(this.config).find(query);\n      }\n    }\n\n    if (children === false) {\n      return result;\n    }\n\n    if (query.fields && query.fields.indexOf('_id') === -1) {\n      throw new Error('_id field required for `children`');\n    }\n\n    result.docs = await this._extendDocs(result.docs, children, parents, role);\n\n    return result;\n  }\n\n  entityRevisions (entityId) {\n    return new Promise((resolve, reject) => {\n      Db.connect(this.config).get(entityId, {\n        revs_info: true,\n      })\n        .then((response) => {\n          const revisionIds = [];\n\n          response._revs_info.forEach((revision) => {\n            if (revision.status === 'available') {\n              revisionIds.push(revision.rev);\n            }\n          });\n\n          Db.connect(this.config).get(entityId, {\n            open_revs: JSON.stringify(revisionIds),\n          })\n            .then((response) => {\n              const revisions = [];\n              const childrenIds = [];\n\n              response.forEach((revision) => {\n                if (revision.ok) {\n                  revisions.push(revision.ok);\n\n                  _.forEach(revision.ok.fields, (field) => {\n                    if (/entity/.test(field.type)) {\n                      _.forEach(field.value, (obj) => {\n                        if (obj.id) {\n                          childrenIds.push(obj.id);\n                        }\n                      });\n                    }\n                  });\n                }\n              });\n\n              Db.connect(this.config).fetch({\n                keys: _.uniq(childrenIds),\n                include_docs: true,\n              })\n                .then((result) => {\n                  const childrenMap = {};\n\n                  result.rows.forEach((row) => {\n                    try {\n                      childrenMap[row.doc._id] = row.doc;\n                    } catch (error) {\n                      console.error('Error: child no longer exists');\n                    }\n                  });\n\n                  resolve(Entity._appendChildren(revisions, childrenMap));\n                }, reject);\n            }, reject);\n        }, reject);\n    });\n  }\n\n  entityCreate (entity) {\n    return new Promise((resolve, reject) => {\n      entity.type = 'entity';\n\n      Db.connect(this.config).insert(entity)\n        .then((response) => {\n          entity._id = response.id;\n          entity._rev = response.rev;\n\n          resolve(entity);\n        }, reject);\n    });\n  }\n\n  entityRead (entityId) {\n    return new Promise((resolve, reject) => {\n      Db.connect(this.config).get(entityId)\n        .then(resolve, reject);\n    });\n  }\n\n  entityUpdate (entities, restore) {\n    return new Promise((resolve, reject) => {\n      entities = _.isArray(entities) ? entities : [entities];\n\n      const entityMap = {};\n\n      const entityIds = entities.map((entityOrEntityId) => {\n        let entityId;\n\n        if (_.isObject(entityOrEntityId)) {\n          entityId = entityOrEntityId._id;\n          entityMap[entityId] = entityOrEntityId;\n        }\n        if (_.isString(entityOrEntityId)) {\n          entityId = entityOrEntityId;\n        }\n\n        return entityId;\n      });\n\n      Db.connect(this.config).fetch({\n        keys: entityIds,\n        include_docs: true,\n      })\n        .then((response) => {\n          const children = [];\n\n          const entities = response.rows.map((row) => {\n            const oldEntity = row.doc;\n            const newEntity = entityMap[oldEntity._id];\n\n            let entity = oldEntity;\n\n            if (newEntity) {\n              delete newEntity._rev;\n\n              const diffs = diff(oldEntity, newEntity);\n\n              diffs.forEach((diff) => {\n                if (/slug|title|thumbnail/.test(diff.path[0])) {\n                  if (children.indexOf(newEntity) === -1 && entityIds.indexOf(newEntity._id) !== -1) {\n                    children.push(newEntity);\n                  }\n                }\n              });\n\n              entity = _.mergeWith({}, oldEntity, newEntity, (a, b) => {\n                if (_.isArray(a) && _.isArray(b)) {\n                  return b;\n                }\n                return undefined;\n              });\n            }\n\n            if (restore) {\n              entity.trashed = false;\n            }\n\n            return entity;\n          });\n\n          this._updateChildren(children)\n            .then(() => {\n              Helpers.chunkUpdate(this.config, entities, CHUNK_UPDATE_SIZE)\n                .then(resolve, reject);\n            }, reject);\n        }, reject);\n    });\n  }\n\n  async entityDelete (entityIds, forever = false) {\n    let entities;\n    let filesResult;\n\n    if (entityIds === 'trashed') {\n      forever = true;\n\n      entities = (await Db.connect(this.config).view('entity', 'trashed', {\n        include_docs: true,\n      })).rows;\n\n    } else {\n      entities = (await Db.connect(this.config).fetch({\n        keys: _.isArray(entityIds) ? entityIds : [entityIds],\n        include_docs: true,\n      })).rows;\n    }\n\n    entities = entities.filter(entity => !entity.value || !entity.value.deleted);\n\n    entities = entities.map(entity => entity.doc);\n\n    if (forever) {\n      await this._removeChildren(entities);\n\n      const fileNames = Entity._fileNames(entities);\n\n      if (fileNames.length) {\n        const assist = new Assist(this.config);\n        filesResult = await assist.deleteFiles(fileNames);\n      }\n\n      entities = entities.map(entity => ({\n        _id: entity._id,\n        _rev: entity._rev,\n        _deleted: true,\n      }));\n\n    } else {\n      entities = entities.map((entity) => {\n        entity.trashed = true;\n        return entity;\n      });\n    }\n\n    const entitiesResult = await Helpers.chunkUpdate(this.config, entities, CHUNK_UPDATE_SIZE);\n\n    return {\n      entities: entitiesResult,\n      files: filesResult,\n    };\n  }\n\n}\n\nmodule.exports = Entity;\n","module.exports = require(\"fs\");","const path = require('path');\nconst fs = require('fs');\nconst _ = require('lodash');\nconst Promise = require('bluebird');\nconst nodemailer = require('nodemailer');\nconst Createsend = Promise.promisifyAll(require('createsend-node'));\nconst nodemailerMailgunTransport = require('nodemailer-mailgun-transport');\nconst EmailTemplate = require('email-templates');\nconst Inky = require('inky').Inky;\nconst mjml2html = require('mjml');\nconst registerComponent = require('mjml-core').registerComponent;\nconst registerDependencies = require('mjml-validator').registerDependencies;\nconst { McSection, McImage } = require('mjml-mailchimp');\nconst htmlToText = require('html-to-text');\nconst moment = require('moment');\nconst countries = require('i18n-iso-countries');\nconst sass = require('node-sass');\n\nconst ClientConfig = require('./client-config');\nconst Helpers = require('./helpers');\n\n\nclass Email {\n  constructor(config) {\n    this.config = config;\n\n    this.inky = new Inky();\n\n    registerComponent(McSection);\n    registerComponent(McImage);\n    registerDependencies({\n      'mc-section': ['mj-column', 'mj-group', 'mj-raw'],\n      'mj-column': ['mc-image'],\n      'mj-hero': ['mc-image'],\n    });\n  }\n\n  getTemplate(templateSlug, templateData = {}, templateOptions = {}) {\n    return new Promise((resolve, reject) => {\n      const options = _.merge({}, {\n        inlineStyles: true,\n        inky: false,\n        mjml: false,\n        skipValidation: false,\n      }, templateOptions);\n\n      let templatePath = path.resolve(this.config.email.templatesPath, templateSlug);\n\n      if (!fs.existsSync(templatePath)) {\n        templatePath = path.resolve('./email', templateSlug);\n      }\n\n      const templateFiles = fs.readdirSync(templatePath);\n\n      let htmlPath = 'html';\n      // Support mjml templates\n      if (_.find(templateFiles, fileName => /^html\\.mjml/.test(fileName))) {\n        htmlPath = 'html.mjml';\n        options.mjml = true;\n      }\n\n      // Support ejs templates (for backwards compatibility)\n      // TODO: convert ejs templates to pug and remove\n      let extension;\n      if (_.find(templateFiles, fileName => /\\.ejs$/.test(fileName))) {\n        extension = 'ejs';\n      }\n\n      let style = '';\n      if (_.find(templateFiles, fileName => /^style\\.scss$/.test(fileName))) {\n        style = sass.renderSync({\n          file: path.resolve(templatePath, 'style.scss'),\n          sourceMapContents: !options.inlineStyles,\n          sourceMapEmbed: !options.inlineStyles,\n        }).css.toString().replace(/\"/g, '\\'');\n      }\n\n      const emailTemplate = new EmailTemplate({\n        views: {\n          root: this.config.email.templatesPath,\n          options: {\n            extension,\n          },\n        },\n        juice: options.inlineStyles,\n        juiceResources: {\n          preserveMediaQueries: true,\n          preserveFontFaces: true,\n          removeStyleTags: false,\n          removeLinkTags: false,\n          preserveImportant: true,\n          webResources: {\n            links: false,\n            scripts: false,\n            images: false,\n            // relativeTo: '',\n          },\n        },\n        transport: {\n          jsonTransport: true,\n        },\n      });\n\n      const cc = new ClientConfig(this.config);\n      const helpers = new Helpers(this.config);\n\n      cc.get()\n        .then((clientConfig) => {\n          templateData = _.merge({}, templateData, {\n            config: _.merge({}, _.pick(this.config, ['cms']), _.pick(clientConfig, ['slug', 'client', 'assets'])),\n            helpers,\n            style,\n            moment,\n            countries,\n            templateSlug,\n          });\n\n          emailTemplate.render(`${templateSlug}/${htmlPath}`, templateData)\n            .then((html) => {\n\n              if (options.mjml) {\n                const convertMjmlResult = mjml2html(html, {\n                  level: options.skipValidation ? 'skip' : 'soft',\n                });\n\n                if (convertMjmlResult.errors && convertMjmlResult.errors.length) {\n                  reject(convertMjmlResult.errors);\n                  return;\n                }\n\n                html = convertMjmlResult.html;\n              }\n\n              if (options.inky) {\n                html = this.inky.releaseTheKraken(html);\n              }\n\n              resolve({\n                html,\n                text: htmlToText.fromString(html),\n              });\n            }, reject);\n        }, reject);\n    });\n  }\n\n  sendEmail(emailOptions, templateSlug, templateData = {}, templateOptions = {}) {\n    return new Promise((resolve, reject) => {\n      const nodemailerMailgun = nodemailer.createTransport(nodemailerMailgunTransport({\n        auth: {\n          api_key: this.config.mailgun.apiKey,\n          domain: this.config.mailgun.domain,\n        },\n      }));\n\n      this.getTemplate(templateSlug, _.merge({}, emailOptions, templateData), templateOptions)\n        .then((emailTemplate) => {\n          emailOptions.html = emailTemplate.html;\n          emailOptions.text = emailTemplate.text;\n\n          nodemailerMailgun.sendMail(emailOptions, (error, metadata) => {\n            if (error) {\n              reject(error);\n              return;\n            }\n\n            resolve({\n              metadata,\n              email: emailOptions,\n            });\n          });\n        }, reject);\n    });\n  }\n\n  subscribe(details, provider, listId) {\n    return new Promise((resolve, reject) => {\n      const cc = new ClientConfig(this.config);\n\n      cc.get()\n        .then((clientConfig) => {\n          if (provider === 'createsend') {\n            if (clientConfig.provider.createsend) {\n              const cs = new Createsend({\n                apiKey: clientConfig.provider.createsend.clientApiKey,\n              });\n\n              const subscribers = Promise.promisifyAll(cs.subscribers);\n\n              subscribers.addSubscriberAsync(listId, {\n                EmailAddress: details.email,\n                Name: details.name,\n                Resubscribe: true,\n                RestartSubscriptionBasedAutoresponders: true,\n              })\n                .then((result) => {\n                  resolve(`Email.subscribe(): ${result.emailAddress}`);\n                })\n                .catch((error) => {\n                  reject(error.Message);\n                });\n\n              return;\n            }\n            reject(new Error('Subscriber list not configured'));\n          }\n        }, reject);\n    });\n  }\n\n}\n\nmodule.exports = Email;\n","module.exports = require(\"babel-runtime/core-js/object/freeze\");","const _ = require('lodash');\n\nconst roles = [\n  {\n    name: 'Admin',\n    slug: 'admin',\n    permissions: {\n      entityGrid: true,\n\n      entityCreate: true,\n      entityRead: true,\n      entityUpdate: true,\n      entityDelete: true,\n\n      taxonomyCreate: true,\n      taxonomyRead: true,\n      taxonomyUpdate: true,\n      taxonomyDelete: true,\n\n      fileCreate: true,\n      fileRead: true,\n      fileUpdate: true,\n      fileDelete: true,\n\n      config: false,\n      schema: false,\n      user: true,\n      settings: true,\n      userSettings: true,\n      tools: true,\n      ecommerce: true,\n    },\n  },\n  {\n    name: 'Editor',\n    slug: 'editor',\n    permissions: {\n      entityGrid: true,\n\n      entityCreate: true,\n      entityRead: true,\n      entityUpdate: true,\n      entityDelete: true,\n\n      taxonomyCreate: true,\n      taxonomyRead: true,\n      taxonomyUpdate: true,\n      taxonomyDelete: true,\n\n      fileCreate: true,\n      fileRead: true,\n      fileUpdate: true,\n      fileDelete: true,\n\n      config: false,\n      schema: false,\n      user: false,\n      settings: false,\n      userSettings: true,\n      tools: false,\n      ecommerce: false,\n    },\n  },\n  {\n    name: 'Guest',\n    slug: 'guest',\n    permissions: {\n      entityGrid: true,\n\n      entityCreate: false,\n      entityRead: true,\n      entityUpdate: false,\n      entityDelete: false,\n\n      taxonomyCreate: false,\n      taxonomyRead: true,\n      taxonomyUpdate: false,\n      taxonomyDelete: false,\n\n      fileCreate: false,\n      fileRead: true,\n      fileUpdate: false,\n      fileDelete: false,\n\n      config: false,\n      schema: false,\n      user: false,\n      settings: false,\n      userSettings: false,\n      tools: false,\n      ecommerce: false,\n    },\n  },\n];\n\nclass Roles {\n  roles() {\n    return roles.map(role => Object.freeze(role));\n  }\n  role(slug) {\n    return _.find(this.roles(), { slug });\n  }\n}\n\nmodule.exports = Roles;\n","module.exports = require(\"@cloudant/cloudant\");","module.exports = require(\"axios\");","const _ = require('lodash');\nconst axios = require('axios');\nconst passwordHash = require('password-hash');\nconst ClientConfig = require('./client-config');\n\nclass Assist {\n  constructor(config) {\n    this.config = config;\n  }\n\n  async deleteFiles(fileNames) {\n    const cc = new ClientConfig(this.config);\n    const clientConfig = await cc.get();\n\n    const assetsSlug = _.get(clientConfig, 'assets.slug', this.config.slug);\n\n    if (fileNames.length === 0) {\n      return [];\n    }\n\n    const result = (await axios.post(`${this.config.assist.url}/${assetsSlug}/file/delete`, { fileNames }, {\n      auth: {\n        username: this.config.assist.username,\n        password: passwordHash.generate(this.config.assist.password),\n      },\n    })).data;\n\n    return result;\n  }\n\n}\n\nmodule.exports = Assist;\n","const _ = require('lodash');\nconst ClientConfig = require('./client-config');\n\nclass User {\n  constructor(config) {\n    this.config = config;\n\n    return this;\n  }\n\n  async create(user) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    clientConfig.users.push(user);\n\n    return cc.set(clientConfig);\n  }\n\n  async read(userId) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    const user = _.find(clientConfig.users, { id: userId });\n\n    if (!user) {\n      throw Error(`User not found: ${userId}`);\n    }\n\n    return user;\n  }\n\n  async update(user) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    const index = _.findIndex(clientConfig.users, { id: user.id });\n\n    if (index === -1) {\n      throw Error(`User not found: ${user.id}`);\n    }\n\n    clientConfig.users.splice(index, 1, user);\n\n    return cc.set(clientConfig);\n  }\n\n  async delete(userId) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    userId = _.isArray(userId) ? userId : [userId];\n\n    clientConfig.users = clientConfig.users.filter(user => userId.indexOf(user.id) === -1);\n\n    return cc.set(clientConfig);\n  }\n}\n\nmodule.exports = User;\n","const Promise = require('bluebird');\nconst fs = Promise.promisifyAll(require('fs'));\nconst Cloudant = require('@cloudant/cloudant');\nconst Db = require('./db');\n\nclass Tools {\n  constructor(config) {\n    this.config = config;\n  }\n\n  async getDb() {\n    const result = await Db.connect(this.config).fetch({\n      include_docs: true,\n    });\n\n    return result;\n  }\n\n  async getChanges() {\n    const result = await Db.connect(this.config).changes({\n      limit: 50,\n      include_docs: true,\n      filter: 'tools/changesEntity',\n    });\n\n    return result;\n  }\n\n  async importDb(dbBackupFile) {\n    const dbName = this.config.db.name;\n\n    const fileConents = await fs.readFileAsync(dbBackupFile.path);\n\n    const docs = JSON.parse(fileConents).rows.map((row) => {\n      const { doc } = row;\n      delete doc._rev;\n      return doc;\n    });\n\n    await fs.unlinkAsync(dbBackupFile.path);\n\n    const cloudant = new Cloudant({\n      url: this.config.db.url,\n      plugins: ['promises', 'retry'],\n    }).db;\n\n    try {\n      await cloudant.destroy(dbName);\n    } catch (error) {\n      //\n    }\n\n    await cloudant.create(dbName);\n\n    const result = await Db.connect(this.config, dbName).bulk({ docs });\n\n    return result;\n  }\n\n}\n\nmodule.exports = Tools;\n","const _ = require('lodash');\nconst Db = require('./db');\nconst ClientConfig = require('./client-config');\n\nclass Taxonomy {\n  constructor(config) {\n    this.config = config;\n  }\n\n  async create(taxonomy) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    clientConfig.taxonomies.push(taxonomy);\n\n    return cc.set(clientConfig);\n  }\n\n  async read(taxonomySlug) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    const taxonomy = _.find(clientConfig.taxonomies, { slug: taxonomySlug });\n\n    if (!taxonomy) {\n      throw Error(`Taxonomy not found: ${taxonomySlug}`);\n    }\n\n    return taxonomy;\n  }\n\n  async update(taxonomy) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    const index = _.findIndex(clientConfig.taxonomies, { slug: taxonomy.slug });\n\n    if (index === -1) {\n      throw Error(`Taxonomy not found: ${taxonomy.slug}`);\n    }\n\n    clientConfig.taxonomies.splice(index, 1, taxonomy);\n\n    return cc.set(clientConfig);\n  }\n\n  async delete(taxonomySlug) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    taxonomySlug = _.isArray(taxonomySlug) ? taxonomySlug : [taxonomySlug];\n\n    clientConfig.taxonomies = clientConfig.taxonomies.filter(taxonomy => taxonomySlug.indexOf(taxonomy.slug) === -1);\n\n    return cc.set(clientConfig);\n  }\n\n  async entitiesByTerm(term) {\n    const db = Db.connect(this.config);\n\n    const entityGroups = (await db.view('entity', 'byTaxonomyTerm', { keys: [term.id], group: true })).rows.map(row => row.value)[0];\n\n    if (!entityGroups) {\n      return [];\n    }\n\n    let entityIds = [];\n\n    _.forEach(entityGroups, (entities) => {\n      entityIds = entityIds.concat(entities);\n    });\n\n    entityIds = _.uniq(entityIds);\n\n    return (await db.fetch({ keys: entityIds, include_docs: true })).rows.map(row => row.doc);\n  }\n\n  async createTerm(taxonomySlug, term) {\n    const taxonomy = await this.read(taxonomySlug);\n\n    taxonomy.terms.push(term);\n\n    return this.update(taxonomy);\n  }\n\n  async updateTerm(term) {\n    let entities = await this.entitiesByTerm(term);\n\n    entities = entities.map((entity) => {\n      entity.fields = _.mapValues(entity.fields, (field) => {\n        if (field.type === 'taxonomy' && field.value) {\n          if (!field.value.terms) {\n            field.value.terms = [];\n          }\n\n          field.value.terms = field.value.terms.map((_term) => {\n            if (_term.id === term.id) {\n              _term.title = term.title;\n              _term.slug = term.slug;\n            }\n\n            if (!_term.parents) {\n              _term.parents = [];\n            }\n\n            _term.parents = _term.parents.map((parent) => {\n              if (parent.id === term.id) {\n                parent.title = term.title;\n                parent.slug = term.slug;\n              }\n              return parent;\n            });\n\n            return _term;\n          });\n        }\n\n        return field;\n      });\n      return entity;\n    });\n\n    return Db.connect(this.config).bulk({ docs: entities });\n  }\n\n  async deleteTerm(term) {\n    let entities = await this.entitiesByTerm(term);\n\n    entities = entities.map((entity) => {\n      entity.fields = _.mapValues(entity.fields, (field) => {\n        if (field.type === 'taxonomy' && field.value) {\n          if (!field.value.terms) {\n            field.value.terms = [];\n          }\n\n          field.value.terms = field.value.terms.filter((_term) => {\n            if (_term.id === term.id) {\n              return false;\n            }\n\n            if ((_term.parents || []).filter(parent => parent.id === term.id).length) {\n              return false;\n            }\n\n            return true;\n          });\n        }\n\n        return field;\n      });\n      return entity;\n    });\n\n    return Db.connect(this.config).bulk({ docs: entities });\n  }\n}\n\nmodule.exports = Taxonomy;\n","module.exports = require(\"hashids\");","module.exports = require(\"stripe\");","const _ = require('lodash');\nconst Stripe = require('stripe');\nconst Promise = require('bluebird');\nconst Hashids = require('hashids');\n\nconst ClientConfig = require('./client-config');\nconst Email = require('./email');\nconst Db = require('./db');\nconst Helpers = require('./helpers');\n\nclass StripeClass {\n  constructor(config) {\n    this.config = config;\n\n    this.stripe = Stripe(this.config.stripe.apiKey);\n    this.email = new Email(this.config);\n\n    this.hashids = new Hashids(this.config.slug, 6, '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ');\n  }\n\n  async getSettings() {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    let settings;\n\n    try {\n      settings = clientConfig.module.ecommerce;\n    } catch (error) {\n      throw new Error(error);\n    }\n\n    try {\n      settings.clientStripeAccountId = clientConfig.provider.stripe.stripe_user_id;\n    } catch (error) {\n      throw new Error(error);\n    }\n\n    settings.client = clientConfig.client;\n    settings.assets = clientConfig.assets;\n\n    return settings;\n  }\n\n  checkout(token, order) {\n    return new Promise((resolve, reject) => {\n      this.getSettings()\n        .then((settings) => {\n\n          const listId = _.get(settings, 'createsend.checkoutSubscriberListId');\n\n          if (order.subscribe && listId) {\n            this.email.subscribe(order.customerDetails, 'createsend', listId)\n              .then((result) => {\n                console.log(result);\n              }, (error) => {\n                console.error(error);\n              });\n          }\n\n          // lookup customer by email, create if not found\n          this.findOrCreateCustomer(order.customerDetails.email, order)\n            .then((customer) => {\n\n              // store order data (customer, items, address)\n              this.createOrder(order, customer)\n                .then((order) => {\n\n                  this.updateOrCreateStripeCustomer(settings.clientStripeAccountId, customer, token, order)\n                    .then((stripeCustomer) => {\n\n                      // update customer, append order to customer, update metadata\n                      this.updateCustomer(customer, stripeCustomer, order)\n                        .then((customer) => {\n\n                          // create charge, take fee\n                          this.createCharge(settings, stripeCustomer, customer, order)\n                            .then((updatedOrder) => {\n\n                              this.sendReceipt(settings, customer, order)\n                                .then((orderReceipt) => {\n\n                                  updatedOrder.messages.orderReceipt = orderReceipt;\n\n                                  this.sendNotification(settings, customer, order)\n                                    .then((orderNotification) => {\n\n                                      updatedOrder.messages.orderNotification = orderNotification;\n\n                                      // update order charge status, charge id\n                                      this.updateOrder(updatedOrder)\n                                        .then((finalOrder) => {\n\n                                          resolve(finalOrder);\n\n                                        }, reject);\n                                    }, reject);\n                                }, reject);\n                            }, reject);\n                        }, reject);\n                    }, reject);\n                }, reject);\n            }, reject);\n        }, reject)\n        .catch(reject);\n    });\n  }\n\n  retrieveAccount() {\n    return new Promise((resolve, reject) => {\n      this.getSettings()\n        .then((settings) => {\n          this.stripe.accounts.retrieve(settings.clientStripeAccountId)\n            .then(resolve, reject);\n        }, reject);\n    });\n  }\n\n  refund(order, amount) {\n    return new Promise((resolve, reject) => {\n      this.getSettings()\n        .then((settings) => {\n          this.stripe.refunds.create({\n            refund_application_fee: true,\n            charge: order.charge.id,\n            amount,\n          }, {\n            stripe_account: settings.clientStripeAccountId,\n          })\n            .then((refund) => {\n              this.stripe.charges.retrieve(order.charge.id, {\n                stripe_account: settings.clientStripeAccountId,\n              })\n                .then((charge) => {\n                  order.charge.status = charge.status;\n                  order.charge.amount = charge.amount;\n                  order.charge.amountRefunded = charge.amount_refunded;\n\n                  Helpers.createOrUpdate(this.config, order)\n                    .then(resolve, reject);\n                }, reject);\n            }, reject);\n        }, reject);\n    });\n  }\n\n  findOrCreateCustomer(email, order) {\n    return new Promise((resolve, reject) => {\n      Db.connect(this.config).view('ecommerce', 'customerByEmail', {\n        keys: [email],\n        include_docs: true,\n      })\n        .then((body) => {\n          if (body.rows.length) {\n            resolve(body.rows[0].doc);\n\n          } else {\n            const now = JSON.stringify(new Date()).replace(/\"/g, '');\n\n            const newCustomer = {\n              type: 'customer',\n              createdAt: now,\n              modifiedAt: now,\n              email: order.customerDetails.email,\n              name: order.customerDetails.name,\n              phone: order.customerDetails.phone,\n              billingAddress: order.billingAddress,\n              shippingAddress: order.shippingAddress,\n              orders: [],\n            };\n\n            Db.connect(this.config).insert(newCustomer)\n              .then((body) => {\n                newCustomer._id = body.id;\n                newCustomer._rev = body.rev;\n\n                resolve(newCustomer);\n              }, reject);\n          }\n        }, reject);\n    });\n  }\n\n  updateOrCreateStripeCustomer(clientStripeAccountId, customer, token, order) {\n    return new Promise((resolve, reject) => {\n      const stripeCustomer = {\n        source: token,\n        email: order.customer.email,\n        description: order.customer.name,\n        metadata: {\n          customer_id: customer._id,\n        // billingAddress: JSON.stringify(order.billingAddress),\n        // shippingAddress: JSON.stringify(order.shippingAddress)\n        },\n      };\n\n      if (customer.stripe && customer.stripe.customer.id) {\n        this.stripe.customers.update(customer.stripe.customer.id, stripeCustomer, {\n          stripe_account: clientStripeAccountId,\n        })\n          .then(resolve, (error) => {\n            if (error.type === 'StripeInvalidRequestError' && error.param === 'id') {\n              this.stripe.customers.create(stripeCustomer, {\n                stripe_account: clientStripeAccountId,\n              }).then(resolve, reject);\n\n            } else {\n              reject(error);\n            }\n          });\n\n      } else {\n        this.stripe.customers.create(stripeCustomer, {\n          stripe_account: clientStripeAccountId,\n        }).then(resolve, reject);\n      }\n    });\n  }\n\n  createOrder(order, customer) {\n    return new Promise((resolve, reject) => {\n      const items = order.items.map(item => ({\n        id: item.id,\n        title: item.title.replace(/<br\\s?>/ig, ' ').replace(/<\\/?p>|<\\/?span>/ig, ''),\n        price: item.price,\n        quantity: item.quantity,\n        metadata: item.metadata || {},\n      }));\n\n      const now = JSON.stringify(new Date()).replace(/\"/g, '');\n\n      const newOrder = {\n        type: 'order',\n        orderId: this.hashids.encode(new Date().getTime()),\n        createdAt: now,\n        modifiedAt: now,\n        customer: {\n          id: customer._id,\n          email: customer.email,\n          name: customer.name,\n        },\n        items,\n        shippingMethod: {\n          name: order.shippingMethod.name,\n          amount: Number(order.shippingMethod.amount),\n        },\n        subtotal: Number(order.subtotal),\n        tax: {\n          rate: order.tax.rate || 0,\n          includedInPrice: order.tax.includedInPrice || false,\n          total: order.tax.total || 0,\n          show: order.tax.show || false,\n        },\n        discount: {\n          code: order.discount.code || '',\n          name: order.discount.name || '',\n          total: order.discount.total || 0,\n        },\n        total: Number(order.total),\n        billingAddress: order.billingAddress,\n        shippingAddress: order.shippingAddress,\n        messages: {},\n        status: 'pending',\n        test: true,\n      };\n\n      Db.connect(this.config).insert(newOrder)\n        .then((body) => {\n          newOrder._id = body.id;\n          newOrder._rev = body.rev;\n\n          resolve(newOrder);\n        }, reject);\n    });\n  }\n\n  updateOrder(order) {\n    return new Promise((resolve, reject) => {\n      Db.connect(this.config).insert(order)\n        .then((body) => {\n          order._rev = body.rev;\n\n          resolve(order);\n        }, reject);\n    });\n  }\n\n  updateCustomer(customer, stripeCustomer, order) {\n    return new Promise((resolve, reject) => {\n      const now = JSON.stringify(new Date()).replace(/\"/g, '');\n\n      customer.modifiedAt = now;\n\n      if (!customer.orders) {\n        customer.orders = [];\n      }\n\n      customer.orders.push(order._id);\n\n      if (!customer.stripe) {\n        customer.stripe = {\n          customer: {\n            id: null,\n          },\n        };\n      }\n\n      customer.stripe.customer.id = stripeCustomer.id;\n\n      Db.connect(this.config).insert(customer)\n        .then((body) => {\n          customer._rev = body.rev;\n\n          resolve(customer);\n        }, reject);\n    });\n  }\n\n  createCharge(settings, stripeCustomer, customer, order) {\n    return new Promise((resolve, reject) => {\n      const amount = Number(order.total) * 100;\n\n      const charge = {\n        amount,\n        currency: settings.currency.iso.toLowerCase(),\n        customer: stripeCustomer.id,\n        capture: true,\n        description: order.orderId,\n        // shipping: order.shippingAddress, // fraud prevention, must follow expected schema\n        metadata: {\n          customer_id: customer._id,\n          order_id: order._id,\n        },\n        statement_descriptor: _.kebabCase(settings.storeName).toUpperCase(),\n        application_fee: Math.ceil(amount * 0.02),\n      };\n\n      this.stripe.charges.create(charge, {\n        stripe_account: settings.clientStripeAccountId,\n      })\n        .then((charge) => {\n\n          order.charge = {\n            paymentGateway: 'stripe',\n            id: charge.id,\n            status: charge.status,\n            currency: charge.currency.toUpperCase(),\n            amount: charge.amount,\n            amountRefunded: charge.amount_refunded,\n          };\n\n          order.test = !charge.livemode;\n\n          resolve(order);\n\n        }, reject);\n    });\n  }\n\n  sendReceipt(settings, customer, order) {\n    return new Promise((resolve, reject) => {\n      const templateData = {\n        settings,\n        order,\n      };\n\n      const emailOptions = {\n        from: `${settings.emailSenderName} <${settings.emailSenderAddress}>`,\n        to: customer.email,\n        subject: `Your order at ${settings.storeName} (${order.orderId})`,\n      };\n\n      const assetSlug = _.get(settings, 'assets.slug', this.config.slug);\n\n      this.email.sendEmail(emailOptions, `${assetSlug}/order-receipt`, templateData).then(resolve, reject);\n    });\n  }\n\n  sendNotification(settings, customer, order) {\n    return new Promise((resolve, reject) => {\n      const templateData = {\n        settings,\n        order,\n      };\n\n      const emailOptions = {\n        from: `${settings.emailSenderName} <${settings.emailSenderAddress}>`,\n        to: settings.emailSenderAddress,\n        subject: `New order at ${settings.storeName} (${order.orderId})`,\n      };\n\n      const assetSlug = _.get(settings, 'assets.slug', this.config.slug);\n\n      this.email.sendEmail(emailOptions, `${assetSlug}/order-notification`, templateData).then(resolve, reject);\n    });\n  }\n\n}\n\nmodule.exports = StripeClass;\n","module.exports = require(\"shippo\");","const Promise = require('bluebird');\nconst shippo = require('shippo');\n\nclass Shippo {\n  constructor(config) {\n    this.config = config;\n\n    this.shippo = shippo(config.shippo.token);\n  }\n\n  getQuote(address, parcel) {\n    return new Promise((resolve, reject) => {\n\n      const addressFrom = {\n        object_purpose: 'QUOTE',\n        zip: this.config.shippo.fromZip,\n        country: this.config.shippo.fromCountry,\n      };\n\n      const addressTo = {\n        object_purpose: 'QUOTE',\n        // 'name': address.name,\n        // 'company': '',\n        // 'street1': address.street1,\n        // 'street2': address.street2,\n        // 'city': address.city,\n        // 'state': '',\n        zip: address.zip,\n        country: address.country,\n        // 'phone': address.phone,\n        // 'email': address.email,\n        metadata: '',\n      };\n\n      parcel.distance_unit = 'cm';\n      parcel.mass_unit = 'kg';\n\n      this.shippo.shipment.create({\n        object_purpose: 'QUOTE',\n        address_from: addressFrom,\n        address_to: addressTo,\n        parcel,\n      })\n        .then((shipment) => {\n          const ratesReady = (shipment, attempts) => {\n            if ((shipment.object_status === 'QUEUED' || shipment.object_status === 'WAITING') && attempts < 10) {\n              this.shippo.shipment.retrieve(shipment.object_id).then((val) => {\n                ratesReady(val, attempts + 1);\n              });\n\n            } else {\n              this.shippo.shipment.rates(shipment.object_id)\n                .then((rates) => {\n                  resolve(rates);\n\n                }, (error) => {\n                  console.error('There was an error retrieving rates : %s', error);\n                  reject(error);\n                });\n            }\n          };\n\n          ratesReady(shipment, 0);\n\n        }, (error) => {\n          console.error('There was an error creating shipment: %s', error);\n          reject(error);\n        });\n\n    });\n  }\n\n}\n\nmodule.exports = Shippo;\n","const _ = require('lodash');\nconst ClientConfig = require('./client-config');\n\nclass Settings {\n  constructor(config) {\n    this.config = config;\n\n    return this;\n  }\n\n  async update(settings) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    clientConfig.client = _.merge({}, clientConfig.client, settings);\n\n    return cc.set(clientConfig);\n  }\n}\n\nmodule.exports = Settings;\n","module.exports = require(\"recursive-readdir\");","module.exports = require(\"babel-runtime/helpers/typeof\");","const path = require('path');\nconst _ = require('lodash');\nconst request = require('request-promise');\nconst readdir = require('recursive-readdir');\nconst Entity = require('./entity');\nconst ClientConfig = require('./client-config');\n\nclass Pdf {\n  constructor (config) {\n    this.config = config;\n  }\n\n  async getTemplates() {\n    const templates = {};\n\n    const files = await readdir(this.config.pdf.templatesPath);\n\n    files.forEach((file) => {\n      if (!/\\.js$/.test(file)) {\n        return;\n      }\n\n      const id = file\n        .replace(`${this.config.pdf.templatesPath}/`, '')\n        .replace('.js', '');\n\n      // eslint-disable-next-line\n      templates[id] = require(file);\n    });\n\n    return templates;\n  }\n\n  async getPayload (templateId, entityId, role) {\n    // if (!this.templates) {\n    //   this.templates = await this.getTemplates();\n    // }\n\n    // if (!this.templates[templateId]) {\n    //   throw new Error('Template not found');\n    // }\n\n    // eslint-disable-next-line\n    const template = require(path.resolve(this.config.pdf.templatesPath, templateId));\n\n    const entity = new Entity(this.config);\n\n    const entities = (await entity.entityList([entityId], 2, false, role)).map(row => row.doc);\n\n    if (entities.length === 0) {\n      throw new Error('Entity not found');\n    }\n\n    const payload = template(Entity.flattenValues(entities)[0]);\n\n    return payload;\n  }\n\n  async getPdf (payload) {\n    const cc = new ClientConfig(this.config);\n    const clientConfig = await cc.get();\n\n    const assetSlug = _.get(clientConfig, 'assets.slug', this.config.slug);\n    const assistPdfUrl = `${this.config.assist.url}/${assetSlug}/pdf/download`;\n\n    payload = typeof payload === 'object' ? JSON.stringify(payload).replace(/'/gi, '') : payload;\n\n    const response = await request({\n      method: 'POST',\n      uri: assistPdfUrl,\n      encoding: null,\n      form: {\n        payload,\n      },\n    });\n\n    return response;\n  }\n\n}\n\nmodule.exports = Pdf;\n","module.exports = require(\"jsonwebtoken\");","const jwt = require('jsonwebtoken');\n\nclass Jwt {\n  constructor(config) {\n    this.config = config;\n  }\n\n  signToken(payload, options = {}) {\n    return jwt.sign(payload, this.config.auth.tokenSecret, options);\n  }\n\n  verifyToken(token) {\n    return jwt.verify(token, this.config.auth.tokenSecret);\n  }\n}\n\nmodule.exports = Jwt;\n","const _ = require('lodash');\nconst Promise = require('bluebird');\nconst request = require('request-promise');\n\nmodule.exports = function (options) {\n  const defaultOptions = {\n    client_id: null,\n    access_token: null,\n    version: 'v1',\n    host: 'https://api.instagram.com',\n  };\n\n  options = _.merge({}, defaultOptions, options || {});\n\n  const _request = (method, endpoint, query) => new Promise((resolve, reject) => {\n    const requestOptions = {\n      method,\n      url: [options.host, options.version, endpoint].join('/'),\n      qs: {\n        access_token: query.access_token || options.access_token,\n        client_id: query.client_id || options.client_id,\n      },\n    };\n\n    requestOptions.qs = _.extend({}, requestOptions.qs, query);\n\n    request(requestOptions)\n      .then((response) => {\n        resolve(JSON.parse(response));\n      }, reject);\n  });\n\n  this.get = (endpoint, query) => _request('GET', endpoint, query);\n};\n","module.exports = require(\"deep-diff\");","module.exports = require(\"json-query\");","module.exports = require(\"embedly\");","const _ = require('lodash');\nconst Promise = require('bluebird');\nconst EmbedlyApi = require('embedly');\n\nclass Embedly {\n  constructor(config) {\n    this.config = config;\n  }\n\n  oembed(urls) {\n    return new Promise((resolve, reject) => {\n      const embedly = new EmbedlyApi({\n        key: this.config.embedly.apiKey,\n      });\n\n      const opts = {\n        urls: _.isArray(urls) ? urls : [urls],\n        format: 'json',\n      };\n\n      embedly.oembed(opts, (error, result) => {\n        if (error) {\n          reject(error);\n          return;\n        }\n\n        resolve(result);\n      });\n    });\n  }\n\n}\n\nmodule.exports = Embedly;\n","module.exports = require(\"node-sass\");","module.exports = require(\"i18n-iso-countries\");","module.exports = require(\"moment\");","module.exports = require(\"html-to-text\");","module.exports = require(\"mjml-mailchimp\");","module.exports = require(\"mjml-validator\");","module.exports = require(\"mjml-core\");","module.exports = require(\"mjml\");","module.exports = require(\"inky\");","module.exports = require(\"email-templates\");","module.exports = require(\"nodemailer-mailgun-transport\");","module.exports = require(\"createsend-node\");","module.exports = require(\"nodemailer\");","const _ = require('lodash');\nconst Promise = require('bluebird');\nconst Db = require('./db');\nconst Helpers = require('./helpers');\n\nclass Ecommerce {\n  constructor(config) {\n    this.config = config;\n  }\n\n  getType(type, query) {\n    return new Promise((resolve, reject) => {\n      query.sort = _.isString(query.sort) ? `\"${query.sort}\"` : query.sort;\n\n      Db.connect(this.config).search('ecommerce', type, query)\n        .then(resolve, reject);\n    });\n  }\n\n  setType(type, item) {\n    return new Promise((resolve, reject) => {\n      item.type = type;\n\n      Helpers.createOrUpdate(this.config, item)\n        .then(resolve, reject);\n    });\n  }\n\n  deleteType(items) {\n    return new Promise((resolve, reject) => {\n      items = items.map(item => ({\n        _id: item._id,\n        _rev: item._rev,\n        _deleted: true,\n      }));\n\n      Helpers.chunkUpdate(this.config, items, 1000)\n        .then(resolve, reject);\n    });\n  }\n\n  getOrder(orderId) {\n    return new Promise((resolve, reject) => {\n      Db.connect(this.config).view('ecommerce', 'orderByOrderId', {\n        key: orderId,\n        include_docs: true,\n      })\n        .then((body) => {\n          if (!body.rows.length) {\n            reject(new Error('Order not found'));\n            return;\n          }\n\n          resolve(body.rows[0].doc);\n        }, reject);\n    });\n  }\n\n  verifyDiscount(code) {\n    return new Promise((resolve, reject) => {\n      Db.connect(this.config).view('ecommerce', 'discountByCode', {\n        keys: [code],\n        include_docs: true,\n      })\n        .then((body) => {\n          if (body.rows.length) {\n            const discount = body.rows[0].doc;\n\n            const now = new Date().getTime();\n\n            const dateStart = new Date(Date.parse(discount.dateStart)).getTime();\n            const dateEnd = new Date(Date.parse(discount.dateEnd)).getTime();\n\n            if (dateStart > now) {\n              reject(new Error('Discount not valid (not begun)'));\n              return;\n\n            }\n\n            if (dateEnd < now) {\n              reject(new Error('Discount not valid (expired)'));\n              return;\n            }\n\n            resolve(discount);\n\n          } else {\n            reject(new Error({\n              statusCode: 404,\n              message: `Discount code not found (${code})`,\n            }));\n          }\n        }, reject);\n    });\n  }\n\n}\n\nmodule.exports = Ecommerce;\n","module.exports = require(\"querystring\");","const _ = require('lodash');\nconst querystring = require('querystring');\nconst axios = require('axios');\nconst ClientConfig = require('./client-config');\nconst Db = require('./db');\n\nconst providerTokenUri = {\n  google: 'https://www.googleapis.com/oauth2/v4/token',\n  instagram: 'https://api.instagram.com/oauth/access_token',\n  stripe: 'https://connect.stripe.com/oauth/token',\n  vimeo: 'https://api.vimeo.com/oauth/access_token',\n  spotify: 'https://accounts.spotify.com/api/token',\n};\n\nclass Auth {\n  constructor(config) {\n    this.config = config;\n  }\n\n  async authoriseUser(slug, userId) {\n    const isSuperUser = this.config.auth.superUserId.split(',').map(superUser => superUser.trim()).indexOf(userId) > -1;\n\n    if (isSuperUser) {\n      return {\n        id: userId,\n        role: 'super',\n      };\n    }\n\n    const clientConfig = await Db.connect(this.config, slug).get('config');\n\n    const user = _.find(clientConfig.users, { id: userId });\n\n    if (!user) {\n      throw Error(`User not found: ${userId}`);\n    }\n\n    if (!user.active) {\n      throw Error(`User not active: ${userId}`);\n    }\n\n    return user;\n  }\n\n  async authProvider(provider, params, userId = null, refresh = false) {\n    const cc = new ClientConfig(this.config);\n\n    const clientConfig = await cc.get();\n\n    const providerConfig = _.merge({}, this.config[provider], params);\n\n    let providerClientConfig;\n\n    if (userId) {\n      providerClientConfig = _.get(clientConfig, ['userSettings', userId, 'provider', provider], {});\n    } else {\n      providerClientConfig = _.get(clientConfig, ['provider', provider], {});\n    }\n\n    const data = {\n      grant_type: refresh ? 'refresh_token' : 'authorization_code',\n      code: params.code,\n      client_id: providerConfig.clientId,\n      client_secret: providerConfig.clientSecret,\n      redirect_uri: providerConfig.redirectUri,\n      refresh_token: providerClientConfig.refresh_token,\n    };\n\n    const uri = providerTokenUri[provider];\n\n    let providerAuth;\n\n    try {\n      providerAuth = (await axios.post(uri, querystring.stringify(data))).data;\n    } catch (error) {\n      throw new Error(JSON.stringify(error.response.data));\n    }\n\n    providerClientConfig = _.merge({}, providerClientConfig, providerAuth);\n    providerClientConfig.begins = Math.floor(new Date().getTime() / 1000);\n\n    if (provider === 'google') {\n      try {\n        providerClientConfig.user = (await axios.get(`https://www.googleapis.com/plus/v1/people/me?access_token=${providerClientConfig.access_token}`)).data;\n      } catch (error) {\n        console.error(error);\n      }\n    }\n\n    if (provider === 'spotify') {\n      try {\n        providerClientConfig.user = (await axios.get(`https://api.spotify.com/v1/me?access_token=${providerClientConfig.access_token}`)).data;\n      } catch (error) {\n        console.error(error);\n      }\n    }\n\n    if (userId) {\n      _.set(clientConfig, ['userSettings', userId, 'provider', provider], providerClientConfig);\n    } else {\n      _.set(clientConfig, ['provider', provider], providerClientConfig);\n    }\n\n    return cc.set(clientConfig);\n  }\n\n}\n\nmodule.exports = Auth;\n","module.exports = require(\"password-hash\");","const path = require('path');\n\nconst config = {\n  environment: process.env.ENVIRONMENT || 'development',\n  debug: process.env.DEBUG || false,\n\n  slug: process.env.SLUG,\n  baseUrl: process.env.BASE_URL || '',\n\n  db: {\n    url: process.env.DB_URL,\n    host: process.env.DB_HOST,\n    name: process.env.DB_NAME,\n    requestPlugin: process.env.DB_REQUEST_PLUGIN,\n    meterType: process.env.DB_METER_TYPE,\n  },\n\n  auth: {\n    superUserId: process.env.AUTH_SUPER_USER_ID,\n    tokenSecret: process.env.AUTH_TOKEN_SECRET || 'change_this_secret',\n  },\n\n  dev: {\n    userId: process.env.DEV_USER_ID || 'dev',\n    role: process.env.DEV_ROLE || 'super',\n  },\n\n  cms: {\n    title: process.env.CMS_TITLE,\n    url: process.env.CMS_URL,\n  },\n\n  assist: {\n    url: process.env.ASSIST_URL,\n    username: process.env.ASSIST_USERNAME,\n    password: process.env.ASSIST_PASSWORD,\n  },\n\n  pdf: {\n    templates: {},\n  },\n\n  email: {\n    templatesPath: path.resolve(__dirname, 'email'),\n  },\n\n  instagram: {\n    clientId: process.env.INSTAGRAM_CLIENT_ID,\n    clientSecret: process.env.INSTAGRAM_CLIENT_SECRET,\n  },\n\n  twitter: {\n    consumerKey: process.env.TWITTER_CONSUMER_KEY,\n    consumerSecret: process.env.TWITTER_CONSUMER_SECRET,\n    accessTokenKey: process.env.TWITTER_ACCESS_TOKEN_KEY,\n    accessTokenSecret: process.env.TWITTER_ACCESS_TOKEN_SECRET,\n  },\n\n  google: {\n    clientId: process.env.GOOGLE_CLIENT_ID,\n    clientSecret: process.env.GOOGLE_CLIENT_SECRET,\n  },\n\n  mailgun: {\n    apiKey: process.env.MAILGUN_API_KEY,\n    domain: process.env.MAILGUN_DOMAIN,\n  },\n\n  embedly: {\n    apiKey: process.env.EMBEDLY_API_KEY,\n  },\n\n  aws: {\n    iamAccessKeyId: process.env.AWS_IAM_ACCESS_KEY_ID,\n    iamAccessKeySecret: process.env.AWS_IAM_ACCESS_KEY_SECRET,\n\n    s3: {\n      bucket: process.env.AWS_S3_BUCKET,\n    },\n  },\n\n  shippo: {\n    token: process.env.SHIPPO_TOKEN,\n    fromZip: process.env.SHIPPO_FROM_ZIP,\n    fromCountry: process.env.SHIPPO_FROM_COUNTRY,\n  },\n\n  spotify: {\n    clientId: process.env.SPOTIFY_CLIENT_ID,\n    clientSecret: process.env.SPOTIFY_CLIENT_SECRET,\n  },\n\n  stripe: {\n    clientId: process.env.STRIPE_CLIENT_ID,\n    clientSecret: process.env.STRIPE_CLIENT_SECRET,\n    apiKey: process.env.STRIPE_API_KEY,\n  },\n\n  vimeo: {\n    clientId: process.env.VIMEO_CLIENT_ID,\n    clientSecret: process.env.VIMEO_CLIENT_SECRET,\n  },\n\n  zencoder: {\n    apiKey: process.env.ZENCODER_API_KEY,\n    s3: {\n      bucket: process.env.ZENCODER_S3_BUCKET,\n      credentials: process.env.ZENCODER_S3_CREDENTIALS,\n    },\n  },\n};\n\nmodule.exports = config;\n","function Api() { }\n\nApi.defaultConfig = require('./config.default');\n\nApi.Assist = (...args) => new (require('./lib/assist'))(...args);\nApi.Auth = (...args) => new (require('./lib/auth'))(...args);\nApi.ClientConfig = (...args) => new (require('./lib/client-config'))(...args);\nApi.Db = (...args) => new (require('./lib/db'))(...args);\nApi.Ecommerce = (...args) => new (require('./lib/ecommerce'))(...args);\nApi.Email = (...args) => new (require('./lib/email'))(...args);\nApi.Embedly = (...args) => new (require('./lib/embedly'))(...args);\nApi.Entity = (...args) => new (require('./lib/entity'))(...args);\nApi.Fields = (...args) => new (require('./lib/fields'))(...args);\nApi.Helpers = (...args) => new (require('./lib/helpers'))(...args);\nApi.Instagram = (...args) => new (require('./lib/instagram'))(...args);\nApi.Jwt = (...args) => new (require('./lib/jwt'))(...args);\nApi.Pdf = (...args) => new (require('./lib/pdf'))(...args);\nApi.Roles = (...args) => new (require('./lib/roles'))(...args);\nApi.Schema = (...args) => new (require('./lib/schema'))(...args);\nApi.Settings = (...args) => new (require('./lib/settings'))(...args);\nApi.Shippo = (...args) => new (require('./lib/shippo'))(...args);\nApi.Stripe = (...args) => new (require('./lib/stripe'))(...args);\nApi.Taxonomy = (...args) => new (require('./lib/taxonomy'))(...args);\nApi.Tools = (...args) => new (require('./lib/tools'))(...args);\nApi.User = (...args) => new (require('./lib/user'))(...args);\n\nmodule.exports = Api;\n"],"sourceRoot":""}