!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AceApiServer=t():e.AceApiServer=t()}(global,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=27)}([function(e,t){e.exports=require("babel-runtime/regenerator")},function(e,t){e.exports=require("babel-runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("babel-runtime/helpers/classCallCheck")},function(e,t){e.exports=require("babel-runtime/helpers/createClass")},function(e,t,n){"use strict";var r=i(n(0)),s=i(n(1)),a=i(n(3)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(7),l=n(9),d={_id:"config",client:{},assets:{},schemas:[],taxonomies:[],users:[],roles:(new(n(17))).roles(),provider:{},module:{}},f=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"get",value:function(){var e=(0,s.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=d,e.prev=1,e.next=4,c.connect(this.config).get("config");case 4:t=e.sent,t=o.merge({},d,t),e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:return t.slug=this.config.slug,e.abrupt("return",t);case 12:case"end":return e.stop()}},e,this,[[1,8]])}));return function(){return e.apply(this,arguments)}}()},{key:"set",value:function(){var e=(0,s.default)(r.default.mark(function e(t){return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t._id="config",delete t.roles,e.next=4,l.createOrUpdate(this.config,t);case 4:return t=e.sent,t=o.merge({},d,t),e.abrupt("return",t);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t){e.exports=require("bluebird")},function(e,t,n){"use strict";var r=a(n(3)),s=a(n(4));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(16),i=function(){function e(t,n){return(0,r.default)(this,e),this.config=t,e.connect(t,n)}return(0,s.default)(e,null,[{key:"connect",value:function(e,t){return new u({url:e.db.url,maxAttempt:5,plugins:["promises",{retry:{retryDelayMultiplier:2,retryInitialDelayMsecs:500}}]}).db.use(t||e.db.name)}}]),e}();e.exports=i},function(e,t){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,t,n){"use strict";var r=u(n(8)),s=u(n(3)),a=u(n(4));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(2),o=n(6),c=n(7),l=function(){function e(t){(0,s.default)(this,e),this.config=t,this.assistUrl=t.assist.url,this.slug=t.slug}return(0,a.default)(e,[{key:"thumbnailSrc",value:function(e,t,n,r){if(!e)return"";var s=void 0;"string"==typeof t&&(s=t.split(/,|;/),t={},s.forEach(function(e){e=e.split(/_|:/),t[e[0]]=e[1]}));var a=!!e.crops&&e.crops[n];a?(t.x=a[0],t.y=a[1],t.x2=a[2],t.y2=a[3]):r&&(t.g=r),s=[],i.forEach(t,function(e,t){s.push([t,e].join(":"))});var u=s.join(";");if(/(image)/.test(e.thumbnailType))return"svg"===e.ext?[this.assistUrl,this.slug,e.name+e.ext].join("/"):[this.assistUrl,this.slug,"transform",u,e.name+e.ext].join("/");if(/(video)/.test(e.thumbnailType))return[this.assistUrl,this.slug,"transform",u,e.name,"thumb.jpg"].join("/");if(/(oembed|proxy)/.test(e.thumbnailType)){var o=e.thumbnailUrl.replace(/https?:\/\//,"");return[this.assistUrl,this.slug,"proxy","transform",u,o].join("/")}return""}}],[{key:"createOrUpdate",value:function(e,t){return new o(function(n,r){c.connect(e).insert(t).then(function(e){t._id=e.id,t._rev=e.rev,n(t)},function(s){409===s.statusCode?c.connect(e).get(t._id).then(function(s){t._rev=s._rev,c.connect(e).insert(t).then(function(e){t._rev=e.rev,n(t)},r)},r):r(s)})})}},{key:"chunkUpdate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return new o(function(r,s){var a=[];i.chunk(t,n).forEach(function(t){a.push(new o(function(n,r){c.connect(e).bulk({docs:t}).then(n,r)}))}),o.all(a).then(r,s)})}},{key:"groupEntities",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=[],r={entities:[]};return e.forEach(function(e){(!e.groupBefore||r.entities.length>=t)&&(r={entities:[]}),r.entities.push(e),(!e.groupAfter||r.entities.length>=t)&&(r.ratio=0,r.entities.forEach(function(e){r.ratio+=(e.thumbnail||e).ratio}),r.entities.forEach(function(e){e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n}},{key:"now",value:function(){return(0,r.default)(new Date).replace(/"/g,"")}},{key:"replace",value:function(e,t,n){return e.map(function(e){return e[n]===t[n]?t:e})}}]),e}();e.exports=l},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("babel-runtime/core-js/object/keys")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";var r=i(n(0)),s=i(n(1)),a=i(n(3)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(10),l=n(48),d=n(5),f=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"deleteFiles",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new d(this.config),e.next=3,n.get();case 3:if(s=e.sent,a=o.get(s,"assets.slug",this.config.slug),0!==t.length){e.next=7;break}return e.abrupt("return",[]);case 7:return e.next=9,c.post(this.config.assist.url+"/"+a+"/file/delete",{fileNames:t},{auth:{username:this.config.assist.username,password:l.generate(this.config.assist.password)}});case 9:return u=e.sent.data,e.abrupt("return",u);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t){e.exports=require("@cloudant/cloudant")},function(e,t,n){"use strict";var r=u(n(18)),s=u(n(3)),a=u(n(4));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(2),o=[{name:"Admin",slug:"admin",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!0,settings:!0,userSettings:!0,tools:!0,ecommerce:!0}},{name:"Editor",slug:"editor",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!1,settings:!1,userSettings:!0,tools:!1,ecommerce:!1}},{name:"Guest",slug:"guest",permissions:{entityGrid:!0,entityCreate:!1,entityRead:!0,entityUpdate:!1,entityDelete:!1,taxonomyCreate:!1,taxonomyRead:!0,taxonomyUpdate:!1,taxonomyDelete:!1,fileCreate:!1,fileRead:!0,fileUpdate:!1,fileDelete:!1,config:!1,schema:!1,user:!1,settings:!1,userSettings:!1,tools:!1,ecommerce:!1}}],c=function(){function e(){(0,s.default)(this,e)}return(0,a.default)(e,[{key:"roles",value:function(){return o.map(function(e){return(0,r.default)(e)})}},{key:"role",value:function(e){return i.find(this.roles(),{slug:e})}}]),e}();e.exports=c},function(e,t){e.exports=require("babel-runtime/core-js/object/freeze")},function(e,t,n){"use strict";var r=a(n(3)),s=a(n(4));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(12),i=n(13),o=n(2),c=n(6),l=n(52),d=c.promisifyAll(n(53)),f=n(54),p=n(55),h=n(56).Inky,v=n(57),m=n(58).registerComponent,y=n(59).registerDependencies,g=n(60),x=g.McSection,b=g.McImage,w=n(61),k=n(62),_=n(63),E=n(64),S=n(5),T=n(9),q=function(){function e(t){(0,r.default)(this,e),this.config=t,this.inky=new h,m(x),m(b),y({"mc-section":["mj-column","mj-group","mj-raw"],"mj-column":["mc-image"],"mj-hero":["mc-image"]})}return(0,s.default)(e,[{key:"getTemplate",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new c(function(s,a){var c=o.merge({},{inlineStyles:!0,inky:!1,mjml:!1,skipValidation:!1},r),l=u.join(t.config.email.templatesPath,e);i.existsSync(l)||(l=u.resolve("../email",e));var d=i.readdirSync(l),f="html";o.find(d,function(e){return/^html\.mjml/.test(e)})&&(f="html.mjml",c.mjml=!0);var h=void 0;o.find(d,function(e){return/\.ejs$/.test(e)})&&(h="ejs");var m="";o.find(d,function(e){return/^style\.scss$/.test(e)})&&(m=E.renderSync({file:u.join(l,"style.scss"),sourceMapContents:!c.inlineStyles,sourceMapEmbed:!c.inlineStyles}).css.toString().replace(/"/g,"'"));var y=new p({views:{root:t.config.email.templatesPath,options:{extension:h}},juice:c.inlineStyles,juiceResources:{preserveMediaQueries:!0,preserveFontFaces:!0,removeStyleTags:!1,removeLinkTags:!1,preserveImportant:!0,webResources:{links:!1,scripts:!1,images:!1}},transport:{jsonTransport:!0}}),g=new S(t.config),x=new T(t.config);g.get().then(function(r){n=o.merge({},n,{config:o.merge({},o.pick(t.config,["cms"]),o.pick(r,["slug","client","assets"])),helpers:x,style:m,moment:k,countries:_,templateSlug:e}),y.render(e+"/"+f,n).then(function(e){if(c.mjml){var n=v(e,{level:c.skipValidation?"skip":"soft"});if(n.errors&&n.errors.length)return void a(n.errors);e=n.html}c.inky&&(e=t.inky.releaseTheKraken(e)),s({html:e,text:w.fromString(e)})},a)},a)})}},{key:"sendEmail",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return new c(function(a,u){var i=l.createTransport(f({auth:{api_key:n.config.mailgun.apiKey,domain:n.config.mailgun.domain}}));n.getTemplate(t,o.merge({},e,r),s).then(function(t){e.html=t.html,e.text=t.text,i.sendMail(e,function(t,n){t?u(t):a({metadata:n,email:e})})},u)})}},{key:"subscribe",value:function(e,t,n){var r=this;return new c(function(s,a){new S(r.config).get().then(function(r){if("createsend"===t){if(r.provider.createsend){var u=new d({apiKey:r.provider.createsend.clientApiKey});return void c.promisifyAll(u.subscribers).addSubscriberAsync(n,{EmailAddress:e.email,Name:e.name,Resubscribe:!0,RestartSubscriptionBasedAutoresponders:!0}).then(function(e){s("Email.subscribe(): "+e.emailAddress)}).catch(function(e){a(e.Message)})}a(new Error("Subscriber list not configured"))}},a)})}}]),e}();e.exports=q},function(e,t,n){"use strict";var r=c(n(8)),s=c(n(67)),a=c(n(0)),u=c(n(1)),i=c(n(3)),o=c(n(4));function c(e){return e&&e.__esModule?e:{default:e}}var l=n(2),d=n(6),f=n(68),p=n(69).diff,h=n(5),v=n(7),m=n(9),y=n(21),g=n(15),x=function(){function e(t){(0,i.default)(this,e),this.config=t,this.flattenValues=e.flattenValues}return(0,o.default)(e,[{key:"fieldValues",value:function(){var e=(0,u.default)(a.default.mark(function e(t,n){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.connect(this.config).viewWithList("entity","byField","search",{startkey:[t],endkey:[t,{}],group:!0,searchTerm:n});case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"_entitiesById",value:function(){var t=(0,u.default)(a.default.mark(function t(){var n,r,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return a.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return u=l.merge({parents:!1,role:"guest"},u),n={include_docs:!0},s.length&&(n.keys=s),t.next=5,v.connect(this.config).view("entity",u.parents?"byIdExtended":"byId",n);case 5:return r=t.sent,r=e._appendParents(r,u.parents,u.role),t.abrupt("return",r);case 8:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"_getDocMap",value:function(){var t=(0,u.default)(a.default.mark(function t(n){var r,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return a.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i._childDepth=i._childDepth||0,i.parents||i.children){t.next=3;break}return t.abrupt("return",u);case 3:if(r=[],n.forEach(function(t){var n=!!t.doc,s=n?t.doc:t;i.children&&s.fields&&l.size(s.fields)&&(l.isArray(i.children)?e._queriesFromString(i.children[i._childDepth]).forEach(function(t){r=r.concat(l.flatten(e._query(s,t,!0).value).map(function(e){return e&&e.id}))}):l.forEach(s.fields,function(e){l.isArray(e.value)&&(e.value=e.value.filter(function(e){return e}),e.value.forEach(function(e){e.id&&r.push(e.id)}))}));var a=n?t.id:s._id||s.id;u[a]||r.push(a)}),0!==(r=(r=l.uniq(r)).filter(function(e){return!u[e]})).length){t.next=9;break}return t.abrupt("return",u);case 9:return t.next=11,this._entitiesById(r,i);case 11:if(t.t0=function(e){return e.doc},(n=t.sent.rows.map(t.t0)).forEach(function(e){u[e._id]=e}),i.children&&i._childDepth!==e._childDepthLimit(i.children)){t.next=16;break}return t.abrupt("return",u);case 16:return t.next=18,this._getDocMap(n,u,(0,s.default)({},i,{_childDepth:i._childDepth+1}));case 18:return u=t.sent,t.abrupt("return",u);case 20:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_extendDocs",value:function(){var t=(0,u.default)(a.default.mark(function t(n){var r,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return a.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return s=l.merge({select:!1,children:!1,parents:!1,role:"guest"},s),t.next=3,this._getDocMap(n,{},s);case 3:return r=t.sent,n=e._mergeDocs(n,r,s),s.select&&(n=l.flatten(e._query(n,s.select).value)),r=null,t.abrupt("return",n);case 8:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_removeChildren",value:function(e){var t=this;return new d(function(n,r){0!==e.length?(e=e.map(function(e){return e._id}),v.connect(t.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(function(s){var a=l.uniqBy(s.rows,function(e){return e.doc._id}).map(function(t){return t.doc.fields=l.mapValues(t.doc.fields,function(t){return l.isArray(t.value)&&(t.value=l.filter(t.value,function(t){return!("entity"===t.type&&-1!==e.indexOf(t.id))})),t}),t.doc});0!==a.length?m.chunkUpdate(t.config,a,1e3).then(n,r):n([])},r)):n([])})}},{key:"_updateChildren",value:function(e){var t=this;return new d(function(n,r){if(0!==e.length){var s={};e=e.map(function(e){return s[e._id]=e,e._id}),v.connect(t.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(function(e){var a=e.rows.map(function(e){var t=e.doc;return l.forEach(t.fields,function(e,n){l.isArray(e.value)&&(t.fields[n].value=e.value.filter(function(e){return e}).map(function(e){return"entity"===e.type&&s[e.id]&&(e.slug=s[e.id].slug,e.title=s[e.id].title,e.schema=s[e.id].schema,e.published=s[e.id].published,s[e.id].thumbnail?e.thumbnail=s[e.id].thumbnail:e.thumbnail=null),e}))}),t});m.chunkUpdate(t.config,a,1e3).then(n,r)},r)}else n([])})}},{key:"entityList",value:function(){var e=(0,u.default)(a.default.mark(function e(){var t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=l.merge({select:!1,children:!1,parents:!1,role:"guest"},s),e.next=3,this._entitiesById(r,s);case 3:return t=e.sent,e.next=6,this._extendDocs(t.rows,s);case 6:return n=e.sent,e.abrupt("return",n);case 8:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_entitySearch",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new d(function(s,a){e.limit=Math.min(e.limit||200,200),e.sort=l.isString(e.sort)?'"'+e.sort+'"':e.sort,n.children&&(e.include_docs=!0),e.include_fields||(e.include_fields=[]),l.isArray(e.include_fields)&&(e.include_fields=(0,r.default)(e.include_fields)),e.sort||delete e.sort,e.bookmark||delete e.bookmark,e.index||delete e.index,e.group_field||delete e.group_field,v.connect(t.config).search("entity",e.index||"all",e).then(function(e){if(e.groups){var r=[];return e.groups=e.groups.map(function(e){return r.push(new d(function(r,s){(n.children||n.parents)&&0!==e.total_rows?t._extendDocs(e.hits,n).then(function(t){e.hits=t,r()},s):r()})),e}),void d.all(r).then(function(){s(e)},a)}t._extendDocs(e.rows,n).then(function(t){e.rows=t,s(e)},a)},a)})}},{key:"entitySearch",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return n=l.merge({children:!1,parents:!1,role:"guest"},n),new d(function(r,s){var a=e.limit||25;if(a<=200)t._entitySearch(e,n).then(r,s);else{var u=[],i=[];(function t(o){var c=this,d=l.clone(e);o&&(d.bookmark=o),this._entitySearch(d,n).then(function(e){e.rows&&(u=u.concat(e.rows)),e.groups&&(i=i.concat(e.groups)),u.length<e.total_rows&&u.length<a?t.call(c,e.bookmark):(e.rows=u,e.groups=i,r(e))},s)}).call(t)}})}},{key:"entityFind",value:function(){var e=(0,u.default)(a.default.mark(function e(t){var n,r,s,u,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=l.merge({children:!1,parents:!1,role:"guest"},i),n=void 0,e.prev=2,e.next=5,v.connect(this.config).find(t);case 5:n=e.sent,e.next=21;break;case 8:if(e.prev=8,e.t0=e.catch(2),"no_usable_index"!==e.t0.error){e.next=21;break}return r=new h(this.config),e.next=14,r.get();case 14:return s=e.sent,u=new y(this.config),e.next=18,u.updateEntityIndex(s.schemas);case 18:return e.next=20,v.connect(this.config).find(t);case 20:n=e.sent;case 21:if(!1!==i.children){e.next=23;break}return e.abrupt("return",n);case 23:if(!t.fields||-1!==t.fields.indexOf("_id")){e.next=25;break}throw new Error("_id field required for `children`");case 25:return e.next=27,this._extendDocs(n.docs,i);case 27:return n.docs=e.sent,e.abrupt("return",n);case 29:case"end":return e.stop()}},e,this,[[2,8]])}));return function(t){return e.apply(this,arguments)}}()},{key:"entityRevisions",value:function(t){var n=this;return new d(function(s,a){v.connect(n.config).get(t,{revs_info:!0}).then(function(u){var i=[];u._revs_info.forEach(function(e){"available"===e.status&&i.push(e.rev)}),v.connect(n.config).get(t,{open_revs:(0,r.default)(i)}).then(function(t){var r=[],u=[];t.forEach(function(e){e.ok&&(r.push(e.ok),l.forEach(e.ok.fields,function(e){/entity/.test(e.type)&&l.forEach(e.value,function(e){e.id&&u.push(e.id)})}))}),v.connect(n.config).fetch({keys:l.uniq(u),include_docs:!0}).then(function(t){var n={};t.rows.forEach(function(e){try{n[e.doc._id]=e.doc}catch(e){console.error("Error: child no longer exists")}}),s(e._appendChildren(r,n))},a)},a)},a)})}},{key:"entityCreate",value:function(e){var t=this;return new d(function(n,r){e.type="entity",v.connect(t.config).insert(e).then(function(t){e._id=t.id,e._rev=t.rev,n(e)},r)})}},{key:"entityRead",value:function(e){var t=this;return new d(function(n,r){v.connect(t.config).get(e).then(n,r)})}},{key:"entityUpdate",value:function(){var e=(0,u.default)(a.default.mark(function e(t,n){var r,s,u,i,o,c;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=l.isArray(t)?t:[t],r={},s=t.map(function(e){var t=void 0;return l.isObject(e)&&(t=e._id,r[t]=e),l.isString(e)&&(t=e),t}),e.next=5,v.connect(this.config).fetch({keys:s,include_docs:!0});case 5:if(u=e.sent,i=[],o=[],t=u.rows.map(function(e){var t=e.doc,a=r[t._id],u=t;a&&(delete a._rev,p(t,a).forEach(function(e){if(/published|slug|title|thumbnail/.test(e.path[0])&&-1===i.indexOf(a)&&-1!==s.indexOf(a._id)&&i.push(a),"fields"===e.path[0]&&"value"===e.path[2]){var n=t.fields[e.path[1]];/attachment|image|audio|video/.test(n.type)&&n.value&&o.push(n.value.file.name)}}),u=l.mergeWith({},t,a,function(e,t){if(l.isArray(e)&&l.isArray(t))return t}));return n&&(u.trashed=!1),u}),o.length,!i.length){e.next=13;break}return e.next=13,this._updateChildren(i);case 13:return e.next=15,m.chunkUpdate(this.config,t,1e3);case 15:return c=e.sent,e.abrupt("return",c);case 17:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"entityDelete",value:function(){var t=(0,u.default)(a.default.mark(function t(n){var r,s,u,i,o,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return a.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=void 0,s=void 0,"trashed"!==n){t.next=9;break}return c=!0,t.next=6,v.connect(this.config).view("entity","trashed",{include_docs:!0});case 6:r=t.sent.rows,t.next=12;break;case 9:return t.next=11,v.connect(this.config).fetch({keys:l.isArray(n)?n:[n],include_docs:!0});case 11:r=t.sent.rows;case 12:return r=(r=r.filter(function(e){return!e.value||!e.value.deleted})).map(function(e){return e.doc}),t.next=16,this._removeChildren(r);case 16:if(!c){t.next=26;break}if(!(u=e._fileNames(r)).length){t.next=23;break}return i=new g(this.config),t.next=22,i.deleteFiles(u);case 22:s=t.sent;case 23:r=r.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}}),t.next=27;break;case 26:r=r.map(function(e){return e.trashed=!0,e});case 27:return t.next=29,m.chunkUpdate(this.config,r,1e3);case 29:return o=t.sent,t.abrupt("return",{entities:o,files:s});case 31:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}],[{key:"flattenValues",value:function(t){return t.map(function(t){return t.fields&&l.size(t.fields)?(t.fields=l.mapValues(t.fields,function(t){return/entity/.test(t.type)&&l.isArray(t.value)&&(t.value=e.flattenValues(t.value)),t.value}),t):t})}},{key:"filterEntityFields",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"guest",n=l.isArray(e);return e=(n?e:[e]).map(function(e){return l.size(e.fields)&&(e.fields=l.mapValues(e.fields,function(e){return l.isArray(e.value)&&(e.value=e.value.filter(function(e){return!!e&&(!e.type||"entity"!==e.type||"guest"!==t||(void 0===e.published||e.published))})),e})),e}),n?e:e[0]}},{key:"_appendChildren",value:function(e,t){return e.map(function(e){return l.size(e.fields)?(e.fields=l.mapValues(e.fields,function(e){return l.isArray(e.value)&&(e.value=e.value.filter(function(e){return!!e&&("entity"!==e.type||void 0!==t[e.id])}),e.value=e.value.map(function(e){return"entity"===e.type&&(e=l.merge(e,t[e.id])),e=l.omitBy(e,function(e,t){return t.startsWith("_")})})),e}),e):e})}},{key:"_appendParents",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"guest",s={};return t.rows.forEach(function(e){e.doc&&"entity"===e.value.type&&(n&&(e.doc.parents=[]),s[e.id]=e.doc)}),n&&(t.rows.forEach(function(t){t.doc&&"parent"===t.value.type&&s[t.key].parents.push(e.filterEntityFields(t.doc,r))}),s=l.mapValues(s,function(e){return e.parents=l.uniqBy(e.parents,function(e){return e._id}),e})),s=null,t}},{key:"_fileNames",value:function(e){var t=[];return e.forEach(function(e){l.forEach(e.fields,function(e){e.value&&e.value.file&&t.push(e.value.file.name)})}),l.uniq(t)}},{key:"_query",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t=t.replace(/(\s\s|\t|\r|\n)/g,""),n){var r=t.trim().split(/\[|\]/);t=""+("fields."+r[0]+".value["+(r[1]||"*")+"]")+(/\]:/.test(t)?":"+t.split(/\]:/).slice(-1)[0].trim():"")}return f(t,{data:e,locals:{slice:function(e,t,n){return l.slice(e,t,n)},sample:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return l.sampleSize(e,t)},group:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=[],r=[];return e.forEach(function(e){(!e.groupBefore||r.length>=t)&&(r=[]),r.push(e),(!e.groupAfter||r.length>=t)&&(r.ratio=0,r.forEach(function(e){r.ratio+=(e.thumbnail||e).ratio}),r.forEach(function(e){e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n},pick:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return l.map(e,function(e){var t={id:e.id||void 0};return(n=n.filter(function(e){return e})).forEach(function(n){var r=n.match(/([^\s]+)/g),s=r[0],a=r[r.length-1];l.set(t,a,l.get(e,s))}),t})}},allowRegexp:!0})}},{key:"_queriesFromString",value:function(e){var t=(e=e.replace(/(\s\s|\t|\r|\n)/gm,"")).match(/\(([^)]+)\)/g),n=(e=e.replace(/\(.*?\)/g,"()")).split(/,(?![^([]*[\])])/g);return n=n.map(function(e){var n=e.match(/\(\)/g);return n&&l.times(n.length,function(){e=e.replace("()",t.splice(0,1))}),e.trim()})}},{key:"_childDepthLimit",value:function(e){var t=0;return l.isNumber(e)&&(t=e-1),l.isArray(e)&&(t=e.length-1),t}},{key:"_mergeDocs",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{children:!1,parents:!1};return r._childDepth=r._childDepth||0,r.children&&r._childDepth-1===e._childDepthLimit(r.children)?t:t=t.map(function(t){var a=!!t.doc,u=a?t.doc:t;if(n[t.id||t._id]&&(u=n[t.id||t._id]),r.children&&u.fields&&l.size(u.fields)){var i=void 0;l.isArray(r.children)&&(i={},e._queriesFromString(r.children[r._childDepth]).forEach(function(e){var t=e.split(/\[|\]/)[0];i[t]=e})),u.fields=l.mapValues(u.fields,function(t,a){return l.isArray(t.value)&&(t.value=t.value.filter(function(e){return e}),(!i||i&&i[a])&&(i&&i[a]&&(t.value=t.value.filter(function(e){return e.id&&n[e.id]})),t.value=t.value.map(function(e){return e&&e.id&&n[e.id]&&(e=l.merge(e,n[e.id]||{}),e=l.omitBy(e,function(e,t){return t.startsWith("_")})),e}),t.value=e._mergeDocs(t.value,n,(0,s.default)({},r,{_childDepth:r._childDepth+1})))),t}),u.fields=l.mapValues(u.fields,function(t,n){return l.isArray(t.value)&&i&&i[n]&&(t.value=l.flatten(e._query(u,i[n],!0).value)),t})}return l.isArray(r.parents)&&u.parents&&(u.parents=l.flatten(e._query(u.parents,r.parents[0]).value)),a?t.doc=u:t=u,t})}}]),e}();e.exports=x},function(e,t,n){"use strict";var r=i(n(0)),s=i(n(1)),a=i(n(3)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(5),l=n(7),d=n(22),f=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(s=e.sent).schemas.push(t),e.next=7,this.updateEntityIndex(s.schemas);case 7:return e.abrupt("return",n.set(s));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(s=e.sent,a=o.find(s.schemas,{slug:t})){e.next=7;break}throw Error("Schema not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(s=e.sent,-1!==(a=o.findIndex(s.schemas,{slug:t.slug}))){e.next=7;break}throw Error("Schema not found: "+t.slug);case 7:return s.schemas.splice(a,1,t),e.next=10,this.updateEntityIndex(s.schemas);case 10:return e.abrupt("return",n.set(s));case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return s=e.sent,t=o.isArray(t)?t:[t],s.schemas=s.schemas.filter(function(e){return-1===t.indexOf(e.slug)}),s.schemas=s.schemas.map(function(e){return e.fields?(e.fields=e.fields.map(function(e){return e.settings?(e.settings.schemas&&(e.settings.schemas=e.settings.schemas.filter(function(e){return-1===t.indexOf(e)})),e):e}),e):e}),e.next=9,this.updateEntityIndex(s.schemas);case 9:return e.abrupt("return",n.set(s));case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateAll",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(s=e.sent).schemas=t,e.abrupt("return",n.set(s));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateEntityIndex",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],t.forEach(function(e){n=n.concat(e.fields)}),n=o.uniqBy(n,"slug"),s={name:"entity",type:"text",ddoc:"entityIndex",index:{default_field:{enabled:!0,analyzer:"standard"},selector:{$and:[{type:"entity"}]},fields:[{name:"published",type:"boolean"},{name:"trashed",type:"boolean"},{name:"title",type:"string"},{name:"slug",type:"string"},{name:"schema",type:"string"},{name:"modifiedAt",type:"string"},{name:"publishedAt",type:"string"}]}},n.forEach(function(e){var t=d.field(e.type);/number|string|boolean/.test(t.dataType)&&s.index.fields.push({name:"fields."+e.slug+".value",type:t.dataType}),/array/.test(t.dataType)&&s.index.fields.push({name:"fields."+e.slug+".value.[].slug",type:"string"}),/taxonomy/.test(e.type)&&s.index.fields.push({name:"fields."+e.slug+".value.terms.[].slug",type:"string"})}),e.next=7,l.connect(this.config).index(s);case 7:return a=e.sent,e.abrupt("return",a);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t,n){"use strict";var r=u(n(18)),s=u(n(3)),a=u(n(4));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(2),o=[{type:"attachment",name:"Attachment",dataType:null},{type:"audio",name:"Audio",dataType:null},{type:"checkbox",name:"Checkbox",dataType:"boolean"},{type:"color",name:"Color",dataType:"string"},{type:"date",name:"Date",dataType:"string"},{type:"embedly",name:"Embedly",dataType:null},{type:"entity",name:"Entity",dataType:"array"},{type:"entityGrid",name:"Entity Grid",dataType:"array"},{type:"entityTile",name:"Entity Tile",dataType:"array"},{type:"image",name:"Image",dataType:null},{type:"keyValue",name:"Key Value",dataType:null},{type:"number",name:"Number",dataType:"number"},{type:"richText",name:"Rich Text",dataType:null},{type:"select",name:"Select",dataType:"array"},{type:"taxonomy",name:"Taxonomy",dataType:null},{type:"text",name:"Text",dataType:"string"},{type:"textArea",name:"Text Area",dataType:"string"},{type:"user",name:"User",dataType:"array"},{type:"video",name:"Video",dataType:null},{type:"vimeo",name:"Vimeo",dataType:null}],c=function(){function e(){(0,s.default)(this,e)}return(0,a.default)(e,null,[{key:"fields",value:function(){return o.map(function(e){return(0,r.default)(e)})}},{key:"field",value:function(t){return i.find(e.fields(),{type:t})}}]),e}();e.exports=c},function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("babel-runtime/helpers/typeof")},function(e,t,n){"use strict";var r={environment:process.env.ENVIRONMENT||"development",api:{prefix:process.env.API_PREFIX||"",forceHttps:!!process.env.API_FORCE_HTTPS&&JSON.parse(process.env.API_FORCE_HTTPS),blacklistToken:(process.env.API_BLACKLIST_TOKEN||"").split(","),blacklistReferrer:(process.env.API_BLACKLIST_REFERRER||"").split(",")},session:{secret:process.env.SESSION_SECRET||"change_me",ttl:parseInt(process.env.SESSION_TTL||7200,10)},cache:{enabled:!!process.env.CACHE_ENABLED&&JSON.parse(process.env.CACHE_ENABLED),ttl:60*parseInt(process.env.CACHE_TTL||30,10),compress:!!process.env.CACHE_COMPRESS&&JSON.parse(process.env.CACHE_COMPRESS),memory:{max:1e3*parseInt(process.env.CACHE_MEMORY_MAX||128,10)*1e3}},redis:{url:process.env.REDIS_URL,host:process.env.REDIS_HOST,port:process.env.REDIS_PORT,password:process.env.REDIS_PASSWORD,db:parseInt(process.env.REDIS_DB||0,10)},logentriesToken:process.env.LOGENTRIES_TOKEN};e.exports=r},function(e,t){e.exports=require("lodash/isArray")},function(e,t,n){"use strict";var r=process.env.PORT||5e3,s=process.env.HOST||"localhost",a=n(2),u=n(14),i=n(28),o=n(29),c=n(30),l=n(31),d=n(32),f=n(33),p=n(34),h=n(35)(p),v=n(36),m=n(25);e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=a.merge({},m,e),y=u(),g={secret:n.session.secret,resave:!0,saveUninitialized:!0};if(n.redis.url||n.redis.host){var x={ttl:n.session.ttl};n.redis.url?x.url=n.redis.url:(x.host=n.redis.host,x.port=n.redis.port,x.password=n.redis.password,x.db=n.redis.db),g.store=new h(x)}else g.cookie={maxAge:n.session.ttl};if(y.use(c()),y.use(o("tiny")),y.use(l()),y.use(d.json({limit:"50mb"})),y.use(d.urlencoded({extended:!0,limit:"50mb"})),y.use(f()),y.use(p(g)),v(y,n),t){var b=i.createServer(y);b.on("listening",function(){console.log("listening: http://"+s+":"+r)}),b.listen(r)}return y}},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("method-override")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("connect-redis")},function(e,t,n){"use strict";var r=i(n(11)),s=i(n(0)),a=i(n(1)),u=i(n(8));function i(e){return e&&e.__esModule?e:{default:e}}process.on("unhandledRejection",function(e){return console.error(e)});var o=n(2),c=n(14),l=n(37),d=n(38),f=n(6),p=n(39),h=f.promisifyAll(n(40)),v=n(41),m=n(42),y=n(43),g=n(44),x=n(45),b=n(46),w=43981,k=n(25);e.exports=function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,E=g(o.merge({},b.defaultConfig,k,i)),S=function(e){return function(t,n,r){f.resolve(e(t,n,r)).catch(r)}},T=function(e){return"development"===E.environment&&o.find(["/token","/email"],function(t){return new RegExp("^"+t).test(e.path)})},q=_||function(e,t,n){if(!T(e))return e.session.userId?void n():(t.status(401),void t.send({code:401,message:"Not authorised"}));n()},A=function(e){return o.mergeWith({},JSON.parse((0,u.default)(e)),function e(t){return o.forIn(t,function(t,n,r){o.isPlainObject(t)&&(t=e(t),0===o.keys(t).length&&delete r[n]),o.isUndefined(t)&&delete r[n]}),t}(o.cloneDeep(e)))},I=function(){var e=(0,a.default)(s.default.mark(function e(n){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(r=A(E)).slug=n,r.db.name=n,e.abrupt("return",r);case 4:case"end":return e.stop()}},e,t)}));return function(t){return e.apply(this,arguments)}}(),C=void 0;if(E.cache.enabled)if(E.redis.url||E.redis.host){var M={ttl:E.cache.ttl};E.redis.url?M.url=E.redis.url:(M.host=E.redis.host,M.port=E.redis.port,M.password=E.redis.password,M.db=E.redis.db);var O=(C=l.caching(o.merge({store:d},M))).store.getClient();O.on("ready",function(){console.log("redis: ready")}),O.on("error",function(e){console.error("redis: error:",e)})}else C=l.caching({store:"memory",ttl:E.cache.ttl,max:E.cache.memory.max,length:function(e){var t=y(e);return t}});var R=function(e){var t={path:e.path,query:e.query,body:e.body};return e.session.slug+":"+x.h64((0,u.default)(t),w).toString(16)},N=S(function(){var e=(0,a.default)(s.default.mark(function e(n,r,a){var u,i;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!E.cache.enabled||"guest"!==n.session.role||!1===(n.query.__cache&&JSON.parse(n.query.__cache))){e.next=22;break}return e.prev=2,u=R(n),e.next=6,C.get(u);case 6:if("string"!=typeof(i=e.sent)){e.next=17;break}if(!E.cache.compress){e.next=12;break}return e.next=11,h.gunzipAsync(Buffer.from(i,"base64"));case 11:i=e.sent.toString();case 12:try{i=JSON.parse(i)}catch(e){}return r.set("X-Cached-Response",!0),r.status(i?200:204),r.send(i),e.abrupt("return");case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(2),console.error(e.t0);case 22:r.set("X-Cached-Response",!1),a();case 24:case"end":return e.stop()}},e,t,[[2,19]])}));return function(t,n,r){return e.apply(this,arguments)}}()),D=function(){var e=(0,a.default)(s.default.mark(function e(n,r,a){var u,i,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===a||null===a?(a="",r.status(204),r.send(a)):(a=m.stringify(a),r.status(200),r.send(JSON.parse(a))),!o||!E.cache.enabled||"guest"!==n.session.role){e.next=9;break}if(u=R(n),!E.cache.compress){e.next=7;break}return e.next=6,h.gzipAsync(Buffer.from(a));case 6:a=e.sent.toString("base64");case 7:i=n.query.__cache?parseInt(n.query.__cache,10):E.cache.ttl,C.set(u,a,{ttl:i});case 9:case"end":return e.stop()}},e,t)}));return function(t,n,r){return e.apply(this,arguments)}}(),j=b.Jwt(E),U=c.Router();"production"===E.environment&&!0===E.api.forceHttps&&(e.enable&&e.enable("trust proxy"),e.use(function(e,t,n){e.headers["x-forwarded-proto"]&&"https"!==e.headers["x-forwarded-proto"]&&e.headers["cf-visitor"]&&"https"!==JSON.parse(e.headers["cf-visitor"]).scheme?t.redirect(301,"https://"+e.headers.host+e.path):n()})),e.use("/"+E.api.prefix,function(e,t,n){var r={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,PUT,POST,DELETE,OPTIONS","Access-Control-Expose-Headers":"X-Slug, X-Role, X-User-Id",Vary:"Accept-Encoding, X-Api-Token"};e.headers["access-control-request-headers"]&&(r["Access-Control-Allow-Headers"]=e.headers["access-control-request-headers"]),t.set(r),"OPTIONS"!==e.method?n():t.sendStatus(200)},function(e,t,n){if(T(e))n();else{var r=e.headers.referrer||e.headers.referer;if(r){var s=new p(r).hostname.split(".").slice(-2).join(".");if(E.api.blacklistReferrer.indexOf(s)>-1)return t.status(401),void t.send({code:401,message:"Not authorised, referrer blacklisted"})}var a=e.headers["x-api-token"]||e.query.apiToken||e.session.apiToken;if(!a)return t.status(401),void t.send({code:401,message:"Not authorised, missing token"});if(E.api.blacklistToken.indexOf(a)>-1)return t.status(401),void t.send({code:401,message:"Not authorised, token blacklisted"});try{var u=j.verifyToken(a);e.session.userId=u.userId,e.session.slug=u.slug,e.session.role=u.role||"guest"}catch(e){return t.status(401),void t.send({code:401,message:"Not authorised, token verification failed ("+e.message+")",error:e})}if(!e.session.slug)return t.status(401),void t.send({code:401,message:"Not authorised, missing slug"});e.session.role||(e.session.role="guest"),e.session.userId&&t.set("X-User-Id",e.session.userId),t.set("X-Environment",E.environment),t.set("X-Slug",e.session.slug),t.set("X-Role",e.session.role),n()}},U),e.get("/"+E.api.prefix,function(e,t){t.send("<pre> ______\n|A     |\n|  /\\  |\n| /  \\ |\n|(    )|\n|  )(  |\n|______|</pre>")});var P={app:e,router:U,cache:C,authMiddleware:q,permissionMiddleware:function(e,t,n,r){if(!t.session.role)return n.status(401),void n.send({permissions:e,message:"Error: role not defined in session."});if("super"!==t.session.role){var s=b.Roles();o.isString(e)&&(e=e.split(","));var a=!1;if(e.forEach(function(e){s.role(t.session.role).permissions[e.trim()]&&(a=!0)}),!s.role(t.session.role)||!a)return n.status(401),void n.send({permissions:e,message:"Sorry, you're not authorised to do this."});r()}else r()},cacheMiddleware:N,asyncMiddleware:S,getConfig:I,handleResponse:D,handleError:function(e,t,n){"[object Object]"===Object.prototype.toString.call(n)&&(n=m.parse(m.stringify(n))),n=n.response||n,console.error(n);var r=n.statusCode||n.status||n.code||500,s=n.stack||n.error||n.message||n.body||n.data||n.statusText;t.status("string"==typeof r?500:r),t.send({code:r,message:s})}};(0,r.default)(b).forEach(function(e){P[e]=b[e]}),E.logentriesToken&&(P.log=new v({token:E.logentriesToken}));var L=function e(t,n){n.removeListener("finish",e),n.removeListener("close",e)};return"production"!==E.environment&&e.use(function(e,t,n){t.on("finish",L.bind(null,e,t)),t.on("close",L.bind(null,e,t)),n()}),n(90)(P,E),n(91)(P,E),n(92)(P,E),n(93)(P,E),n(94)(P,E),n(96)(P,E),n(97)(P,E),n(98)(P,E),n(99)(P,E),n(100)(P,E),n(101)(P,E),n(102)(P,E),n(103)(P,E),n(104)(P,E),n(105)(P,E),n(106)(P,E),n(107)(P,E),n(109)(P,E),n(110)(P,E),n(111)(P,E),n(112)(P,E),n(113)(P,E),e}},function(e,t){e.exports=require("cache-manager")},function(e,t){e.exports=require("cache-manager-redis-store")},function(e,t){e.exports=require("url-parse")},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("le_node")},function(e,t){e.exports=require("circular-json-es6")},function(e,t){e.exports=require("object-sizeof")},function(e,t){e.exports=require("deep-freeze")},function(e,t){e.exports=require("xxhashjs")},function(e,t,n){"use strict";function r(){}r.defaultConfig=n(47),r.Assist=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(15),[null].concat(t)))},r.Auth=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(49),[null].concat(t)))},r.ClientConfig=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(5),[null].concat(t)))},r.Db=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(7),[null].concat(t)))},r.Ecommerce=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(51),[null].concat(t)))},r.Email=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(19),[null].concat(t)))},r.Embedly=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(65),[null].concat(t)))},r.Entity=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(20),[null].concat(t)))},r.Fields=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(22),[null].concat(t)))},r.Helpers=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(9),[null].concat(t)))},r.Instagram=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(70),[null].concat(t)))},r.Jwt=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(71),[null].concat(t)))},r.Pdf=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(73),[null].concat(t)))},r.Roles=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(17),[null].concat(t)))},r.Schema=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(21),[null].concat(t)))},r.Settings=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(77),[null].concat(t)))},r.Shippo=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(78),[null].concat(t)))},r.Shopify=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(80),[null].concat(t)))},r.Stripe=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(84),[null].concat(t)))},r.Taxonomy=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(87),[null].concat(t)))},r.Tools=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(88),[null].concat(t)))},r.User=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(89),[null].concat(t)))},e.exports=r},function(e,t,n){"use strict";(function(t){var r=n(12),s={environment:process.env.ENVIRONMENT||"development",debug:process.env.DEBUG||!1,slug:process.env.SLUG,baseUrl:process.env.BASE_URL||"",db:{url:process.env.DB_URL,host:process.env.DB_HOST,name:process.env.DB_NAME,requestPlugin:process.env.DB_REQUEST_PLUGIN,meterType:process.env.DB_METER_TYPE},auth:{superUserId:process.env.AUTH_SUPER_USER_ID,tokenSecret:process.env.AUTH_TOKEN_SECRET||"change_this_secret"},dev:{userId:process.env.DEV_USER_ID||"dev",role:process.env.DEV_ROLE||"super"},cms:{title:process.env.CMS_TITLE,url:process.env.CMS_URL},assist:{url:process.env.ASSIST_URL,username:process.env.ASSIST_USERNAME,password:process.env.ASSIST_PASSWORD},mailgun:{apiKey:process.env.MAILGUN_API_KEY,domain:process.env.MAILGUN_DOMAIN},embedly:{apiKey:process.env.EMBEDLY_API_KEY},pdf:{templatesPath:r.resolve(t,"pdf")},email:{templatesPath:r.resolve(t,"email")},provider:{google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},instagram:{clientId:process.env.INSTAGRAM_CLIENT_ID,clientSecret:process.env.INSTAGRAM_CLIENT_SECRET},spotify:{clientId:process.env.SPOTIFY_CLIENT_ID,clientSecret:process.env.SPOTIFY_CLIENT_SECRET},stripe:{clientId:process.env.STRIPE_CLIENT_ID,clientSecret:process.env.STRIPE_CLIENT_SECRET,apiKey:process.env.STRIPE_API_KEY},twitter:{consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,accessTokenKey:process.env.TWITTER_ACCESS_TOKEN_KEY,accessTokenSecret:process.env.TWITTER_ACCESS_TOKEN_SECRET},vimeo:{clientId:process.env.VIMEO_CLIENT_ID,clientSecret:process.env.VIMEO_CLIENT_SECRET}}};e.exports=s}).call(this,"/")},function(e,t){e.exports=require("password-hash")},function(e,t,n){"use strict";var r=o(n(8)),s=o(n(0)),a=o(n(1)),u=o(n(3)),i=o(n(4));function o(e){return e&&e.__esModule?e:{default:e}}var c=n(2),l=n(50),d=n(10),f=n(5),p=n(7),h={google:"https://www.googleapis.com/oauth2/v4/token",instagram:"https://api.instagram.com/oauth/access_token",stripe:"https://connect.stripe.com/oauth/token",vimeo:"https://api.vimeo.com/oauth/access_token",spotify:"https://accounts.spotify.com/api/token"},v=function(){function e(t){(0,u.default)(this,e),this.config=t}return(0,i.default)(e,[{key:"authoriseUser",value:function(){var e=(0,a.default)(s.default.mark(function e(t,n){var r,a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.config.auth.superUserId.split(",").map(function(e){return e.trim()}).indexOf(n)>-1)){e.next=3;break}return e.abrupt("return",{id:n,role:"super"});case 3:return e.next=5,p.connect(this.config,t).get("config");case 5:if(r=e.sent,a=c.find(r.users,{id:n})){e.next=9;break}throw Error("User not found: "+n);case 9:if(a.active){e.next=11;break}throw Error("User not active: "+n);case 11:return e.abrupt("return",a);case 12:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"authProvider",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var n,a,u,i,o,p,v,m=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,g=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new f(this.config),e.next=3,n.get();case 3:return a=e.sent,u=c.merge({},this.config.provider[t],m||{}),i=void 0,i=y?c.get(a,["userSettings",y,"provider",t],{}):c.get(a,["provider",t],{}),o={grant_type:g?"refresh_token":"authorization_code",code:m&&m.code?m.code:void 0,client_id:u.clientId,client_secret:u.clientSecret,redirect_uri:u.redirectUri,refresh_token:i.refresh_token},p=h[t],v=void 0,e.prev=10,e.next=13,d.post(p,l.stringify(o));case 13:v=e.sent.data,e.next=19;break;case 16:throw e.prev=16,e.t0=e.catch(10),new Error((0,r.default)(e.t0.response.data));case 19:if((i=c.merge({},i,v)).begins=Math.floor((new Date).getTime()/1e3),"google"!==t){e.next=31;break}return e.prev=22,e.next=25,d.get("https://www.googleapis.com/plus/v1/people/me?access_token="+i.access_token);case 25:i.user=e.sent.data,e.next=31;break;case 28:e.prev=28,e.t1=e.catch(22),console.error(e.t1);case 31:if("spotify"!==t){e.next=41;break}return e.prev=32,e.next=35,d.get("https://api.spotify.com/v1/me?access_token="+i.access_token);case 35:i.user=e.sent.data,e.next=41;break;case 38:e.prev=38,e.t2=e.catch(32),console.error(e.t2);case 41:return y?c.set(a,["userSettings",y,"provider",t],i):c.set(a,["provider",t],i),e.abrupt("return",n.set(a));case 43:case"end":return e.stop()}},e,this,[[10,16],[22,28],[32,38]])}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=v},function(e,t){e.exports=require("querystring")},function(e,t,n){"use strict";var r=a(n(3)),s=a(n(4));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),i=n(6),o=n(7),c=n(9),l=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,s.default)(e,[{key:"getType",value:function(e,t){var n=this;return new i(function(r,s){t.sort=u.isString(t.sort)?'"'+t.sort+'"':t.sort,o.connect(n.config).search("ecommerce",e,t).then(r,s)})}},{key:"setType",value:function(e,t){var n=this;return new i(function(r,s){t.type=e,c.createOrUpdate(n.config,t).then(r,s)})}},{key:"deleteType",value:function(e){var t=this;return new i(function(n,r){e=e.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}}),c.chunkUpdate(t.config,e,1e3).then(n,r)})}},{key:"getOrder",value:function(e){var t=this;return new i(function(n,r){o.connect(t.config).view("ecommerce","orderByOrderId",{key:e,include_docs:!0}).then(function(e){e.rows.length?n(e.rows[0].doc):r(new Error("Order not found"))},r)})}},{key:"verifyDiscount",value:function(e){var t=this;return new i(function(n,r){o.connect(t.config).view("ecommerce","discountByCode",{keys:[e],include_docs:!0}).then(function(t){if(t.rows.length){var s=t.rows[0].doc,a=(new Date).getTime(),u=new Date(Date.parse(s.dateStart)).getTime(),i=new Date(Date.parse(s.dateEnd)).getTime();if(u>a)return void r(new Error("Discount not valid (not begun)"));if(i<a)return void r(new Error("Discount not valid (expired)"));n(s)}else r(new Error({statusCode:404,message:"Discount code not found ("+e+")"}))},r)})}}]),e}();e.exports=l},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("createsend-node")},function(e,t){e.exports=require("nodemailer-mailgun-transport")},function(e,t){e.exports=require("email-templates")},function(e,t){e.exports=require("inky")},function(e,t){e.exports=require("mjml")},function(e,t){e.exports=require("mjml-core")},function(e,t){e.exports=require("mjml-validator")},function(e,t){e.exports=require("mjml-mailchimp")},function(e,t){e.exports=require("html-to-text")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("i18n-iso-countries")},function(e,t){e.exports=require("node-sass")},function(e,t,n){"use strict";var r=a(n(3)),s=a(n(4));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),i=n(6),o=n(66),c=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,s.default)(e,[{key:"oembed",value:function(e){var t=this;return new i(function(n,r){var s=new o({key:t.config.embedly.apiKey}),a={urls:u.isArray(e)?e:[e],format:"json"};s.oembed(a,function(e,t){e?r(e):n(t)})})}}]),e}();e.exports=c},function(e,t){e.exports=require("embedly")},function(e,t){e.exports=require("babel-runtime/helpers/extends")},function(e,t){e.exports=require("json-query")},function(e,t){e.exports=require("deep-diff")},function(e,t,n){"use strict";var r=n(2),s=n(6),a=n(23);e.exports=function(e){e=r.merge({},{client_id:null,access_token:null,version:"v1",host:"https://api.instagram.com"},e||{});this.get=function(t,n){return function(t,n,u){return new s(function(s,i){var o={method:t,url:[e.host,e.version,n].join("/"),qs:{access_token:u.access_token||e.access_token,client_id:u.client_id||e.client_id}};o.qs=r.extend({},o.qs,u),a(o).then(function(e){s(JSON.parse(e))},i)})}("GET",t,n)}}},function(e,t,n){"use strict";var r=a(n(3)),s=a(n(4));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(72),i=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,s.default)(e,[{key:"signToken",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u.sign(e,this.config.auth.tokenSecret,t)}},{key:"verifyToken",value:function(e){return u.verify(e,this.config.auth.tokenSecret)}}]),e}();e.exports=i},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var r=c(n(8)),s=c(n(24)),a=c(n(0)),u=c(n(1)),i=c(n(3)),o=c(n(4));function c(e){return e&&e.__esModule?e:{default:e}}var l=n(13),d=n(12),f=n(2),p=n(74),h=n(23),v=n(75),m=n(20),y=n(5),g=function(){function e(t){(0,i.default)(this,e),this.config=t}return(0,o.default)(e,[{key:"getTemplates",value:function(){var e=(0,u.default)(a.default.mark(function e(){var t,r=this;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={},e.next=3,v(this.config.pdf.templatesPath);case 3:return e.sent.forEach(function(e){if(/\.js$/.test(e)){var s=e.replace(r.config.pdf.templatesPath+"/","").replace(".js","");t[s]=n(76)(e)}}),e.abrupt("return",t);case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getPayload",value:function(){var e=(0,u.default)(a.default.mark(function e(t,n,r){var s,u,i,o;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=p(l.readFileSync(d.join(this.config.pdf.templatesPath,t+".js"),"utf-8"),t+".js",{},!0),u=new m(this.config),e.next=4,u.entityList([n],{children:2,role:r});case 4:if(e.t0=function(e){return e.doc},0!==(i=e.sent.map(e.t0)).length){e.next=8;break}throw new Error("Entity not found");case 8:return o=s(m.flattenValues(i)[0]),e.abrupt("return",o);case 10:case"end":return e.stop()}},e,this)}));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"getPdf",value:function(){var e=(0,u.default)(a.default.mark(function e(t){var n,u,i,o,c;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new y(this.config),e.next=3,n.get();case 3:return u=e.sent,i=f.get(u,"assets.slug",this.config.slug),o=this.config.assist.url+"/"+i+"/pdf/download",t="object"===(void 0===t?"undefined":(0,s.default)(t))?(0,r.default)(t).replace(/'/gi,""):t,e.next=9,h({method:"POST",uri:o,encoding:null,form:{payload:t}});case 9:return c=e.sent,e.abrupt("return",c);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=g},function(e,t){e.exports=require("eval")},function(e,t){e.exports=require("recursive-readdir")},function(e,t){function n(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=76},function(e,t,n){"use strict";var r=i(n(0)),s=i(n(1)),a=i(n(3)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(5),l=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"update",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(s=e.sent).client=o.merge({},s.client,t),e.abrupt("return",n.set(s));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=l},function(e,t,n){"use strict";var r=a(n(3)),s=a(n(4));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(6),i=n(79),o=function(){function e(t){(0,r.default)(this,e),this.config=t,this.shippo=i(t.shippo.token)}return(0,s.default)(e,[{key:"getQuote",value:function(e,t){var n=this;return new u(function(r,s){var a={object_purpose:"QUOTE",zip:n.config.shippo.fromZip,country:n.config.shippo.fromCountry},u={object_purpose:"QUOTE",zip:e.zip,country:e.country,metadata:""};t.distance_unit="cm",t.mass_unit="kg",n.shippo.shipment.create({object_purpose:"QUOTE",address_from:a,address_to:u,parcel:t}).then(function(e){!function e(t,a){("QUEUED"===t.object_status||"WAITING"===t.object_status)&&a<10?n.shippo.shipment.retrieve(t.object_id).then(function(t){e(t,a+1)}):n.shippo.shipment.rates(t.object_id).then(function(e){r(e)},function(e){console.error("There was an error retrieving rates : %s",e),s(e)})}(e,0)},function(e){console.error("There was an error creating shipment: %s",e),s(e)})})}}]),e}();e.exports=o},function(e,t){e.exports=require("shippo")},function(e,t,n){"use strict";var r=i(n(0)),s=i(n(1)),a=i(n(3)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(10),c=n(81),l=n(82),d=n(83),f=n(5),p=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"getCatalog",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a,u,i,p,h=t.shopLink,v=t.productLinkTemplate;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new f(this.config),e.next=3,n.get();case 3:return s=e.sent,e.next=6,o({url:"https://"+s.provider.shopify.domain+".myshopify.com/api/graphql",method:"post",headers:{"X-Shopify-Storefront-Access-Token":s.provider.shopify.storefrontAccessToken},data:{query:"\n          query {\n            shop {\n              name\n              primaryDomain {\n                url\n              }\n              description\n              products(first: 250) {\n                edges {\n                  node {\n                    id\n                    handle\n                    title\n                    description\n                    onlineStoreUrl\n                    images(first: 1) {\n                      edges {\n                        node {\n                          originalSrc\n                          transformedSrc\n                        }\n                      }\n                    }\n                    productType\n                    vendor\n                    availableForSale\n                    priceRange {\n                      minVariantPrice {\n                        amount\n                        currencyCode\n                      }\n                      maxVariantPrice {\n                        amount\n                        currencyCode\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        "}});case 6:return a=e.sent.data.data,u=l.compile(v),i=a.shop.products.edges.map(function(e){return{"g:id":e.node.handle,"g:title":c.encode(e.node.title),"g:description":c.encode(e.node.description),"g:link":u({handle:e.node.handle}),"g:image_link":e.node.images.edges[0].node.originalSrc,"g:brand":e.node.vendor,"g:condition":"new","g:availability":e.node.availableForSale?"in stock":"out of stock","g:price":e.node.priceRange.minVariantPrice.amount+" "+e.node.priceRange.minVariantPrice.currencyCode}}),p=[{name:"title",text:a.shop.name},{name:"link",text:h},{name:"description",text:a.shop.description}],i.forEach(function(e){p.push({name:"item",children:e})}),e.abrupt("return",'<?xml version="1.0"?>\n    <rss xmlns:g="http://base.google.com/ns/1.0" version="2.0">\n      '+d({channel:p})+"\n    </rss>");case 12:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=p},function(e,t){e.exports=require("he")},function(e,t){e.exports=require("handlebars")},function(e,t){e.exports=require("jsontoxml")},function(e,t,n){"use strict";var r=o(n(8)),s=o(n(0)),a=o(n(1)),u=o(n(3)),i=o(n(4));function o(e){return e&&e.__esModule?e:{default:e}}var c=n(2),l=n(85),d=n(6),f=n(86),p=n(5),h=n(19),v=n(7),m=n(9),y=function(){function e(t){(0,u.default)(this,e),this.config=t,this.stripe=l(this.config.stripe.apiKey),this.email=new h(this.config),this.hashids=new f(this.config.slug,6,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ")}return(0,i.default)(e,[{key:"getSettings",value:function(){var e=(0,a.default)(s.default.mark(function e(){var t,n,r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new p(this.config),e.next=3,t.get();case 3:n=e.sent,r=void 0,e.prev=5,r=n.module.ecommerce,e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(5),new Error(e.t0);case 12:e.prev=12,r.clientStripeAccountId=n.provider.stripe.stripe_user_id,e.next=19;break;case 16:throw e.prev=16,e.t1=e.catch(12),new Error(e.t1);case 19:return r.client=n.client,r.assets=n.assets,e.abrupt("return",r);case 22:case"end":return e.stop()}},e,this,[[5,9],[12,16]])}));return function(){return e.apply(this,arguments)}}()},{key:"checkout",value:function(e,t){var n=this;return new d(function(r,s){n.getSettings().then(function(a){var u=c.get(a,"createsend.checkoutSubscriberListId");t.subscribe&&u&&n.email.subscribe(t.customerDetails,"createsend",u).then(function(e){console.log(e)},function(e){console.error(e)}),n.findOrCreateCustomer(t.customerDetails.email,t).then(function(u){n.createOrder(t,u).then(function(t){n.updateOrCreateStripeCustomer(a.clientStripeAccountId,u,e,t).then(function(e){n.updateCustomer(u,e,t).then(function(u){n.createCharge(a,e,u,t).then(function(e){n.sendReceipt(a,u,t).then(function(i){e.messages.orderReceipt=i,n.sendNotification(a,u,t).then(function(t){e.messages.orderNotification=t,n.updateOrder(e).then(function(e){r(e)},s)},s)},s)},s)},s)},s)},s)},s)},s).catch(s)})}},{key:"retrieveAccount",value:function(){var e=this;return new d(function(t,n){e.getSettings().then(function(r){e.stripe.accounts.retrieve(r.clientStripeAccountId).then(t,n)},n)})}},{key:"refund",value:function(e,t){var n=this;return new d(function(r,s){n.getSettings().then(function(a){n.stripe.refunds.create({refund_application_fee:!0,charge:e.charge.id,amount:t},{stripe_account:a.clientStripeAccountId}).then(function(t){n.stripe.charges.retrieve(e.charge.id,{stripe_account:a.clientStripeAccountId}).then(function(t){e.charge.status=t.status,e.charge.amount=t.amount,e.charge.amountRefunded=t.amount_refunded,m.createOrUpdate(n.config,e).then(r,s)},s)},s)},s)})}},{key:"findOrCreateCustomer",value:function(e,t){var n=this;return new d(function(s,a){v.connect(n.config).view("ecommerce","customerByEmail",{keys:[e],include_docs:!0}).then(function(e){if(e.rows.length)s(e.rows[0].doc);else{var u=(0,r.default)(new Date).replace(/"/g,""),i={type:"customer",createdAt:u,modifiedAt:u,email:t.customerDetails.email,name:t.customerDetails.name,phone:t.customerDetails.phone,billingAddress:t.billingAddress,shippingAddress:t.shippingAddress,orders:[]};v.connect(n.config).insert(i).then(function(e){i._id=e.id,i._rev=e.rev,s(i)},a)}},a)})}},{key:"updateOrCreateStripeCustomer",value:function(e,t,n,r){var s=this;return new d(function(a,u){var i={source:n,email:r.customer.email,description:r.customer.name,metadata:{customer_id:t._id}};t.stripe&&t.stripe.customer.id?s.stripe.customers.update(t.stripe.customer.id,i,{stripe_account:e}).then(a,function(t){"StripeInvalidRequestError"===t.type&&"id"===t.param?s.stripe.customers.create(i,{stripe_account:e}).then(a,u):u(t)}):s.stripe.customers.create(i,{stripe_account:e}).then(a,u)})}},{key:"createOrder",value:function(e,t){var n=this;return new d(function(s,a){var u=e.items.map(function(e){return{id:e.id,title:e.title.replace(/<br\s?>/gi," ").replace(/<\/?p>|<\/?span>/gi,""),price:e.price,quantity:e.quantity,metadata:e.metadata||{}}}),i=(0,r.default)(new Date).replace(/"/g,""),o={type:"order",orderId:n.hashids.encode((new Date).getTime()),createdAt:i,modifiedAt:i,customer:{id:t._id,email:t.email,name:t.name},items:u,shippingMethod:{name:e.shippingMethod.name,amount:Number(e.shippingMethod.amount)},subtotal:Number(e.subtotal),tax:{rate:e.tax.rate||0,includedInPrice:e.tax.includedInPrice||!1,total:e.tax.total||0,show:e.tax.show||!1},discount:{code:e.discount.code||"",name:e.discount.name||"",total:e.discount.total||0},total:Number(e.total),billingAddress:e.billingAddress,shippingAddress:e.shippingAddress,messages:{},status:"pending",test:!0};v.connect(n.config).insert(o).then(function(e){o._id=e.id,o._rev=e.rev,s(o)},a)})}},{key:"updateOrder",value:function(e){var t=this;return new d(function(n,r){v.connect(t.config).insert(e).then(function(t){e._rev=t.rev,n(e)},r)})}},{key:"updateCustomer",value:function(e,t,n){var s=this;return new d(function(a,u){var i=(0,r.default)(new Date).replace(/"/g,"");e.modifiedAt=i,e.orders||(e.orders=[]),e.orders.push(n._id),e.stripe||(e.stripe={customer:{id:null}}),e.stripe.customer.id=t.id,v.connect(s.config).insert(e).then(function(t){e._rev=t.rev,a(e)},u)})}},{key:"createCharge",value:function(e,t,n,r){var s=this;return new d(function(a,u){var i=100*Number(r.total),o={amount:i,currency:e.currency.iso.toLowerCase(),customer:t.id,capture:!0,description:r.orderId,metadata:{customer_id:n._id,order_id:r._id},statement_descriptor:c.kebabCase(e.storeName).toUpperCase(),application_fee:Math.ceil(.02*i)};s.stripe.charges.create(o,{stripe_account:e.clientStripeAccountId}).then(function(e){r.charge={paymentGateway:"stripe",id:e.id,status:e.status,currency:e.currency.toUpperCase(),amount:e.amount,amountRefunded:e.amount_refunded},r.test=!e.livemode,a(r)},u)})}},{key:"sendReceipt",value:function(e,t,n){var r=this;return new d(function(s,a){var u={settings:e,order:n},i={from:e.emailSenderName+" <"+e.emailSenderAddress+">",to:t.email,subject:"Your order at "+e.storeName+" ("+n.orderId+")"},o=c.get(e,"assets.slug",r.config.slug);r.email.sendEmail(i,o+"/order-receipt",u).then(s,a)})}},{key:"sendNotification",value:function(e,t,n){var r=this;return new d(function(t,s){var a={settings:e,order:n},u={from:e.emailSenderName+" <"+e.emailSenderAddress+">",to:e.emailSenderAddress,subject:"New order at "+e.storeName+" ("+n.orderId+")"},i=c.get(e,"assets.slug",r.config.slug);r.email.sendEmail(u,i+"/order-notification",a).then(t,s)})}}]),e}();e.exports=y},function(e,t){e.exports=require("stripe")},function(e,t){e.exports=require("hashids")},function(e,t,n){"use strict";var r=i(n(0)),s=i(n(1)),a=i(n(3)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(7),l=n(5),d=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:return(s=e.sent).taxonomies.push(t),e.abrupt("return",n.set(s));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:if(s=e.sent,a=o.find(s.taxonomies,{slug:t})){e.next=7;break}throw Error("Taxonomy not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:if(s=e.sent,-1!==(a=o.findIndex(s.taxonomies,{slug:t.slug}))){e.next=7;break}throw Error("Taxonomy not found: "+t.slug);case 7:return s.taxonomies.splice(a,1,t),e.abrupt("return",n.set(s));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:return s=e.sent,t=o.isArray(t)?t:[t],s.taxonomies=s.taxonomies.filter(function(e){return-1===t.indexOf(e.slug)}),e.abrupt("return",n.set(s));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"entitiesByTerm",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.connect(this.config),e.next=3,n.view("entity","byTaxonomyTerm",{keys:[t.id],group:!0});case 3:if(e.t0=function(e){return e.value},s=e.sent.rows.map(e.t0)[0]){e.next=7;break}return e.abrupt("return",[]);case 7:return a=[],o.forEach(s,function(e){a=a.concat(e)}),a=o.uniq(a),e.next=12,n.fetch({keys:a,include_docs:!0});case 12:return e.t1=function(e){return e.doc},e.t2=function(e){return e.doc},u=e.sent.rows.filter(e.t1).map(e.t2),e.abrupt("return",u);case 16:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"createTerm",value:function(){var e=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.read(t);case 2:return(s=e.sent).terms.push(n),e.abrupt("return",this.update(s));case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"updateTerm",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.entitiesByTerm(t);case 2:return n=(n=e.sent).map(function(e){return e.fields=o.mapValues(e.fields,function(e){return"taxonomy"===e.type&&e.value&&(e.value.terms||(e.value.terms=[]),e.value.terms=e.value.terms.map(function(e){return e.id===t.id&&(e.title=t.title,e.slug=t.slug),e.parents||(e.parents=[]),e.parents=e.parents.map(function(e){return e.id===t.id&&(e.title=t.title,e.slug=t.slug),e}),e})),e}),e}),e.abrupt("return",c.connect(this.config).bulk({docs:n}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"deleteTerm",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.entitiesByTerm(t);case 2:return n=(n=e.sent).map(function(e){return e.fields=o.mapValues(e.fields,function(e){return"taxonomy"===e.type&&e.value&&(e.value.terms||(e.value.terms=[]),e.value.terms=e.value.terms.filter(function(e){return e.id!==t.id&&!(e.parents||[]).filter(function(e){return e.id===t.id}).length})),e}),e}),e.abrupt("return",c.connect(this.config).bulk({docs:n}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=d},function(e,t,n){"use strict";var r=i(n(0)),s=i(n(1)),a=i(n(3)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(6).promisifyAll(n(13)),c=n(16),l=n(7),d=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"getDb",value:function(){var e=(0,s.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.connect(this.config).fetch({include_docs:!0});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getChanges",value:function(){var e=(0,s.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.connect(this.config).changes({limit:50,include_docs:!0,filter:"tools/changesEntity"});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"importDb",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a,u,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.config.db.name,e.next=3,o.readFileAsync(t.path);case 3:return s=e.sent,a=JSON.parse(s).rows.map(function(e){var t=e.doc;return delete t._rev,t}),e.next=7,o.unlinkAsync(t.path);case 7:return u=new c({url:this.config.db.url,plugins:["promises","retry"]}).db,e.prev=8,e.next=11,u.destroy(n);case 11:e.next=15;break;case 13:e.prev=13,e.t0=e.catch(8);case 15:return e.next=17,u.create(n);case 17:return e.next=19,l.connect(this.config,n).bulk({docs:a});case 19:return i=e.sent,e.abrupt("return",i);case 21:case"end":return e.stop()}},e,this,[[8,13]])}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=d},function(e,t,n){"use strict";var r=i(n(0)),s=i(n(1)),a=i(n(3)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(5),l=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(s=e.sent).users.push(t),e.abrupt("return",n.set(s));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(s=e.sent,a=o.find(s.users,{id:t})){e.next=7;break}throw Error("User not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(s=e.sent,-1!==(a=o.findIndex(s.users,{id:t.id}))){e.next=7;break}throw Error("User not found: "+t.id);case 7:return s.users.splice(a,1,t),e.abrupt("return",n.set(s));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return s=e.sent,t=o.isArray(t)?t:[t],s.users=s.users.filter(function(e){return-1===t.indexOf(e.id)}),e.abrupt("return",n.set(s));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=l},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Analytics,n=e.router,a=e.authMiddleware,u=e.cacheMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;n.get("/analytics.:ext?",a,u,i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o();case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.get(n.query);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Auth,n=e.router,a=e.authMiddleware,u=e.permissionMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;n.get("/auth/:provider/config",a,u.bind(null,["settings","userSettings"]),i(function(){var e=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o();case 2:if((s=e.sent).provider[t.params.provider]){e.next=7;break}return n.status(404),n.send({}),e.abrupt("return");case 7:n.status(200),n.send({clientId:s.provider[t.params.provider].clientId});case 9:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}())),n.get("/auth/:provider",a,u.bind(null,"settings"),function(e,t){t.status(e.query.error?500:200),t.send(e.params.provider+": "+(e.query.error_description?e.query.error_description:"successfully authenticated"))}),n.post("/auth/:provider",a,u.bind(null,"settings"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.authProvider(n.params.provider,n.body);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.put("/auth/:provider/refresh",a,i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.authProvider(n.params.provider,n.body,null,!0);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.post("/auth/:provider/:userId",a,u.bind(null,"userSettings"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.authProvider(n.params.provider,n.body,n.params.userId);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.put("/auth/:provider/:userId/refresh",a,i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.authProvider(n.params.provider,n.body,n.params.userId,!0);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.router,n=e.cache,a=e.asyncMiddleware,u=e.getConfig,i=e.handleResponse;t.get("/cache/clear.:ext?",a(function(){var e=(0,s.default)(r.default.mark(function e(t,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u();case 2:if(e.sent.cache.enabled){e.next=6;break}return i(t,s,"Cache disabled"),e.abrupt("return");case 6:a="redis"===n.store.name?"*":void 0,n.keys(a).then(function(e){var r=e.filter(function(e){return 0===e.indexOf(t.session.slug)});r.forEach(function(e){return n.del(e)}),i(t,s,r.length+" items removed from cache")});case 8:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.ClientConfig,n=e.router,a=e.authMiddleware,u=e.permissionMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;n.get("/config.:ext?",a,i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.get();case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.post("/config.:ext?",a,u.bind(null,"config"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.set(n.body.config);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";e.exports=function(e){e.router.all("/debug/useragent.:ext?",function(e,t){var r=n(95).parse(e.headers["user-agent"]);t.status(200),t.send("\n      <html>\n        <head>\n          <title>"+r.source+'</title>\n          <meta name="description" content="'+r.source+'">\n        </head>\n        <body>'+r.source+"</body>\n      </html>\n    ")})}},function(e,t){e.exports=require("express-useragent")},function(e,t,n){"use strict";var r=u(n(8)),s=u(n(0)),a=u(n(1));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(26);e.exports=function(e){var t=e.Ecommerce,n=e.router,u=e.authMiddleware,o=e.permissionMiddleware,c=e.asyncMiddleware,l=e.getConfig,d=e.handleResponse,f=e.handleError;n.get("/ecommerce/order/message/:message.:ext?",u,o.bind(null,"ecommerce"),c(function(){var e=(0,a.default)(s.default.mark(function e(n,r){var a,u;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,l(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.next=8,a.getOrder(n.query.orderId);case 8:u=e.sent,d(n,r,u.messages[n.params.message].email.html),e.next=15;break;case 12:e.prev=12,e.t2=e.catch(5),f(n,r,e.t2);case 15:case"end":return e.stop()}},e,void 0,[[5,12]])}));return function(t,n){return e.apply(this,arguments)}}())),n.get("/ecommerce/:type.:ext?",u,o.bind(null,"ecommerce"),c(function(){var e=(0,a.default)(s.default.mark(function e(n,a){var u;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i(n.query.sort)&&(n.query.sort=(0,r.default)(n.query.sort).replace(/\\"/g,"")),e.t0=t,e.next=4,l(n.session.slug);case 4:return e.t1=e.sent,u=(0,e.t0)(e.t1),e.prev=6,e.t2=d,e.t3=n,e.t4=a,e.next=12,u.getType(n.params.type,n.query);case 12:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=19;break;case 16:e.prev=16,e.t6=e.catch(6),f(n,a,e.t6);case 19:case"end":return e.stop()}},e,void 0,[[6,16]])}));return function(t,n){return e.apply(this,arguments)}}())),n.post("/ecommerce/:type.:ext?",u,o.bind(null,"ecommerce"),c(function(){var e=(0,a.default)(s.default.mark(function e(n,r){var a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(/^(discount|order)$/.test(n.params.type)){e.next=3;break}return f(n,r,"Illegal type: "+n.params.type),e.abrupt("return");case 3:return e.t0=t,e.next=6,l(n.session.slug);case 6:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=8,e.t2=d,e.t3=n,e.t4=r,e.next=14,a.setType(n.params.type,n.body.item);case 14:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=21;break;case 18:e.prev=18,e.t6=e.catch(8),f(n,r,e.t6);case 21:case"end":return e.stop()}},e,void 0,[[8,18]])}));return function(t,n){return e.apply(this,arguments)}}())),n.delete("/ecommerce/:type.:ext?",u,o.bind(null,"ecommerce"),c(function(){var e=(0,a.default)(s.default.mark(function e(n,r){var a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(/^(discount)$/.test(n.params.type)){e.next=3;break}return f(n,r,"Illegal type: "+n.params.type),e.abrupt("return");case 3:return e.t0=t,e.next=6,l(n.session.slug);case 6:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=8,e.t2=d,e.t3=n,e.t4=r,e.next=14,a.deleteType(n.body.item);case 14:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=21;break;case 18:e.prev=18,e.t6=e.catch(8),f(n,r,e.t6);case 21:case"end":return e.stop()}},e,void 0,[[8,18]])}));return function(t,n){return e.apply(this,arguments)}}())),n.get("/ecommerce/discount/:code.:ext?",c(function(){var e=(0,a.default)(s.default.mark(function e(n,r){var a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,l(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=d,e.t3=n,e.t4=r,e.next=11,a.verifyDiscount(n.params.code);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),f(n,r,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=u(n(0)),s=u(n(11)),a=u(n(1));function u(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Email,n=e.Entity,u=e.router,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;u.all("/email/preview.:ext?",i(function(){var e=(0,a.default)(r.default.mark(function e(u,i){var d,f,p,h,v,m=function(){var e=(0,a.default)(r.default.mark(function e(){var n,s,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!f.data){e.next=3;break}return c(u,i,a),e.abrupt("return");case 3:return e.t0=t,e.next=6,o(p);case 6:return e.t1=e.sent,n=(0,e.t0)(e.t1),e.prev=8,e.next=11,n.getTemplate(d.templateSlug,a,f);case 11:s=e.sent,c(u,i,s.html),e.next=18;break;case 15:e.prev=15,e.t2=e.catch(8),l(u,i,e.t2);case 18:case"end":return e.stop()}},e,this,[[8,15]])}));return function(){return e.apply(this,arguments)}}();return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(d=(0,s.default)(u.body).length?u.body:u.query||{},f={data:!!d.data&&JSON.parse(d.data),inlineStyles:!d.inlineStyles||JSON.parse(d.inlineStyles),inky:!!d.inky&&JSON.parse(d.inky),mjml:!!d.mjml&&JSON.parse(d.mjml),skipValidation:!!d.skipValidation&&JSON.parse(d.skipValidation)},p=d.slug||u.session.slug,!d.payload){e.next=6;break}return m(JSON.parse(d.payload)),e.abrupt("return");case 6:if(!d.entityId){e.next=18;break}return e.t0=n,e.next=10,o(p);case 10:return e.t1=e.sent,h=(0,e.t0)(e.t1),e.next=14,h.entityList([d.entityId],{children:2});case 14:return e.t2=function(e){return e.doc},v=e.sent.map(e.t2),m(h.flattenValues(v)[0]),e.abrupt("return");case 18:m();case 19:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}())),u.all("/email/send.:ext?",i(function(){var e=(0,a.default)(r.default.mark(function e(n,a){var u,i,d,f,p,h;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return u=(0,s.default)(n.body).length?n.body:n.query||{},i={inlineStyles:!u.inlineStyles||JSON.parse(u.inlineStyles),inky:!!u.inky&&JSON.parse(u.inky),mjml:!!u.mjml&&JSON.parse(u.mjml),skipValidation:!u.skipValidation||JSON.parse(u.skipValidation)},d={fromName:u.fromName||"",fromEmail:u.fromEmail,toName:u.toName||"",toEmail:u.toEmail,from:(u.fromName||"")+" <"+u.fromEmail+">",to:u.toEmail,subject:u.subject},f=u.slug||n.session.slug,e.t0=t,e.next=7,o(f);case 7:return e.t1=e.sent,p=(0,e.t0)(e.t1),e.prev=9,e.next=12,p.sendEmail(d,u.templateSlug,u.payload,i);case 12:h=e.sent,c(n,a,h),e.next=19;break;case 16:e.prev=16,e.t2=e.catch(9),l(n,a,e.t2);case 19:case"end":return e.stop()}},e,void 0,[[9,16]])}));return function(t,n){return e.apply(this,arguments)}}())),u.post("/email/subscribe.:ext?",i(function(){var e=(0,a.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.subscribe({email:n.body.email||n.query.email,name:n.body.name||n.query.name||""});case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Embedly,n=e.router,a=e.authMiddleware,u=e.asyncMiddleware,i=e.getConfig,o=e.handleResponse,c=e.handleError;n.get("/embedly/oembed.:ext?",a,u(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,i();case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=o,e.t3=n,e.t4=s,e.next=11,a.oembed(n.query.url||n.query.urls);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),c(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=i(n(24)),s=i(n(11)),a=i(n(0)),u=i(n(1));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(26);e.exports=function(e){var t=e.Db,n=e.Entity,i=e.router,c=e.authMiddleware,l=e.permissionMiddleware,d=e.cacheMiddleware,f=e.asyncMiddleware,p=e.getConfig,h=e.handleResponse,v=e.handleError;i.get("/entities/index.:ext?",f(function(){var e=(0,u.default)(a.default.mark(function e(n,r){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=h,e.t1=n,e.t2=r,e.t3=t,e.next=7,p(n.session.slug);case 7:return e.t4=e.sent,e.next=10,(0,e.t3)(e.t4).indexAsync();case 10:e.t5=e.sent,(0,e.t0)(e.t1,e.t2,e.t5),e.next=17;break;case 14:e.prev=14,e.t6=e.catch(0),v(n,r,e.t6);case 17:case"end":return e.stop()}},e,void 0,[[0,14]])}));return function(t,n){return e.apply(this,arguments)}}())),i.all("/entities/search?.:ext?",d,f(function(){var e=(0,u.default)(a.default.mark(function e(t,u){var i,o,c,l,d,f,m,y,g,x,b,w,k,_,E;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,s.default)(t.body).length?t.body:t.query,o=void 0!==i.include_docs&&JSON.parse(i.include_docs),c=void 0!==i.include_fields?"object"===(0,r.default)(i.include_fields)?i.include_fields:JSON.parse(i.include_fields):[],l=void 0!==i.select&&i.select,d=void 0!==i.children&&("object"===(0,r.default)(i.children)?i.children:JSON.parse(i.children)),f=void 0!==i.parents&&("object"===(0,r.default)(i.parents)?i.parents:JSON.parse(i.parents)),!0===d&&(d=1),!0===f&&(f=1),m=void 0!==i.trashed&&JSON.parse(i.trashed),y=void 0!==i.sort?i.sort:null,g=void 0!==i.limit?parseInt(i.limit,10):null,x=void 0!==i.bookmark?i.bookmark:null,b=void 0!==i.group_field?i.group_field:null,w=void 0!==i.index?i.index:null,k=i.query||i.q,(_=[]).push(m?"trashed:true":"!trashed:true"),"guest"===t.session.role&&_.push("published:true"),k&&_.push("("+k+")"),_=_.join(" AND "),e.t0=n,e.next=23,p(t.session.slug);case 23:return e.t1=e.sent,E=(0,e.t0)(e.t1),e.prev=25,e.t2=h,e.t3=t,e.t4=u,e.next=31,E.entitySearch({query:_,include_docs:o,include_fields:c,sort:y,limit:g,bookmark:x,group_field:b,index:w},{select:l,children:d,parents:f,role:t.session.role});case 31:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=38;break;case 35:e.prev=35,e.t6=e.catch(25),v(t,u,e.t6);case 38:case"end":return e.stop()}},e,void 0,[[25,35]])}));return function(t,n){return e.apply(this,arguments)}}())),i.all("/entities/find.:ext?",d,f(function(){var e=(0,u.default)(a.default.mark(function e(t,u){var i,o,c,l,d,f;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,s.default)(t.body).length?t.body:t.query,o=void 0!==i.children&&("object"===(0,r.default)(i.children)?i.children:JSON.parse(i.children)),c=void 0!==i.parents&&("object"===(0,r.default)(i.parents)?i.parents:JSON.parse(i.parents)),!0===o&&(o=1),!0===c&&(c=1),l=void 0!==i.trashed&&JSON.parse(i.trashed),(d=i.query?JSON.parse(i.query):{selector:{}}).use_index=["entityIndex","entity"],d.selector.$and||(d.selector={$and:[d.selector]}),l?d.selector.$and.push({trashed:!0}):d.selector.$and.push({$or:[{trashed:{$exists:!1}},{trashed:!1}]}),"guest"===t.session.role&&d.selector.$and.push({published:!0}),t.query.limit&&(d.limit=parseInt(t.query.limit,10)),e.t0=n,e.next=15,p(t.session.slug);case 15:return e.t1=e.sent,f=(0,e.t0)(e.t1),e.prev=17,e.t2=h,e.t3=t,e.t4=u,e.next=23,f.entityFind(d,{children:o,parents:c,role:t.session.role});case 23:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=30;break;case 27:e.prev=27,e.t6=e.catch(17),v(t,u,e.t6);case 30:case"end":return e.stop()}},e,void 0,[[17,27]])}));return function(t,n){return e.apply(this,arguments)}}())),i.get("/entities/field.:ext?",d,f(function(){var e=(0,u.default)(a.default.mark(function e(t,r){var s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=r,e.next=11,s.fieldValues(t.query.slug||t.query.fieldSlug,t.query.searchTerm);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(r,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),i.all("/entities.:ext?",d,f(function(){var e=(0,u.default)(a.default.mark(function e(t,u){var i,c,l,d,f,m;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,s.default)(t.body).length?t.body:t.query,c=void 0!==i.select&&i.select,l=void 0!==i.children&&("object"===(0,r.default)(i.children)?i.children:JSON.parse(i.children)),d=void 0!==i.parents&&("object"===(0,r.default)(i.parents)?i.parents:JSON.parse(i.parents)),!0===l&&(l=1),!0===d&&(d=1),(f=i.ids||i.id)&&(f=o(f)?f:[f]),e.t0=n,e.next=11,p(t.session.slug);case 11:return e.t1=e.sent,m=(0,e.t0)(e.t1),e.prev=13,e.t2=h,e.t3=t,e.t4=u,e.next=19,m.entityList(f,{select:c,children:l,parents:d,role:t.session.role});case 19:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=26;break;case 23:e.prev=23,e.t6=e.catch(13),v(t,u,e.t6);case 26:case"end":return e.stop()}},e,void 0,[[13,23]])}));return function(t,n){return e.apply(this,arguments)}}())),i.get("/entity/revisions.:ext?",c,l.bind(null,"entityRead"),f(function(){var e=(0,u.default)(a.default.mark(function e(t,r){var s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=r,e.next=11,s.entityRevisions(t.query.id);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,r,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),i.post("/entity.:ext?",c,l.bind(null,"entityCreate"),f(function(){var e=(0,u.default)(a.default.mark(function e(t,r){var s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=r,e.next=11,s.entityCreate(t.body.entity);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,r,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),i.get("/entity.:ext?",c,l.bind(null,"entityRead"),f(function(){var e=(0,u.default)(a.default.mark(function e(t,r){var s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=r,e.next=11,s.entityRead(t.query.id);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,r,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),i.put("/entity.:ext?",c,l.bind(null,"entityUpdate"),f(function(){var e=(0,u.default)(a.default.mark(function e(t,r){var s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=r,e.next=11,s.entityUpdate(t.body.entity||t.body.entities,t.body.restore||!1);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,r,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),i.delete("/entity.:ext?",c,l.bind(null,"entityDelete"),f(function(){var e=(0,u.default)(a.default.mark(function e(t,r){var s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=r,e.next=11,s.entityDelete(t.body.entity||t.body.entities,t.body.forever||!1);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,r,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),i.delete("/entity/trashed.:ext?",c,l.bind(null,"entityDelete"),f(function(){var e=(0,u.default)(a.default.mark(function e(t,r){var s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=r,e.next=11,s.entityDelete("trashed");case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,r,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.ClientConfig,n=e.router,a=e.cacheMiddleware,u=e.asyncMiddleware,i=e.getConfig,o=e.handleResponse,c=e.handleError;n.get("/metadata.:ext?",a,u(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,i(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.next=7,a.get();case 7:u=e.sent;try{o(n,s,u.client.metadata,!0)}catch(e){c(n,s,e)}case 9:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=u(n(8)),s=u(n(0)),a=u(n(1));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(2);e.exports=function(e){var t=e.Pdf,n=e.ClientConfig,u=e.router,o=e.asyncMiddleware,c=e.getConfig,l=e.handleError;u.get("/pdf/view.:ext?",o(function(){var e=(0,a.default)(s.default.mark(function e(n,r){var a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:e.t1=e.sent,(a=(0,e.t0)(e.t1)).getPayload(n.query.template,n.query.id,n.session.role).then(function(e){a.getPdf(e).then(function(e){r.type("application/pdf"),r.status(200),r.send(e)},l.bind(null,n,r))},l.bind(null,n,r));case 6:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}())),u.get("/pdf/download.:ext?",o(function(){var e=(0,a.default)(s.default.mark(function e(n,r){var a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:e.t1=e.sent,(a=(0,e.t0)(e.t1)).getPayload(n.query.template,n.query.id,n.session.role).then(function(e){a.getPdf(e).then(function(t){r.attachment(e.fileName||"download.pdf"),r.status(200),r.send(t)},l.bind(null,n,r))},l.bind(null,n,r));case 6:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}())),u.get("/pdf/payload.:ext?",o(function(){var e=(0,a.default)(s.default.mark(function e(n,r){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:e.t1=e.sent,(0,e.t0)(e.t1).getPayload(n.query.template,n.query.id,n.session.role).then(function(e){r.status(200),r.json(e)},l.bind(null,n,r));case 6:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}())),u.get("/pdf/submit.:ext?",o(function(){var e=(0,a.default)(s.default.mark(function e(a,u){var o,d,f,p;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c(a.session.slug);case 2:return o=e.sent,d=n(o),e.next=6,d.get();case 6:f=e.sent,p=i.get(f,"assets.slug",a.session.slug),t(o).getPayload(a.query.template,a.query.id,a.session.role).then(function(e){e=(0,r.default)(e).replace(/'/gi,""),u.status(200),u.send("\n          <body onload='form.submit()'>\n            <form id='form' method='POST' action='"+o.assist.url+"/"+p+"/pdf/download' target='_self'>\n              <input type='hidden' name='payload' value='"+e+"' />\n            </form>\n          </body>\n        ")},l.bind(null,a,u));case 10:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),i=n(10);e.exports=function(e){var t=e.Auth,n=e.ClientConfig,a=e.router,o=e.cacheMiddleware,c=e.asyncMiddleware,l=e.getConfig,d=e.handleResponse,f=e.handleError,p={google:"https://www.googleapis.com",instagram:"https://api.instagram.com",spotify:"https://api.spotify.com",vimeo:"https://api.vimeo.com"},h=c(function(){var e=(0,s.default)(r.default.mark(function e(s,a){var o,c,h,v,m,y,g,x,b,w,k;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=s.method,c=s.params[0],h=s.params[2]?s.params[1]:null,v=(s.params[2]||s.params[1]).split("/").filter(function(e){return""!==e}).join("/"),e.next=6,l(s.session.slug);case 6:return m=e.sent,y=n(m),e.next=10,y.get();case 10:if(g=e.sent,x=void 0,!h){e.next=18;break}if(g.userSettings[h]){e.next=15;break}throw Error("User settings not found: "+h);case 15:x=g.userSettings[h].provider[c],e.next=19;break;case 18:x=g.provider[c];case 19:if(!(Math.floor((new Date).getTime()/1e3)-(x.begins||0)>x.expires_in)){e.next=36;break}return e.t0=t,e.next=23,l(s.session.slug);case 23:if(e.t1=e.sent,b=(0,e.t0)(e.t1),!h){e.next=32;break}return e.next=28,b.authProvider(c,{},h,!0);case 28:g=e.sent,x=g.userSettings[h].provider[c],e.next=36;break;case 32:return e.next=34,b.authProvider(c,{},null,!0);case 34:g=e.sent,x=g.provider[c];case 36:return w=u.merge({},s.query),w=u.omitBy(w,function(e,t){return/^(__)/.test(t)}),/bearer/i.test(x.token_type)||(w.access_token=x.access_token),e.prev=39,e.next=42,i.request({url:v,baseURL:p[c],method:o,headers:{Authorization:"Bearer "+x.access_token},params:w});case 42:k=e.sent,d(s,a,k.data,!0),e.next=49;break;case 46:e.prev=46,e.t2=e.catch(39),f(s,a,e.t2);case 49:case"end":return e.stop()}},e,void 0,[[39,46]])}));return function(t,n){return e.apply(this,arguments)}}());a.all(/\/provider\/([^/]+)\/([^/]+)\/api\/?(.+)?/,o,h),a.all(/\/provider\/([^/]+)\/api\/?(.+)?/,o,h)}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Schema,n=e.router,a=e.authMiddleware,u=e.permissionMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;n.post("/schema.:ext?",a,u.bind(null,"schema"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.create(n.body.schema);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.get("/schema.:ext?",a,u.bind(null,"schema"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.read(n.query.schemaId);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.put("/schema.:ext?",a,u.bind(null,"schema"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.update(n.body.schema);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.delete("/schema.:ext?",a,u.bind(null,"schema"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.delete(n.body.schemaSlug||n.body.schemaSlugs||n.query.schemaSlug||n.query.schemaSlugs);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.put("/schemas.:ext?",a,u.bind(null,"schema"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.updateAll(n.body.schemas);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Settings,n=e.router,a=e.authMiddleware,u=e.permissionMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;n.post("/settings.:ext?",a,u.bind(null,"settings"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.update(n.body.settings);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Shippo,n=e.router,a=e.asyncMiddleware,u=e.getConfig,i=e.handleResponse,o=e.handleError;n.all("/shippo/quote.:ext?",a(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a,c,l;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,u();case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),c=n.body.address||JSON.parse(n.params.address),l=n.body.parcel||JSON.parse(n.params.parcel),e.prev=7,e.t2=i,e.t3=n,e.t4=s,e.next=13,a.getQuote(c,l);case 13:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=20;break;case 17:e.prev=17,e.t6=e.catch(7),o(n,s,e.t6);case 20:case"end":return e.stop()}},e,void 0,[[7,17]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Shopify,n=e.router,a=e.cacheMiddleware,u=e.asyncMiddleware,i=e.getConfig,o=e.handleResponse,c=e.handleError;n.get("/shopify/catalog.:ext?",a,u(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,i(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,s.setHeader("Content-Type","application/rss+xml"),e.t2=o,e.t3=n,e.t4=s,e.next=12,a.getCatalog(n.query);case 12:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=19;break;case 16:e.prev=16,e.t6=e.catch(5),c(n,s,e.t6);case 19:case"end":return e.stop()}},e,void 0,[[5,16]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.ClientConfig,a=e.Instagram,u=e.router,i=e.cacheMiddleware,o=e.asyncMiddleware,c=e.getConfig,l=e.handleResponse,d=e.handleError,f={};u.get(/\/social\/twitter\/([^/]+)\/?(.+)?/,i,o(function(){var e=(0,s.default)(r.default.mark(function e(t,s){var a,u,i,o,f,p;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.params[0],u=t.params[1].split("/").filter(function(e){return""!==e}),e.next=4,c(t.session.slug);case 4:return i=e.sent,o=n(6),f=n(108),p=o.promisifyAll(new f({consumer_key:i.provider.twitter.consumerKey,consumer_secret:i.provider.twitter.consumerSecret,access_token_key:i.provider.twitter.accessTokenKey,access_token_secret:i.provider.twitter.accessTokenSecret})),e.prev=8,e.t0=l,e.t1=t,e.t2=s,e.next=14,p[a+"Async"](u.join("/"),t.query);case 14:e.t3=e.sent,(0,e.t0)(e.t1,e.t2,e.t3,!0),e.next=21;break;case 18:e.prev=18,e.t4=e.catch(8),d(t,s,e.t4);case 21:case"end":return e.stop()}},e,void 0,[[8,18]])}));return function(t,n){return e.apply(this,arguments)}}())),u.get(/\/social\/instagram\/([^/]+)\/?(.+)?/,i,o(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var u,i,o,p,h,v,m;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return u=n.params[0],i=n.params[1].split("/").filter(function(e){return""!==e}),e.next=4,c(n.session.slug);case 4:if(o=e.sent,f[n.session.slug]){e.next=18;break}return p=t(o),e.prev=7,e.next=10,p.get();case 10:h=e.sent,f[n.session.slug]=h.provider.instagram.access_token,e.next=18;break;case 14:return e.prev=14,e.t0=e.catch(7),d(s,new Error("Instagram: access_token required")),e.abrupt("return");case 18:return n.query.access_token=f[n.session.slug],v=a({client_id:o.provider.instagram.clientId}),e.prev=20,e.next=23,v[u](i.join("/"),n.query);case 23:m=e.sent;try{delete m.pagination.next_url}catch(e){}l(n,s,m,!0),e.next=31;break;case 28:e.prev=28,e.t1=e.catch(20),d(n,s,e.t1);case 31:case"end":return e.stop()}},e,void 0,[[7,14],[20,28]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t){e.exports=require("twitter")},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Ecommerce,n=e.Email,a=e.Stripe,u=e.router,i=e.authMiddleware,o=e.permissionMiddleware,c=e.asyncMiddleware,l=e.getConfig,d=e.handleResponse,f=e.handleError;u.all("/stripe/checkout.:ext?",c(function(){var e=(0,s.default)(r.default.mark(function e(t,n){var s,u,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.token||JSON.parse(t.query.token),u=t.body.order||JSON.parse(t.query.order),e.t0=a,e.next=5,l(t.session.slug);case 5:return e.t1=e.sent,i=(0,e.t0)(e.t1),e.prev=7,e.t2=d,e.t3=t,e.t4=n,e.next=13,i.checkout(s,u);case 13:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=20;break;case 17:e.prev=17,e.t6=e.catch(7),f(t,n,e.t6);case 20:case"end":return e.stop()}},e,void 0,[[7,17]])}));return function(t,n){return e.apply(this,arguments)}}())),u.post("/stripe/refund.:ext?",i,o.bind(null,"ecommerce"),c(function(){var e=(0,s.default)(r.default.mark(function e(t,n){var s,u,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.order||JSON.parse(t.query.order),u=100*Number(t.body.amount||t.query.amount||0),e.t0=a,e.next=5,l(t.session.slug);case 5:return e.t1=e.sent,i=(0,e.t0)(e.t1),e.prev=7,e.t2=d,e.t3=t,e.t4=n,e.next=13,i.refund(s,u);case 13:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=20;break;case 17:e.prev=17,e.t6=e.catch(7),f(t,n,e.t6);case 20:case"end":return e.stop()}},e,void 0,[[7,17]])}));return function(t,n){return e.apply(this,arguments)}}())),u.get("/stripe/account.:ext?",i,o.bind(null,"ecommerce"),c(function(){var e=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=a,e.next=3,l(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=d,e.t3=t,e.t4=n,e.next=11,s.retrieveAccount();case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),f(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),u.get("/stripe/email.:ext?",c(function(){var e=(0,s.default)(r.default.mark(function e(s,u){var i,o,c,p,h,v,m,y;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l(s.session.slug);case 2:return i=e.sent,o=n(i),c=a(i),p=t(i),e.next=8,c.getSettings();case 8:return h=e.sent,e.next=11,p.getOrder(s.query.orderId);case 11:return v=e.sent,m={settings:h,order:v},e.next=15,o.getTemplate(s.session.slug+"/"+s.query.template,m);case 15:y=e.sent;try{d(s,u,y.html)}catch(e){f(s,u,e)}case 17:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Taxonomy,n=e.router,a=e.authMiddleware,u=e.permissionMiddleware,i=e.cacheMiddleware,o=e.asyncMiddleware,c=e.getConfig,l=e.handleResponse,d=e.handleError;n.post("/taxonomy.:ext?",a,u.bind(null,"taxonomyUpdate"),o(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=n,e.t4=s,e.next=11,a.create(n.body.taxonomy);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.get("/taxonomy.:ext?",i,o(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=n,e.t4=s,e.next=11,a.read(n.query.slug||n.query.taxonomySlug);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.put("/taxonomy.:ext?",a,u.bind(null,"taxonomyUpdate"),o(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=n,e.t4=s,e.next=11,a.update(n.body.taxonomy);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.delete("/taxonomy.:ext?",a,u.bind(null,"taxonomyUpdate"),o(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=n,e.t4=s,e.next=11,a.delete(n.body.taxonomySlug||n.body.taxonomySlugs||n.query.taxonomySlug||n.query.taxonomySlugs);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.post("/taxonomy/term.:ext?",a,u.bind(null,"taxonomyUpdate"),o(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=n,e.t4=s,e.next=11,a.createTerm(n.body.slug||n.body.taxonomySlug,n.body.term);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.put("/taxonomy/term.:ext?",a,u.bind(null,"taxonomyUpdate"),o(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=n,e.t4=s,e.next=11,a.updateTerm(n.query.term||n.body.term);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.delete("/taxonomy/term.:ext?",a,u.bind(null,"taxonomyUpdate"),o(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,c(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=n,e.t4=s,e.next=11,a.deleteTerm(n.query.term||n.body.term);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Jwt,a=e.router,u=e.authMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse;a.get("/token.:ext?",u,i(function(){var e=(0,s.default)(r.default.mark(function e(s,a){var u,i,l,d,f,p;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o();case 2:u=e.sent,i={role:s.session.role,slug:s.session.slug,userId:s.session.userId},"super"!==s.session.role&&"development"!==u.environment||(i.role=s.query.role||s.session.role||u.dev.role,i.slug=s.query.slug||s.session.slug||u.dev.slug,"guest"!==i.role&&(i.userId=s.query.userId||s.session.userId||u.dev.userId)),l=n(2),d=l.pickBy(s.query,function(e,t){return/^(expiresIn|notBefore|audience|issuer|jwtid|subject|noTimestamp|header)$/.test(t)}),d=l.mapValues(d,function(e){return l.isNaN(+e)?e:+e}),f=t(u),p=f.signToken(i,d),s.session.apiToken=p,c(s,a,{token:p,payload:i,options:d});case 13:case"end":return e.stop()}},e,void 0)}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.Tools,n=e.router,a=e.authMiddleware,u=e.permissionMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;n.get("/tools/export-db.:ext?",a,u.bind(null,"tools"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.next=8,a.getDb();case 8:u=e.sent,s.setHeader("Content-Disposition","attachment; filename="+n.session.slug+".json"),s.setHeader("Content-Type","application/json"),s.status(200),s.send(u),e.next=18;break;case 15:e.prev=15,e.t2=e.catch(5),l(n,s,e.t2);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.get("/tools/changes.:ext?",a,i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.getChanges();case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}},function(e,t,n){"use strict";var r=a(n(0)),s=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=e.User,n=e.router,a=e.authMiddleware,u=e.permissionMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;n.post("/user.:ext?",a,u.bind(null,"user"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.create(n.body.user);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.get("/user.:ext?",a,u.bind(null,"user"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.read(n.query.userId);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.put("/user.:ext?",a,u.bind(null,"user"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.update(n.body.user);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}())),n.delete("/user.:ext?",a,u.bind(null,"user"),i(function(){var e=(0,s.default)(r.default.mark(function e(n,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,o(n.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=n,e.t4=s,e.next=11,a.delete(n.body.userId||n.body.userIds||n.query.userId||n.query.userIds);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(n,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])}));return function(t,n){return e.apply(this,arguments)}}()))}}])});
//# sourceMappingURL=server.js.map