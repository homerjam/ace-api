!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AceApiServer=t():e.AceApiServer=t()}(global,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=22)}([function(e,t){e.exports=require("@babel/runtime/helpers/interopRequireDefault")},function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t){e.exports=require("lodash")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(5),i=r(6),o={_id:"config",client:{},assets:{},schemas:[],taxonomies:[],users:[],roles:(new(r(13))).roles(),provider:{},module:{}};e.exports=class{constructor(e){this.config=e}get(){var e,t=this;return n.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=o,r.prev=1,r.next=4,n.default.awrap(a.connect(t.config).get("config"));case 4:e=r.sent,e=s.merge({},o,e),r.next=10;break;case 8:r.prev=8,r.t0=r.catch(1);case 10:return e.slug=t.config.slug,r.abrupt("return",e);case 12:case"end":return r.stop()}}),null,null,[[1,8]],Promise)}set(e){var t=this;return n.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e._id="config",delete e.roles,r.next=4,n.default.awrap(i.createOrUpdate(t.config,e));case 4:return e=r.sent,e=s.merge({},o,e),r.abrupt("return",e);case 7:case"end":return r.stop()}}),null,null,null,Promise)}}},function(e,t){e.exports=require("bluebird")},function(e,t,r){"use strict";const n=r(12);class s{constructor(e,t){return this.config=e,s.connect(e,t)}static connect(e,t){return new n({url:e.db.url,maxAttempt:5,plugins:["promises",{retry:{retryDelayMultiplier:2,retryInitialDelayMsecs:500}}]}).db.use(t||e.db.name)}}e.exports=s},function(e,t,r){"use strict";const n=r(2),s=r(4),a=r(5);e.exports=class{constructor(e){this.config=e,this.assistUrl=e.assist.url,this.slug=e.slug}static createOrUpdate(e,t){return new s((r,n)=>{a.connect(e).insert(t).then(e=>{t._id=e.id,t._rev=e.rev,r(t)},s=>{409===s.statusCode?a.connect(e).get(t._id).then(s=>{t._rev=s._rev,a.connect(e).insert(t).then(e=>{t._rev=e.rev,r(t)},n)},n):n(s)})})}static chunkUpdate(e,t,r=1e3){return new s((i,o)=>{const c=n.chunk(t,r),u=[];c.forEach(t=>{u.push(new s((r,n)=>{a.connect(e).bulk({docs:t}).then(r,n)}))}),s.all(u).then(i,o)})}static groupEntities(e,t=1/0){const r=[];let n={entities:[]};return e.forEach(e=>{(!e.groupBefore||n.entities.length>=t)&&(n={entities:[]}),n.entities.push(e),(!e.groupAfter||n.entities.length>=t)&&(n.ratio=0,n.entities.forEach(e=>{n.ratio+=(e.thumbnail||e).ratio}),n.entities.forEach(e=>{e.groupRatio=(e.thumbnail||e).ratio/n.ratio}),r.push(n))}),r}static now(){return JSON.stringify(new Date).replace(/"/g,"")}static replace(e,t,r){return e.map(e=>e[r]===t[r]?t:e)}thumbnailSrc(e,t,r,s){if(!e)return"";let a;"string"==typeof t&&(a=t.split(/,|;/),t={},a.forEach(e=>{e=e.split(/_|:/),t[e[0]]=e[1]}));const i=!!e.crops&&e.crops[r];i?(t.x=i[0],t.y=i[1],t.x2=i[2],t.y2=i[3]):s&&(t.g=s),a=[],n.forEach(t,(e,t)=>{a.push([t,e].join(":"))});const o=a.join(";");if(/(image)/.test(e.thumbnailType))return"svg"===e.ext?[this.assistUrl,this.slug,e.name+e.ext].join("/"):[this.assistUrl,this.slug,"transform",o,e.name+e.ext].join("/");if(/(video)/.test(e.thumbnailType))return[this.assistUrl,this.slug,"transform",o,e.name,"thumb.jpg"].join("/");if(/(oembed|proxy)/.test(e.thumbnailType)){const t=e.thumbnailUrl.replace(/https?:\/\//,"");return[this.assistUrl,this.slug,"proxy","transform",o,t].join("/")}return""}}},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(7),i=r(43),o=r(3);e.exports=class{constructor(e){this.config=e}deleteFiles(e){var t,r,c,u,l=this;return n.default.async((function(d){for(;;)switch(d.prev=d.next){case 0:return t=new o(l.config),d.next=3,n.default.awrap(t.get());case 3:if(r=d.sent,c=s.get(r,"assets.slug",l.config.slug),0!==e.length){d.next=7;break}return d.abrupt("return",[]);case 7:return d.next=9,n.default.awrap(a.post(`${l.config.assist.url}/${c}/file/delete`,{fileNames:e},{auth:{username:l.config.assist.username,password:i.generate(l.config.assist.password)}}));case 9:return u=d.sent.data,d.abrupt("return",u);case 11:case"end":return d.stop()}}),null,null,null,Promise)}}},function(e,t){e.exports=require("@cloudant/cloudant")},function(e,t,r){"use strict";const n=r(2),s=[{name:"Admin",slug:"admin",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!0,settings:!0,userSettings:!0,tools:!0,ecommerce:!0}},{name:"Editor",slug:"editor",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!1,settings:!1,userSettings:!0,tools:!1,ecommerce:!1}},{name:"Guest",slug:"guest",permissions:{entityGrid:!0,entityCreate:!1,entityRead:!0,entityUpdate:!1,entityDelete:!1,taxonomyCreate:!1,taxonomyRead:!0,taxonomyUpdate:!1,taxonomyDelete:!1,fileCreate:!1,fileRead:!0,fileUpdate:!1,fileDelete:!1,config:!1,schema:!1,user:!1,settings:!1,userSettings:!1,tools:!1,ecommerce:!1}}];e.exports=class{roles(){return s.map(e=>Object.freeze(e))}role(e){return n.find(this.roles(),{slug:e})}}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(8),a=r(4),i=a.promisifyAll(r(9)),o=r(2),c=r(47),u=a.promisifyAll(r(48)),l=r(49),d=r(50).Inky,p=r(51),f=r(52).registerComponent,h=r(53).registerDependencies,{McSection:m,McImage:g}=r(54),y=r(55),x=r(56),v=r(57),w=r(58),b=r(59),_=r(60),k=r(61),E=r(3),S=r(6);e.exports=class{constructor(e){this.config=e,this.inky=new d,m.componentName="mc-section",g.componentName="mc-image",f(m),f(g),h({"mc-section":["mj-column","mj-group","mj-raw"],"mj-column":["mc-image"],"mj-hero":["mc-image"]})}getTemplate(e,t={},r={}){var a,c,u,l,d,f,h,m,g,T,P,q=this;return n.default.async((function(I){for(;;)switch(I.prev=I.next){case 0:return a=o.merge({},{inlineStyles:!0,inky:!1,mjml:!1,skipValidation:!1},r),c=s.join(q.config.email.templatesPath,e),I.prev=2,I.next=5,n.default.awrap(i.statAsync(c));case 5:I.next=10;break;case 7:I.prev=7,I.t0=I.catch(2),c=s.resolve("../email",e);case 10:return I.next=12,n.default.awrap(i.readdirAsync(c));case 12:if(u=I.sent,l="html",o.find(u,e=>/^html\.mjml/.test(e))&&(l="html.mjml",a.mjml=!0),d="html",o.find(u,e=>/\.pug$/.test(e))&&(d="pug"),o.find(u,e=>/\.ejs$/.test(e))&&(d="ejs"),f="",!o.find(u,e=>/^style\.scss$/.test(e))){I.next=23;break}return I.next=22,n.default.awrap(w.compileAsync(s.join(c,"style.scss"),{sourceMapContents:!a.inlineStyles,sourceMapEmbed:!a.inlineStyles}));case 22:f=I.sent.css.toString().replace(/"/g,"'");case 23:return h=new E(q.config),I.next=26,n.default.awrap(h.get());case 26:if(m=I.sent,g=new S(q.config),t=o.merge({},t,{config:o.merge({},o.pick(q.config,["cms","slug","client","assets"]),o.pick(m,["slug","client","assets"])),helpers:g,style:f,moment:x,countries:v,templateSlug:e}),"html"===d&&(T=i.readFileAsync(`${c}/${l}.${d}`)),"pug"===d&&(T=b.renderFile(`${c}/${l}.${d}`,t)),"ejs"!==d){I.next=35;break}return I.next=34,n.default.awrap(_.renderFile(`${c}/${l}.${d}`,t));case 34:T=I.sent;case 35:if(!a.mjml){I.next=40;break}if(!(P=p(T,{level:a.skipValidation?"skip":"soft"})).errors||!P.errors.length){I.next=39;break}throw new Error(o.uniq(P.errors.map(e=>e.formattedMessage)).join("\n"));case 39:T=P.html;case 40:return a.inky&&(T=q.inky.releaseTheKraken(T)),a.inlineStyles&&(T=k(T,{preserveMediaQueries:!0,preserveFontFaces:!0,removeStyleTags:!1,removeLinkTags:!1,preserveImportant:!0,webResources:{links:!1,scripts:!1,images:!1}})),I.abrupt("return",{html:T,text:y.fromString(T)});case 43:case"end":return I.stop()}}),null,null,[[2,7]],Promise)}sendEmail(e,t,r={},n={}){return new a((s,a)=>{const i=c.createTransport(l({auth:{api_key:this.config.mailgun.apiKey,domain:this.config.mailgun.domain}}));this.getTemplate(t,o.merge({},e,r),n).then(t=>{e.html=t.html,e.text=t.text,i.sendMail(e,(t,r)=>{t?a(t):s({metadata:r,email:e})})},a)})}subscribe(e,t,r){return new a((n,s)=>{new E(this.config).get().then(i=>{if("createsend"===t){if(i.provider.createsend){const t=new u({apiKey:i.provider.createsend.clientApiKey});return void a.promisifyAll(t.subscribers).addSubscriberAsync(r,{EmailAddress:e.email,Name:e.name,Resubscribe:!0,RestartSubscriptionBasedAutoresponders:!0}).then(e=>{n("Email.subscribe(): "+e.emailAddress)}).catch(e=>{s(e.Message)})}s(new Error("Subscriber list not configured"))}},s)})}}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(4),i=r(64),{diff:o}=r(65),c=r(3),u=r(5),l=r(6),d=r(16),p=r(11);class f{constructor(e){this.config=e,this.flattenValues=f.flattenValues}static flattenValues(e){return e.map(e=>e.fields&&s.size(e.fields)?(e.fields=s.mapValues(e.fields,e=>(/entity/.test(e.type)&&s.isArray(e.value)&&(e.value=f.flattenValues(e.value)),e.value)),e):e)}static _filterEntityFields(e,t="guest"){const r=s.isArray(e);return e=(r?e:[e]).map(e=>(s.size(e.fields)&&(e.fields=s.mapValues(e.fields,e=>(s.isArray(e.value)&&(e.value=e.value.filter(e=>!!e&&(!e.type||"entity"!==e.type||"guest"!==t||(void 0===e.published||e.published)))),e))),e)),r?e:e[0]}static _appendChildren(e,t){return e.map(e=>s.size(e.fields)?(e.fields=s.mapValues(e.fields,e=>(s.isArray(e.value)&&(e.value=e.value.filter(e=>!!e&&("entity"!==e.type||void 0!==t[e.id])),e.value=e.value.map(e=>("entity"===e.type&&(e=s.merge(e,t[e.id])),e=s.omitBy(e,(e,t)=>t.startsWith("_"))))),e)),e):e)}static _appendParents(e,t=null,r="guest"){let n={};return e.forEach(e=>{e.doc&&"entity"===e.value.type&&(n[e.id]={...e.doc,parents:[]})}),t&&(e.forEach(e=>{e.doc&&"parent"===e.value.type&&n[e.key].parents.push(f._filterEntityFields(e.doc,r))}),n=s.mapValues(n,e=>(e.parents=s.uniqBy(e.parents,e=>e._id),e))),e=(e=e.map(e=>(e.doc=n[e.id],e))).filter(e=>"entity"===e.value.type)}static _fileNames(e){const t=[];return e.forEach(e=>{s.forEach(e.fields,e=>{e.value&&e.value.file&&t.push(e.value.file.name)})}),s.uniq(t)}fieldValues(e,t){var r,s=this;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,n.default.awrap(u.connect(s.config).viewWithList("entity","byField","search",{startkey:[e],endkey:[e,{}],group:!0,searchTerm:t}));case 2:return r=a.sent,a.abrupt("return",r);case 4:case"end":return a.stop()}}),null,null,null,Promise)}static _query(e,t,r=!1){if(t=t.replace(/(\s\s|\t|\r|\n)/g,""),r){const e=t.trim().split(/\[|\]/),r=`fields.${e[0]}.value[${e[1]||"*"}]`,n=/\]:/.test(t)?":"+t.split(/\]:/).slice(-1)[0].trim():"";t=`${r}${n}`}return i(t,{data:e,locals:{slice:(e,t,r)=>s.slice(e,t,r),sample:(e,t=1)=>s.sampleSize(e,t),group:(e,t=1/0)=>{const r=[];let n=[];return e.forEach(e=>{(!e.groupBefore||n.length>=t)&&(n=[]),n.push(e),(!e.groupAfter||n.length>=t)&&(n.ratio=0,n.forEach(e=>{n.ratio+=(e.thumbnail||e).ratio}),n.forEach(e=>{e.groupRatio=(e.thumbnail||e).ratio/n.ratio}),r.push(n))}),r},pick:(e,...t)=>s.map(e,e=>{const r={id:e.id||void 0};return(t=t.filter(e=>e)).forEach(t=>{const n=t.match(/([^\s]+)/g),a=n[0],i=n[n.length-1];s.set(r,i,s.get(e,a))}),r})},allowRegexp:!0})}static _queriesFromString(e){const t=(e=e.replace(/(\s\s|\t|\r|\n)/gm,"")).match(/\(([^)]+)\)/g);let r=(e=e.replace(/\(.*?\)/g,"()")).split(/,(?![^([]*[\])])/g);return r=r.map(e=>{const r=e.match(/\(\)/g);return r&&s.times(r.length,()=>{e=e.replace("()",t.splice(0,1))}),e.trim()}),r}_entitiesById(e=[],t={}){var r,a,i=this;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=s.merge({parents:!1,role:"guest"},t),r={include_docs:!0},e.length&&(r.keys=e),o.next=5,n.default.awrap(u.connect(i.config).view("entity",t.parents?"byIdExtended":"byId",r));case 5:return(a=o.sent).rows=a.rows.map(e=>(e.doc=f._filterEntityFields(e.doc,t.role),e)),a.rows=f._appendParents(a.rows,t.parents,t.role),o.abrupt("return",a);case 9:case"end":return o.stop()}}),null,null,null,Promise)}static _childDepthLimit(e){let t=0;return s.isNumber(e)&&(t=e-1),s.isArray(e)&&(t=e.length-1),t}_getDocMap(e,t={},r={}){var a,i,o,c=this;return n.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(r._childDepth=r._childDepth||0,r.parents||r.children){u.next=3;break}return u.abrupt("return",t);case 3:if(a=[],i=[],e.forEach(e=>{const t=!!e.doc;let n=t?e.doc:e;n=f._filterEntityFields(n,r.role),r.children&&n.fields&&s.size(n.fields)&&(s.isArray(r.children)?f._queriesFromString(r.children[r._childDepth]).forEach(e=>{i=i.concat(s.flatten(f._query(n,e,!0).value).map(e=>e&&e.id))}):s.forEach(n.fields,e=>{s.isArray(e.value)&&(e.value=e.value.filter(e=>e),e.value.forEach(e=>{e.id&&i.push(e.id)}))})),a.push(t?e.id:n._id||n.id)}),!((a=(a=s.uniq(a)).filter(e=>!t[e])).length>0)){u.next=14;break}return u.next=12,n.default.awrap(c._entitiesById(a,r));case 12:u.sent.rows.map(e=>e.doc).forEach(e=>{t[e._id]=e});case 14:if(i=(i=s.uniq(i)).filter(e=>!t[e]),o=[],!(i.length>0)){u.next=22;break}return u.next=20,n.default.awrap(c._entitiesById(i,{...r,parents:!1}));case 20:(o=u.sent.rows.map(e=>e.doc)).forEach(e=>{t[e._id]=e});case 22:if(r.children&&r._childDepth!==f._childDepthLimit(r.children)){u.next=24;break}return u.abrupt("return",t);case 24:return u.next=26,n.default.awrap(c._getDocMap(o,t,{...r,parents:!1,_childDepth:r._childDepth+1}));case 26:return u.abrupt("return",u.sent);case 27:case"end":return u.stop()}}),null,null,null,Promise)}static _mergeDocs(e,t,r={children:!1,parents:!1}){return r._childDepth=r._childDepth||0,r.children&&r._childDepth-1===f._childDepthLimit(r.children)?e:e=e.map(e=>{const n=!!e.doc;let a=n?e.doc:e;if(t[e.id||e._id]&&(a=s.merge({},a,t[e.id||e._id])),r.children&&a.fields&&s.size(a.fields)){let e;s.isArray(r.children)&&(e={},f._queriesFromString(r.children[r._childDepth]).forEach(t=>{const r=t.split(/\[|\]/)[0];e[r]=t})),a.fields=s.mapValues(a.fields,(n,a)=>(s.isArray(n.value)&&(n.value=n.value.filter(e=>e),(!e||e&&e[a])&&(e&&e[a]&&(n.value=n.value.filter(e=>e.id&&t[e.id])),n.value=n.value.map(e=>(e&&e.id&&t[e.id]&&(e=s.merge(e,t[e.id]||{}),e=s.omitBy(e,(e,t)=>t.startsWith("_"))),e)),n.value=f._mergeDocs(n.value,t,{...r,_childDepth:r._childDepth+1}))),n)),a.fields=s.mapValues(a.fields,(t,r)=>(s.isArray(t.value)&&e&&e[r]&&(t.value=s.flatten(f._query(a,e[r],!0).value)),t))}return s.isArray(r.parents)&&a.parents&&(a.parents=s.flatten(f._query(a.parents,r.parents[0]).value)),n?e.doc=a:e=a,e})}_extendRowsOrDocs(e,t={}){var r,a=this;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=s.merge({select:!1,children:!1,parents:!1,role:"guest"},t),i.next=3,n.default.awrap(a._getDocMap(e,{},t));case 3:return r=i.sent,e=f._mergeDocs(e,r,t),t.select&&(e=s.flatten(f._query(e,t.select).value)),r=null,i.abrupt("return",e);case 8:case"end":return i.stop()}}),null,null,null,Promise)}_removeChildren(e){return new a((t,r)=>{0!==e.length?(e=e.map(e=>e._id),u.connect(this.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(n=>{const a=s.uniqBy(n.rows,e=>e.doc._id).map(t=>(t.doc.fields=s.mapValues(t.doc.fields,t=>(s.isArray(t.value)&&(t.value=s.filter(t.value,t=>!("entity"===t.type&&-1!==e.indexOf(t.id)))),t)),t.doc));0!==a.length?l.chunkUpdate(this.config,a,1e3).then(t,r):t([])},r)):t([])})}_updateChildren(e){return new a((t,r)=>{if(0===e.length)return void t([]);const n={};e=e.map(e=>(n[e._id]=e,e._id)),u.connect(this.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(e=>{const a=e.rows.map(e=>{const t=e.doc;return s.forEach(t.fields,(e,r)=>{s.isArray(e.value)&&(t.fields[r].value=e.value.filter(e=>e).map(e=>("entity"===e.type&&n[e.id]&&(e.slug=n[e.id].slug,e.title=n[e.id].title,e.schema=n[e.id].schema,e.published=n[e.id].published,n[e.id].thumbnail?e.thumbnail=n[e.id].thumbnail:e.thumbnail=null),e)))}),t});l.chunkUpdate(this.config,a,1e3).then(t,r)},r)})}entityList(e=[],t={}){var r,a,i=this;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=s.merge({select:!1,children:!1,parents:!1,role:"guest"},t),o.next=3,n.default.awrap(i._entitiesById(e,t));case 3:return r=o.sent,o.next=6,n.default.awrap(i._extendRowsOrDocs(r.rows,t));case 6:return a=o.sent,o.abrupt("return",a);case 8:case"end":return o.stop()}}),null,null,null,Promise)}_entitySearch(e,t={}){return new a((r,n)=>{e.limit=Math.min(e.limit||200,200),t.children&&(e.include_docs=!0),e.include_fields||(e.include_fields=[]),e.sort||delete e.sort,e.bookmark||delete e.bookmark,e.index||delete e.index,e.group_field||delete e.group_field,u.connect(this.config).search("entity",e.index||"all",e).then(e=>{if(e.groups){const s=[];return e.groups=e.groups.map(e=>(s.push(new a((r,n)=>{(t.children||t.parents)&&0!==e.total_rows?this._extendRowsOrDocs(e.hits,t).then(t=>{e.hits=t,r()},n):r()})),e)),void a.all(s).then(()=>{r(e)},n)}this._extendRowsOrDocs(e.rows,t).then(t=>{e.rows=t,r(e)},n)},n)})}entitySearch(e,t={}){return t=s.merge({children:!1,parents:!1,role:"guest"},t),new a((r,n)=>{const a=e.limit||25;if(a<=200)return void this._entitySearch(e,t).then(r,n);let i=[],o=[];(function c(u){const l=s.clone(e);u&&(l.bookmark=u),this._entitySearch(l,t).then(e=>{e.rows&&(i=i.concat(e.rows)),e.groups&&(o=o.concat(e.groups)),i.length<e.total_rows&&i.length<a?c.call(this,e.bookmark):(e.rows=i,e.groups=o,r(e))},n)}).call(this)})}entityFind(e,t={}){var r,a,i,o,l=this;return n.default.async((function(p){for(;;)switch(p.prev=p.next){case 0:return t=s.merge({children:!1,parents:!1,role:"guest"},t),p.prev=1,p.next=4,n.default.awrap(u.connect(l.config).find(e));case 4:r=p.sent,p.next=20;break;case 7:if(p.prev=7,p.t0=p.catch(1),"no_usable_index"!==p.t0.error){p.next=20;break}return a=new c(l.config),p.next=13,n.default.awrap(a.get());case 13:return i=p.sent,o=new d(l.config),p.next=17,n.default.awrap(o.updateEntityIndex(i.schemas));case 17:return p.next=19,n.default.awrap(u.connect(l.config).find(e));case 19:r=p.sent;case 20:if(!1!==t.children){p.next=22;break}return p.abrupt("return",r);case 22:if(!e.fields||-1!==e.fields.indexOf("_id")){p.next=24;break}throw new Error("_id field required for `children`");case 24:return p.next=26,n.default.awrap(l._extendRowsOrDocs(r.docs,t));case 26:return r.docs=p.sent,p.abrupt("return",r);case 28:case"end":return p.stop()}}),null,null,[[1,7]],Promise)}entityRevisions(e){return new a((t,r)=>{u.connect(this.config).get(e,{revs_info:!0}).then(n=>{const a=[];n._revs_info.forEach(e=>{"available"===e.status&&a.push(e.rev)}),u.connect(this.config).get(e,{open_revs:JSON.stringify(a)}).then(e=>{const n=[],a=[];e.forEach(e=>{e.ok&&(n.push(e.ok),s.forEach(e.ok.fields,e=>{/entity/.test(e.type)&&s.forEach(e.value,e=>{e.id&&a.push(e.id)})}))}),u.connect(this.config).fetch({keys:s.uniq(a),include_docs:!0}).then(e=>{const r={};e.rows.forEach(e=>{try{r[e.doc._id]=e.doc}catch(e){console.error("Error: child no longer exists")}}),t(f._appendChildren(n,r))},r)},r)},r)})}entityCreate(e){return new a((t,r)=>{e.type="entity",u.connect(this.config).insert(e).then(r=>{e._id=r.id,e._rev=r.rev,t(e)},r)})}entityRead(e){return new a((t,r)=>{u.connect(this.config).get(e).then(t,r)})}entityUpdate(e,t){var r,a,i,c,d,p,f=this;return n.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return e=s.isArray(e)?e:[e],r={},a=e.map(e=>{let t;return s.isObject(e)&&(t=e._id,r[t]=e),s.isString(e)&&(t=e),t}),h.next=5,n.default.awrap(u.connect(f.config).fetch({keys:a,include_docs:!0}));case 5:if(i=h.sent,c=[],d=[],e=i.rows.map(e=>{const n=e.doc,i=r[n._id];let u=n;return i&&(delete i._rev,o(n,i).forEach(e=>{if(/published|slug|title|thumbnail/.test(e.path[0])&&-1===c.indexOf(i)&&-1!==a.indexOf(i._id)&&c.push(i),"fields"===e.path[0]&&"value"===e.path[2]){const t=n.fields[e.path[1]];/attachment|image|audio|video/.test(t.type)&&t.value&&d.push(t.value.file.name)}}),u=s.mergeWith({},n,i,(e,t)=>{if(s.isArray(e)&&s.isArray(t))return t})),t&&(u.trashed=!1),u}),d.length,!c.length){h.next=13;break}return h.next=13,n.default.awrap(f._updateChildren(c));case 13:return h.next=15,n.default.awrap(l.chunkUpdate(f.config,e,1e3));case 15:return p=h.sent,h.abrupt("return",p);case 17:case"end":return h.stop()}}),null,null,null,Promise)}entityDelete(e,t=!1){var r,a,i,o,c,d=this;return n.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:if("trashed"!==e){h.next=7;break}return t=!0,h.next=4,n.default.awrap(u.connect(d.config).view("entity","trashed",{include_docs:!0}));case 4:r=h.sent.rows,h.next=10;break;case 7:return h.next=9,n.default.awrap(u.connect(d.config).fetch({keys:s.isArray(e)?e:[e],include_docs:!0}));case 9:r=h.sent.rows;case 10:return r=(r=r.filter(e=>!e.value||!e.value.deleted)).map(e=>e.doc),h.next=14,n.default.awrap(d._removeChildren(r));case 14:if(!t){h.next=24;break}if(!(i=f._fileNames(r)).length){h.next=21;break}return o=new p(d.config),h.next=20,n.default.awrap(o.deleteFiles(i));case 20:a=h.sent;case 21:r=r.map(e=>({_id:e._id,_rev:e._rev,_deleted:!0})),h.next=25;break;case 24:r=r.map(e=>(e.trashed=!0,e));case 25:return h.next=27,n.default.awrap(l.chunkUpdate(d.config,r,1e3));case 27:return c=h.sent,h.abrupt("return",{entities:c,files:a});case 29:case"end":return h.stop()}}),null,null,null,Promise)}}e.exports=f},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(3),i=r(5),o=r(17);e.exports=class{constructor(e){return this.config=e,this}create(e){var t,r,s=this;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=new a(s.config),i.next=3,n.default.awrap(t.get());case 3:return(r=i.sent).schemas.push(e),i.next=7,n.default.awrap(s.updateEntityIndex(r.schemas));case 7:return i.abrupt("return",t.set(r));case 8:case"end":return i.stop()}}),null,null,null,Promise)}read(e){var t,r,i,o=this;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(o.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,i=s.find(r.schemas,{slug:e})){c.next=7;break}throw Error("Schema not found: "+e);case 7:return c.abrupt("return",i);case 8:case"end":return c.stop()}}),null,null,null,Promise)}update(e){var t,r,i,o=this;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(o.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,-1!==(i=s.findIndex(r.schemas,{slug:e.slug}))){c.next=7;break}throw Error("Schema not found: "+e.slug);case 7:return r.schemas.splice(i,1,e),c.next=10,n.default.awrap(o.updateEntityIndex(r.schemas));case 10:return c.abrupt("return",t.set(r));case 11:case"end":return c.stop()}}),null,null,null,Promise)}delete(e){var t,r,i=this;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=new a(i.config),o.next=3,n.default.awrap(t.get());case 3:return r=o.sent,e=s.isArray(e)?e:[e],r.schemas=r.schemas.filter(t=>-1===e.indexOf(t.slug)),r.schemas=r.schemas.map(t=>t.fields?(t.fields=t.fields.map(t=>t.settings?(t.settings.schemas&&(t.settings.schemas=t.settings.schemas.filter(t=>-1===e.indexOf(t))),t):t),t):t),o.next=9,n.default.awrap(i.updateEntityIndex(r.schemas));case 9:return o.abrupt("return",t.set(r));case 10:case"end":return o.stop()}}),null,null,null,Promise)}updateAll(e){var t,r,s=this;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=new a(s.config),i.next=3,n.default.awrap(t.get());case 3:return(r=i.sent).schemas=e,i.abrupt("return",t.set(r));case 6:case"end":return i.stop()}}),null,null,null,Promise)}updateEntityIndex(e){var t,r,a,c=this;return n.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=[],e.forEach(e=>{t=t.concat(e.fields)}),t=s.uniqBy(t,"slug"),r={name:"entity",type:"text",ddoc:"entityIndex",index:{default_field:{enabled:!0,analyzer:"standard"},selector:{$and:[{type:"entity"}]},fields:[{name:"published",type:"boolean"},{name:"trashed",type:"boolean"},{name:"title",type:"string"},{name:"slug",type:"string"},{name:"schema",type:"string"},{name:"modifiedAt",type:"string"},{name:"publishedAt",type:"string"}]}},t.forEach(e=>{const t=o.field(e.type);/number|string|boolean/.test(t.dataType)&&r.index.fields.push({name:`fields.${e.slug}.value`,type:t.dataType}),/array/.test(t.dataType)&&r.index.fields.push({name:`fields.${e.slug}.value.[].slug`,type:"string"}),/taxonomy/.test(e.type)&&r.index.fields.push({name:`fields.${e.slug}.value.terms.[].slug`,type:"string"})}),u.next=7,n.default.awrap(i.connect(c.config).index(r));case 7:return a=u.sent,u.abrupt("return",a);case 9:case"end":return u.stop()}}),null,null,null,Promise)}}},function(e,t,r){"use strict";const n=r(2),s=[{type:"attachment",name:"Attachment",dataType:null},{type:"audio",name:"Audio",dataType:null},{type:"checkbox",name:"Checkbox",dataType:"boolean"},{type:"color",name:"Color",dataType:"string"},{type:"date",name:"Date",dataType:"string"},{type:"embedly",name:"Embedly",dataType:null},{type:"entity",name:"Entity",dataType:"array"},{type:"entityGrid",name:"Entity Grid",dataType:"array"},{type:"entityTile",name:"Entity Tile",dataType:"array"},{type:"image",name:"Image",dataType:null},{type:"keyValue",name:"Key Value",dataType:null},{type:"number",name:"Number",dataType:"number"},{type:"richText",name:"Rich Text",dataType:null},{type:"select",name:"Select",dataType:"array"},{type:"taxonomy",name:"Taxonomy",dataType:null},{type:"text",name:"Text",dataType:"string"},{type:"textArea",name:"Text Area",dataType:"string"},{type:"user",name:"User",dataType:"array"},{type:"video",name:"Video",dataType:null},{type:"vimeo",name:"Vimeo",dataType:null}];class a{static fields(){return s.map(e=>Object.freeze(e))}static field(e){return n.find(a.fields(),{type:e})}}e.exports=a},function(e,t){e.exports=require("request-promise")},function(e,t,r){"use strict";const n={environment:process.env.ENVIRONMENT||"development",api:{prefix:process.env.API_PREFIX||"",forceHttps:!!process.env.API_FORCE_HTTPS&&JSON.parse(process.env.API_FORCE_HTTPS),blacklistToken:(process.env.API_BLACKLIST_TOKEN||"").split(","),blacklistReferrer:(process.env.API_BLACKLIST_REFERRER||"").split(",")},session:{secret:process.env.SESSION_SECRET||"change_me",ttl:parseInt(process.env.SESSION_TTL||7200,10)},cache:{enabled:!!process.env.CACHE_ENABLED&&JSON.parse(process.env.CACHE_ENABLED),ttl:60*parseInt(process.env.CACHE_TTL||30,10),compress:!!process.env.CACHE_COMPRESS&&JSON.parse(process.env.CACHE_COMPRESS),memory:{max:1e3*parseInt(process.env.CACHE_MEMORY_MAX||128,10)*1e3}},redis:{url:process.env.REDIS_URL,host:process.env.REDIS_HOST,port:process.env.REDIS_PORT,password:process.env.REDIS_PASSWORD,db:parseInt(process.env.REDIS_DB||0,10)},logentriesToken:process.env.LOGENTRIES_TOKEN};e.exports=n},function(e,t){e.exports=require("lodash/pick")},function(e,t){e.exports=require("lodash/isArray")},function(e,t,r){"use strict";const n=process.env.PORT||5001,s=process.env.HOST||"localhost",a=r(2),i=r(10),o=r(23),c=r(24),u=r(25),l=r(26),d=r(27),p=r(28),f=r(29),h=r(30),m=r(31)(h),g=r(32),y=r(19);e.exports=function(e={},t=!0){const r=a.merge({},y,e),x=i(),v={secret:r.session.secret,resave:!0,saveUninitialized:!0};if(r.redis.url||r.redis.host){const e={ttl:r.session.ttl};r.redis.url?e.url=r.redis.url:(e.host=r.redis.host,e.port=r.redis.port,e.password=r.redis.password,e.db=r.redis.db);const t=f.createClient(e);t.unref(),t.on("error",console.log),v.store=new m({client:t})}else v.cookie={maxAge:r.session.ttl};if(x.use(u()),x.use(c("tiny")),x.use(l()),x.use(d.json({limit:"50mb"})),x.use(d.urlencoded({extended:!0,limit:"50mb"})),x.use(p()),x.use(h(v)),g(x,r),t){const e=o.createServer(x);e.on("listening",()=>{console.log(`listening: http://${s}:${n}`)}),e.listen(n)}return x}},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("method-override")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("connect-redis")},function(e,t,r){"use strict";var n=r(0)(r(1));process.on("unhandledRejection",e=>console.error(e));const s=r(2),a=r(10),i=r(33),o=r(34),c=r(4),u=r(35),l=c.promisifyAll(r(36)),d=r(37),p=r(38),f=r(39),h=r(40),m=r(41),g=r(19);e.exports=function(e,t={},y=null){const x=f(s.merge({},m.defaultConfig,g,t)),v=e=>(t,r,n)=>{c.resolve(e(t,r,n)).catch(n)},w=e=>!!s.find(["/auth/user","/config/info"],t=>new RegExp("^"+t).test(e.path))||!("development"!==x.environment||!s.find(["/token","/email"],t=>new RegExp("^"+t).test(e.path))),b=y||((e,t,r)=>{if(!w(e))return e.session.userId?void r():(t.status(401),void t.send({code:401,message:"Not authorised"}));r()}),_=e=>(s.forIn(e,(e,t,r)=>{s.isPlainObject(e)&&(e=_(e),0===s.keys(e).length&&delete r[t]),s.isUndefined(e)&&delete r[t]}),e),k=e=>s.mergeWith({},JSON.parse(JSON.stringify(e)),_(s.cloneDeep(e)));let E;if(x.cache.enabled)if(x.redis.url||x.redis.host){const e={ttl:x.cache.ttl};x.redis.url?e.url=x.redis.url:(e.host=x.redis.host,e.port=x.redis.port,e.password=x.redis.password,e.db=x.redis.db),E=i.caching(s.merge({store:o},e));const t=E.store.getClient();t.on("ready",()=>{console.log("redis: ready")}),t.on("error",e=>{console.error("redis: error:",e)})}else E=i.caching({store:"memory",ttl:x.cache.ttl,max:x.cache.memory.max,length:e=>p(e)});const S=e=>{const t={path:e.path,query:e.query,body:e.body};return`${e.session.slug}:${h.h64(JSON.stringify(t),43981).toString(16)}`},T=v((e,t,r)=>{var s,a;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(!(x.cache.enabled&&"guest"===e.session.role&&!1!==(e.query.__cache&&JSON.parse(e.query.__cache)))){i.next=22;break}return i.prev=2,s=S(e),i.next=6,n.default.awrap(E.get(s));case 6:if("string"!=typeof(a=i.sent)){i.next=17;break}if(!x.cache.compress){i.next=12;break}return i.next=11,n.default.awrap(l.gunzipAsync(Buffer.from(a,"base64")));case 11:a=i.sent.toString();case 12:try{a=JSON.parse(a)}catch(e){}return t.set("X-Cached-Response",!0),t.status(a?200:204),t.send(a),i.abrupt("return");case 17:i.next=22;break;case 19:i.prev=19,i.t0=i.catch(2),console.error(i.t0);case 22:t.set("X-Cached-Response",!1),r();case 24:case"end":return i.stop()}}),null,null,[[2,19]],Promise)}),P=m.Jwt(x),q=a.Router(),I=(e,t,r)=>{e.headers["x-forwarded-proto"]&&"https"!==e.headers["x-forwarded-proto"]&&e.headers["cf-visitor"]&&"https"!==JSON.parse(e.headers["cf-visitor"]).scheme?t.redirect(301,`https://${e.headers.host}${e.path}`):r()};"production"===x.environment&&!0===x.api.forceHttps&&(e.enable&&e.enable("trust proxy"),e.use(I)),e.use("/"+x.api.prefix,(e,t,r)=>{const n={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,PUT,POST,DELETE,OPTIONS","Access-Control-Expose-Headers":"X-Slug, X-Role, X-User-Id",Vary:"Accept-Encoding, X-Api-Token"};e.headers["access-control-request-headers"]&&(n["Access-Control-Allow-Headers"]=e.headers["access-control-request-headers"]),t.set(n),"OPTIONS"!==e.method?r():t.sendStatus(200)},(e,t,r)=>{if(w(e))return void r();const n=e.headers.referrer||e.headers.referer;if(n){const e=new u(n).hostname.split(".").slice(-2).join(".");if(x.api.blacklistReferrer.indexOf(e)>-1)return t.status(401),void t.send({code:401,message:"Not authorised, referrer blacklisted"})}const s=e.headers["x-api-token"]||e.query.apiToken||e.session.apiToken;if(!s)return t.status(401),void t.send({code:401,message:"Not authorised, missing token"});if(x.api.blacklistToken.indexOf(s)>-1)return t.status(401),void t.send({code:401,message:"Not authorised, token blacklisted"});try{const t=P.verifyToken(s);e.session.userId=t.userId,e.session.slug=t.slug,e.session.role=t.role||"guest"}catch(e){return t.status(401),void t.send({code:401,message:`Not authorised, token verification failed (${e.message})`,error:e})}if(!e.session.slug)return t.status(401),void t.send({code:401,message:"Not authorised, missing slug"});e.session.role||(e.session.role="guest"),e.session.userId&&t.set("X-User-Id",e.session.userId),t.set("X-Environment",x.environment),t.set("X-Slug",e.session.slug),t.set("X-Role",e.session.role),r()},q),e.get("/"+x.api.prefix,(e,t)=>{t.send("<pre> ______\n|A     |\n|  /\\  |\n| /  \\ |\n|(    )|\n|  )(  |\n|______|</pre>")});const C={app:e,router:q,cache:E,authMiddleware:b,permissionMiddleware:(e,t,r,n)=>{if(!t.session.role)return r.status(401),void r.send({permissions:e,message:"Error: undefined role"});if("super"===t.session.role)return void n();const a=m.Roles();s.isString(e)&&(e=e.split(","));let i=!1;if(e.forEach(e=>{a.role(t.session.role).permissions[e.trim()]&&(i=!0)}),!a.role(t.session.role)||!i)return r.status(401),void r.send({permissions:e,message:"Error: not authorised"});n()},cacheMiddleware:T,asyncMiddleware:v,getConfig:e=>{var t;return n.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return(t=k(x)).slug=e,t.db.name=e,r.abrupt("return",t);case 4:case"end":return r.stop()}}),null,null,null,Promise)},handleResponse:(e,t,r,s=!1)=>{var a,i;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(null==r?(r="",t.status(204),t.send(r)):(r=d.stringify(r),t.status(200),t.send(JSON.parse(r))),!s||!x.cache.enabled||"guest"!==e.session.role){o.next=9;break}if(a=S(e),!x.cache.compress){o.next=7;break}return o.next=6,n.default.awrap(l.gzipAsync(Buffer.from(r)));case 6:r=o.sent.toString("base64");case 7:i=e.query.__cache?parseInt(e.query.__cache,10):x.cache.ttl,E.set(a,r,{ttl:i});case 9:case"end":return o.stop()}}),null,null,null,Promise)},handleError:(e,t,r)=>{"[object Object]"===Object.prototype.toString.call(r)&&(r=d.parse(d.stringify(r))),r=r.response||r,console.error(r);const n=r.statusCode||r.status||r.code||500,s=r.stack||r.error||r.message||r.body||r.data||r.statusText||r;t.status("string"==typeof n?500:n),t.send({code:n,message:s})}};Object.keys(m).forEach(e=>{C[e]=m[e]});const O=(e,t)=>{t.removeListener("finish",O),t.removeListener("close",O)};return"production"!==x.environment&&e.use((e,t,r)=>{t.on("finish",O.bind(null,e,t)),t.on("close",O.bind(null,e,t)),r()}),r(86)(C,x),r(87)(C,x),r(88)(C,x),r(89)(C,x),r(90)(C,x),r(92)(C,x),r(93)(C,x),r(94)(C,x),r(95)(C,x),r(96)(C,x),r(97)(C,x),r(98)(C,x),r(99)(C,x),r(100)(C,x),r(101)(C,x),r(102)(C,x),r(103)(C,x),r(105)(C,x),r(106)(C,x),r(107)(C,x),r(108)(C,x),r(109)(C,x),e}},function(e,t){e.exports=require("cache-manager")},function(e,t){e.exports=require("cache-manager-redis-store")},function(e,t){e.exports=require("url-parse")},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("circular-json-es6")},function(e,t){e.exports=require("object-sizeof")},function(e,t){e.exports=require("deep-freeze")},function(e,t){e.exports=require("xxhashjs")},function(e,t,r){"use strict";function n(){}n.defaultConfig=r(42),n.Assist=(...e)=>new(r(11))(...e),n.Auth=(...e)=>new(r(44))(...e),n.ClientConfig=(...e)=>new(r(3))(...e),n.Db=(...e)=>new(r(5))(...e),n.Ecommerce=(...e)=>new(r(46))(...e),n.Email=(...e)=>new(r(14))(...e),n.Embedly=(...e)=>new(r(62))(...e),n.Entity=(...e)=>new(r(15))(...e),n.Fields=(...e)=>new(r(17))(...e),n.Helpers=(...e)=>new(r(6))(...e),n.Instagram=(...e)=>new(r(66))(...e),n.Jwt=(...e)=>new(r(67))(...e),n.Pdf=(...e)=>new(r(69))(...e),n.Roles=(...e)=>new(r(13))(...e),n.Schema=(...e)=>new(r(16))(...e),n.Settings=(...e)=>new(r(73))(...e),n.Shippo=(...e)=>new(r(74))(...e),n.Shopify=(...e)=>new(r(76))(...e),n.Stripe=(...e)=>new(r(80))(...e),n.Taxonomy=(...e)=>new(r(83))(...e),n.Tools=(...e)=>new(r(84))(...e),n.User=(...e)=>new(r(85))(...e),e.exports=n},function(e,t,r){"use strict";(function(t){const n=r(8),s={environment:process.env.ENVIRONMENT||"development",debug:process.env.DEBUG||!1,slug:process.env.SLUG,baseUrl:process.env.BASE_URL||"",db:{url:process.env.DB_URL,host:process.env.DB_HOST,name:process.env.DB_NAME,requestPlugin:process.env.DB_REQUEST_PLUGIN,meterType:process.env.DB_METER_TYPE},auth:{superUserId:process.env.AUTH_SUPER_USER_ID,tokenSecret:process.env.AUTH_TOKEN_SECRET||"change_this_secret"},dev:{userId:process.env.DEV_USER_ID||"dev",role:process.env.DEV_ROLE||"super"},cms:{title:process.env.CMS_TITLE,url:process.env.CMS_URL},assist:{url:process.env.ASSIST_URL,username:process.env.ASSIST_USERNAME,password:process.env.ASSIST_PASSWORD},mailgun:{apiKey:process.env.MAILGUN_API_KEY,domain:process.env.MAILGUN_DOMAIN},embedly:{apiKey:process.env.EMBEDLY_API_KEY},pdf:{templatesPath:n.resolve(t,"pdf")},email:{templatesPath:n.resolve(t,"email")},provider:{google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},instagram:{clientId:process.env.INSTAGRAM_CLIENT_ID,clientSecret:process.env.INSTAGRAM_CLIENT_SECRET},spotify:{clientId:process.env.SPOTIFY_CLIENT_ID,clientSecret:process.env.SPOTIFY_CLIENT_SECRET},stripe:{clientId:process.env.STRIPE_CLIENT_ID,clientSecret:process.env.STRIPE_CLIENT_SECRET,apiKey:process.env.STRIPE_API_KEY},twitter:{consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,accessTokenKey:process.env.TWITTER_ACCESS_TOKEN_KEY,accessTokenSecret:process.env.TWITTER_ACCESS_TOKEN_SECRET},vimeo:{clientId:process.env.VIMEO_CLIENT_ID,clientSecret:process.env.VIMEO_CLIENT_SECRET}}};e.exports=s}).call(this,"/")},function(e,t){e.exports=require("password-hash")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(45),i=r(7),o=r(3),c=r(5),u={google:"https://www.googleapis.com/oauth2/v4/token",instagram:"https://api.instagram.com/oauth/access_token",stripe:"https://connect.stripe.com/oauth/token",vimeo:"https://api.vimeo.com/oauth/access_token",spotify:"https://accounts.spotify.com/api/token"};e.exports=class{constructor(e){this.config=e}authUser(e,t){var r,a,i=this;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(!(s.get(i.config,"auth.superUserId","").split(",").map(e=>e.trim()).indexOf(t)>-1)){o.next=3;break}return o.abrupt("return",{id:t,active:!0,role:"super"});case 3:return o.next=5,n.default.awrap(c.connect(i.config,e).get("config"));case 5:if(r=o.sent,a=s.find(r.users,e=>e.email.toLowerCase()===t.toLowerCase())){o.next=9;break}throw Error("User not found: "+t);case 9:if(a.active){o.next=11;break}throw Error("User not active: "+t);case 11:return o.abrupt("return",a);case 12:case"end":return o.stop()}}),null,null,null,Promise)}authProvider(e,t={},r=null,c=!1){var l,d,p,f,h,m,g,y=this;return n.default.async((function(x){for(;;)switch(x.prev=x.next){case 0:return l=new o(y.config),x.next=3,n.default.awrap(l.get());case 3:return d=x.sent,p=s.merge({},y.config.provider[e],t||{}),(f=r?s.get(d,["userSettings",r,"provider",e]):s.get(d,["provider",e]))||(f={}),h={grant_type:c?"refresh_token":"authorization_code",code:t&&t.code?t.code:void 0,client_id:p.clientId,client_secret:p.clientSecret,redirect_uri:p.redirectUri,refresh_token:c?f.refresh_token:void 0},m=u[e],x.prev=9,x.next=12,n.default.awrap(i.post(m,a.stringify(h)));case 12:g=x.sent.data,x.next=18;break;case 15:throw x.prev=15,x.t0=x.catch(9),new Error(JSON.stringify(x.t0.response.data));case 18:if((f=s.merge({},f,g)).begins=Math.floor((new Date).getTime()/1e3),"google"!==e){x.next=30;break}return x.prev=21,x.next=24,n.default.awrap(i.get("https://www.googleapis.com/plus/v1/people/me?access_token="+f.access_token));case 24:f.user=x.sent.data,x.next=30;break;case 27:x.prev=27,x.t1=x.catch(21),console.error(x.t1);case 30:if("spotify"!==e){x.next=40;break}return x.prev=31,x.next=34,n.default.awrap(i.get("https://api.spotify.com/v1/me?access_token="+f.access_token));case 34:f.user=x.sent.data,x.next=40;break;case 37:x.prev=37,x.t2=x.catch(31),console.error(x.t2);case 40:return r?s.set(d,["userSettings",r,"provider",e],f):s.set(d,["provider",e],f),x.abrupt("return",l.set(d));case 42:case"end":return x.stop()}}),null,null,[[9,15],[21,27],[31,37]],Promise)}}},function(e,t){e.exports=require("querystring")},function(e,t,r){"use strict";const n=r(2),s=r(4),a=r(5),i=r(6);e.exports=class{constructor(e){this.config=e}getType(e,t){return new s((r,s)=>{t.sort=n.isString(t.sort)?`"${t.sort}"`:t.sort,a.connect(this.config).search("ecommerce",e,t).then(r,s)})}setType(e,t){return new s((r,n)=>{t.type=e,i.createOrUpdate(this.config,t).then(r,n)})}deleteType(e){return new s((t,r)=>{e=e.map(e=>({_id:e._id,_rev:e._rev,_deleted:!0})),i.chunkUpdate(this.config,e,1e3).then(t,r)})}getOrder(e){return new s((t,r)=>{a.connect(this.config).view("ecommerce","orderByOrderId",{key:e,include_docs:!0}).then(e=>{e.rows.length?t(e.rows[0].doc):r(new Error("Order not found"))},r)})}verifyDiscount(e){return new s((t,r)=>{a.connect(this.config).view("ecommerce","discountByCode",{keys:[e],include_docs:!0}).then(n=>{if(n.rows.length){const e=n.rows[0].doc,s=(new Date).getTime(),a=new Date(Date.parse(e.dateStart)).getTime(),i=new Date(Date.parse(e.dateEnd)).getTime();if(a>s)return void r(new Error("Discount not valid (not begun)"));if(i<s)return void r(new Error("Discount not valid (expired)"));t(e)}else r(new Error({statusCode:404,message:`Discount code not found (${e})`}))},r)})}}},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("createsend-node")},function(e,t){e.exports=require("nodemailer-mailgun-transport")},function(e,t){e.exports=require("inky")},function(e,t){e.exports=require("mjml")},function(e,t){e.exports=require("mjml-core")},function(e,t){e.exports=require("mjml-validator")},function(e,t){e.exports=require("mjml-mailchimp")},function(e,t){e.exports=require("html-to-text")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("i18n-iso-countries")},function(e,t){e.exports=require("sass")},function(e,t){e.exports=require("pug")},function(e,t){e.exports=require("ejs")},function(e,t){e.exports=require("juice")},function(e,t,r){"use strict";const n=r(2),s=r(4),a=r(63);e.exports=class{constructor(e){this.config=e}oembed(e){return new s((t,r)=>{const s=new a({key:this.config.embedly.apiKey}),i={urls:n.isArray(e)?e:[e],format:"json"};s.oembed(i,(e,n)=>{e?r(e):t(n)})})}}},function(e,t){e.exports=require("embedly")},function(e,t){e.exports=require("json-query")},function(e,t){e.exports=require("deep-diff")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(18);e.exports=class{constructor(e){this.options=s.merge({},{client_id:null,access_token:null,version:"v1",host:"https://api.instagram.com"},e||{})}_request(e,t,r){var i,o,c=this;return n.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return(i={method:e,url:[c.options.host,c.options.version,t].join("/"),qs:{access_token:r.access_token||c.options.access_token,client_id:r.client_id||c.options.client_id}}).qs=s.extend({},i.qs,r),u.next=4,n.default.awrap(a(i));case 4:return o=u.sent,u.abrupt("return",JSON.parse(o));case 6:case"end":return u.stop()}}),null,null,null,Promise)}get(e,t){return this._request("GET",e,t)}}},function(e,t,r){"use strict";const n=r(68);e.exports=class{constructor(e){this.config=e}signToken(e,t={}){return n.sign(e,this.config.auth.tokenSecret,t)}verifyToken(e){return n.verify(e,this.config.auth.tokenSecret)}}},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(9),a=r(8),i=r(2),o=r(70),c=r(18),u=r(71),l=r(15),d=r(3);e.exports=class{constructor(e){this.config=e}getTemplates(){var e,t=this;return n.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return e={},s.next=3,n.default.awrap(u(t.config.pdf.templatesPath));case 3:return s.sent.forEach(n=>{if(!/\.js$/.test(n))return;const s=n.replace(t.config.pdf.templatesPath+"/","").replace(".js","");e[s]=r(72)(n)}),s.abrupt("return",e);case 6:case"end":return s.stop()}}),null,null,null,Promise)}getPayload(e,t,r){var i,c,u,d,p=this;return n.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return i=o(s.readFileSync(a.join(p.config.pdf.templatesPath,e+".js"),"utf-8"),e+".js",{},!0),c=new l(p.config),f.next=4,n.default.awrap(c.entityList([t],{children:2,role:r}));case 4:if(0!==(u=f.sent.map(e=>e.doc)).length){f.next=7;break}throw new Error("Entity not found");case 7:return d=i(l.flattenValues(u)[0]),f.abrupt("return",d);case 9:case"end":return f.stop()}}),null,null,null,Promise)}getPdf(e){var t,r,s,a,o,u=this;return n.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return t=new d(u.config),l.next=3,n.default.awrap(t.get());case 3:return r=l.sent,s=i.get(r,"assets.slug",u.config.slug),a=`${u.config.assist.url}/${s}/pdf/download`,e="object"==typeof e?JSON.stringify(e).replace(/'/gi,"â€™"):e,l.next=9,n.default.awrap(c({method:"POST",uri:a,encoding:null,form:{payload:e}}));case 9:return o=l.sent,l.abrupt("return",o);case 11:case"end":return l.stop()}}),null,null,null,Promise)}}},function(e,t){e.exports=require("eval")},function(e,t){e.exports=require("recursive-readdir")},function(e,t){function r(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=72},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(3);e.exports=class{constructor(e){return this.config=e,this}update(e){var t,r,i=this;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=new a(i.config),o.next=3,n.default.awrap(t.get());case 3:return(r=o.sent).client=s.merge({},r.client,e),o.abrupt("return",t.set(r));case 6:case"end":return o.stop()}}),null,null,null,Promise)}}},function(e,t,r){"use strict";const n=r(4),s=r(75);e.exports=class{constructor(e){this.config=e,this.shippo=s(e.shippo.token)}getQuote(e,t){return new n((r,n)=>{const s={object_purpose:"QUOTE",zip:this.config.shippo.fromZip,country:this.config.shippo.fromCountry},a={object_purpose:"QUOTE",zip:e.zip,country:e.country,metadata:""};t.distance_unit="cm",t.mass_unit="kg",this.shippo.shipment.create({object_purpose:"QUOTE",address_from:s,address_to:a,parcel:t}).then(e=>{const t=(e,s)=>{("QUEUED"===e.object_status||"WAITING"===e.object_status)&&s<10?this.shippo.shipment.retrieve(e.object_id).then(e=>{t(e,s+1)}):this.shippo.shipment.rates(e.object_id).then(e=>{r(e)},e=>{console.error("There was an error retrieving rates : %s",e),n(e)})};t(e,0)},e=>{console.error("There was an error creating shipment: %s",e),n(e)})})}}},function(e,t){e.exports=require("shippo")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(7),a=r(77),i=r(78),o=r(79),c=r(3);e.exports=class{constructor(e){this.config=e}getCatalog({shopLink:e,productLinkTemplate:t}){var r,u,l,d,p,f,h=this;return n.default.async((function(m){for(;;)switch(m.prev=m.next){case 0:return r=new c(h.config),m.next=3,n.default.awrap(r.get());case 3:return u=m.sent,m.next=6,n.default.awrap(s({url:`https://${u.provider.shopify.domain}.myshopify.com/api/graphql`,method:"post",headers:{"X-Shopify-Storefront-Access-Token":u.provider.shopify.storefrontAccessToken},data:{query:"\n          query {\n            shop {\n              name\n              primaryDomain {\n                url\n              }\n              description\n              products(first: 250) {\n                edges {\n                  node {\n                    id\n                    handle\n                    title\n                    description\n                    onlineStoreUrl\n                    images(first: 1) {\n                      edges {\n                        node {\n                          originalSrc\n                          transformedSrc\n                        }\n                      }\n                    }\n                    productType\n                    vendor\n                    availableForSale\n                    priceRange {\n                      minVariantPrice {\n                        amount\n                        currencyCode\n                      }\n                      maxVariantPrice {\n                        amount\n                        currencyCode\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        "}}));case 6:return l=m.sent.data.data,d=i.compile(t),p=l.shop.products.edges.map(e=>({"g:id":e.node.handle,"g:title":a.encode(e.node.title),"g:description":a.encode(e.node.description),"g:link":d({handle:e.node.handle}),"g:image_link":e.node.images.edges[0].node.originalSrc,"g:brand":e.node.vendor,"g:condition":"new","g:availability":e.node.availableForSale?"in stock":"out of stock","g:price":`${e.node.priceRange.minVariantPrice.amount} ${e.node.priceRange.minVariantPrice.currencyCode}`})),f=[{name:"title",text:l.shop.name},{name:"link",text:e},{name:"description",text:l.shop.description}],p.forEach(e=>{f.push({name:"item",children:e})}),m.abrupt("return",`<?xml version="1.0"?>\n    <rss xmlns:g="http://base.google.com/ns/1.0" version="2.0">\n      ${o({channel:f})}\n    </rss>`);case 12:case"end":return m.stop()}}),null,null,null,Promise)}}},function(e,t){e.exports=require("he")},function(e,t){e.exports=require("handlebars")},function(e,t){e.exports=require("jsontoxml")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(81),i=r(4),o=r(82),c=r(3),u=r(14),l=r(5),d=r(6);e.exports=class{constructor(e){this.config=e,this.stripe=a(this.config.stripe.apiKey),this.email=new u(this.config),this.hashids=new o(this.config.slug,6,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ")}getSettings(){var e,t,r,s=this;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return e=new c(s.config),a.next=3,n.default.awrap(e.get());case 3:t=a.sent,a.prev=4,r=t.module.ecommerce,a.next=11;break;case 8:throw a.prev=8,a.t0=a.catch(4),new Error(a.t0);case 11:a.prev=11,r.clientStripeAccountId=t.provider.stripe.stripe_user_id,a.next=18;break;case 15:throw a.prev=15,a.t1=a.catch(11),new Error(a.t1);case 18:return r.client=t.client,r.assets=t.assets,a.abrupt("return",r);case 21:case"end":return a.stop()}}),null,null,[[4,8],[11,15]],Promise)}checkout(e,t){return new i((r,n)=>{this.getSettings().then(a=>{const i=s.get(a,"createsend.checkoutSubscriberListId");t.subscribe&&i&&this.email.subscribe(t.customerDetails,"createsend",i).then(e=>{console.log(e)},e=>{console.error(e)}),this.findOrCreateCustomer(t.customerDetails.email,t).then(s=>{this.createOrder(t,s).then(t=>{this.updateOrCreateStripeCustomer(a.clientStripeAccountId,s,e,t).then(e=>{this.updateCustomer(s,e,t).then(s=>{this.createCharge(a,e,s,t).then(e=>{this.sendReceipt(a,s,t).then(i=>{e.messages.orderReceipt=i,this.sendNotification(a,s,t).then(t=>{e.messages.orderNotification=t,this.updateOrder(e).then(e=>{r(e)},n)},n)},n)},n)},n)},n)},n)},n)},n).catch(n)})}retrieveAccount(){return new i((e,t)=>{this.getSettings().then(r=>{this.stripe.accounts.retrieve(r.clientStripeAccountId).then(e,t)},t)})}refund(e,t){return new i((r,n)=>{this.getSettings().then(s=>{this.stripe.refunds.create({refund_application_fee:!0,charge:e.charge.id,amount:t},{stripe_account:s.clientStripeAccountId}).then(()=>{this.stripe.charges.retrieve(e.charge.id,{stripe_account:s.clientStripeAccountId}).then(t=>{e.charge.status=t.status,e.charge.amount=t.amount,e.charge.amountRefunded=t.amount_refunded,d.createOrUpdate(this.config,e).then(r,n)},n)},n)},n)})}findOrCreateCustomer(e,t){return new i((r,n)=>{l.connect(this.config).view("ecommerce","customerByEmail",{keys:[e],include_docs:!0}).then(e=>{if(e.rows.length)r(e.rows[0].doc);else{const e=JSON.stringify(new Date).replace(/"/g,""),s={type:"customer",createdAt:e,modifiedAt:e,email:t.customerDetails.email,name:t.customerDetails.name,phone:t.customerDetails.phone,billingAddress:t.billingAddress,shippingAddress:t.shippingAddress,orders:[]};l.connect(this.config).insert(s).then(e=>{s._id=e.id,s._rev=e.rev,r(s)},n)}},n)})}updateOrCreateStripeCustomer(e,t,r,n){return new i((s,a)=>{const i={source:r,email:n.customer.email,description:n.customer.name,metadata:{customer_id:t._id}};t.stripe&&t.stripe.customer.id?this.stripe.customers.update(t.stripe.customer.id,i,{stripe_account:e}).then(s,t=>{"StripeInvalidRequestError"===t.type&&"id"===t.param?this.stripe.customers.create(i,{stripe_account:e}).then(s,a):a(t)}):this.stripe.customers.create(i,{stripe_account:e}).then(s,a)})}createOrder(e,t){return new i((r,n)=>{const s=e.items.map(e=>({id:e.id,title:e.title.replace(/<br\s?>/gi," ").replace(/<\/?p>|<\/?span>/gi,""),price:e.price,quantity:e.quantity,metadata:e.metadata||{}})),a=JSON.stringify(new Date).replace(/"/g,""),i={type:"order",orderId:this.hashids.encode((new Date).getTime()),createdAt:a,modifiedAt:a,customer:{id:t._id,email:t.email,name:t.name},items:s,shippingMethod:{name:e.shippingMethod.name,amount:Number(e.shippingMethod.amount)},subtotal:Number(e.subtotal),tax:{rate:e.tax.rate||0,includedInPrice:e.tax.includedInPrice||!1,total:e.tax.total||0,show:e.tax.show||!1},discount:{code:e.discount.code||"",name:e.discount.name||"",total:e.discount.total||0},total:Number(e.total),billingAddress:e.billingAddress,shippingAddress:e.shippingAddress,messages:{},status:"pending",test:!0};l.connect(this.config).insert(i).then(e=>{i._id=e.id,i._rev=e.rev,r(i)},n)})}updateOrder(e){return new i((t,r)=>{l.connect(this.config).insert(e).then(r=>{e._rev=r.rev,t(e)},r)})}updateCustomer(e,t,r){return new i((n,s)=>{const a=JSON.stringify(new Date).replace(/"/g,"");e.modifiedAt=a,e.orders||(e.orders=[]),e.orders.push(r._id),e.stripe||(e.stripe={customer:{id:null}}),e.stripe.customer.id=t.id,l.connect(this.config).insert(e).then(t=>{e._rev=t.rev,n(e)},s)})}createCharge(e,t,r,n){return new i((a,i)=>{const o=100*Number(n.total),c={amount:o,currency:e.currency.iso.toLowerCase(),customer:t.id,capture:!0,description:n.orderId,metadata:{customer_id:r._id,order_id:n._id},statement_descriptor:s.kebabCase(e.storeName).toUpperCase(),application_fee:Math.ceil(.02*o)};this.stripe.charges.create(c,{stripe_account:e.clientStripeAccountId}).then(e=>{n.charge={paymentGateway:"stripe",id:e.id,status:e.status,currency:e.currency.toUpperCase(),amount:e.amount,amountRefunded:e.amount_refunded},n.test=!e.livemode,a(n)},i)})}sendReceipt(e,t,r){return new i((n,a)=>{const i={settings:e,order:r},o={from:`${e.emailSenderName} <${e.emailSenderAddress}>`,to:t.email,subject:`Your order at ${e.storeName} (${r.orderId})`},c=s.get(e,"assets.slug",this.config.slug);this.email.sendEmail(o,c+"/order-receipt",i).then(n,a)})}sendNotification(e,t,r){return new i((t,n)=>{const a={settings:e,order:r},i={from:`${e.emailSenderName} <${e.emailSenderAddress}>`,to:e.emailSenderAddress,subject:`New order at ${e.storeName} (${r.orderId})`},o=s.get(e,"assets.slug",this.config.slug);this.email.sendEmail(i,o+"/order-notification",a).then(t,n)})}}},function(e,t){e.exports=require("stripe")},function(e,t){e.exports=require("hashids")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(5),i=r(3);e.exports=class{constructor(e){this.config=e}create(e){var t,r,s=this;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=new i(s.config),a.next=3,n.default.awrap(t.get());case 3:return(r=a.sent).taxonomies.push(e),a.abrupt("return",t.set(r));case 6:case"end":return a.stop()}}),null,null,null,Promise)}read(e){var t,r,a,o=this;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new i(o.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,a=s.find(r.taxonomies,{slug:e})){c.next=7;break}throw Error("Taxonomy not found: "+e);case 7:return c.abrupt("return",a);case 8:case"end":return c.stop()}}),null,null,null,Promise)}update(e){var t,r,a,o=this;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new i(o.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,-1!==(a=s.findIndex(r.taxonomies,{slug:e.slug}))){c.next=7;break}throw Error("Taxonomy not found: "+e.slug);case 7:return r.taxonomies.splice(a,1,e),c.abrupt("return",t.set(r));case 9:case"end":return c.stop()}}),null,null,null,Promise)}delete(e){var t,r,a=this;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=new i(a.config),o.next=3,n.default.awrap(t.get());case 3:return r=o.sent,e=s.isArray(e)?e:[e],r.taxonomies=r.taxonomies.filter(t=>-1===e.indexOf(t.slug)),o.abrupt("return",t.set(r));case 7:case"end":return o.stop()}}),null,null,null,Promise)}entitiesByTerm(e){var t,r,i,o,c=this;return n.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return t=a.connect(c.config),u.next=3,n.default.awrap(t.view("entity","byTaxonomyTerm",{keys:[e.id],group:!0}));case 3:if(r=u.sent.rows.map(e=>e.value)[0]){u.next=6;break}return u.abrupt("return",[]);case 6:return i=[],s.forEach(r,e=>{i=i.concat(e)}),i=s.uniq(i),u.next=11,n.default.awrap(t.fetch({keys:i,include_docs:!0}));case 11:return o=u.sent.rows.filter(e=>e.doc).map(e=>e.doc),u.abrupt("return",o);case 13:case"end":return u.stop()}}),null,null,null,Promise)}createTerm(e,t){var r,s=this;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,n.default.awrap(s.read(e));case 2:return(r=a.sent).terms.push(t),a.abrupt("return",s.update(r));case 5:case"end":return a.stop()}}),null,null,null,Promise)}updateTerm(e){var t,r=this;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,n.default.awrap(r.entitiesByTerm(e));case 2:return t=(t=i.sent).map(t=>(t.fields=s.mapValues(t.fields,t=>("taxonomy"===t.type&&t.value&&(t.value.terms||(t.value.terms=[]),t.value.terms=t.value.terms.map(t=>(t.id===e.id&&(t.title=e.title,t.slug=e.slug),t.parents||(t.parents=[]),t.parents=t.parents.map(t=>(t.id===e.id&&(t.title=e.title,t.slug=e.slug),t)),t))),t)),t)),i.abrupt("return",a.connect(r.config).bulk({docs:t}));case 5:case"end":return i.stop()}}),null,null,null,Promise)}deleteTerm(e){var t,r=this;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,n.default.awrap(r.entitiesByTerm(e));case 2:return t=(t=i.sent).map(t=>(t.fields=s.mapValues(t.fields,t=>("taxonomy"===t.type&&t.value&&(t.value.terms||(t.value.terms=[]),t.value.terms=t.value.terms.filter(t=>t.id!==e.id&&!(t.parents||[]).filter(t=>t.id===e.id).length)),t)),t)),i.abrupt("return",a.connect(r.config).bulk({docs:t}));case 5:case"end":return i.stop()}}),null,null,null,Promise)}}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(4).promisifyAll(r(9)),a=r(12),i=r(5);e.exports=class{constructor(e){this.config=e}getDb(){var e,t=this;return n.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.default.awrap(i.connect(t.config).fetch({include_docs:!0}));case 2:return e=r.sent,r.abrupt("return",e);case 4:case"end":return r.stop()}}),null,null,null,Promise)}getChanges(){var e,t=this;return n.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.default.awrap(i.connect(t.config).changes({limit:50,include_docs:!0,filter:"tools/changesEntity"}));case 2:return e=r.sent,r.abrupt("return",e);case 4:case"end":return r.stop()}}),null,null,null,Promise)}importDb(e){var t,r,o,c,u,l=this;return n.default.async((function(d){for(;;)switch(d.prev=d.next){case 0:return t=l.config.db.name,d.next=3,n.default.awrap(s.readFileAsync(e.path));case 3:return r=d.sent,o=JSON.parse(r).rows.map(e=>{const{doc:t}=e;return delete t._rev,t}),d.next=7,n.default.awrap(s.unlinkAsync(e.path));case 7:return c=new a({url:l.config.db.url,plugins:["promises","retry"]}).db,d.prev=8,d.next=11,n.default.awrap(c.destroy(t));case 11:d.next=15;break;case 13:d.prev=13,d.t0=d.catch(8);case 15:return d.next=17,n.default.awrap(c.create(t));case 17:return d.next=19,n.default.awrap(i.connect(l.config,t).bulk({docs:o}));case 19:return u=d.sent,d.abrupt("return",u);case 21:case"end":return d.stop()}}),null,null,[[8,13]],Promise)}}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(3);e.exports=class{constructor(e){return this.config=e,this}create(e){var t,r,s=this;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=new a(s.config),i.next=3,n.default.awrap(t.get());case 3:return r=i.sent,e.id=e.id.toLowerCase(),e.email=e.email.toLowerCase(),r.users.push(e),i.abrupt("return",t.set(r));case 8:case"end":return i.stop()}}),null,null,null,Promise)}read(e){var t,r,i,o=this;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(o.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,i=s.find(r.users,{id:e})){c.next=7;break}throw Error("User not found: "+e);case 7:return c.abrupt("return",i);case 8:case"end":return c.stop()}}),null,null,null,Promise)}update(e){var t,r,i,o=this;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(o.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,-1!==(i=s.findIndex(r.users,{id:e.id}))){c.next=7;break}throw Error("User not found: "+e.id);case 7:return e.email=e.email.toLowerCase(),r.users.splice(i,1,e),c.abrupt("return",t.set(r));case 10:case"end":return c.stop()}}),null,null,null,Promise)}delete(e){var t,r,i=this;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=new a(i.config),o.next=3,n.default.awrap(t.get());case 3:return r=o.sent,e=s.isArray(e)?e:[e],r.users=r.users.filter(t=>-1===e.indexOf(t.id)),o.abrupt("return",t.set(r));case 7:case"end":return o.stop()}}),null,null,null,Promise)}}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Analytics:e,router:t,authMiddleware:r,cacheMiddleware:s,asyncMiddleware:a,getConfig:i,handleResponse:o,handleError:c})=>{t.get("/analytics.:ext?",r,s,a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i());case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.get(t.query));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5,!0),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(20);e.exports=({Auth:e,router:t,authMiddleware:r,permissionMiddleware:a,asyncMiddleware:i,getConfig:o,handleResponse:c,handleError:u})=>{t.get("/auth/user.:ext?",i((t,r)=>{var a,i;return n.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.t0=e,l.next=3,n.default.awrap(o(t.query.slug));case 3:return l.t1=l.sent,a=(0,l.t0)(l.t1),l.t2=s,l.next=8,n.default.awrap(a.authUser(t.query.slug,t.query.userId));case 8:l.t3=l.sent,l.t4=["active","role"],i=(0,l.t2)(l.t3,l.t4);try{c(t,r,i)}catch(e){u(t,r,e)}case 12:case"end":return l.stop()}}),null,null,null,Promise)})),t.get("/auth/provider/:provider/config",r,a.bind(null,["settings","userSettings"]),i((e,t)=>{var r;return n.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,n.default.awrap(o());case 2:if((r=s.sent).provider[e.params.provider]){s.next=7;break}return t.status(404),t.send({}),s.abrupt("return");case 7:t.status(200),t.send({clientId:r.provider[e.params.provider].clientId});case 9:case"end":return s.stop()}}),null,null,null,Promise)})),t.get("/auth/provider/:provider",r,a.bind(null,"settings"),(e,t)=>{t.status(e.query.error?500:200),t.send(`${e.params.provider}: ${e.query.error_description?e.query.error_description:"successfully authenticated"}`)}),t.post("/auth/provider/:provider",r,a.bind(null,"settings"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.authProvider(t.params.provider,t.body));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.put("/auth/provider/:provider/refresh",r,i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.authProvider(t.params.provider,t.body,null,!0));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.post("/auth/provider/:provider/:userId",r,a.bind(null,"userSettings"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.authProvider(t.params.provider,t.body,t.params.userId));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.put("/auth/provider/:provider/:userId/refresh",r,i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.authProvider(t.params.provider,t.body,t.params.userId,!0));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({router:e,cache:t,asyncMiddleware:r,getConfig:s,handleResponse:a})=>{e.get("/cache/clear.:ext?",r((e,r)=>{var i;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,n.default.awrap(s());case 2:if(o.sent.cache.enabled){o.next=6;break}return a(e,r,"Cache disabled"),o.abrupt("return");case 6:i="redis"===t.store.name?"*":void 0,t.keys(i).then(n=>{const s=n.filter(t=>0===t.indexOf(e.session.slug));s.forEach(e=>t.del(e)),a(e,r,s.length+" items removed from cache")});case 8:case"end":return o.stop()}}),null,null,null,Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(20);e.exports=({ClientConfig:e,router:t,authMiddleware:r,permissionMiddleware:a,asyncMiddleware:i,getConfig:o,handleResponse:c,handleError:u})=>{t.get("/config/info.:ext?",i((t,r)=>{var a,i;return n.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.t0=e,l.next=3,n.default.awrap(o(t.query.slug||t.session.slug));case 3:return l.t1=l.sent,a=(0,l.t0)(l.t1),l.t2=s,l.next=8,n.default.awrap(a.get());case 8:if(l.t3=l.sent,l.t4=["client.name"],i=(0,l.t2)(l.t3,l.t4),0!==Object.keys(i).length){l.next=14;break}return u(t,r,new Error("Account ID not found")),l.abrupt("return");case 14:try{c(t,r,i)}catch(e){u(t,r,e)}case 15:case"end":return l.stop()}}),null,null,null,Promise)})),t.get("/config.:ext?",r,i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.get());case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.post("/config.:ext?",r,a.bind(null,"config"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.set(t.body.config));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";e.exports=({router:e})=>{e.all("/debug/useragent.:ext?",(e,t)=>{const n=r(91).parse(e.headers["user-agent"]);t.status(200),t.send(`\n      <html>\n        <head>\n          <title>${n.source}</title>\n          <meta name="description" content="${n.source}">\n        </head>\n        <body>${n.source}</body>\n      </html>\n    `)})}},function(e,t){e.exports=require("express-useragent")},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(21);e.exports=({Ecommerce:e,router:t,authMiddleware:r,permissionMiddleware:a,asyncMiddleware:i,getConfig:o,handleResponse:c,handleError:u})=>{t.get("/ecommerce/order/message/:message.:ext?",r,a.bind(null,"ecommerce"),i((t,r)=>{var s,a;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.t0=e,i.next=3,n.default.awrap(o(t.session.slug));case 3:return i.t1=i.sent,s=(0,i.t0)(i.t1),i.prev=5,i.next=8,n.default.awrap(s.getOrder(t.query.orderId));case 8:a=i.sent,c(t,r,a.messages[t.params.message].email.html),i.next=15;break;case 12:i.prev=12,i.t2=i.catch(5),u(t,r,i.t2);case 15:case"end":return i.stop()}}),null,null,[[5,12]],Promise)})),t.get("/ecommerce/:type.:ext?",r,a.bind(null,"ecommerce"),i((t,r)=>{var a;return n.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return s(t.query.sort)&&(t.query.sort=JSON.stringify(t.query.sort).replace(/\\"/g,"")),i.t0=e,i.next=4,n.default.awrap(o(t.session.slug));case 4:return i.t1=i.sent,a=(0,i.t0)(i.t1),i.prev=6,i.t2=c,i.t3=t,i.t4=r,i.next=12,n.default.awrap(a.getType(t.params.type,t.query));case 12:i.t5=i.sent,(0,i.t2)(i.t3,i.t4,i.t5),i.next=19;break;case 16:i.prev=16,i.t6=i.catch(6),u(t,r,i.t6);case 19:case"end":return i.stop()}}),null,null,[[6,16]],Promise)})),t.post("/ecommerce/:type.:ext?",r,a.bind(null,"ecommerce"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(/^(discount|order)$/.test(t.params.type)){a.next=3;break}return u(t,r,"Illegal type: "+t.params.type),a.abrupt("return");case 3:return a.t0=e,a.next=6,n.default.awrap(o(t.session.slug));case 6:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=8,a.t2=c,a.t3=t,a.t4=r,a.next=14,n.default.awrap(s.setType(t.params.type,t.body.item));case 14:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=21;break;case 18:a.prev=18,a.t6=a.catch(8),u(t,r,a.t6);case 21:case"end":return a.stop()}}),null,null,[[8,18]],Promise)})),t.delete("/ecommerce/:type.:ext?",r,a.bind(null,"ecommerce"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(/^(discount)$/.test(t.params.type)){a.next=3;break}return u(t,r,"Illegal type: "+t.params.type),a.abrupt("return");case 3:return a.t0=e,a.next=6,n.default.awrap(o(t.session.slug));case 6:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=8,a.t2=c,a.t3=t,a.t4=r,a.next=14,n.default.awrap(s.deleteType(t.body.item));case 14:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=21;break;case 18:a.prev=18,a.t6=a.catch(8),u(t,r,a.t6);case 21:case"end":return a.stop()}}),null,null,[[8,18]],Promise)})),t.get("/ecommerce/discount/:code.:ext?",i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.verifyDiscount(t.params.code));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Email:e,Entity:t,router:r,asyncMiddleware:s,getConfig:a,handleResponse:i,handleError:o})=>{r.all("/email/preview.:ext?",s((r,s)=>{var c,u,l,d,p,f;return n.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:if(d=function(t={}){var d,p;return n.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:if(!u.data){f.next=3;break}return i(r,s,t),f.abrupt("return");case 3:return f.t0=e,f.next=6,n.default.awrap(a(l));case 6:return f.t1=f.sent,d=(0,f.t0)(f.t1),f.prev=8,f.next=11,n.default.awrap(d.getTemplate(c.templateSlug,t,u));case 11:p=f.sent,i(r,s,p.html),f.next=18;break;case 15:f.prev=15,f.t2=f.catch(8),o(r,s,f.t2);case 18:case"end":return f.stop()}}),null,null,[[8,15]],Promise)},c=Object.keys(r.body).length?r.body:r.query||{},u={data:!!c.data&&JSON.parse(c.data),inlineStyles:!c.inlineStyles||JSON.parse(c.inlineStyles),inky:!!c.inky&&JSON.parse(c.inky),mjml:!!c.mjml&&JSON.parse(c.mjml),skipValidation:!!c.skipValidation&&JSON.parse(c.skipValidation)},l=c.slug||r.session.slug,!c.payload){h.next=7;break}return d(JSON.parse(c.payload)),h.abrupt("return");case 7:if(!c.entityId){h.next=18;break}return h.t0=t,h.next=11,n.default.awrap(a(l));case 11:return h.t1=h.sent,p=(0,h.t0)(h.t1),h.next=15,n.default.awrap(p.entityList([c.entityId],{children:2}));case 15:return f=h.sent.map(e=>e.doc),d(p.flattenValues(f)[0]),h.abrupt("return");case 18:d();case 19:case"end":return h.stop()}}),null,null,null,Promise)})),r.all("/email/send.:ext?",s((t,r)=>{var s,c,u,l,d,p;return n.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return s=Object.keys(t.body).length?t.body:t.query||{},c={inlineStyles:!s.inlineStyles||JSON.parse(s.inlineStyles),inky:!!s.inky&&JSON.parse(s.inky),mjml:!!s.mjml&&JSON.parse(s.mjml),skipValidation:!s.skipValidation||JSON.parse(s.skipValidation)},u={fromName:s.fromName||"",fromEmail:s.fromEmail,toName:s.toName||"",toEmail:s.toEmail,from:`${s.fromName||""} <${s.fromEmail}>`,to:s.toEmail,subject:s.subject},l=s.slug||t.session.slug,f.t0=e,f.next=7,n.default.awrap(a(l));case 7:return f.t1=f.sent,d=(0,f.t0)(f.t1),f.prev=9,f.next=12,n.default.awrap(d.sendEmail(u,s.templateSlug,s.payload,c));case 12:p=f.sent,i(t,r,p),f.next=19;break;case 16:f.prev=16,f.t2=f.catch(9),o(t,r,f.t2);case 19:case"end":return f.stop()}}),null,null,[[9,16]],Promise)})),r.post("/email/subscribe.:ext?",s((t,r)=>{var s;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return c.t0=e,c.next=3,n.default.awrap(a(t.session.slug));case 3:return c.t1=c.sent,s=(0,c.t0)(c.t1),c.prev=5,c.t2=i,c.t3=t,c.t4=r,c.next=11,n.default.awrap(s.subscribe({email:t.body.email||t.query.email,name:t.body.name||t.query.name||""}));case 11:c.t5=c.sent,(0,c.t2)(c.t3,c.t4,c.t5),c.next=18;break;case 15:c.prev=15,c.t6=c.catch(5),o(t,r,c.t6);case 18:case"end":return c.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Embedly:e,router:t,authMiddleware:r,asyncMiddleware:s,getConfig:a,handleResponse:i,handleError:o})=>{t.get("/embedly/oembed.:ext?",r,s((t,r)=>{var s;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return c.t0=e,c.next=3,n.default.awrap(a());case 3:return c.t1=c.sent,s=(0,c.t0)(c.t1),c.prev=5,c.t2=i,c.t3=t,c.t4=r,c.next=11,n.default.awrap(s.oembed(t.query.url||t.query.urls));case 11:c.t5=c.sent,(0,c.t2)(c.t3,c.t4,c.t5),c.next=18;break;case 15:c.prev=15,c.t6=c.catch(5),o(t,r,c.t6);case 18:case"end":return c.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(21);e.exports=({Db:e,Entity:t,router:r,authMiddleware:a,permissionMiddleware:i,cacheMiddleware:o,asyncMiddleware:c,getConfig:u,handleResponse:l,handleError:d})=>{r.get("/entities/index.:ext?",c((t,r)=>n.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.prev=0,s.t0=l,s.t1=t,s.t2=r,s.t3=n.default,s.t4=e,s.next=8,n.default.awrap(u(t.session.slug));case 8:return s.t5=s.sent,s.t6=(0,s.t4)(s.t5).indexAsync(),s.next=12,s.t3.awrap.call(s.t3,s.t6);case 12:s.t7=s.sent,(0,s.t0)(s.t1,s.t2,s.t7),s.next=19;break;case 16:s.prev=16,s.t8=s.catch(0),d(t,r,s.t8);case 19:case"end":return s.stop()}}),null,null,[[0,16]],Promise))),r.all("/entities/search?.:ext?",o,c((e,r)=>{var s,a,i,o,c,p,f,h,m,g,y,x,v,w,b;return n.default.async((function(_){for(;;)switch(_.prev=_.next){case 0:return s=Object.keys(e.body).length?e.body:e.query,a=void 0!==s.include_docs&&JSON.parse(s.include_docs),i=void 0!==s.include_fields?"object"==typeof s.include_fields?s.include_fields:JSON.parse(s.include_fields):[],o=void 0!==s.select&&s.select,c=void 0!==s.children&&("object"==typeof s.children?s.children:JSON.parse(s.children)),p=void 0!==s.parents&&("object"==typeof s.parents?s.parents:JSON.parse(s.parents)),!0===c&&(c=1),!0===p&&(p=1),f=void 0!==s.trashed&&JSON.parse(s.trashed),h=void 0!==s.sort?s.sort:null,m=void 0!==s.limit?parseInt(s.limit,10):null,g=void 0!==s.bookmark?s.bookmark:null,y=void 0!==s.group_field?s.group_field:null,x=void 0!==s.index?s.index:null,v=s.query||s.q,(w=[]).push(f?"trashed:true":"!trashed:true"),"guest"===e.session.role&&w.push("published:true"),v&&w.push(`(${v})`),w=w.join(" AND "),_.t0=t,_.next=23,n.default.awrap(u(e.session.slug));case 23:return _.t1=_.sent,b=(0,_.t0)(_.t1),_.prev=25,_.t2=l,_.t3=e,_.t4=r,_.next=31,n.default.awrap(b.entitySearch({query:w,include_docs:a,include_fields:i,sort:h,limit:m,bookmark:g,group_field:y,index:x},{select:o,children:c,parents:p,role:e.session.role}));case 31:_.t5=_.sent,(0,_.t2)(_.t3,_.t4,_.t5,!0),_.next=38;break;case 35:_.prev=35,_.t6=_.catch(25),d(e,r,_.t6);case 38:case"end":return _.stop()}}),null,null,[[25,35]],Promise)})),r.all("/entities/find.:ext?",o,c((e,r)=>{var s,a,i,o,c,p;return n.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return s=Object.keys(e.body).length?e.body:e.query,a=void 0!==s.children&&("object"==typeof s.children?s.children:JSON.parse(s.children)),i=void 0!==s.parents&&("object"==typeof s.parents?s.parents:JSON.parse(s.parents)),!0===a&&(a=1),!0===i&&(i=1),o=void 0!==s.trashed&&JSON.parse(s.trashed),(c=s.query?JSON.parse(s.query):{selector:{}}).use_index=["entityIndex","entity"],c.selector.$and||(c.selector={$and:[c.selector]}),o?c.selector.$and.push({trashed:!0}):c.selector.$and.push({$or:[{trashed:{$exists:!1}},{trashed:!1}]}),"guest"===e.session.role&&c.selector.$and.push({published:!0}),e.query.limit&&(c.limit=parseInt(e.query.limit,10)),f.t0=t,f.next=15,n.default.awrap(u(e.session.slug));case 15:return f.t1=f.sent,p=(0,f.t0)(f.t1),f.prev=17,f.t2=l,f.t3=e,f.t4=r,f.next=23,n.default.awrap(p.entityFind(c,{children:a,parents:i,role:e.session.role}));case 23:f.t5=f.sent,(0,f.t2)(f.t3,f.t4,f.t5,!0),f.next=30;break;case 27:f.prev=27,f.t6=f.catch(17),d(e,r,f.t6);case 30:case"end":return f.stop()}}),null,null,[[17,27]],Promise)})),r.get("/entities/field.:ext?",o,c((e,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=t,a.next=3,n.default.awrap(u(e.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=l,a.t3=e,a.t4=r,a.next=11,n.default.awrap(s.fieldValues(e.query.slug||e.query.fieldSlug,e.query.searchTerm));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5,!0),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),d(r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),r.all("/entities.:ext?",o,c((e,r)=>{var a,i,o,c,p,f;return n.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return a=Object.keys(e.body).length?e.body:e.query,i=void 0!==a.select&&a.select,o=void 0!==a.children&&("object"==typeof a.children?a.children:JSON.parse(a.children)),c=void 0!==a.parents&&("object"==typeof a.parents?a.parents:JSON.parse(a.parents)),!0===o&&(o=1),!0===c&&(c=1),(p=a.ids||a.id)&&(p=s(p)?p:[p]),h.t0=t,h.next=11,n.default.awrap(u(e.session.slug));case 11:return h.t1=h.sent,f=(0,h.t0)(h.t1),h.prev=13,h.t2=l,h.t3=e,h.t4=r,h.next=19,n.default.awrap(f.entityList(p,{select:i,children:o,parents:c,role:e.session.role}));case 19:h.t5=h.sent,(0,h.t2)(h.t3,h.t4,h.t5,!0),h.next=26;break;case 23:h.prev=23,h.t6=h.catch(13),d(e,r,h.t6);case 26:case"end":return h.stop()}}),null,null,[[13,23]],Promise)})),r.get("/entity/revisions.:ext?",a,i.bind(null,"entityRead"),c((e,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=t,a.next=3,n.default.awrap(u(e.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=l,a.t3=e,a.t4=r,a.next=11,n.default.awrap(s.entityRevisions(e.query.id));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),d(e,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),r.post("/entity.:ext?",a,i.bind(null,"entityCreate"),c((e,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=t,a.next=3,n.default.awrap(u(e.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=l,a.t3=e,a.t4=r,a.next=11,n.default.awrap(s.entityCreate(e.body.entity));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),d(e,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),r.get("/entity.:ext?",a,i.bind(null,"entityRead"),c((e,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=t,a.next=3,n.default.awrap(u(e.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=l,a.t3=e,a.t4=r,a.next=11,n.default.awrap(s.entityRead(e.query.id));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),d(e,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),r.put("/entity.:ext?",a,i.bind(null,"entityUpdate"),c((e,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=t,a.next=3,n.default.awrap(u(e.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=l,a.t3=e,a.t4=r,a.next=11,n.default.awrap(s.entityUpdate(e.body.entity||e.body.entities,e.body.restore||!1));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),d(e,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),r.delete("/entity.:ext?",a,i.bind(null,"entityDelete"),c((e,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=t,a.next=3,n.default.awrap(u(e.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=l,a.t3=e,a.t4=r,a.next=11,n.default.awrap(s.entityDelete(e.body.entity||e.body.entities,e.body.forever||!1));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),d(e,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),r.delete("/entity/trashed.:ext?",a,i.bind(null,"entityDelete"),c((e,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=t,a.next=3,n.default.awrap(u(e.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=l,a.t3=e,a.t4=r,a.next=11,n.default.awrap(s.entityDelete("trashed"));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),d(e,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({ClientConfig:e,router:t,cacheMiddleware:r,asyncMiddleware:s,getConfig:a,handleResponse:i,handleError:o})=>{t.get("/metadata.:ext?",r,s((t,r)=>{var s,c;return n.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return u.t0=e,u.next=3,n.default.awrap(a(t.session.slug));case 3:return u.t1=u.sent,s=(0,u.t0)(u.t1),u.next=7,n.default.awrap(s.get());case 7:c=u.sent;try{i(t,r,c.client.metadata,!0)}catch(e){o(t,r,e)}case 9:case"end":return u.stop()}}),null,null,null,Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2);e.exports=({Pdf:e,ClientConfig:t,router:r,asyncMiddleware:a,getConfig:i,handleError:o})=>{r.get("/pdf/view.:ext?",a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:a.t1=a.sent,(s=(0,a.t0)(a.t1)).getPayload(t.query.template,t.query.id,t.session.role).then(e=>{s.getPdf(e).then(e=>{r.type("application/pdf"),r.status(200),r.send(e)},o.bind(null,t,r))},o.bind(null,t,r));case 6:case"end":return a.stop()}}),null,null,null,Promise)})),r.get("/pdf/download.:ext?",a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:a.t1=a.sent,(s=(0,a.t0)(a.t1)).getPayload(t.query.template,t.query.id,t.session.role).then(e=>{s.getPdf(e).then(t=>{r.attachment(e.fileName||"download.pdf"),r.status(200),r.send(t)},o.bind(null,t,r))},o.bind(null,t,r));case 6:case"end":return a.stop()}}),null,null,null,Promise)})),r.get("/pdf/payload.:ext?",a((t,r)=>n.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.t0=e,s.next=3,n.default.awrap(i(t.session.slug));case 3:s.t1=s.sent,(0,s.t0)(s.t1).getPayload(t.query.template,t.query.id,t.session.role).then(e=>{r.status(200),r.json(e)},o.bind(null,t,r));case 6:case"end":return s.stop()}}),null,null,null,Promise))),r.get("/pdf/submit.:ext?",a((r,a)=>{var c,u,l,d;return n.default.async((function(p){for(;;)switch(p.prev=p.next){case 0:return p.next=2,n.default.awrap(i(r.session.slug));case 2:return c=p.sent,u=t(c),p.next=6,n.default.awrap(u.get());case 6:l=p.sent,d=s.get(l,"assets.slug",r.session.slug),e(c).getPayload(r.query.template,r.query.id,r.session.role).then(e=>{e=JSON.stringify(e).replace(/'/gi,"â€™"),a.status(200),a.send(`\n          <body onload='form.submit()'>\n            <form id='form' method='POST' action='${c.assist.url}/${d}/pdf/download' target='_self'>\n              <input type='hidden' name='payload' value='${e}' />\n            </form>\n          </body>\n        `)},o.bind(null,r,a));case 10:case"end":return p.stop()}}),null,null,null,Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));const s=r(2),a=r(7);e.exports=({Auth:e,ClientConfig:t,router:r,cacheMiddleware:i,asyncMiddleware:o,getConfig:c,handleResponse:u,handleError:l})=>{const d={google:"https://www.googleapis.com",instagram:"https://api.instagram.com",spotify:"https://api.spotify.com",vimeo:"https://api.vimeo.com"},p=o((r,i)=>{var o,p,f,h,m,g,y,x,v,w,b;return n.default.async((function(_){for(;;)switch(_.prev=_.next){case 0:return o=r.method,p=r.params[0],f=r.params[2]?r.params[1]:null,h=(r.params[2]||r.params[1]).split("/").filter(e=>""!==e).join("/"),_.next=6,n.default.awrap(c(r.session.slug));case 6:return m=_.sent,g=t(m),_.next=10,n.default.awrap(g.get());case 10:if(y=_.sent,!f){_.next=17;break}if(y.userSettings[f]){_.next=14;break}throw Error("User settings not found: "+f);case 14:x=y.userSettings[f].provider[p],_.next=18;break;case 17:x=y.provider[p];case 18:if(!(Math.floor((new Date).getTime()/1e3)-(x.begins||0)>x.expires_in)){_.next=35;break}return _.t0=e,_.next=22,n.default.awrap(c(r.session.slug));case 22:if(_.t1=_.sent,v=(0,_.t0)(_.t1),!f){_.next=31;break}return _.next=27,n.default.awrap(v.authProvider(p,{},f,!0));case 27:y=_.sent,x=y.userSettings[f].provider[p],_.next=35;break;case 31:return _.next=33,n.default.awrap(v.authProvider(p,{},null,!0));case 33:y=_.sent,x=y.provider[p];case 35:return w=s.merge({},r.query),w=s.omitBy(w,(e,t)=>/^(__)/.test(t)),/bearer/i.test(x.token_type)||(w.access_token=x.access_token),_.prev=38,_.next=41,n.default.awrap(a.request({url:h,baseURL:d[p],method:o,headers:{Authorization:"Bearer "+x.access_token},params:w}));case 41:b=_.sent,u(r,i,b.data,!0),_.next=48;break;case 45:_.prev=45,_.t2=_.catch(38),l(r,i,_.t2);case 48:case"end":return _.stop()}}),null,null,[[38,45]],Promise)});r.all(/\/provider\/([^/]+)\/([^/]+)\/api\/?(.+)?/,i,p),r.all(/\/provider\/([^/]+)\/api\/?(.+)?/,i,p)}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Schema:e,router:t,authMiddleware:r,permissionMiddleware:s,asyncMiddleware:a,getConfig:i,handleResponse:o,handleError:c})=>{t.post("/schema.:ext?",r,s.bind(null,"schema"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.create(t.body.schema));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.get("/schema.:ext?",r,s.bind(null,"schema"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.read(t.query.schemaId));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.put("/schema.:ext?",r,s.bind(null,"schema"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.update(t.body.schema));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.delete("/schema.:ext?",r,s.bind(null,"schema"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.delete(t.body.schemaSlug||t.body.schemaSlugs||t.query.schemaSlug||t.query.schemaSlugs));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.put("/schemas.:ext?",r,s.bind(null,"schema"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.updateAll(t.body.schemas));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Settings:e,router:t,authMiddleware:r,permissionMiddleware:s,asyncMiddleware:a,getConfig:i,handleResponse:o,handleError:c})=>{t.post("/settings.:ext?",r,s.bind(null,"settings"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.update(t.body.settings));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Shippo:e,router:t,asyncMiddleware:r,getConfig:s,handleResponse:a,handleError:i})=>{t.all("/shippo/quote.:ext?",r((t,r)=>{var o,c,u;return n.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.t0=e,l.next=3,n.default.awrap(s());case 3:return l.t1=l.sent,o=(0,l.t0)(l.t1),c=t.body.address||JSON.parse(t.params.address),u=t.body.parcel||JSON.parse(t.params.parcel),l.prev=7,l.t2=a,l.t3=t,l.t4=r,l.next=13,n.default.awrap(o.getQuote(c,u));case 13:l.t5=l.sent,(0,l.t2)(l.t3,l.t4,l.t5,!0),l.next=20;break;case 17:l.prev=17,l.t6=l.catch(7),i(t,r,l.t6);case 20:case"end":return l.stop()}}),null,null,[[7,17]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Shopify:e,router:t,cacheMiddleware:r,asyncMiddleware:s,getConfig:a,handleResponse:i,handleError:o})=>{t.get("/shopify/catalog.:ext?",r,s((t,r)=>{var s;return n.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return c.t0=e,c.next=3,n.default.awrap(a(t.session.slug));case 3:return c.t1=c.sent,s=(0,c.t0)(c.t1),c.prev=5,r.setHeader("Content-Type","application/rss+xml"),c.t2=i,c.t3=t,c.t4=r,c.next=12,n.default.awrap(s.getCatalog(t.query));case 12:c.t5=c.sent,(0,c.t2)(c.t3,c.t4,c.t5,!0),c.next=19;break;case 16:c.prev=16,c.t6=c.catch(5),o(t,r,c.t6);case 19:case"end":return c.stop()}}),null,null,[[5,16]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({ClientConfig:e,Instagram:t,router:s,cacheMiddleware:a,asyncMiddleware:i,getConfig:o,handleResponse:c,handleError:u})=>{const l={};s.get(/\/social\/twitter\/([^/]+)\/?(.+)?/,a,i((e,t)=>{var s,a,i,l,d,p;return n.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return s=e.params[0],a=e.params[1].split("/").filter(e=>""!==e),f.next=4,n.default.awrap(o(e.session.slug));case 4:return i=f.sent,l=r(4),d=r(104),p=l.promisifyAll(new d({consumer_key:i.provider.twitter.consumerKey,consumer_secret:i.provider.twitter.consumerSecret,access_token_key:i.provider.twitter.accessTokenKey,access_token_secret:i.provider.twitter.accessTokenSecret})),f.prev=8,f.t0=c,f.t1=e,f.t2=t,f.next=14,n.default.awrap(p[s+"Async"](a.join("/"),e.query));case 14:f.t3=f.sent,(0,f.t0)(f.t1,f.t2,f.t3,!0),f.next=21;break;case 18:f.prev=18,f.t4=f.catch(8),u(e,t,f.t4);case 21:case"end":return f.stop()}}),null,null,[[8,18]],l)})),s.get(/\/social\/instagram\/([^/]+)\/?(.+)?/,a,i((r,s)=>{var a,i,d,p,f,h,m,g;return n.default.async((function(y){for(;;)switch(y.prev=y.next){case 0:return a=r.params[0],i=r.params[1].split("/").filter(e=>""!==e),y.next=4,n.default.awrap(o(r.session.slug));case 4:if(d=y.sent,p=l[r.session.slug]){y.next=19;break}return f=e(d),y.prev=8,y.next=11,n.default.awrap(f.get());case 11:h=y.sent,p=h.provider.instagram.access_token,y.next=19;break;case 15:return y.prev=15,y.t0=y.catch(8),u(s,new Error("Instagram: access_token required")),y.abrupt("return");case 19:return l[r.session.slug]=p,m=t({client_id:d.provider.instagram.clientId}),y.prev=21,y.next=24,n.default.awrap(m[a](i.join("/"),{...r.query,access_token:p}));case 24:g=y.sent;try{delete g.pagination.next_url}catch(e){}c(r,s,g,!0),y.next=32;break;case 29:y.prev=29,y.t1=y.catch(21),u(r,s,y.t1);case 32:case"end":return y.stop()}}),null,null,[[8,15],[21,29]],Promise)}))}},function(e,t){e.exports=require("twitter")},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Ecommerce:e,Email:t,Stripe:r,router:s,authMiddleware:a,permissionMiddleware:i,asyncMiddleware:o,getConfig:c,handleResponse:u,handleError:l})=>{s.all("/stripe/checkout.:ext?",o((e,t)=>{var s,a,i;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return s=e.body.token||JSON.parse(e.query.token),a=e.body.order||JSON.parse(e.query.order),o.t0=r,o.next=5,n.default.awrap(c(e.session.slug));case 5:return o.t1=o.sent,i=(0,o.t0)(o.t1),o.prev=7,o.t2=u,o.t3=e,o.t4=t,o.next=13,n.default.awrap(i.checkout(s,a));case 13:o.t5=o.sent,(0,o.t2)(o.t3,o.t4,o.t5),o.next=20;break;case 17:o.prev=17,o.t6=o.catch(7),l(e,t,o.t6);case 20:case"end":return o.stop()}}),null,null,[[7,17]],Promise)})),s.post("/stripe/refund.:ext?",a,i.bind(null,"ecommerce"),o((e,t)=>{var s,a,i;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return s=e.body.order||JSON.parse(e.query.order),a=100*Number(e.body.amount||e.query.amount||0),o.t0=r,o.next=5,n.default.awrap(c(e.session.slug));case 5:return o.t1=o.sent,i=(0,o.t0)(o.t1),o.prev=7,o.t2=u,o.t3=e,o.t4=t,o.next=13,n.default.awrap(i.refund(s,a));case 13:o.t5=o.sent,(0,o.t2)(o.t3,o.t4,o.t5),o.next=20;break;case 17:o.prev=17,o.t6=o.catch(7),l(e,t,o.t6);case 20:case"end":return o.stop()}}),null,null,[[7,17]],Promise)})),s.get("/stripe/account.:ext?",a,i.bind(null,"ecommerce"),o((e,t)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=r,a.next=3,n.default.awrap(c(e.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=u,a.t3=e,a.t4=t,a.next=11,n.default.awrap(s.retrieveAccount());case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),l(e,t,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),s.get("/stripe/email.:ext?",o((s,a)=>{var i,o,d,p,f,h,m,g;return n.default.async((function(y){for(;;)switch(y.prev=y.next){case 0:return y.next=2,n.default.awrap(c(s.session.slug));case 2:return i=y.sent,o=t(i),d=r(i),p=e(i),y.next=8,n.default.awrap(d.getSettings());case 8:return f=y.sent,y.next=11,n.default.awrap(p.getOrder(s.query.orderId));case 11:return h=y.sent,m={settings:f,order:h},y.next=15,n.default.awrap(o.getTemplate(`${s.session.slug}/${s.query.template}`,m));case 15:g=y.sent;try{u(s,a,g.html)}catch(e){l(s,a,e)}case 17:case"end":return y.stop()}}),null,null,null,Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Taxonomy:e,router:t,authMiddleware:r,permissionMiddleware:s,cacheMiddleware:a,asyncMiddleware:i,getConfig:o,handleResponse:c,handleError:u})=>{t.post("/taxonomy.:ext?",r,s.bind(null,"taxonomyUpdate"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.create(t.body.taxonomy));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.get("/taxonomy.:ext?",a,i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.read(t.query.slug||t.query.taxonomySlug));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5,!0),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.put("/taxonomy.:ext?",r,s.bind(null,"taxonomyUpdate"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.update(t.body.taxonomy));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.delete("/taxonomy.:ext?",r,s.bind(null,"taxonomyUpdate"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.delete(t.body.taxonomySlug||t.body.taxonomySlugs||t.query.taxonomySlug||t.query.taxonomySlugs));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.post("/taxonomy/term.:ext?",r,s.bind(null,"taxonomyUpdate"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.createTerm(t.body.slug||t.body.taxonomySlug,t.body.term));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.put("/taxonomy/term.:ext?",r,s.bind(null,"taxonomyUpdate"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.updateTerm(t.query.term||t.body.term));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.delete("/taxonomy/term.:ext?",r,s.bind(null,"taxonomyUpdate"),i((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(o(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=c,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.deleteTerm(t.query.term||t.body.term));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),u(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Jwt:e,router:t,authMiddleware:s,asyncMiddleware:a,getConfig:i,handleResponse:o})=>{t.get("/token.:ext?",s,a((t,s)=>{var a,c,u,l,d,p;return n.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return f.next=2,n.default.awrap(i());case 2:a=f.sent,c={role:t.session.role,slug:t.session.slug,userId:t.session.userId},"super"!==t.session.role&&"development"!==a.environment||(c.role=t.query.role||t.session.role||a.dev.role,c.slug=t.query.slug||t.session.slug||a.dev.slug,"guest"!==c.role&&(c.userId=t.query.userId||t.session.userId||a.dev.userId)),u=r(2),l=u.pickBy(t.query,(e,t)=>/^(expiresIn|notBefore|audience|issuer|jwtid|subject|noTimestamp|header)$/.test(t)),l=u.mapValues(l,e=>u.isNaN(+e)?e:+e),d=e(a),p=d.signToken(c,l),t.session.apiToken=p,o(t,s,{token:p,payload:c,options:l});case 13:case"end":return f.stop()}}),null,null,null,Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({Tools:e,router:t,authMiddleware:r,permissionMiddleware:s,asyncMiddleware:a,getConfig:i,handleResponse:o,handleError:c})=>{t.get("/tools/export-db.:ext?",r,s.bind(null,"tools"),a((t,r)=>{var s,a;return n.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.t0=e,o.next=3,n.default.awrap(i(t.session.slug));case 3:return o.t1=o.sent,s=(0,o.t0)(o.t1),o.prev=5,o.next=8,n.default.awrap(s.getDb());case 8:a=o.sent,r.setHeader("Content-Disposition",`attachment; filename=${t.session.slug}.json`),r.setHeader("Content-Type","application/json"),r.status(200),r.send(a),o.next=18;break;case 15:o.prev=15,o.t2=o.catch(5),c(t,r,o.t2);case 18:case"end":return o.stop()}}),null,null,[[5,15]],Promise)})),t.get("/tools/changes.:ext?",r,a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.getChanges());case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}},function(e,t,r){"use strict";var n=r(0)(r(1));e.exports=({User:e,router:t,authMiddleware:r,permissionMiddleware:s,asyncMiddleware:a,getConfig:i,handleResponse:o,handleError:c})=>{t.post("/user.:ext?",r,s.bind(null,"user"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.create(t.body.user));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.get("/user.:ext?",r,s.bind(null,"user"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.read(t.query.userId));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.put("/user.:ext?",r,s.bind(null,"user"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.update(t.body.user));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)})),t.delete("/user.:ext?",r,s.bind(null,"user"),a((t,r)=>{var s;return n.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=e,a.next=3,n.default.awrap(i(t.session.slug));case 3:return a.t1=a.sent,s=(0,a.t0)(a.t1),a.prev=5,a.t2=o,a.t3=t,a.t4=r,a.next=11,n.default.awrap(s.delete(t.body.userId||t.body.userIds||t.query.userId||t.query.userIds));case 11:a.t5=a.sent,(0,a.t2)(a.t3,a.t4,a.t5),a.next=18;break;case 15:a.prev=15,a.t6=a.catch(5),c(t,r,a.t6);case 18:case"end":return a.stop()}}),null,null,[[5,15]],Promise)}))}}])}));
//# sourceMappingURL=server.js.map