!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AceApi=t():e.AceApi=t()}(global,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=77)}([function(e,t){e.exports=require("babel-runtime/helpers/createClass")},function(e,t){e.exports=require("babel-runtime/helpers/classCallCheck")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("bluebird")},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(71),o=function(){function e(t,n){return(0,r.default)(this,e),this.config=t,e.connect(t,n)}return(0,i.default)(e,null,[{key:"connect",value:function(e,t){return new u({url:e.db.url,maxAttempt:5,plugins:["promises",{retry:{retryDelayMultiplier:2,retryInitialDelayMsecs:500}}]}).db.use(t||e.db.name)}}]),e}();e.exports=o},function(e,t,n){"use strict";var r=o(n(7)),i=o(n(6)),a=o(n(1)),u=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var s=n(2),c=n(4),l=n(8),f={_id:"config",client:{},schemas:[],taxonomies:[],users:[],roles:(new(n(29))).roles()},d=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"get",value:function(){var e=(0,i.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=f,e.prev=1,e.next=4,c.connect(this.config).get("config");case 4:t=e.sent,t=s.merge({},f,t),e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:return t.slug=this.config.slug,e.abrupt("return",t);case 12:case"end":return e.stop()}},e,this,[[1,8]])}));return function(){return e.apply(this,arguments)}}()},{key:"set",value:function(){var e=(0,i.default)(r.default.mark(function e(t){return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t._id="config",delete t.roles,e.next=4,l.createOrUpdate(this.config,t);case 4:return t=e.sent,t=s.merge({},f,t),e.abrupt("return",t);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=d},function(e,t){e.exports=require("babel-runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("babel-runtime/regenerator")},function(e,t,n){"use strict";var r=u(n(10)),i=u(n(1)),a=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var o=n(2),s=n(3),c=n(4),l=function(){function e(t){(0,i.default)(this,e),this.config=t,this.assistUrl=t.assist.url,this.slug=t.slug}return(0,a.default)(e,[{key:"thumbnailSrc",value:function(e,t,n,r){if(!e)return"";var i=void 0;"string"==typeof t&&(i=t.split(/,|;/),t={},i.forEach(function(e){e=e.split(/_|:/),t[e[0]]=e[1]}));var a=!!e.crops&&e.crops[n];a?(t.x=a[0],t.y=a[1],t.x2=a[2],t.y2=a[3]):r&&(t.g=r),i=[],o.forEach(t,function(e,t){i.push([t,e].join(":"))});var u=i.join(";");if(/image/.test(e.thumbnailType)){var s=e.fileName;return"svg"===s.split(".").pop().toLowerCase()?[this.assistUrl,this.slug,s].join("/"):[this.assistUrl,this.slug,"transform",u,s].join("/")}if(/video|oembed|proxy/.test(e.thumbnailType)){var c=e.thumbnailUrl.replace(/https?:\/\//,"");return[this.assistUrl,this.slug,"proxy","transform",u,c].join("/")}return""}}],[{key:"createOrUpdate",value:function(e,t){return new s(function(n,r){c.connect(e).insert(t).then(function(e){t._id=e.id,t._rev=e.rev,n(t)},function(i){409===i.statusCode?c.connect(e).get(t._id).then(function(i){t._rev=i._rev,c.connect(e).insert(t).then(function(e){t._rev=e.rev,n(t)},r)},r):r(i)})})}},{key:"chunkUpdate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return new s(function(r,i){var a=[];o.chunk(t,n).forEach(function(t){a.push(new s(function(n,r){c.connect(e).bulk({docs:t}).then(n,r)}))}),s.all(a).then(r,i)})}},{key:"groupEntities",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=[],r={entities:[]};return e.forEach(function(e){(!e.groupBefore||r.entities.length>=t)&&(r={entities:[]}),r.entities.push(e),(!e.groupAfter||r.entities.length>=t)&&(r.ratio=0,r.entities.forEach(function(e){r.ratio+=(e.thumbnail||e).ratio}),r.entities.forEach(function(e){e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n}},{key:"now",value:function(){return(0,r.default)(new Date).replace(/"/g,"")}},{key:"replace",value:function(e,t,n){return e.map(function(e){return e[n]===t[n]?t:e})}}]),e}();e.exports=l},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var r=u(n(14)),i=u(n(1)),a=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var o=n(2),s=n(3),c=n(11),l=s.promisifyAll(n(9)),f=n(16),d=n(49),p=n(48),h=function(){function e(t){(0,i.default)(this,e),this.config=t,this.s3=new p.S3({accessKeyId:t.aws.accessKeyId,secretAccessKey:t.aws.accessKeySecret}),s.promisifyAll((0,r.default)(this.s3))}return(0,a.default)(e,[{key:"prepareUpload",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return new s(function(r,i){l.statAsync(t).then(function(i){var a=i.size,u=f.getType(t),o=d.v1(),s=c.extname(t),l=[n,""+o+s].join("/"),p={Bucket:e,Key:l,ACL:"public-read",StorageClass:"REDUCED_REDUNDANCY",Metadata:{},Expires:new Date("2099-01-01"),CacheControl:"max-age=31536000",ContentType:u,ContentLength:a};r({fileName:t,uploadOptions:p,metadata:{bucket:e,src:l,base:o,ext:s},original:{fileName:c.basename(t),fileSize:a,mimeType:u}})},i)})}},{key:"upload",value:function(e,t){var n=this;return new s(function(r,i){t.Body=l.createReadStream(e),n.s3.upload(t).send(function(e,t){e?i(e):r(t)})})}},{key:"getSignedUrl",value:function(e,t,n){return this.s3.getSignedUrlAsync("getObject",{Bucket:e,Key:t,ResponseContentDisposition:'attachment; filename="'+n+'"'})}},{key:"getObject",value:function(e,t){return this.s3.getObjectAsync({Bucket:e,Key:t})}},{key:"deleteFiles",value:function(e,t){var n=this;return new s(function(r,i){if(0!==t.length){var a=o.uniq(t.map(function(e){try{return e.metadata.s3.bucket}catch(e){return null}}).filter(function(e){return e})),u={},c=[];t.forEach(function(t){a.forEach(function(r){try{c.push(n.s3.listObjectsAsync({Bucket:r,Prefix:e+"/"+t.metadata.s3.base}))}catch(e){console.log(e)}})}),s.all(c).then(function(e){e.forEach(function(e){e.Contents.forEach(function(t){u[e.Name]||(u[e.Name]=[]),u[e.Name].push({Key:t.Key})})});var t=[];o.forEach(u,function(e,r){t.push(n.s3.deleteObjectsAsync({Bucket:r,Delete:{Objects:e}}))}),0!==t.length?s.all(t).then(i,r):i()},r)}else i()})}}]),e}();e.exports=h},function(e,t){e.exports=require("babel-runtime/helpers/typeof")},function(e,t){e.exports=require("babel-runtime/core-js/object/get-prototype-of")},function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("mime")},function(e,t,n){"use strict";var r=u(n(28)),i=u(n(1)),a=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var o=n(2),s=[{type:"attachment",name:"Attachment",dataType:null},{type:"audio",name:"Audio",dataType:null},{type:"checkbox",name:"Checkbox",dataType:"boolean"},{type:"color",name:"Color",dataType:"string"},{type:"date",name:"Date",dataType:"string"},{type:"embedly",name:"Embedly",dataType:null},{type:"entity",name:"Entity",dataType:"array"},{type:"entityGrid",name:"Entity Grid",dataType:"array"},{type:"entityTile",name:"Entity Tile",dataType:"array"},{type:"image",name:"Image",dataType:null},{type:"keyValue",name:"Key Value",dataType:null},{type:"number",name:"Number",dataType:"number"},{type:"richText",name:"Rich Text",dataType:null},{type:"select",name:"Select",dataType:"array"},{type:"taxonomy",name:"Taxonomy",dataType:null},{type:"text",name:"Text",dataType:"string"},{type:"textArea",name:"Text Area",dataType:"string"},{type:"video",name:"Video",dataType:null},{type:"vimeo",name:"Vimeo",dataType:null}],c=function(){function e(){(0,i.default)(this,e)}return(0,a.default)(e,null,[{key:"fields",value:function(){return s.map(function(e){return(0,r.default)(e)})}},{key:"field",value:function(t){return o.find(e.fields(),{type:t})}}]),e}();e.exports=c},function(e,t,n){"use strict";var r=o(n(7)),i=o(n(6)),a=o(n(1)),u=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var s=n(2),c=n(5),l=n(4),f=n(17),d=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(i=e.sent).schemas.push(t),e.next=7,this.updateEntityIndex(i.schemas);case 7:return e.abrupt("return",n.set(i));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(i=e.sent,a=s.find(i.schemas,{slug:t})){e.next=7;break}throw Error("Schema not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(i=e.sent,-1!==(a=s.findIndex(i.schemas,{slug:t.slug}))){e.next=7;break}throw Error("Schema not found: "+t.slug);case 7:return i.schemas.splice(a,1,t),e.next=10,this.updateEntityIndex(i.schemas);case 10:return e.abrupt("return",n.set(i));case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return i=e.sent,t=s.isArray(t)?t:[t],i.schemas=i.schemas.filter(function(e){return-1===t.indexOf(e.slug)}),i.schemas=i.schemas.map(function(e){return e.fields?(e.fields=e.fields.map(function(e){return e.settings?(e.settings.schemas&&(e.settings.schemas=e.settings.schemas.filter(function(e){return-1===t.indexOf(e)})),e):e}),e):e}),e.next=9,this.updateEntityIndex(i.schemas);case 9:return e.abrupt("return",n.set(i));case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateAll",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(i=e.sent).schemas=t,e.abrupt("return",n.set(i));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateEntityIndex",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],t.forEach(function(e){n=n.concat(e.fields)}),n=s.uniqBy(n,"slug"),i={name:"entity",type:"text",ddoc:"entityIndex",index:{default_field:{enabled:!0,analyzer:"standard"},selector:{$and:[{type:"entity"}]},fields:[{name:"published",type:"boolean"},{name:"trashed",type:"boolean"},{name:"title",type:"string"},{name:"slug",type:"string"},{name:"schema",type:"string"},{name:"modifiedAt",type:"string"},{name:"publishedAt",type:"string"}]}},n.forEach(function(e){var t=f.field(e.type);/number|string|boolean/.test(t.dataType)&&i.index.fields.push({name:"fields."+e.slug+".value",type:t.dataType}),/array/.test(t.dataType)&&i.index.fields.push({name:"fields."+e.slug+".value.[].slug",type:"string"}),/taxonomy/.test(e.type)&&i.index.fields.push({name:"fields."+e.slug+".value.terms.[].slug",type:"string"})}),e.next=7,l.connect(this.config).index(i);case 7:return a=e.sent,e.abrupt("return",a);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=d},function(e,t,n){"use strict";var r=s(n(10)),i=s(n(7)),a=s(n(6)),u=s(n(1)),o=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var c=n(2),l=n(3),f=n(51).diff,d=n(5),p=n(4),h=n(8),v=n(18),m=function(){function e(t){(0,u.default)(this,e),this.config=t}return(0,o.default)(e,[{key:"fieldValues",value:function(){var e=(0,a.default)(i.default.mark(function e(t,n){var r;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.connect(this.config).viewWithList("entity","byField","search",{startkey:[t],endkey:[t,{}],group:!0,searchTerm:n});case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"entitiesById",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return new l(function(u,o){0!==t.length?p.connect(r.config).view("entity",i?"byIdExtended":"byId",{keys:t,include_docs:!0}).then(function(t){var r=e.consolidateResult(t,n,i,a);u(r)},o):u([])})}},{key:"_getDocMap",value:function(){var e=(0,a.default)(i.default.mark(function e(t,n,r,a){var u,o,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r||n){e.next=2;break}return e.abrupt("return",s);case 2:return u=[],t.forEach(function(e){var t=!!e.doc?e.doc:e;n&&c.size(t.fields)?c.forEach(t.fields,function(e){c.isArray(e.value)&&e.value.forEach(function(e){e.id&&!s[e.id]&&u.push(e.id)})}):u.push(t.id||t._id)}),e.next=6,this.entitiesById(u,n,r,a);case 6:if((o=e.sent).forEach(function(e){s[e._id]=e}),l+=1,n&&!(n&&l>=n)){e.next=11;break}return e.abrupt("return",s);case 11:return e.next=13,this._getDocMap(o,n,r,a,s,l);case 13:return s=e.sent,o=null,e.abrupt("return",s);case 16:case"end":return e.stop()}},e,this)}));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"_extendDocs",value:function(){var t=(0,a.default)(i.default.mark(function t(n,r,a,u){var o;return i.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._getDocMap(n,r,a,u);case 2:return o=t.sent,n=e._mergeDocs(n,o,r),o=null,t.abrupt("return",n);case 6:case"end":return t.stop()}},t,this)}));return function(e,n,r,i){return t.apply(this,arguments)}}()},{key:"_detachFiles",value:function(t){var n=this;return new l(function(r,i){var a=e._fileIds(t);0!==a.length?p.connect(n.config).fetch({keys:a,include_docs:!0}).then(function(e){var t=e.rows.filter(function(e){return!e.value||!e.value.deleted});0!==t.length?(t=t.map(function(e){return delete e.doc.entity,e.doc}),h.chunkUpdate(n.config,t,1e3).then(r,i)):r([])},i):r([])})}},{key:"_removeChildren",value:function(e){var t=this;return new l(function(n,r){0!==e.length?(e=e.map(function(e){return e._id}),p.connect(t.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(function(i){var a=c.uniqBy(i.rows,function(e){return e.doc._id}).map(function(t){return t.doc.fields=c.mapValues(t.doc.fields,function(t){return c.isArray(t.value)&&(t.value=c.remove(t.value,function(t){return"entity"===t.type&&-1!==e.indexOf(t.id)})),t}),t.doc});0!==a.length?h.chunkUpdate(t.config,a,1e3).then(n,r):n([])},r)):n([])})}},{key:"_updateChildren",value:function(e){var t=this;return new l(function(n,r){if(0!==e.length){var i={};e=e.map(function(e){return i[e._id]=e,e._id}),p.connect(t.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(function(e){var a=e.rows.map(function(e){var t=e.doc;return c.forEach(t.fields,function(e,n){c.isArray(e.value)&&(t.fields[n].value=e.value.map(function(e){return"entity"===e.type&&i[e.id]&&(e.slug=i[e.id].slug,e.title=i[e.id].title,e.schema=i[e.id].schema,e.published=i[e.id].published,i[e.id].thumbnail?e.thumbnail=i[e.id].thumbnail:e.thumbnail=null),e}))}),t});h.chunkUpdate(t.config,a,1e3).then(n,r)},r)}else n([])})}},{key:"_updateFiles",value:function(e){var t=this;return new l(function(n,r){if(0!==e.length){var i=[],a={};e.forEach(function(e){e.oldId&&(a[e.oldId]=null,i.push(e.oldId)),e.newId&&(a[e.newId]=e.entity,i.push(e.newId))}),i=i.filter(function(e){return c.isString(e)}),p.connect(t.config).fetch({keys:i,include_docs:!0}).then(function(e){var i=e.rows.filter(function(e){return!e.value||!e.value.deleted});0!==i.length?(i=i.map(function(e){return a[e.doc._id]?e.doc.entity={id:a[e.doc._id]}:delete e.doc.entity,e.doc}),h.chunkUpdate(t.config,i,1e3).then(n,r)):n([])},r)}else n([])})}},{key:"entityList",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return new l(function(u,o){p.connect(r.config).view("entity","byId",t).then(function(t){t.rows=e.consolidateResult(t,n,i,a),(n||i)&&0!==t.total_rows?r._extendDocs(t.rows,n,i,a).then(function(e){t.rows=e,u(t.rows)},o):u(t.rows)},o)})}},{key:"_entitySearch",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return new l(function(a,u){e.limit=Math.min(e.limit?parseInt(e.limit,10):200,200),e.sort=c.isString(e.sort)?'"'+e.sort+'"':e.sort,t&&(e.include_docs=!0),p.connect(n.config).search("entity",e.index||"all",e).then(function(e){if(e.groups){var o=[];return e.groups=e.groups.map(function(e){return o.push(new l(function(a,u){(t||r)&&0!==e.total_rows?n._extendDocs(e.hits,t,r,i).then(function(t){e.hits=t,a()},u):a()})),e}),void l.all(o).then(function(){a(e)},u)}(t||r)&&0!==e.total_rows?n._extendDocs(e.rows,t,r,i).then(function(t){e.rows=t,a(e)},u):a(e)},u)})}},{key:"entitySearch",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return new l(function(a,u){var o=e.limit?parseInt(e.limit,10):25;if(o<=200)n._entitySearch(e,t,r,i).then(a,u);else{var s=[],l=[];(function n(f){var d=this,p=c.clone(e);f&&(p.bookmark=f),this._entitySearch(p,t,r,i).then(function(e){e.rows&&(s=s.concat(e.rows)),e.groups&&(l=l.concat(e.groups)),s.length<e.total_rows&&s.length<o?n.call(d,e.bookmark):(e.rows=s,e.groups=l,a(e))},u)}).call(n)}})}},{key:"entityFind",value:function(){var e=(0,a.default)(i.default.mark(function e(t){var n,r,a,u,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=void 0,e.prev=1,e.next=4,p.connect(this.config).find(t);case 4:n=e.sent,e.next=20;break;case 7:if(e.prev=7,e.t0=e.catch(1),"no_usable_index"!==e.t0.error){e.next=20;break}return r=new d(this.config),e.next=13,r.get();case 13:return a=e.sent,u=new v(this.config),e.next=17,u.updateEntityIndex(a.schemas);case 17:return e.next=19,p.connect(this.config).find(t);case 19:n=e.sent;case 20:if(!1!==o){e.next=22;break}return e.abrupt("return",n);case 22:if(!t.fields||-1!==t.fields.indexOf("_id")){e.next=24;break}throw new Error("_id field required for `children`");case 24:return e.next=26,this._extendDocs(n.docs,o,s,c);case 26:return n.docs=e.sent,e.abrupt("return",n);case 28:case"end":return e.stop()}},e,this,[[1,7]])}));return function(t){return e.apply(this,arguments)}}()},{key:"entityRevisions",value:function(t){var n=this;return new l(function(i,a){p.connect(n.config).get(t,{revs_info:!0}).then(function(u){var o=[];u._revs_info.forEach(function(e){"available"===e.status&&o.push(e.rev)}),p.connect(n.config).get(t,{open_revs:(0,r.default)(o)}).then(function(t){var r=[],u=[];t.forEach(function(e){e.ok&&(r.push(e.ok),c.forEach(e.ok.fields,function(e){/entity/.test(e.type)&&c.forEach(e.value,function(e){e.id&&u.push(e.id)}),/image/.test(e.type)&&e.value.id&&u.push(e.value.id)}))}),p.connect(n.config).fetch({keys:c.uniq(u),include_docs:!0}).then(function(t){var n={};t.rows.forEach(function(e){try{n[e.doc._id]=e.doc}catch(e){console.error("Error: child no longer exists")}}),i(e._consolidateChildren(r,n))},a)},a)},a)})}},{key:"entityCreate",value:function(t){var n=this;return new l(function(r,i){t.type="entity",p.connect(n.config).insert(t).then(function(a){t._id=a.id,t._rev=a.rev;var u=e._fileIds([t]);if(0!==u.length){var o=[];u.forEach(function(e){o.push({oldId:null,newId:e,entity:t._id})}),n._updateFiles(o).then(function(){r(t)},i)}else r(t)},i)})}},{key:"entityRead",value:function(e){var t=this;return new l(function(n,r){p.connect(t.config).get(e).then(n,r)})}},{key:"entityUpdate",value:function(e,t){var n=this;return new l(function(r,i){var a={},u=(e=c.isArray(e)?e:[e]).map(function(e){var t=void 0;return c.isObject(e)&&(t=e._id,a[t]=e),c.isString(e)&&(t=e),t});p.connect(n.config).fetch({keys:u,include_docs:!0}).then(function(e){var o=[],s=[],l=e.rows.map(function(e){var n=e.doc,r=a[n._id],i=n;r&&(delete r._rev,f(n,r).forEach(function(e){if("fields"===e.path[0]){var t=n.fields[e.path[1]],i=r.fields[e.path[1]];i&&i.value&&"file"===i.value.type&&("id"===e.path[3]||e.rhs&&e.rhs.value)&&s.push({oldId:t?t.value.id:null,newId:i.value.id,entity:r._id})}/slug|title|thumbnail/.test(e.path[0])&&-1===o.indexOf(r)&&-1!==u.indexOf(r._id)&&o.push(r)}),i=c.mergeWith({},n,r,function(e,t){if(c.isArray(e)&&c.isArray(t))return t}));return t&&(i.trashed=!1),i});n._updateChildren(o).then(function(){n._updateFiles(s).then(function(){h.chunkUpdate(n.config,l,1e3).then(r,i)},i)},i)},i)})}},{key:"entityDelete",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new l(function(r,i){var a=void 0;"trashed"===e?(n=!0,a=p.connect(t.config).view("entity","trashed",{include_docs:!0})):a=p.connect(t.config).fetch({keys:c.isArray(e)?e:[e],include_docs:!0}),a.then(function(e){var a=e.rows.filter(function(e){return!e.value||!e.value.deleted});a=a.map(function(e){return e.doc}),n?t._removeChildren(a).then(function(){t._detachFiles(a).then(function(){a=a.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}}),h.chunkUpdate(t.config,a,1e3).then(r,i)},i)},i):(a=a.map(function(e){return e.trashed=!0,e}),h.chunkUpdate(t.config,a,1e3).then(r,i))},i)})}}],[{key:"flattenValues",value:function(t){return t.map(function(t){return t.fields&&c.size(t.fields)?(t.fields=c.mapValues(t.fields,function(t){return/entity/.test(t.type)&&c.isArray(t.value)&&(t.value=e.flattenValues(t.value)),t.value}),t):t})}},{key:"filterEntityFields",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"guest",n=c.isArray(e);return e=(n?e:[e]).map(function(e){return c.size(e.fields)&&(e.fields=c.mapValues(e.fields,function(e){return c.isArray(e.value)&&(e.value=e.value.filter(function(e){return!!e&&(!e.type||"entity"!==e.type||"guest"!==t||(void 0===e.published||e.published))})),e})),e}),n?e:e[0]}},{key:"_consolidateChildren",value:function(e,t){return e.map(function(e){return c.size(e.fields)?(e.fields=c.mapValues(e.fields,function(e){return c.isArray(e.value)&&(e.value=e.value.filter(function(e){return!!e&&("entity"!==e.type||void 0!==t[e.id])}),e.value=e.value.map(function(e){return"entity"===e.type&&(e=c.merge(e,t[e.id])),e=c.omitBy(e,function(e,t){return t.startsWith("_")})})),c.isObject(e.value)&&"file"===e.value.type&&t[e.value.id]&&(e.value=c.merge(e.value,t[e.value.id]),e.value=c.omitBy(e.value,function(e,t){return t.startsWith("_")})),e}),e):e})}},{key:"consolidateResult",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest",a=[],u={},o={};return t.rows.forEach(function(t){t.doc&&(n&&"field"===t.value.type&&(o[t.doc._id]=e.filterEntityFields(t.doc,i)),r&&"entity"===t.value.type&&(t.doc.parents=[],u[t.key]=t.doc),"entity"===t.value.type&&a.push(t.doc))}),n&&(a=e._consolidateChildren(a,o)),r&&(t.rows.forEach(function(t){t.doc&&"parent"===t.value.type&&u[t.key].parents.push(e.filterEntityFields(t.doc,i))}),u=c.mapValues(u,function(e){return e.parents=c.uniqBy(e.parents,function(e){return e._id}),e})),u=null,o=null,a}},{key:"_fileIds",value:function(e){var t=[];return e.forEach(function(e){c.forEach(e.fields,function(e){e.value&&"file"===e.value.type&&t.push(e.value.id)})}),c.uniq(t)}},{key:"_mergeDocs",value:function(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return i+=1,r&&i>=r?t:t=t.map(function(t){var a=!!t.doc,u=n[t.id||t._id]||(a?t.doc:t);return r&&u.fields&&(u.fields=c.mapValues(u.fields,function(t){return c.isArray(t.value)&&(t.value=t.value.map(function(e){return e.id&&n[e.id]&&(e=c.merge(e,n[e.id]||{}),e=c.omitBy(e,function(e,t){return t.startsWith("_")})),e}),t.value=e._mergeDocs(t.value,n,r,i)),t})),a?t.doc=u:t=u,t})}}]),e}();e.exports=m},function(e,t){e.exports=require("react")},function(e,t){e.exports=require("lodash/merge")},function(e,t){e.exports=require("mjml-core")},function(e,t){e.exports=require("babel-runtime/core-js/object/define-property")},function(e,t){e.exports=require("babel-runtime/core-js/object/create")},function(e,t){e.exports=require("babel-runtime/core-js/object/set-prototype-of")},function(e,t){e.exports=require("mjml")},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(11),o=n(9),s=n(2),c=n(3),l=n(69),f=c.promisifyAll(n(68)),d=n(67),p=n(66),h=n(65).Inky,v=n(26).mjml2html,m=n(26).registerMJElement,y=n(64),g=n(63),b=n(62),_=n(61),w=n(5),x=n(8),k=n(60).default,E=n(55).default,A=function(){function e(t){(0,r.default)(this,e),this.config=t,this.inky=new h,m(k),m(E)}return(0,i.default)(e,[{key:"getTemplate",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new c(function(i,a){r=s.merge({},{preview:!1,inky:!1,mjml:!1,skipValidation:!1},r);var c=u.resolve(n.config.email.templatesPath,e),l="pug";o.existsSync(c+"/html.ejs")&&(l="ejs");var f=_.renderSync({file:u.resolve(c,"style.scss"),sourceMapContents:r.preview,sourceMapEmbed:r.preview}).css.toString().replace(/"/g,"'"),d=new p({views:{root:n.config.email.templatesPath,options:{extension:l}},juice:!r.preview,juiceResources:{preserveMediaQueries:!0,preserveFontFaces:!0,removeStyleTags:!1,removeLinkTags:!1,preserveImportant:!0,webResources:{links:!1,scripts:!1}},transport:{jsonTransport:!0}}),h=new w(n.config),m=new x(n.config);h.get().then(function(u){t=s.merge({},t,{config:s.pick(u,["client","assets"]),helpers:m,style:f,moment:g,countries:b,template:e,preview:r.preview}),d.render(e+"/html",t).then(function(e){if(r.mjml){var t=v(e,{level:r.skipValidation?"skip":"soft"});if(t.errors&&t.errors.length)return void a(t.errors);e=t.html}r.inky&&(e=n.inky.releaseTheKraken(e)),i({html:e,text:y.fromString(e)})},a)},a)})}},{key:"sendEmail",value:function(e,t,n,r){var i=this;return new c(function(a,u){var o=l.createTransport(d({auth:{api_key:i.config.mailgun.apiKey,domain:i.config.mailgun.domain}}));i.getTemplate(t,n,r).then(function(t){e.html=t.html,e.text=t.text,o.sendMail(e,function(t,n){t?u(t):a({metadata:n,email:e})})},u)})}},{key:"subscribe",value:function(e,t,n){var r=this;return new c(function(i,a){new w(r.config).get().then(function(r){if("createsend"===t){if(r.provider.createsend){var u=new f({apiKey:r.provider.createsend.clientApiKey});return void c.promisifyAll(u.subscribers).addSubscriberAsync(n,{EmailAddress:e.email,Name:e.name,Resubscribe:!0,RestartSubscriptionBasedAutoresponders:!0}).then(function(e){i("Email.subscribe(): "+e.emailAddress)}).catch(function(e){a(e.Message)})}a(new Error("Subscriber list not configured"))}},a)})}}]),e}();e.exports=A},function(e,t){e.exports=require("babel-runtime/core-js/object/freeze")},function(e,t,n){"use strict";var r=u(n(28)),i=u(n(1)),a=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var o=n(2),s=[{name:"Admin",slug:"admin",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!0,settings:!0,tools:!0,ecommerce:!0}},{name:"Editor",slug:"editor",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!1,settings:!1,tools:!1,ecommerce:!1}},{name:"Guest",slug:"guest",permissions:{entityGrid:!0,entityCreate:!1,entityRead:!0,entityUpdate:!1,entityDelete:!1,taxonomyCreate:!1,taxonomyRead:!0,taxonomyUpdate:!1,taxonomyDelete:!1,fileCreate:!1,fileRead:!0,fileUpdate:!1,fileDelete:!1,config:!1,schema:!1,user:!1,settings:!1,tools:!1,ecommerce:!1}}],c=function(){function e(){(0,i.default)(this,e)}return(0,a.default)(e,[{key:"roles",value:function(){return s.map(function(e){return(0,r.default)(e)})}},{key:"role",value:function(t){return o.find(e.roles(),{slug:t})}}]),e}();e.exports=c},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(3),o=n(15),s=n(75),c=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,i.default)(e,[{key:"deleteFiles",value:function(e,t){var n=this;return new u(function(r,i){0!==t.length?o({method:"DELETE",url:n.config.assist.url+"/"+e+"/file/delete",json:{files:t},auth:{user:n.config.assist.username,pass:s.generate(n.config.assist.password),sendImmediately:!1}}).then(function(e){200!==e.statusCode?i(e):r(e)},i):r()})}}]),e}();e.exports=c},function(e,t){e.exports=require("zencoder")},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),o=n(3),s=n(16),c=n(31),l=n(12),f=n(4),d=n(8),p=function(){function e(t){(0,r.default)(this,e),this.config=t,this.zencoder=c(t.zencoder.apiKey),this.s3=new l(t),this.s3Credentials=t.zencoder.s3.credentials||"s3"}return(0,i.default)(e,[{key:"checkJob",value:function(e,t){var n=this;this.getJob(e).then(function(r){console.log("Zencode.checkJob:",r.jobState,e,t),/pending|waiting|processing/.test(r.jobState)?setTimeout(function(){n.checkJob(r.jobId,t)},1e4):n._updateFile(t,r)})}},{key:"_updateFile",value:function(e,t){var n=this;f.connect(this.config).view("entity","byFile",{keys:[e],include_docs:!0}).then(function(r){if(0!==r.rows.length){var i=r.rows[0].doc;i.fields=u.mapValues(i.fields,function(n){return n.value&&n.value.id===e&&(n.value.metadata.zencoder=t),n}),d.createOrUpdate(n.config,i)}}),f.connect(this.config).get(e).then(function(e){e.metadata.zencoder=t,d.createOrUpdate(n.config,e)})}},{key:"getJob",value:function(e){var t=this;return new o(function(n,r){t.zencoder.Job.details(e,function(e,t){if(e)r(e);else{var i={jobId:t.job.id,jobState:t.job.state,fileSize:0,outputs:{}};if(t.job.thumbnails&&t.job.thumbnails.length){var a=t.job.thumbnails.filter(function(e){return"_thumb"===e.group_label})[0];a&&(i.thumbnail={url:a.url.replace("http://","https://"),width:a.width,height:a.height,ratio:parseInt(a.width,10)/parseInt(a.height,10)})}t.job.output_media_files.forEach(function(e){i.fileSize+=e.file_size_bytes,i.outputs[e.label]={url:e.url.replace("http://","https://"),width:e.width||null,height:e.height||null,duration:e.duration_in_ms,fileSize:e.file_size_bytes,mimeType:s.getType(e.url)}}),t.job.thumbnails.forEach(function(e){i.fileSize+=e.file_size_bytes}),n(i)}})})}},{key:"createJob",value:function(e,t,n){var r=this;return new o(function(i,a){r.s3.upload(e,t.uploadOptions).then(function(e){"video"===t.mediaType&&(t.outputs=t.outputs.sort(function(e,t){return e.maxWidth>t.maxWidth?-1:e.maxWidth<t.maxWidth?1:0}),t.outputs=t.outputs.sort(function(e,t){return e.maxHeight>t.maxHeight?-1:e.maxHeight<t.maxHeight?1:0}));var u=t.outputs.map(function(e,i){var a=t.metadata.bucket+"/"+n+"/"+t.metadata.base,u=e.format||{video:"mp4",audio:"mp3"}[t.mediaType],o={credentials:r.s3Credentials,rrs:!0,public:!0,url:"s3://"+a+"/"+e.slug+"."+u,label:e.slug,quality:e.quality||3,audio_quality:e.audioQuality||3};return e.audioPreNormalize&&(o.audio_pre_normalize=!0),e.audioCompressionRatio&&(o.audio_compression_ratio=e.audioCompressionRatio),"video"===t.mediaType&&(e.maxWidth&&(o.width=e.maxWidth),e.maxHeight&&(o.height=e.maxHeight),e.thumbnails||(e.thumbnails=[]),0===i&&e.thumbnails.unshift({name:"_thumb",slug:"_thumb",format:"jpg",times:[0]}),o.thumbnails=e.thumbnails.map(function(e){var t={credentials:r.zencoderS3Credentials,rrs:!0,public:!0,base_url:"s3://"+a,label:e.slug,prefix:e.slug,format:e.format,start_at_first_frame:!0};return e.number&&(t.number=e.number),e.times&&(t.times=e.times),e.interval&&(t.interval=e.interval),t})),o});r.zencoder.Job.create({input:"http://"+t.metadata.bucket+".s3.amazonaws.com/"+t.metadata.src,outputs:u},function(t,n){t?a(t.errors.join(" ")):i({s3Upload:e,zencoderJob:n})})})})}}]),e}();e.exports=p},function(e,t,n){"use strict";var r=o(n(7)),i=o(n(6)),a=o(n(1)),u=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var s=n(2),c=n(5),l=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(i=e.sent).users.push(t),e.abrupt("return",n.set(i));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(i=e.sent,a=s.find(i.users,{id:t})){e.next=7;break}throw Error("User not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(i=e.sent,-1!==(a=s.findIndex(i.users,{id:t.id}))){e.next=7;break}throw Error("User not found: "+t.id);case 7:return i.users.splice(a,1,t),e.abrupt("return",n.set(i));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return i=e.sent,t=s.isArray(t)?t:[t],i.users=i.users.filter(function(e){return-1===t.indexOf(e.id)}),e.abrupt("return",n.set(i));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=l},function(e,t){e.exports=require("cloudant")},function(e,t,n){"use strict";var r=o(n(7)),i=o(n(6)),a=o(n(1)),u=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var s=n(3).promisifyAll(n(9)),c=n(34),l=n(4),f=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"getDb",value:function(){var e=(0,i.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.connect(this.config).fetch({include_docs:!0});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getChanges",value:function(){var e=(0,i.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.connect(this.config).changes({limit:50,include_docs:!0,filter:"tools/changesEntity"});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"importDb",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a,u,o;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.config.db.name,e.next=3,s.readFileAsync(t.path);case 3:return i=e.sent,a=JSON.parse(i).rows.map(function(e){var t=e.doc;return delete t._rev,t}),e.next=7,s.unlinkAsync(t.path);case 7:return u=new c({url:this.config.db.url,plugins:["promises","retry429"]}).db,e.prev=8,e.next=11,u.destroy(n);case 11:e.next=15;break;case 13:e.prev=13,e.t0=e.catch(8);case 15:return e.next=17,u.create(n);case 17:return e.next=19,l.connect(this.config,n).bulk({docs:a});case 19:return o=e.sent,e.abrupt("return",o);case 21:case"end":return e.stop()}},e,this,[[8,13]])}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t,n){"use strict";var r=o(n(7)),i=o(n(6)),a=o(n(1)),u=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var s=n(2),c=n(4),l=n(5),f=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:return(i=e.sent).taxonomies.push(t),e.abrupt("return",n.set(i));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:if(i=e.sent,a=s.find(i.taxonomies,{slug:t})){e.next=7;break}throw Error("Taxonomy not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:if(i=e.sent,-1!==(a=s.findIndex(i.taxonomies,{slug:t.slug}))){e.next=7;break}throw Error("Taxonomy not found: "+t.slug);case 7:return i.taxonomies.splice(a,1,t),e.abrupt("return",n.set(i));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:return i=e.sent,t=s.isArray(t)?t:[t],i.taxonomies=i.taxonomies.filter(function(e){return-1===t.indexOf(e.slug)}),e.abrupt("return",n.set(i));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"entitiesByTerm",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.connect(this.config),e.next=3,n.view("entity","byTaxonomyTerm",{keys:[t.id],group:!0});case 3:if(e.t0=function(e){return e.value},i=e.sent.rows.map(e.t0)[0]){e.next=7;break}return e.abrupt("return",[]);case 7:return a=[],s.forEach(i,function(e){a=a.concat(e)}),a=s.uniq(a),e.next=12,n.fetch({keys:a,include_docs:!0});case 12:return e.t1=function(e){return e.doc},e.abrupt("return",e.sent.rows.map(e.t1));case 14:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"createTerm",value:function(){var e=(0,i.default)(r.default.mark(function e(t,n){var i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.read(t);case 2:return(i=e.sent).terms.push(n),e.abrupt("return",this.update(i));case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"updateTerm",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.entitiesByTerm(t);case 2:return n=(n=e.sent).map(function(e){return e.fields=s.mapValues(e.fields,function(e){return"taxonomy"===e.type&&e.value&&(e.value.terms||(e.value.terms=[]),e.value.terms=e.value.terms.map(function(e){return e.id===t.id&&(e.title=t.title,e.slug=t.slug),e.parents||(e.parents=[]),e.parents=e.parents.map(function(e){return e.id===t.id&&(e.title=t.title,e.slug=t.slug),e}),e})),e}),e}),e.abrupt("return",c.connect(this.config).bulk({docs:n}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"deleteTerm",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.entitiesByTerm(t);case 2:return n=(n=e.sent).map(function(e){return e.fields=s.mapValues(e.fields,function(e){return"taxonomy"===e.type&&e.value&&(e.value.terms||(e.value.terms=[]),e.value.terms=e.value.terms.filter(function(e){return e.id!==t.id&&!(e.parents||[]).filter(function(e){return e.id===t.id}).length})),e}),e}),e.abrupt("return",c.connect(this.config).bulk({docs:n}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t){e.exports=require("hashids")},function(e,t){e.exports=require("stripe")},function(e,t,n){"use strict";var r=s(n(10)),i=s(n(7)),a=s(n(6)),u=s(n(1)),o=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var c=n(2),l=n(38),f=n(3),d=n(37),p=n(5),h=n(27),v=n(4),m=n(8),y=function(){function e(t){(0,u.default)(this,e),this.config=t,this.stripe=l(this.config.stripe.apiKey),this.email=new h(this.config),this.hashids=new d(this.config.slug,6,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ")}return(0,o.default)(e,[{key:"getSettings",value:function(){var e=(0,a.default)(i.default.mark(function e(){var t,n,r;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new p(this.config),e.next=3,t.get();case 3:n=e.sent,r=void 0,e.prev=5,r=n.module.ecommerce,e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(5),new Error(e.t0);case 12:e.prev=12,r.clientStripeAccountId=n.provider.stripe.stripe_user_id,e.next=19;break;case 16:throw e.prev=16,e.t1=e.catch(12),new Error(e.t1);case 19:return r.client=n.client,r.assets=n.assets,e.abrupt("return",r);case 22:case"end":return e.stop()}},e,this,[[5,9],[12,16]])}));return function(){return e.apply(this,arguments)}}()},{key:"checkout",value:function(e,t){var n=this;return new f(function(r,i){n.getSettings().then(function(a){var u=c.get(a,"createsend.checkoutSubscriberListId");t.subscribe&&u&&n.email.subscribe(t.customerDetails,"createsend",u).then(function(e){console.log(e)},function(e){console.error(e)}),n.findOrCreateCustomer(t.customerDetails.email,t).then(function(u){n.createOrder(t,u).then(function(t){n.updateOrCreateStripeCustomer(a.clientStripeAccountId,u,e,t).then(function(e){n.updateCustomer(u,e,t).then(function(u){n.createCharge(a,e,u,t).then(function(e){n.sendReceipt(a,u,t).then(function(o){e.messages.orderReceipt=o,n.sendNotification(a,u,t).then(function(t){e.messages.orderNotification=t,n.updateOrder(e).then(function(e){r(e)},i)},i)},i)},i)},i)},i)},i)},i)},i).catch(i)})}},{key:"retrieveAccount",value:function(){var e=this;return new f(function(t,n){e.getSettings().then(function(r){e.stripe.accounts.retrieve(r.clientStripeAccountId).then(t,n)},n)})}},{key:"refund",value:function(e,t){var n=this;return new f(function(r,i){n.getSettings().then(function(a){n.stripe.refunds.create({refund_application_fee:!0,charge:e.charge.id,amount:t},{stripe_account:a.clientStripeAccountId}).then(function(t){n.stripe.charges.retrieve(e.charge.id,{stripe_account:a.clientStripeAccountId}).then(function(t){e.charge.status=t.status,e.charge.amount=t.amount,e.charge.amountRefunded=t.amount_refunded,m.createOrUpdate(n.config,e).then(r,i)},i)},i)},i)})}},{key:"findOrCreateCustomer",value:function(e,t){var n=this;return new f(function(i,a){v.connect(n.config).view("ecommerce","customerByEmail",{keys:[e],include_docs:!0}).then(function(e){if(e.rows.length)i(e.rows[0].doc);else{var u=(0,r.default)(new Date).replace(/"/g,""),o={type:"customer",createdAt:u,modifiedAt:u,email:t.customerDetails.email,name:t.customerDetails.name,phone:t.customerDetails.phone,billingAddress:t.billingAddress,shippingAddress:t.shippingAddress,orders:[]};v.connect(n.config).insert(o).then(function(e){o._id=e.id,o._rev=e.rev,i(o)},a)}},a)})}},{key:"updateOrCreateStripeCustomer",value:function(e,t,n,r){var i=this;return new f(function(a,u){var o={source:n,email:r.customer.email,description:r.customer.name,metadata:{customer_id:t._id}};t.stripe&&t.stripe.customer.id?i.stripe.customers.update(t.stripe.customer.id,o,{stripe_account:e}).then(a,function(t){"StripeInvalidRequestError"===t.type&&"id"===t.param?i.stripe.customers.create(o,{stripe_account:e}).then(a,u):u(t)}):i.stripe.customers.create(o,{stripe_account:e}).then(a,u)})}},{key:"createOrder",value:function(e,t){var n=this;return new f(function(i,a){var u=e.items.map(function(e){return{id:e.id,title:e.title.replace(/<br\s?>/gi," ").replace(/<\/?p>|<\/?span>/gi,""),price:e.price,quantity:e.quantity,metadata:e.metadata||{}}}),o=(0,r.default)(new Date).replace(/"/g,""),s={type:"order",orderId:n.hashids.encode((new Date).getTime()),createdAt:o,modifiedAt:o,customer:{id:t._id,email:t.email,name:t.name},items:u,shippingMethod:{name:e.shippingMethod.name,amount:Number(e.shippingMethod.amount)},subtotal:Number(e.subtotal),tax:{rate:e.tax.rate||0,includedInPrice:e.tax.includedInPrice||!1,total:e.tax.total||0,show:e.tax.show||!1},discount:{code:e.discount.code||"",name:e.discount.name||"",total:e.discount.total||0},total:Number(e.total),billingAddress:e.billingAddress,shippingAddress:e.shippingAddress,messages:{},status:"pending",test:!0};v.connect(n.config).insert(s).then(function(e){s._id=e.id,s._rev=e.rev,i(s)},a)})}},{key:"updateOrder",value:function(e){var t=this;return new f(function(n,r){v.connect(t.config).insert(e).then(function(t){e._rev=t.rev,n(e)},r)})}},{key:"updateCustomer",value:function(e,t,n){var i=this;return new f(function(a,u){var o=(0,r.default)(new Date).replace(/"/g,"");e.modifiedAt=o,e.orders||(e.orders=[]),e.orders.push(n._id),e.stripe||(e.stripe={customer:{id:null}}),e.stripe.customer.id=t.id,v.connect(i.config).insert(e).then(function(t){e._rev=t.rev,a(e)},u)})}},{key:"createCharge",value:function(e,t,n,r){var i=this;return new f(function(a,u){var o=100*Number(r.total),s={amount:o,currency:e.currency.iso.toLowerCase(),customer:t.id,capture:!0,description:r.orderId,metadata:{customer_id:n._id,order_id:r._id},statement_descriptor:c.kebabCase(e.storeName).toUpperCase(),application_fee:Math.ceil(.02*o)};i.stripe.charges.create(s,{stripe_account:e.clientStripeAccountId}).then(function(e){r.charge={paymentGateway:"stripe",id:e.id,status:e.status,currency:e.currency.toUpperCase(),amount:e.amount,amountRefunded:e.amount_refunded},r.test=!e.livemode,a(r)},u)})}},{key:"sendReceipt",value:function(e,t,n){var r=this;return new f(function(i,a){var u={settings:e,order:n},o={from:e.emailSenderName+" <"+e.emailSenderAddress+">",to:t.email,subject:"Your order at "+e.storeName+" ("+n.orderId+")"},s=c.get(e,"assets.slug",r.config.slug);r.email.sendEmail(o,s+"/order-receipt",u).then(i,a)})}},{key:"sendNotification",value:function(e,t,n){var r=this;return new f(function(t,i){var a={settings:e,order:n},u={from:e.emailSenderName+" <"+e.emailSenderAddress+">",to:e.emailSenderAddress,subject:"New order at "+e.storeName+" ("+n.orderId+")"},o=c.get(e,"assets.slug",r.config.slug);r.email.sendEmail(u,o+"/order-notification",a).then(t,i)})}}]),e}();e.exports=y},function(e,t){e.exports=require("shippo")},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(3),o=n(40),s=function(){function e(t){(0,r.default)(this,e),this.config=t,this.shippo=o(t.shippo.token)}return(0,i.default)(e,[{key:"getQuote",value:function(e,t){var n=this;return new u(function(r,i){var a={object_purpose:"QUOTE",zip:n.config.shippo.fromZip,country:n.config.shippo.fromCountry},u={object_purpose:"QUOTE",zip:e.zip,country:e.country,metadata:""};t.distance_unit="cm",t.mass_unit="kg",n.shippo.shipment.create({object_purpose:"QUOTE",address_from:a,address_to:u,parcel:t}).then(function(e){!function e(t,a){("QUEUED"===t.object_status||"WAITING"===t.object_status)&&a<10?n.shippo.shipment.retrieve(t.object_id).then(function(t){e(t,a+1)}):n.shippo.shipment.rates(t.object_id).then(function(e){r(e)},function(e){console.error("There was an error retrieving rates : %s",e),i(e)})}(e,0)},function(e){console.error("There was an error creating shipment: %s",e),i(e)})})}}]),e}();e.exports=s},function(e,t,n){"use strict";var r=o(n(7)),i=o(n(6)),a=o(n(1)),u=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var s=n(2),c=n(5),l=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"update",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(i=e.sent).client=s.merge({},i.client,t),e.abrupt("return",n.set(i));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=l},function(e,t,n){"use strict";var r=c(n(7)),i=c(n(10)),a=c(n(13)),u=c(n(6)),o=c(n(1)),s=c(n(0));function c(e){return e&&e.__esModule?e:{default:e}}var l=n(2),f=n(3),d=n(15),p=n(19),h=n(5),v=function(){function e(t){(0,o.default)(this,e),this.config=t,this.templates=this.config.pdf.templates}return(0,s.default)(e,[{key:"getPayload",value:function(e,t,n){var r=this;return new f(function(i,a){r.templates[e]?new p(r.config).entitiesById([t],!0,!1,n).then(function(t){if(0!==t.length){t=p.flattenValues(t);var n=r.templates[e](t[0]);try{i(n)}catch(e){a(e)}}else a(new Error("Entity not found"))}):a(new Error("Template not found"))})}},{key:"getPdf",value:function(){var e=(0,u.default)(r.default.mark(function e(t){var n,u,o,s,c;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new h(this.config),e.next=3,n.get();case 3:return u=e.sent,o=l.get(u,"assets.slug",this.config.slug),s=this.config.assist.url+"/"+o+"/pdf/download",t="object"===(void 0===t?"undefined":(0,a.default)(t))?(0,i.default)(t).replace(/'/gi,""):t,e.next=9,d({method:"POST",uri:s,encoding:null,form:{payload:t}});case 9:return c=e.sent,e.abrupt("return",c);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=v},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(44),o=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,i.default)(e,[{key:"signToken",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u.sign(e,this.config.auth.tokenSecret,t)}},{key:"verifyToken",value:function(e){return u.verify(e,this.config.auth.tokenSecret)}}]),e}();e.exports=o},function(e,t,n){"use strict";var r=n(2),i=n(3),a=n(15);e.exports=function(e){e=r.merge({},{client_id:null,access_token:null,version:"v1",host:"https://api.instagram.com"},e||{});this.get=function(t,n){return function(t,n,u){return new i(function(i,o){var s={method:t,url:[e.host,e.version,n].join("/"),qs:{access_token:u.access_token||e.access_token,client_id:u.client_id||e.client_id}};s.qs=r.extend({},s.qs,u),a(s).then(function(e){i(JSON.parse(e))},o)})}("GET",t,n)}}},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(3),o=u.promisifyAll(n(9)),s=n(11),c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/tmp",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,r.default)(this,e),this.temporaryFolder=t,this.maxFileSize=n,this.fileParameterName="file";try{o.mkdirSync(this.temporaryFolder)}catch(e){}}return(0,i.default)(e,[{key:"getChunkFilename",value:function(t,n){return n=e.cleanIdentifier(n),s.resolve(this.temporaryFolder,"./flow-"+n+"."+t)}},{key:"validate",value:function(t,n,r,i,a,u){if(t="number"!=typeof t?parseInt(t,10):t,n="number"!=typeof n?parseInt(n,10):n,r="number"!=typeof r?parseInt(r,10):r,i=e.cleanIdentifier(i),0===t||0===n||0===r||0===i.length||0===a.length)return"non_flow_request";var o=Math.max(Math.floor(r/n),1);if(t>o)return"invalid_flow_request1";if(this.maxFileSize&&r>this.maxFileSize)return"invalid_flow_request2";if(void 0!==u){if(u="number"!=typeof u?parseInt(u,10):u,t<o&&u!==n)return"invalid_flow_request3";if(o>1&&t===o&&u!==r%n+parseInt(n,10))return"invalid_flow_request4";if(1===o&&u!==r)return"invalid_flow_request5"}return"valid"}},{key:"checkChunk",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";return e="number"!=typeof e?parseInt(e,10):e,t="number"!=typeof t?parseInt(t,10):t,n="number"!=typeof n?parseInt(n,10):n,new u(function(u,s){var c=r.validate(e,t,n,i,a);if("valid"===c){var l=r.getChunkFilename(e,i);o.statAsync(l).then(u,s)}else s(c)})}},{key:"mergeChunks",value:function(e,t,n){var r=this;return new u(function(i,a){for(var c=[],l=1;l<=e;l++)c.push(o.readFileAsync(r.getChunkFilename(l,t)));u.all(c).then(function(e){o.writeFileAsync(s.join(r.temporaryFolder,n),Buffer.concat(e)).then(i,a)},a)})}},{key:"deleteFile",value:function(e){return o.unlinkAsync(s.join(this.temporaryFolder,e))}},{key:"removeChunks",value:function(e){var t=this;return new u(function(n,r){!function i(a){var u=t.getChunkFilename(a,e);o.stat(u,function(e){e?n():(o.unlink(u,function(e){e&&r(e)}),i(a+1))})}(1)})}},{key:"saveChunk",value:function(e,t,n,r,i,a,s){var c=this;return t="number"!=typeof t?parseInt(t,10):t,n="number"!=typeof n?parseInt(n,10):n,r="number"!=typeof r?parseInt(r,10):r,i="number"!=typeof i?parseInt(i,10):i,new u(function(r,u){if(e[c.fileParameterName]&&e[c.fileParameterName].size){var l=e[c.fileParameterName].originalFilename,f=e[c.fileParameterName].size;f="number"!=typeof f?parseInt(f,10):f;var d=c.validate(t,n,i,a,s,f);if("valid"===d){var p=c.getChunkFilename(t,a),h=Math.max(Math.floor(i/n),1);o.rename(e[c.fileParameterName].path,p,function(){!function e(n){o.stat(c.getChunkFilename(n,a),function(i){i?r({status:"incomplete",filename:s,originalFilename:l,identifier:a}):n===h&&t===h?c.mergeChunks(h,a,s).then(function(){c.removeChunks(a).then(function(){r({status:"complete",filename:s,originalFilename:l,identifier:a})},u)},u):e(n+1)})}(1)})}else u(new Error(d+": "+s+" "+l+" "+a))}else u(new Error("invalid_flow_request"))})}},{key:"write",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r.end=void 0===r.end||r.end;!function i(a){var u=n.getChunkFilename(a,e);o.stat(u,function(e){if(e)r.end&&t.end(),r.onDone&&r.onDone();else{var n=o.createReadStream(u);n.pipe(t,{end:!1}),n.on("end",function(){i(a+1)})}})}(1)}}],[{key:"cleanIdentifier",value:function(e){return e.replace(/[^0-9A-Za-z_-]/g,"")}}]),e}();e.exports=c},function(e,t){e.exports=require("aws-sdk")},function(e,t){e.exports=require("uuid")},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),o=n(3),s=n(30),c=n(12),l=n(4),f=n(8),d=function(){function e(t){(0,r.default)(this,e),this.config=t,this.assist=new s(t),this.s3=new c(t)}return(0,i.default)(e,[{key:"search",value:function(e){var t=this;return new o(function(n,r){e.sort=u.isString(e.sort)?'"'+e.sort+'"':e.sort,l.connect(t.config).search("file","all",e).then(n,r)})}},{key:"create",value:function(e){var t=this;return new o(function(n,r){e.type="file",l.connect(t.config).insert(e).then(n,r)})}},{key:"delete",value:function(e,t){var n=this;return new o(function(r,i){("trashed"===e?l.connect(n.config).view("file","trashed",{include_docs:!0}):l.connect(n.config).fetch({keys:u.isArray(e)?e:[e],include_docs:!0})).then(function(e){var a=e.rows.filter(function(e){return!e.value||!e.value.deleted}),u=[],s=[];(a=a.map(function(e){return e.doc})).forEach(function(e){"assist"===e.location&&u.push(e.fileName),"s3"===e.location&&s.push(e)});var c=n.assist.deleteFiles(t,u),l=n.s3.deleteFiles(t,s);o.settle([c,l]).then(function(e){var t=[];e.forEach(function(e){e.isRejected()&&t.push(e.reason())}),t.length;var u=a.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}});f.chunkUpdate(n.config,u,1e3).then(r,i)})})})}}]),e}();e.exports=d},function(e,t){e.exports=require("deep-diff")},function(e,t){e.exports=require("embedly")},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),o=n(3),s=n(52),c=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,i.default)(e,[{key:"oembed",value:function(e){var t=this;return new o(function(n,r){var i=new s({key:t.config.embedly.apiKey}),a={urls:u.isArray(e)?e:[e],format:"json"};i.oembed(a,function(e,t){e?r(e):n(t)})})}}]),e}();e.exports=c},function(e,t){e.exports=require("lodash/min")},function(e,t,n){"use strict";var r=s(n(14)),i=s(n(25)),a=s(n(24)),u=s(n(13)),o=s(n(23));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var c,l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),(0,o.default)(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=n(22),d=m(n(21)),p=m(n(54)),h=n(20),v=m(h);function m(e){return e&&e.__esModule?e:{default:e}}function y(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":(0,u.default)(t))&&"function"!=typeof t?e:t}var g={table:{borderCollapse:"collapse",borderSpacing:"0"},img:{border:"none",borderRadius:"",display:"block",outline:"none",textDecoration:"none",width:"100%"}},b=(0,f.MJMLElement)(c=function(e){function t(){var e,n,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var a=arguments.length,u=Array(a),o=0;o<a;o++)u[o]=arguments[o];return n=i=y(this,(e=t.__proto__||(0,r.default)(t)).call.apply(e,[this].concat(u))),i.styles=i.getStyles(),y(i,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":(0,u.default)(t)));e.prototype=(0,a.default)(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(i.default?(0,i.default)(e,t):e.__proto__=t)}(t,h.Component),l(t,[{key:"getContentWidth",value:function(){var e=this.props,t=e.mjAttribute,n=e.getPadding,r=t("parentWidth"),i=(0,p.default)([parseInt(t("width")),parseInt(r)]),a=n("right"),u=n("left")+a+i-parseInt(r);return u>0?i-u:i}},{key:"getStyles",value:function(){var e=this.props,t=e.mjAttribute,n=e.defaultUnit;return(0,d.default)({},g,{td:{width:this.getContentWidth()},img:{border:t("border"),height:t("height"),borderRadius:n(t("border-radius"),"px")}})}},{key:"renderImage",value:function(){var e=this.props.mjAttribute,t=v.default.createElement("img",{"data-mc-edit":e("mc:edit"),alt:e("alt"),title:e("title"),height:e("height"),src:e("src"),style:this.styles.img,width:this.getContentWidth()});return""!=e("href")?v.default.createElement("a",{href:e("href"),target:e("target")},t):t}},{key:"render",value:function(){var e=this.props.mjAttribute;return v.default.createElement("table",{className:"mc-image",cellPadding:"0",cellSpacing:"0","data-legacy-align":e("align"),"data-legacy-border":"0",style:this.styles.table},v.default.createElement("tbody",null,v.default.createElement("tr",null,v.default.createElement("td",{style:this.styles.td},this.renderImage()))))}}]),t}())||c;b.tagName="mc-image",b.parentTag=["mj-column","mj-hero-content"],b.defaultMJMLDefinition={attributes:{"mc:edit":null,align:"center",alt:"",border:"none","border-radius":null,"container-background-color":null,height:"auto",href:"","padding-bottom":null,"padding-left":null,"padding-right":null,"padding-top":null,padding:"10px 25px",src:"",target:"_blank",title:"","vertical-align":null,width:null}},b.endingTag=!0,b.baseStyles=g,b.postRender=function(e){return e("[data-mc-edit]").each(function(){e(this).attr("mc:edit",e(this).attr("data-mc-edit")).removeAttr("data-mc-edit")}),e},t.default=b},function(e,t){e.exports=require("mjml-raw")},function(e,t){e.exports=require("mjml-group")},function(e,t){e.exports=require("mjml-column")},function(e,t){e.exports=require("lodash/cloneDeep")},function(e,t,n){"use strict";var r=s(n(14)),i=s(n(25)),a=s(n(24)),u=s(n(13)),o=s(n(23));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var c,l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),(0,o.default)(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=n(22),d=b(n(59)),p=b(n(21)),h=n(20),v=b(h),m=b(n(58)),y=b(n(57)),g=b(n(56));function b(e){return e&&e.__esModule?e:{default:e}}function _(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":(0,u.default)(t))&&"function"!=typeof t?e:t}var w={div:{margin:"0 auto"},table:{fontSize:"0px",width:"100%"},td:{textAlign:"center",verticalAlign:"top"}},x=(0,f.MJMLElement)(c=function(e){function t(){var e,n,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var a=arguments.length,u=Array(a),o=0;o<a;o++)u[o]=arguments[o];return n=i=_(this,(e=t.__proto__||(0,r.default)(t)).call.apply(e,[this].concat(u))),i.styles=i.getStyles(),_(i,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":(0,u.default)(t)));e.prototype=(0,a.default)(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(i.default?(0,i.default)(e,t):e.__proto__=t)}(t,h.Component),l(t,[{key:"isFullWidth",value:function(){return"full-width"==(0,this.props.mjAttribute)("full-width")}},{key:"getStyles",value:function(){var e=this.props,t=e.mjAttribute,n=e.parentWidth,r=e.defaultUnit,i=t("background-url")?{background:((t("background-color")||"")+" url("+t("background-url")+") top center / "+(t("background-size")||"")+" "+(t("background-repeat")||"")).trim()}:{background:t("background-color")};return(0,p.default)({},w,{td:{fontSize:"0px",padding:r(t("padding"),"px"),paddingBottom:r(t("padding-bottom"),"px"),paddingLeft:r(t("padding-left"),"px"),paddingRight:r(t("padding-right"),"px"),paddingTop:r(t("padding-top"),"px"),textAlign:t("text-align"),verticalAlign:t("vertical-align")},div:{maxWidth:r(n)}},{div:this.isFullWidth()?{}:(0,d.default)(i),table:this.isFullWidth()?{}:(0,d.default)(i),tableFullwidth:this.isFullWidth()?(0,d.default)(i):{}})}},{key:"renderFullWidthSection",value:function(){var e=this.props.mjAttribute;return v.default.createElement("table",{cellPadding:"0",cellSpacing:"0","data-legacy-background":e("background-url"),"data-legacy-border":"0","data-mc-hideable":e("mc:hideable"),"data-mc-repeatable":e("mc:repeatable"),"data-mc-variant":e("mc:variant"),"data-mc-edit":e("mc:edit"),style:(0,p.default)({},this.styles.tableFullwidth,this.styles.table)},v.default.createElement("tbody",null,v.default.createElement("tr",null,v.default.createElement("td",null,this.renderSection()))))}},{key:"renderSection",value:function(){var e=this.props,t=e.renderWrappedOutlookChildren,n=e.mjAttribute,r=e.children,i=e.parentWidth,a=this.isFullWidth();return v.default.createElement("div",{"data-mc-hideable":n("mc:hideable"),"data-mc-repeatable":n("mc:repeatable"),"data-mc-variant":n("mc:variant"),"data-mc-edit":n("mc:edit"),style:this.styles.div},v.default.createElement("table",{cellPadding:"0",cellSpacing:"0",className:"mc-section-outlook-background","data-legacy-align":"center","data-legacy-background":a?void 0:n("background-url"),"data-legacy-border":"0","data-url":n("background-url")||"","data-width":i,style:this.styles.table},v.default.createElement("tbody",null,v.default.createElement("tr",null,v.default.createElement("td",{style:this.styles.td},t(r))))))}},{key:"render",value:function(){return this.isFullWidth()?this.renderFullWidthSection():this.renderSection()}}]),t}())||c;x.tagName="mc-section",x.parentTag=["mj-container"],x.defaultMJMLDefinition={attributes:{"mc:hideable":null,"mc:repeatable":null,"mc:variant":null,"mc:edit":null,"background-color":null,"background-url":null,"background-repeat":"repeat","background-size":"auto",border:null,"border-bottom":null,"border-left":null,"border-radius":null,"border-right":null,"border-top":null,direction:"ltr","full-width":null,padding:"20px 0","padding-top":null,"padding-bottom":null,"padding-left":null,"padding-right":null,"text-align":"center","vertical-align":"top"}},x.baseStyles=w,x.postRender=function(e){return e(".mc-section-outlook-background").each(function(){var t=e(this).data("url"),n=e(this).data("width");e(this).removeAttr("class").removeAttr("data-url").removeAttr("data-width"),t&&(e(this).before(f.helpers.startConditionalTag+'\n      <v:rect xmlns:v="urn:schemas-microsoft-com:vml" fill="true" stroke="false" style="width:'+n+'px;">\n        <v:fill origin="0.5, 0" position="0.5,0" type="tile" src="'+t+'" />\n        <v:textbox style="mso-fit-shape-to-text:true" inset="0,0,0,0">\n      '+f.helpers.endConditionalTag),e(this).after(f.helpers.startConditionalTag+"\n        </v:textbox>\n      </v:rect>\n      "+f.helpers.endConditionalTag))}),e(".mc-section-outlook-open").each(function(){var t=e(this).next();e(this).replaceWith(f.helpers.startConditionalTag+'\n      <table border="0" cellpadding="0" cellspacing="0"><tr><td style="vertical-align:'+t.data("vertical-align")+";width:"+parseInt(e(this).data("width"))+'px;">\n      '+f.helpers.endConditionalTag),t.removeAttr("data-vertical-align")}),e(".mc-section-outlook-line").each(function(){var t=e(this).next();e(this).replaceWith(f.helpers.startConditionalTag+'\n      </td><td style="vertical-align:'+t.data("vertical-align")+";width:"+parseInt(e(this).data("width"))+'px;">\n      '+f.helpers.endConditionalTag),t.removeAttr("data-vertical-align")}),e(".mc-section-outlook-close").each(function(){e(this).replaceWith(f.helpers.startConditionalTag+"\n      </td></tr></table>\n      "+f.helpers.endConditionalTag)}),e("[data-mc-hideable]").each(function(){e(this).attr("mc:hideable","").removeAttr("data-mc-hideable")}),e("[data-mc-repeatable]").each(function(){e(this).attr("mc:repeatable",e(this).attr("data-mc-repeatable"))}),e("[data-mc-variant]").each(function(){e(this).attr("mc:variant",e(this).attr("data-mc-variant"))}),e("[data-mc-edit]").each(function(){e(this).attr("mc:edit",e(this).attr("data-mc-edit")).removeAttr("data-mc-edit")}),e},m.default.parentTag.push("mc-section"),y.default.parentTag.push("mc-section"),g.default.parentTag.push("mc-section"),t.default=x},function(e,t){e.exports=require("node-sass")},function(e,t){e.exports=require("i18n-iso-countries")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("html-to-text")},function(e,t){e.exports=require("inky")},function(e,t){e.exports=require("email-templates")},function(e,t){e.exports=require("nodemailer-mailgun-transport")},function(e,t){e.exports=require("createsend-node")},function(e,t){e.exports=require("nodemailer")},function(e,t,n){"use strict";var r=a(n(1)),i=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),o=n(3),s=n(4),c=n(8),l=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,i.default)(e,[{key:"getType",value:function(e,t){var n=this;return new o(function(r,i){t.sort=u.isString(t.sort)?'"'+t.sort+'"':t.sort,s.connect(n.config).search("ecommerce",e,t).then(r,i)})}},{key:"setType",value:function(e,t){var n=this;return new o(function(r,i){t.type=e,c.createOrUpdate(n.config,t).then(r,i)})}},{key:"deleteType",value:function(e){var t=this;return new o(function(n,r){e=e.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}}),c.chunkUpdate(t.config,e,1e3).then(n,r)})}},{key:"getOrder",value:function(e){var t=this;return new o(function(n,r){s.connect(t.config).view("ecommerce","orderByOrderId",{key:e,include_docs:!0}).then(function(e){e.rows.length?n(e.rows[0].doc):r(new Error("Order not found"))},r)})}},{key:"verifyDiscount",value:function(e){var t=this;return new o(function(n,r){s.connect(t.config).view("ecommerce","discountByCode",{keys:[e],include_docs:!0}).then(function(t){if(t.rows.length){var i=t.rows[0].doc,a=(new Date).getTime(),u=new Date(Date.parse(i.dateStart)).getTime(),o=new Date(Date.parse(i.dateEnd)).getTime();if(u>a)return void r(new Error("Discount not valid (not begun)"));if(o<a)return void r(new Error("Discount not valid (expired)"));n(i)}else r(new Error({statusCode:404,message:"Discount code not found ("+e+")"}))},r)})}}]),e}();e.exports=l},function(e,t){e.exports=require("@cloudant/cloudant")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("querystring")},function(e,t,n){"use strict";var r=o(n(7)),i=o(n(6)),a=o(n(1)),u=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var s=n(2),c=n(73),l=n(72),f=n(5),d=n(4),p={google:"https://www.googleapis.com/oauth2/v4/token",instagram:"https://api.instagram.com/oauth/access_token",stripe:"https://connect.stripe.com/oauth/token",vimeo:"https://api.vimeo.com/oauth/access_token"},h=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"authoriseUser",value:function(){var e=(0,i.default)(r.default.mark(function e(t,n){var i,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.config.auth.superUserId.split(",").map(function(e){return e.trim()}).indexOf(n)>-1)){e.next=3;break}return e.abrupt("return",{id:n,role:"super"});case 3:return e.next=5,d.connect(this.config,t).get("config");case 5:if(i=e.sent,a=s.find(i.users,{id:n})){e.next=9;break}throw Error("User not found: "+n);case 9:if(a.active){e.next=11;break}throw Error("User not active: "+n);case 11:return e.abrupt("return",a);case 12:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"authenticateWithProvider",value:function(){var e=(0,i.default)(r.default.mark(function e(t,n){var i,a,u,o,d,h,v=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=s.merge({},this.config[t],n),a={grant_type:v?"refresh_token":"authorization_code",client_id:i.clientId,client_secret:i.clientSecret,redirect_uri:i.redirectUri,code:n.code,refresh_token:n.refresh_token},u=p[t],o=void 0,e.prev=4,e.next=7,l.post(u,c.stringify(a));case 7:o=e.sent,e.next=13;break;case 10:throw e.prev=10,e.t0=e.catch(4),new Error(e.t0);case 13:return d=new f(this.config),e.next=16,d.get();case 16:return(h=e.sent).provider||(h.provider={}),h.provider[t]=s.merge({},h.provider[t]||{},o.data),e.abrupt("return",d.set(h));case 20:case"end":return e.stop()}},e,this,[[4,10]])}));return function(t,n){return e.apply(this,arguments)}}()}]),e}();e.exports=h},function(e,t){e.exports=require("password-hash")},function(e,t,n){"use strict";(function(t){var r=n(11),i={environment:process.env.ENVIRONMENT||"development",debug:process.env.DEBUG||!1,slug:process.env.SLUG,baseUrl:process.env.BASE_URL||"",db:{url:process.env.DB_URL,host:process.env.DB_HOST,name:process.env.DB_NAME,requestPlugin:process.env.DB_REQUEST_PLUGIN,meterType:process.env.DB_METER_TYPE},auth:{superUserId:process.env.AUTH_SUPER_USER_ID,tokenSecret:process.env.AUTH_TOKEN_SECRET||"change_this_secret"},dev:{userId:process.env.DEV_USER_ID||"dev",role:process.env.DEV_ROLE||"super"},assist:{url:process.env.ASSIST_URL,username:process.env.ASSIST_USERNAME,password:process.env.ASSIST_PASSWORD},instagram:{clientId:process.env.INSTAGRAM_CLIENT_ID,clientSecret:process.env.INSTAGRAM_CLIENT_SECRET},twitter:{consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,accessTokenKey:process.env.TWITTER_ACCESS_TOKEN_KEY,accessTokenSecret:process.env.TWITTER_ACCESS_TOKEN_SECRET},google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},mailgun:{apiKey:process.env.MAILGUN_API_KEY,domain:process.env.MAILGUN_DOMAIN},embedly:{apiKey:process.env.EMBEDLY_API_KEY},aws:{accessKeyId:process.env.AWS_ACCESS_KEY_ID,accessKeySecret:process.env.AWS_ACCESS_KEY_SECRET,s3:{bucket:process.env.AWS_S3_BUCKET}},shippo:{token:process.env.SHIPPO_TOKEN,fromZip:process.env.SHIPPO_FROM_ZIP,fromCountry:process.env.SHIPPO_FROM_COUNTRY},stripe:{clientId:process.env.STRIPE_CLIENT_ID,clientSecret:process.env.STRIPE_CLIENT_SECRET,apiKey:process.env.STRIPE_API_KEY},vimeo:{clientId:process.env.VIMEO_CLIENT_ID,clientSecret:process.env.VIMEO_CLIENT_SECRET},zencoder:{apiKey:process.env.ZENCODER_API_KEY,s3:{bucket:process.env.ZENCODER_S3_BUCKET,credentials:process.env.ZENCODER_S3_CREDENTIALS}},pdf:{templates:{}},email:{templatesPath:r.resolve(t,"email")}};e.exports=i}).call(this,"/")},function(e,t,n){"use strict";function r(){}r.defaultConfig=n(76),r.Assist=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(30),[null].concat(t)))},r.Auth=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(74),[null].concat(t)))},r.ClientConfig=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(5),[null].concat(t)))},r.Db=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(4),[null].concat(t)))},r.Ecommerce=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(70),[null].concat(t)))},r.Email=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(27),[null].concat(t)))},r.Embedly=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(53),[null].concat(t)))},r.Entity=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(19),[null].concat(t)))},r.Fields=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(17),[null].concat(t)))},r.File=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(50),[null].concat(t)))},r.Flow=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(47),[null].concat(t)))},r.Helpers=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(8),[null].concat(t)))},r.Instagram=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(46),[null].concat(t)))},r.Jwt=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(45),[null].concat(t)))},r.Pdf=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(43),[null].concat(t)))},r.Roles=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(29),[null].concat(t)))},r.S3=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(12),[null].concat(t)))},r.Schema=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(18),[null].concat(t)))},r.Settings=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(42),[null].concat(t)))},r.Shippo=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(41),[null].concat(t)))},r.Stripe=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(39),[null].concat(t)))},r.Taxonomy=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(36),[null].concat(t)))},r.Tools=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(35),[null].concat(t)))},r.User=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(33),[null].concat(t)))},r.Zencode=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(32),[null].concat(t)))},e.exports=r}])});
//# sourceMappingURL=ace-api.js.map